<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="format-detection" content="telephone=no">
    <title>C·ª≠a H√†ng - TECH HAVEN | PC T√πy Ch·ªânh &amp; Linh Ki·ªán Cao C·∫•p | Mua S·∫Øm Online</title>
    
    <!-- Google Site Verification -->
    <meta name="google-site-verification" content="iY2tYQRO1C7TRzvpo5pQkC7pmJptjx-YyzPKVdgP5CM">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Mua s·∫Øm PC Gaming, Laptop, linh ki·ªán m√°y t√≠nh ch√≠nh h√£ng t·∫°i TECH HAVEN. ƒêa d·∫°ng s·∫£n ph·∫©m t·ª´ CPU Intel/AMD, VGA RTX, RAM DDR5, SSD NVMe. Gi√° t·ªët, giao h√†ng nhanh.">
    <meta name="keywords" content="mua PC gaming, mua laptop gaming, mua linh ki·ªán m√°y t√≠nh, CPU Intel, CPU AMD, VGA RTX, RAM gaming, SSD NVMe, m√†n h√¨nh 144Hz, b√†n ph√≠m c∆°">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <link rel="canonical" href="https://tech-haven-5368b.web.app/shop">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tech-haven-5368b.web.app/shop">
    <meta property="og:title" content="C·ª≠a H√†ng - TECH HAVEN | PC T√πy Ch·ªânh & Linh Ki·ªán Cao C·∫•p">
    <meta property="og:description" content="Mua s·∫Øm PC Gaming, Laptop, linh ki·ªán m√°y t√≠nh ch√≠nh h√£ng. ƒêa d·∫°ng s·∫£n ph·∫©m, gi√° t·ªët, giao h√†ng nhanh.">
    <meta property="og:image" content="https://tech-haven-5368b.web.app/images/shop-og.png">
    <meta property="og:locale" content="vi_VN">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="C·ª≠a H√†ng - TECH HAVEN">
    <meta name="twitter:description" content="Mua s·∫Øm PC Gaming, Laptop, linh ki·ªán m√°y t√≠nh ch√≠nh h√£ng">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="manifest" href="/images/site.webmanifest">
    
    <!-- Google Fonts for Vietnamese Support - Optimized -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet"></noscript>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/shop.css">
    <link rel="stylesheet" href="/css/smart-cart.css">
    <link rel="stylesheet" href="/css/ai-chat-widget.css">
    <link rel="stylesheet" href="/css/checkout-coin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N54V96PG4M"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-N54V96PG4M');
    </script>
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "CollectionPage",
        "name": "C·ª≠a H√†ng TECH HAVEN",
        "description": "Danh s√°ch s·∫£n ph·∫©m PC Gaming, Laptop, linh ki·ªán m√°y t√≠nh",
        "url": "https://tech-haven-5368b.web.app/shop",
        "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Trang ch·ªß",
                    "item": "https://tech-haven-5368b.web.app/"
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "C·ª≠a h√†ng",
                    "item": "https://tech-haven-5368b.web.app/shop"
                }
            ]
        }
    }
    </script>
    
    <!-- Firebase Authentication SDK (compat only) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Lottie Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    
    <script>
        // Firebase Configuration (compat version)
        const firebaseConfigCompat = {
            apiKey: "AIzaSyDpzgsxZ1Jfs5hWAfS-gDbYfgkVte_jXoA",
            authDomain: "tech-haven-5368b.firebaseapp.com",
            projectId: "tech-haven-5368b",
            storageBucket: "tech-haven-5368b.firebasestorage.app",
            messagingSenderId: "442337591630",
            appId: "1:442337591630:web:7005525c7664f513a55e1f"
        };

        // Initialize Firebase (compat)
        firebase.initializeApp(firebaseConfigCompat);
        const authCompat = firebase.auth();
        const firestoreCompat = firebase.firestore();

        console.log('‚úÖ Firebase compat initialized successfully');

        // Current user state
        window.currentUser = null;
        
        // Make Firebase v8 functions globally available for email verification and cart listener
        window.firebaseAuth = authCompat;
        window.firebase = firebase; // Make entire Firebase v8 compat available for script.js
        window.signInWithEmailAndPassword = authCompat.signInWithEmailAndPassword.bind(authCompat);
        window.sendEmailVerification = function(user, settings) {
            return user.sendEmailVerification(settings);
        };
        window.signOut = authCompat.signOut.bind(authCompat);

        // Google Sign In
        window.signInWithGoogle = async function() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await authCompat.signInWithPopup(provider);
                console.log('‚úÖ Google sign in successful:', result.user);
                
                // Clear local cart immediately upon Google login
                console.log('üßπ Clearing local cart for Google user...');
                localStorage.removeItem('techHavenCart');
                localStorage.removeItem('techHavenCartCount');
                
                window.location.reload();
            } catch (error) {
                console.error('‚ùå Google sign in error:', error);
                showNotification('ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i: ' + error.message, 'error');
            }
        };

        // Sign Out
        window.signOutUser = async function() {
            try {
                console.log('üö™ Signing out...');
                
                // Close user profile panel first
                if (window.closeUserProfile) {
                    window.closeUserProfile();
                }
                
                // Sign out from Firebase Auth
                if (window.currentUser && window.currentUser.provider === 'google') {
                    console.log('üîì Signing out Google user...');
                    await authCompat.signOut();
                    console.log('‚úÖ Google sign out successful');
                } else {
                    console.log('üîì Signing out manual user...');
                    // For manual users, just clear localStorage
                    localStorage.removeItem('techHavenUser');
                    console.log('‚úÖ Manual user sign out successful');
                }
                
                // Clear current user
                window.currentUser = null;
                
                // Update UI immediately
                if (window.updateUIBasedOnAuthStatus) {
                    window.updateUIBasedOnAuthStatus();
                }
                
                // Show logout message
                if (window.showNotification) {
                    window.showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
                }
                
                console.log('‚úÖ Sign out successful - reloading page');
                
                // Delay reload slightly to allow UI update
                setTimeout(() => {
                    window.location.reload();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Sign out error:', error);
                // Even if there's an error, clear the user and reload
                window.currentUser = null;
                localStorage.removeItem('techHavenUser');
                
                // Show error message
                if (window.showNotification) {
                    window.showNotification('ƒê√£ ƒëƒÉng xu·∫•t (c√≥ l·ªói nh·ªè)', 'info');
                }
                
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        };

        // Auth state listener (Firebase v8 compat)
        authCompat.onAuthStateChanged(async (user) => {
            console.log('üîê Firebase v8 Auth state changed:', user ? user.email : 'No user');
            
            if (user) {
                // Update window.currentUser and save to localStorage for cross-page access
                window.currentUser = {
                    uid: user.uid,
                    name: user.displayName,
                    email: user.email,
                    photo: user.photoURL,
                    provider: user.providerData && user.providerData.some(p => p.providerId === 'google.com') ? 'google' : 'manual'
                };
                
                // Save user to localStorage for cross-page access (e.g. bill_detail page)
                console.log('üíæ Shop: Saving user to localStorage for cross-page access');
                localStorage.setItem('userData', JSON.stringify(window.currentUser));
                
                // Clear local cart data for Google users (Firebase cart takes precedence)
                if (user.providerData && user.providerData.some(provider => provider.providerId === 'google.com')) {
                    console.log('üßπ Clearing local cart for Google user on v8 auth state change...');
                    localStorage.removeItem('techHavenCart');
                    localStorage.removeItem('techHavenCartCount');
                    
                    // Clear SmartCart if available
                    if (window.smartCart && window.smartCart.clearCartForGoogleLogin) {
                        await window.smartCart.clearCartForGoogleLogin();
                    }
                }
                
                // Start cart real-time listener
                if (window.startCartRealtimeListener) {
                    window.startCartRealtimeListener(user.uid);
                }
                
                // Check if user is new and show welcome modal
                setTimeout(async () => {
                    if (window.checkAndShowWelcomeModal && typeof window.checkAndShowWelcomeModal === 'function') {
                        console.log('üè† Shop: Checking if user needs welcome modal...');
                        await window.checkAndShowWelcomeModal(window.currentUser);
                    } else {
                        console.warn('‚ö†Ô∏è Shop: checkAndShowWelcomeModal not available yet');
                    }
                }, 1000);
            } else {
                // Clear user data when logged out
                window.currentUser = null;
                localStorage.removeItem('userData');
                console.log('üö™ Shop: User logged out, cleared localStorage userData');
                
                // Stop cart real-time listener
                if (window.stopCartRealtimeListener) {
                    window.stopCartRealtimeListener();
                }
            }
        });
    </script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"></script>
    <style>
        /* Override loading screen CSS for shop page */
        body.shop-page.loading, 
        html.loading body.shop-page {
            overflow: auto !important;
            height: auto !important;
        }
        
        /* Prevent loading screen from hiding content on shop page */
        body.shop-page > .header,
        body.shop-page > .shop-header,
        body.shop-page > .shop-content,
        body.shop-page > .footer {
            display: block !important;
            visibility: visible !important;
        }
        
        /* Ensure header doesn't clip mobile menu */
        body.shop-page .header,
        body.shop-page .navbar {
            overflow: visible !important;
        }
        
        /* Keep modals and overlays properly hidden when not active */
        .search-overlay:not(.active),
        .modal-overlay:not(.active) {
            display: none !important;
        }
        
        /* Cart sidebar and overlay should use visibility/opacity, not display */
        .cart-sidebar:not(.active),
        .cart-overlay:not(.active) {
            visibility: hidden;
            opacity: 0;
        }
        
        /* User Icon Styles */
        .user-icon-authenticated {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .user-icon-authenticated:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-name-display {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2937;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Admin Dropdown Styles */
        .admin-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .admin-dropdown .dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 5px;
            padding: 8px 12px;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
        }
        
        .admin-dropdown .dropdown-toggle:hover {
            color: #667eea;
        }
        
        .admin-dropdown .dropdown-toggle i {
            margin-left: 3px;
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .admin-dropdown:hover .dropdown-toggle i {
            transform: rotate(180deg);
        }
        
        .admin-dropdown .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            min-width: 120px;
            z-index: 1000;
        }
        
        .admin-dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
        }
        
        .admin-dropdown .dropdown-menu a {
            display: block;
            padding: 8px 16px;
            text-decoration: none;
            color: #374151;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .admin-dropdown .dropdown-menu a:hover {
            background-color: #f3f4f6;
            color: #667eea;
        }
        
        /* User Profile Panel - Comprehensive styles from index.ejs */
        
        /* Membership Badge in Header */
        .membership-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .membership-tier {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .membership-tier #membershipIcon {
            font-size: 16px;
        }
        
        .membership-points {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            padding-left: 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Membership Info Section */
        .membership-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .membership-current {
            margin-bottom: 20px;
        }
        
        .membership-tier-display {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.85), rgba(124, 58, 237, 0.85));
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .membership-tier-display::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .membership-tier-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .tier-icon {
            font-size: 56px;
            line-height: 1;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
            position: relative;
            z-index: 1;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .tier-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
            z-index: 1;
        }
        
        .tier-name {
            font-size: 28px;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.3);
            letter-spacing: 0.5px;
        }
        
        .tier-points {
            font-size: 15px;
            color: #fff;
            font-weight: 600;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Progress Bar */
        .membership-progress {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .progress-info {
            margin-bottom: 12px;
            font-size: 14px;
            color: #fff;
            text-align: center;
            font-weight: 500;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }
        
        .progress-info strong {
            color: #fff;
            font-weight: 800;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        
        .progress-bar-container {
            height: 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .progress-bar-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: progressShine 2s infinite;
        }
        
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, 
                #667eea 0%, 
                #764ba2 50%, 
                #667eea 100%);
            background-size: 200% 100%;
            border-radius: 20px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            animation: gradientMove 3s ease infinite;
            position: relative;
        }
        
        @keyframes gradientMove {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5));
            border-radius: 20px;
        }
        
        /* Coin Balance Section */
        .coin-balance-section {
            margin: 20px 0;
            padding: 20px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .coin-balance-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.3);
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .coin-balance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 215, 0, 0.4);
        }
        
        .coin-icon {
            font-size: 3.5rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
            animation: coinRotate 3s ease-in-out infinite;
        }
        
        @keyframes coinRotate {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }
        
        .coin-details {
            flex: 1;
        }
        
        .coin-label {
            font-size: 0.9rem;
            color: #333;
            font-weight: 500;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .coin-amount {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .coin-amount span {
            font-family: 'Inter', monospace;
        }
        
        .coin-value-info {
            font-size: 0.85rem;
            color: #555;
            font-weight: 600;
        }
        
        .coin-info-note {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            border-radius: 8px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }
        
        .coin-info-note i {
            color: #ffd700;
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        /* Membership Tiers Legend */
        .membership-tiers-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .tier-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: default;
        }
        
        .tier-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .tier-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 13px;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }
        
        .tier-badge.standard { 
            color: #e5e7eb;
            filter: drop-shadow(0 0 8px rgba(156, 163, 175, 0.8));
        }
        .tier-badge.silver { 
            color: #f3f4f6;
            filter: drop-shadow(0 0 8px rgba(192, 192, 192, 0.9));
        }
        .tier-badge.gold { 
            color: #fcd34d;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 1));
        }
        .tier-badge.diamond { 
            color: #7dd3fc;
            filter: drop-shadow(0 0 12px rgba(96, 215, 255, 1));
            animation: membershipSparkle 2s ease-in-out infinite;
        }
        
        @keyframes membershipSparkle {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(96, 215, 255, 0.8)); }
            50% { filter: drop-shadow(0 0 16px rgba(96, 215, 255, 1)); }
        }
        
        .tier-requirement {
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 8px;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .membership-tier-display {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            
            .tier-icon {
                font-size: 48px;
            }
            
            .tier-name {
                font-size: 24px;
            }
            
            .membership-tiers-legend {
                grid-template-columns: 1fr;
            }
        }
        
        .user-profile-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .user-profile-panel.active {
            right: 0;
        }
        
        .user-profile-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .user-profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }
        
        .user-avatar img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .avatar-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .user-info h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
        }
        
        .user-info p {
            margin: 0 0 8px 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .close-profile-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-profile-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .user-profile-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        
        /* Custom scrollbar for user profile content */
        .user-profile-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .user-profile-content::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 4px;
        }
        
        .user-profile-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
            transition: background 0.3s ease;
        }
        
        .user-profile-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .profile-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .profile-section:last-child {
            border-bottom: none;
        }
        
        .profile-section h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-info .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
        .profile-info label {
            font-weight: 600;
            color: #555;
        }
        
        .profile-info span {
            color: #333;
        }
        
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
        
        .recent-orders, .favorite-products {
            min-height: 60px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        
        /* Custom scrollbar for WebKit browsers */
        .recent-orders::-webkit-scrollbar, .favorite-products::-webkit-scrollbar {
            width: 6px;
        }
        
        .recent-orders::-webkit-scrollbar-track, .favorite-products::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 3px;
        }
        
        .recent-orders::-webkit-scrollbar-thumb, .favorite-products::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
            transition: background 0.3s ease;
        }
        
        .recent-orders::-webkit-scrollbar-thumb:hover, .favorite-products::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .loading-orders, .loading-favorites {
            color: #666;
            font-style: italic;
        }
        
        .empty-favorites, .error-favorites {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            text-align: left;
            padding: 0;
        }
        
        /* When favorites container is scrolling, reset text alignment */
        .favorite-products.has-favorites {
            text-align: left;
            padding: 0;
            position: relative;
        }
        
        /* Add a subtle gradient overlay at the bottom when scrollable */
        .favorite-products.has-favorites::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, rgba(248, 249, 250, 0.8));
            pointer-events: none;
            border-radius: 0 0 8px 8px;
        }
        
        /* Add padding to the grid when it has content */
        .favorite-products.has-favorites .favorites-grid {
            padding: 15px;
        }
        
        .favorite-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .favorite-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .favorite-image {
            position: relative;
            width: 100%;
            height: 120px;
            overflow: hidden;
        }
        
        .favorite-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .favorite-item:hover .favorite-image img {
            transform: scale(1.05);
        }
        
        .favorite-info {
            padding: 0.75rem;
        }
        
        .favorite-info h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .favorite-price {
            margin: 0 0 0.75rem 0;
            font-weight: 700;
            color: #ef4444;
            font-size: 0.875rem;
        }
        
        .favorite-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .favorite-actions .btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .btn-outline-danger {
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        
        .btn-outline-danger:hover {
            background: #ef4444;
            color: white;
        }
        
        .btn-outline-primary {
            background: transparent;
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }
        
        .btn-outline-primary:hover {
            background: #3b82f6;
            color: white;
        }
        
        .favorites-more {
            text-align: center;
            margin-top: 1rem;
        }
        
        /* ---------- Recent Products Styles ---------- */
        .recent-products {
            min-height: 60px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        
        .recent-products::-webkit-scrollbar {
            width: 6px;
        }
        
        .recent-products::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 3px;
        }
        
        .recent-products::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
            transition: background 0.3s ease;
        }
        
        .recent-products::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .loading-recent, .empty-recent, .error-recent {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .recent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            text-align: left;
            padding: 0;
        }
        
        .recent-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .recent-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .recent-image {
            position: relative;
            width: 100%;
            height: 120px;
            overflow: hidden;
        }
        
        .recent-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .recent-item:hover .recent-image img {
            transform: scale(1.05);
        }
        
        .recent-info {
            padding: 0.75rem;
        }
        
        .recent-info h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .recent-price {
            margin: 0 0 0.75rem 0;
            font-weight: 700;
            color: #ef4444;
            font-size: 0.875rem;
        }
        
        .recent-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .recent-actions .btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .recent-actions .btn-outline-primary {
            color: #3b82f6;
            background: white;
            border: 1px solid #3b82f6;
        }
        
        .recent-actions .btn-outline-primary:hover {
            background: #3b82f6;
            color: white;
        }
        
        .recent-actions .btn-primary {
            color: white;
            background: #3b82f6;
        }
        
        .recent-actions .btn-primary:hover {
            background: #2563eb;
        }
        
        .recent-more {
            text-align: center;
            margin-top: 1rem;
        }
        
        /* ---------- Recent Orders Styles ---------- */
        .orders-list { padding: 10px; }
        .order-item { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 12px; padding: 16px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s ease; display: flex; flex-direction: column; width: 100%; box-sizing: border-box; border: 1px solid rgba(102,126,234,0.1); }
        .order-item:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(102,126,234,0.15); border-color: rgba(102,126,234,0.3); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0; gap: 12px; }
        .order-id { display: flex; align-items: center; gap: 10px; font-weight: 700; color: #2d3748; font-size: 0.95rem; flex: 1; min-width: 0; overflow: hidden; }
        .order-id i { color: #667eea; flex-shrink: 0; font-size: 1.1rem; }
        .order-id span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 160px; font-family: 'Courier New', monospace; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .order-status { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-pending { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; }
        .status-processing { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; }
        .status-shipping { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #4338ca; }
        .status-completed { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
        .status-cancelled { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }
        .status-default { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); color: #6b7280; }
        .order-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 14px; padding: 12px; background: rgba(102,126,234,0.03); border-radius: 8px; }
        .order-detail { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; color: #4a5568; padding: 6px 8px; background: white; border-radius: 6px; transition: all 0.2s ease; }
        .order-detail:hover { background: rgba(102,126,234,0.05); transform: scale(1.02); }
        .order-detail i { width: 18px; color: #667eea; font-size: 0.95rem; }
        .order-detail span { font-weight: 500; }
        .order-total { font-weight: 800; color: #ef4444; font-size: 1rem; }
        .order-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
        .order-actions .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
        .order-actions .btn-outline-primary { background: white; color: #667eea; border: 2px solid #667eea; }
        .order-actions .btn-outline-primary:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        .orders-more { text-align: center; margin-top: 1rem; padding: 0 15px; }
        .empty-orders, .error-orders { text-align: center; padding: 2rem 1rem; }
        
        /* ---------- Profile Actions ---------- */
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .profile-actions .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        @media (max-width: 768px) {
            .user-profile-panel {
                width: 100vw;
                right: -100vw;
            }
            
            .recent-orders, .favorite-products {
                max-height: 250px;
            }
            
            .favorites-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.75rem;
            }
            
            .favorite-item {
                border-radius: 6px;
            }
            
            .favorite-image {
                height: 100px;
            }
            
            .favorite-info h5 {
                font-size: 0.8rem;
            }
            
            .favorite-price {
                font-size: 0.8rem;
            }
            
            .favorite-actions .btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.7rem;
            }
        }
        
        /* Tablet and Nest Hub Max specific styles (1280px width) */
        @media screen and (max-width: 1280px) and (min-width: 1025px) {
            .navbar {
                padding: 0 15px;
            }
            
            .nav-menu {
                display: flex;
                gap: 15px;
            }
            
            .nav-menu a {
                font-size: 14px;
                padding: 8px 12px;
                color: white !important; /* Make all nav links white for Nest Hub Max */
            }
            
            /* Special styling for ADMIN text - white color */
            .admin-dropdown .dropdown-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                gap: 5px;
                padding: 8px 12px;
                color: white !important; /* White color for ADMIN text */
                font-weight: 500;
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 4px;
                background: rgba(255,255,255,0.1);
                transition: all 0.3s ease;
            }
            
            .admin-dropdown .dropdown-toggle:hover {
                background: rgba(255,255,255,0.2);
                color: #ffd700 !important; /* Gold color on hover */
                border-color: rgba(255,255,255,0.5);
            }
            
            .admin-dropdown .dropdown-toggle i {
                margin-left: 3px;
                font-size: 12px;
                color: white !important;
            }
            
            .admin-dropdown:hover .dropdown-toggle i {
                color: #ffd700 !important;
            }
            
            /* Dropdown menu styling for Nest Hub Max */
            .admin-dropdown .dropdown-menu {
                background: #2a2a2a; /* Dark background for dropdown */
                border: 1px solid #444;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
            
            .admin-dropdown .dropdown-menu a {
                color: #e5e7eb !important; /* Light gray for INPUT and EDIT */
                font-size: 13px;
                font-weight: 400;
                transition: all 0.3s ease;
            }
            
            .admin-dropdown .dropdown-menu a:hover {
                background-color: #4a4a4a;
                color: #ffd700 !important; /* Gold color on hover */
            }
            
            .mobile-menu-toggle {
                display: none;
            }
            
            .mobile-nav-icons {
                display: none;
            }
        }
        
        /* Mobile adjustments for user icons */
        @media (max-width: 768px) {
            .user-profile-panel {
                width: 100%;
                right: -100%;
            }
            
            .user-name-display {
                display: none;
            }
            
            .user-icon-authenticated {
                padding: 5px;
            }
            
            /* Mobile cart count styling */
            #mobileCartCount {
                background: #dc2626;
                color: white;
                border-radius: 10px;
                padding: 2px 6px;
                font-size: 0.75rem;
                font-weight: bold;
                margin-left: 2px;
                min-width: 18px;
                text-align: center;
                display: inline-block;
            }
        }
        
        /* Login Modal Styles - matching index.ejs */
        .login-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .login-modal-overlay.active {
            display: flex !important;
            opacity: 1;
            visibility: visible;
        }
        
        .login-modal {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.8) translateY(50px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .login-modal-overlay.active .login-modal {
            transform: scale(1) translateY(0);
        }
        
        .login-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 2rem 1rem 2rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .login-modal-header h3 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .close-login-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        
        .close-login-modal:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .login-modal-content {
            padding: 1.5rem 2rem 2rem 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f9fafb;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .remember-me,
        .agree-terms {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #6b7280;
            cursor: pointer;
        }
        
        .remember-me input,
        .agree-terms input {
            width: auto;
            margin: 0;
        }
        
        .forgot-password {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        
        .forgot-password:hover {
            color: #4f46e5;
        }
        
        .login-btn,
        .register-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .login-btn:hover,
        .register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .social-login {
            margin-top: 1rem;
        }
        
        .divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
        }
        
        .divider span {
            background: white;
            padding: 0 1rem;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .google-signin-btn {
            width: 100%;
            padding: 0.875rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            color: #374151;
        }
        
        .google-signin-btn:hover {
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .google-signin-btn i {
            color: #ea4335;
            font-size: 1.2rem;
        }
        
        .modal-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .modal-footer p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .modal-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .modal-footer a:hover {
            color: #4f46e5;
        }
        
        /* Responsive Design for Login Modal */
        @media (max-width: 480px) {
            .login-modal {
                width: 95%;
                margin: 1rem;
            }
            
            .login-modal-header,
            .login-modal-content {
                padding: 1.5rem;
            }
            
            .form-options {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }
        
        /* =====================================
           SHOPPING CART SIDEBAR STYLES
           ===================================== */
        
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .cart-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            z-index: 10000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .cart-sidebar.active {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .cart-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .close-cart:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .cart-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
        }
        
        .cart-item:hover {
            background: #f8fafc;
        }
        
        .cart-item-image {
            width: 60px;
            height: 60px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .cart-item-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .cart-item-name {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }
        
        .cart-item-price {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .quantity-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .cart-item-quantity {
            min-width: 30px;
            text-align: center;
            font-weight: 500;
        }
        
        .remove-item {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        
        .remove-item:hover {
            background: #fee2e2;
            border-color: #fca5a5;
        }
        
        .cart-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .cart-total {
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.125rem;
            color: #1f2937;
        }
        
        .checkout-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .checkout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .empty-cart {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        
        .empty-cart i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Mobile responsiveness for cart */
        @media (max-width: 480px) {
            .cart-sidebar {
                width: 100% !important;
                right: -100% !important;
                z-index: 99999 !important;
            }
            
            .cart-sidebar.active {
                right: 0 !important;
                transform: translateX(0) !important;
            }
            
            .cart-overlay {
                z-index: 99998 !important;
            }
            
            .cart-overlay.active {
                opacity: 1 !important;
                visibility: visible !important;
                display: block !important;
            }
        }
        
        /* =====================================
           ADDRESS MANAGEMENT STYLES
        ===================================== */
        
        /* AUTO-FILLED FORM FIELD STYLES */
        .checkout-form input:disabled {
            background-color: #f5f5f5;
            border: 1px solid #d0d0d0;
            color: #666;
            cursor: not-allowed;
        }
        
        .saved-addresses {
            margin-bottom: 20px;
        }
        
        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .address-header label {
            font-weight: 600;
            color: #374151;
        }
        
        .add-address-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-address-btn:hover {
            background: #2563eb;
        }
        
        .add-address-btn i {
            margin-right: 6px;
        }
        
        .address-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .address-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        
        .address-item:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .address-item.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .address-item.default {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .address-item.default::before {
            content: "M·∫∂C ƒê·ªäNH";
            background: #10b981;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            float: right;
            margin-bottom: 5px;
        }
        
        .address-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .address-text {
            flex: 1;
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }
        
        .address-text strong {
            color: #1f2937;
        }
        
        .address-actions {
            display: flex;
            gap: 8px;
            margin-left: 15px;
        }
        
        .address-action-btn {
            background: none;
            border: 1px solid #d1d5db;
            color: #6b7280;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .address-action-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #374151;
        }
        
        .address-action-btn.set-default {
            color: #059669;
            border-color: #059669;
        }
        
        .address-action-btn.set-default:hover {
            background: #ecfdf5;
        }
        
        .address-action-btn.delete {
            color: #dc2626;
            border-color: #dc2626;
        }
        
        .address-action-btn.delete:hover {
            background: #fef2f2;
        }
        
        .no-addresses {
            text-align: center;
            padding: 30px;
            color: #9ca3af;
        }
        
        .no-addresses i {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .new-address-form {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: #f9fafb;
            margin-top: 15px;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .form-header h5 {
            margin: 0;
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }
        
        .cancel-address-btn {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .cancel-address-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .form-options {
            margin: 15px 0;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
        }
        
        .checkbox-option input {
            margin-right: 8px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .save-address-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .save-address-btn:hover {
            background: #059669;
        }
        
        .save-address-btn i {
            margin-right: 6px;
        }
        
        .cancel-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cancel-btn:hover {
            background: #4b5563;
        }
        
        .selected-address {
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            background: #f0fdf4;
        }
        
        .address-info h6 {
            margin: 0 0 10px 0;
            color: #065f46;
            font-size: 14px;
            font-weight: 600;
        }
        
        .address-info p {
            margin: 0 0 10px 0;
            color: #374151;
            line-height: 1.5;
        }
        
        .change-address-btn {
            background: none;
            border: 1px solid #10b981;
            color: #10b981;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .change-address-btn:hover {
            background: #10b981;
            color: white;
        }
        
        .change-address-btn i {
            margin-right: 4px;
        }
        
        /* Mobile responsiveness for address management */
        @media (max-width: 768px) {
            .address-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .add-address-btn {
                justify-self: center;
            }
            
            .address-details {
                flex-direction: column;
                gap: 10px;
            }
            
            .address-actions {
                margin-left: 0;
                justify-content: flex-end;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .save-address-btn,
            .cancel-btn {
                width: 100%;
            }
        }

        /* =====================================
           DISCOUNT CODE STYLES
        ===================================== */

        .discount-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .discount-codes-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .discount-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .discount-code-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .discount-code-item.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .discount-code-info {
            flex: 1;
        }

        .discount-code-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .discount-code-title i {
            color: #667eea;
            font-size: 16px;
        }

        .discount-code-title strong {
            color: #495057;
            font-size: 16px;
        }

        .discount-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .discount-code-desc {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .discount-code-id {
            color: #495057;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .select-discount-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .select-discount-btn:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
            transform: scale(1.05);
        }

        .manual-code-entry {
            border-top: 1px dashed #dee2e6;
            padding-top: 20px;
        }

        .code-input-group {
            display: flex;
            gap: 10px;
        }

        .code-input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            transition: border-color 0.3s ease;
        }

        .code-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .apply-code-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .apply-code-btn:hover {
            background: linear-gradient(135deg, #218838, #1ea080);
            transform: translateY(-1px);
        }

        .apply-code-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .applied-discount {
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .applied-discount-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #155724;
            font-weight: 500;
        }

        .applied-discount-info i {
            color: #28a745;
            font-size: 16px;
        }

        .remove-discount-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-discount-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* Discount section in order summary */
        .discount-line {
            color: #28a745;
            font-weight: 500;
        }

        .discount-line .discount-amount {
            color: #28a745;
        }

        /* No coupons message styling */
        .no-coupons-message {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
            background: #f9fafb;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            margin: 10px 0;
        }

        .no-coupons-message i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
            color: #9ca3af;
        }

        .no-coupons-message p {
            margin: 0;
            font-size: 14px;
        }

        /* Mobile responsiveness for discount codes */
        @media (max-width: 768px) {
            .discount-code-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .select-discount-btn {
                align-self: flex-end;
            }

            .code-input-group {
                flex-direction: column;
            }

            .apply-code-btn {
                width: 100%;
            }

            .discount-code-title {
                flex-wrap: wrap;
            }
        }

        /* =====================================
           OTP VERIFICATION MODAL STYLES
           ===================================== */
        
        #otpModal .modal-content {
            animation: slideInFromTop 0.3s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* =====================================
           IMPROVED OTP MODAL STYLES
           ===================================== */
        
        .otp-form {
            padding: 2.5rem;
            max-width: 100%;
            margin: 0 auto;
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(253, 242, 248, 0.8) 30%, 
                rgba(254, 247, 247, 0.9) 60%, 
                rgba(255, 241, 242, 0.8) 100%);
            position: relative;
        }

        .otp-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, 
                rgba(244, 114, 182, 0.1) 0%, transparent 50%),
                       radial-gradient(circle at 80% 70%, 
                rgba(236, 72, 153, 0.1) 0%, transparent 50%),
                       radial-gradient(circle at 50% 50%, 
                rgba(190, 24, 93, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .otp-step {
            animation: fadeInUp 0.6s ease-out;
            text-align: center;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .otp-step h4 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            text-shadow: none;
        }

        .otp-step h4::before {
            content: "ÔøΩ";
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .otp-step p {
            color: #6b7280;
            margin-bottom: 2rem;
            line-height: 1.6;
            font-size: 1rem;
        }

        .otp-step .form-group {
            margin-bottom: 2rem;
            text-align: left;
        }

        .otp-step .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: #374151;
            font-weight: 600;
            font-size: 1rem;
        }

        .otp-step .form-group input {
            width: 100%;
            padding: 1.2rem 1.5rem;
            border: 2px solid #fce7f3;
            border-radius: 20px;
            font-size: 1.1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(253, 242, 248, 0.7) 50%, 
                rgba(254, 247, 247, 0.9) 100%);
            box-shadow: 0 4px 15px rgba(244, 114, 182, 0.1), 
                        0 2px 8px rgba(236, 72, 153, 0.05),
                        inset 0 1px 0 rgba(255, 182, 193, 0.1);
            position: relative;
        }

        .otp-step .form-group input:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 0 4px rgba(244, 114, 182, 0.2),
                        0 15px 35px -5px rgba(236, 72, 153, 0.3),
                        0 0 20px rgba(190, 24, 93, 0.1);
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 1) 0%, 
                rgba(253, 242, 248, 0.8) 100%);
            transform: translateY(-2px) scale(1.02);
        }

        .otp-step .form-group input:focus + label,
        .otp-step .form-group input:not(:placeholder-shown) + label {
            transform: translateY(-25px) scale(0.85);
            color: #f472b6;
        }

        #otpCode {
            text-align: center !important;
            font-size: 2.5rem !important;
            font-weight: bold !important;
            letter-spacing: 12px !important;
            font-family: 'Courier New', monospace !important;
            padding: 1.8rem !important;
            background: linear-gradient(145deg, 
                rgba(255, 240, 245, 0.9) 0%, 
                rgba(253, 242, 248, 0.8) 30%,
                rgba(255, 228, 230, 0.9) 60%,
                rgba(254, 242, 242, 0.8) 100%) !important;
            border: 3px solid #f472b6 !important;
            color: #be185d !important;
            position: relative;
            animation: codeGlow 2s ease-in-out infinite alternate;
        }

        @keyframes codeGlow {
            0% {
                box-shadow: 0 0 15px rgba(244, 114, 182, 0.3),
                           inset 0 0 15px rgba(236, 72, 153, 0.1);
            }
            100% {
                box-shadow: 0 0 25px rgba(244, 114, 182, 0.5),
                           0 0 35px rgba(236, 72, 153, 0.3),
                           inset 0 0 20px rgba(190, 24, 93, 0.15);
            }
        }

        #otpCode:focus {
            border-color: #ec4899 !important;
            box-shadow: 0 0 0 6px rgba(244, 114, 182, 0.3),
                        0 15px 40px -5px rgba(236, 72, 153, 0.4),
                        0 0 30px rgba(190, 24, 93, 0.2) !important;
            animation: none;
        }

        #otpCode::placeholder {
            color: rgba(190, 24, 93, 0.5);
            animation: placeholderPulse 2s ease-in-out infinite;
        }

        @keyframes placeholderPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .otp-timer {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fbbf24 100%);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 25px -5px rgba(245, 158, 11, 0.3),
                        0 4px 6px -1px rgba(245, 158, 11, 0.1);
            position: relative;
            overflow: hidden;
        }

        .otp-timer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .otp-timer p {
            margin: 0;
            color: #92400e;
            font-weight: 700;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        #otpTimer {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: #dc2626;
            margin-left: 0.5rem;
            text-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
            position: relative;
            z-index: 1;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .form-actions button {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .form-actions .btn-secondary {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #475569;
            border: 2px solid #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .form-actions .btn-secondary:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            border-color: #94a3b8;
        }

        .form-actions .btn-primary {
            background: linear-gradient(135deg, 
                #f472b6 0%, 
                #ec4899 25%, 
                #be185d 50%, 
                #f97316 75%, 
                #f59e0b 100%);
            color: white;
            border: 2px solid transparent;
            box-shadow: 0 8px 25px -5px rgba(244, 114, 182, 0.4),
                       0 4px 15px rgba(236, 72, 153, 0.2);
            position: relative;
            overflow: hidden;
            animation: buttonPulse 3s ease-in-out infinite;
        }

        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 0 8px 25px -5px rgba(244, 114, 182, 0.4),
                           0 4px 15px rgba(236, 72, 153, 0.2);
            }
            50% {
                box-shadow: 0 12px 35px -5px rgba(244, 114, 182, 0.6),
                           0 6px 20px rgba(236, 72, 153, 0.3),
                           0 0 20px rgba(190, 24, 93, 0.2);
            }
        }

        .form-actions .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                rgba(255, 182, 193, 0.2),
                transparent);
            transition: left 0.6s ease-out;
        }

        .form-actions .btn-primary:hover::before {
            left: 100%;
        }

        .form-actions .btn-primary:hover {
            background: linear-gradient(135deg, 
                #ec4899 0%, 
                #be185d 25%, 
                #9f1239 50%, 
                #ea580c 75%, 
                #d97706 100%);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 20px 45px -5px rgba(244, 114, 182, 0.6),
                       0 10px 25px rgba(236, 72, 153, 0.4),
                       0 0 30px rgba(190, 24, 93, 0.3);
            animation: none;
        }

        .resend-otp {
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        .btn-link {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .btn-link:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #5a67d8;
            text-decoration: none;
            transform: translateY(-2px);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 8px 25px -5px rgba(102, 126, 234, 0.3);
        }

        .btn-link:disabled {
            color: #9ca3af;
            cursor: not-allowed;
            text-decoration: none;
            background: rgba(156, 163, 175, 0.1);
            border-color: rgba(156, 163, 175, 0.3);
            transform: none;
        }

        #otpEmailDisplay {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* =====================================
           OTP MODAL STYLES
           ===================================== */
        
        /* =====================================
           OTP MODAL CONTAINER STYLES
           ===================================== */
        
        #otpModal .modal-content {
            max-width: 500px;
            border-radius: 24px;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(248, 113, 113, 0.3), 
                        0 15px 35px -5px rgba(244, 114, 182, 0.2),
                        0 5px 15px rgba(251, 113, 133, 0.1),
                        0 0 0 1px rgba(255, 182, 193, 0.2);
            background: linear-gradient(145deg, #ffffff 0%, #fdf2f8 50%, #fef7f7 100%);
            overflow: hidden;
            animation: modalFloat 3s ease-in-out infinite alternate;
            position: relative;
        }

        @keyframes modalFloat {
            0% { transform: translateY(0px) rotate(0deg); }
            100% { transform: translateY(-5px) rotate(0.5deg); }
        }

        #otpModal .modal-header {
            border-bottom: none;
            padding: 2rem 2rem 1rem 2rem;
            background: linear-gradient(135deg, #f472b6 0%, #ec4899 25%, #be185d 50%, #f97316 75%, #f59e0b 100%);
            border-radius: 24px 24px 0 0;
            position: relative;
            overflow: hidden;
        }

        #otpModal .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(244, 114, 182, 0.9) 0%, 
                rgba(236, 72, 153, 0.9) 25%, 
                rgba(190, 24, 93, 0.9) 50%, 
                rgba(249, 115, 22, 0.9) 75%, 
                rgba(245, 158, 11, 0.9) 100%);
            backdrop-filter: blur(15px);
        }

        #otpModal .modal-header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 50%);
            animation: sparkle 4s linear infinite;
        }

        @keyframes sparkle {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        #otpModal .modal-header h3 {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        #otpModal .modal-header h3 i {
            color: #fbbf24;
            margin-right: 0.75rem;
            font-size: 1.6rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        #otpModal .close-modal {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.3) 0%, rgba(255, 192, 203, 0.4) 100%);
            border: 2px solid rgba(255, 182, 193, 0.5);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2;
            backdrop-filter: blur(15px);
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            0% { 
                box-shadow: 0 0 10px rgba(244, 114, 182, 0.4),
                           0 0 20px rgba(236, 72, 153, 0.3);
            }
            100% { 
                box-shadow: 0 0 20px rgba(244, 114, 182, 0.6),
                           0 0 30px rgba(236, 72, 153, 0.4),
                           0 0 40px rgba(190, 24, 93, 0.2);
            }
        }

        #otpModal .close-modal:hover {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.5) 0%, rgba(255, 192, 203, 0.6) 100%);
            transform: scale(1.2) rotate(90deg);
            box-shadow: 0 8px 25px rgba(244, 114, 182, 0.4),
                       0 0 30px rgba(236, 72, 153, 0.5);
        }

        #otpModal .modal-body {
            padding: 0;
            display: block;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-link {
            background: none;
            border: none;
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            transition: color 0.3s ease;
        }

        .btn-link:hover {
            color: #1d4ed8;
        }

        .btn-link:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

        .resend-otp {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* =====================================
           RESPONSIVE OTP MODAL STYLES
           ===================================== */
        
        @media (max-width: 768px) {
            #otpModal .modal-content {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
                border-radius: 12px;
            }

            #otpModal .modal-header {
                padding: 1rem 1.5rem;
                border-radius: 12px 12px 0 0;
            }

            .otp-form {
                padding: 1.5rem;
            }

            .otp-step h4 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .otp-step h4::before {
                font-size: 1.3rem;
            }

            .otp-step p {
                font-size: 0.95rem;
                margin-bottom: 1.5rem;
            }

            .otp-step .form-group input {
                padding: 0.875rem 1rem;
                font-size: 1rem;
            }

            #otpCode {
                font-size: 1.75rem !important;
                letter-spacing: 6px !important;
                padding: 1rem !important;
            }

            .otp-timer {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .otp-timer p {
                font-size: 0.9rem;
            }

            #otpTimer {
                font-size: 1.25rem;
            }

            .form-actions {
                flex-direction: column;
                gap: 0.75rem;
                margin-top: 1.5rem;
            }

            .form-actions button {
                padding: 1rem;
                min-width: 100%;
                font-size: 1rem;
            }

            .btn-link {
                font-size: 0.95rem;
                padding: 0.75rem;
            }

            #otpEmailDisplay {
                display: block;
                margin-top: 0.5rem;
                padding: 0.5rem 1rem;
                border-radius: 8px;
            }
        }

        @media (max-width: 480px) {
            #otpModal .modal-content {
                margin: 0.25rem;
                max-width: calc(100% - 0.5rem);
            }

            .otp-form {
                padding: 1rem;
            }

            .otp-step h4 {
                font-size: 1.1rem;
            }

            #otpCode {
                font-size: 1.5rem !important;
                letter-spacing: 4px !important;
            }

            .form-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .form-actions button {
                width: 100%;
            }
        }

        /* =====================================
           VARIANT SELECTION MODAL STYLES
        ===================================== */
        
        .variant-selection {
            padding: 0;
        }
        
        .main-product-info {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }
        
        .variant-info-text {
            margin: 0;
            color: #0c4a6e;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-info-text i {
            color: #0ea5e9;
            font-size: 16px;
        }
        
        .variant-options {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .variant-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ffffff;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .variant-option:hover {
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            transform: translateY(-2px);
        }
        
        .variant-option.main-product {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
        }
        
        .variant-option.main-product:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }
        
        .variant-option-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
        }
        
        .variant-option-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .variant-option-image i {
            font-size: 32px;
            color: #64748b;
        }
        
        .variant-option-info {
            flex: 1;
            min-width: 0;
        }
        
        .variant-option-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .variant-badge.main {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .variant-badge.variant {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .variant-option-price {
            font-size: 18px;
            font-weight: 700;
            color: #dc2626;
            margin: 4px 0;
        }
        
        .variant-option-price .old-price {
            font-size: 14px;
            font-weight: 400;
            color: #6b7280;
            text-decoration: line-through;
            margin-left: 8px;
        }
        
        .variant-option-desc {
            font-size: 13px;
            color: #6b7280;
            margin: 0;
            line-height: 1.4;
        }
        
        .variant-option-stock {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            display: inline-block;
        }
        
        .variant-option-stock.in-stock {
            background: #dcfce7;
            color: #166534;
        }
        
        .variant-option-stock.low-stock {
            background: #fef3c7;
            color: #92400e;
        }
        
        .variant-option-stock.out-stock {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .variant-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .variant-select-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        /* Mobile responsiveness for variant selection */
        @media (max-width: 768px) {
            .variant-option {
                flex-direction: column;
                text-align: center;
                padding: 12px;
            }
            
            .variant-option-image {
                width: 60px;
                height: 60px;
            }
            
            .variant-option-name {
                font-size: 14px;
            }
            
            .variant-option-price {
                font-size: 16px;
            }
            
            .variant-actions {
                flex-direction: column;
            }
        }

        /* =====================================
           CHECKOUT MODAL LAYOUT FIXES
           ===================================== */
        
        /* Modal body flexbox layout */
        #checkoutModal .modal-body {
            display: flex;
            gap: 2rem;
            padding: 1.5rem;
            max-height: 70vh;
            overflow: hidden;
        }
        
        /* Checkout form - scrollable left side */
        #checkoutModal .checkout-form {
            flex: 2;
            overflow-y: auto;
            padding-right: 1rem;
            max-height: 100%;
        }
        
        /* Order summary - fixed right side */
        #checkoutModal .order-summary {
            flex: 1;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            position: sticky;
            top: 0;
            height: fit-content;
            max-height: 100%;
            overflow: hidden;
        }
        
        #checkoutModal .order-summary h4 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Form section styling */
        #checkoutModal .form-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        #checkoutModal .form-section h4 {
            margin: 0 0 1.5rem 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Order items and totals */
        #checkoutModal .order-items {
            margin-bottom: 1.5rem;
        }
        
        #checkoutModal .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        #checkoutModal .order-item:last-child {
            border-bottom: none;
        }
        
        #checkoutModal .order-item-name {
            font-weight: 500;
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        #checkoutModal .order-item-price {
            font-weight: 600;
            color: #dc2626;
            white-space: nowrap;
        }
        
        #checkoutModal .order-totals {
            border-top: 2px solid #e5e7eb;
            padding-top: 1rem;
        }
        
        #checkoutModal .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        #checkoutModal .total-line.total {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
            border-top: 1px solid #d1d5db;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            /* Fix modal content for mobile scroll */
            .modal-content {
                max-height: 95vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            .modal-header {
                flex-shrink: 0;
            }
            
            .modal-footer {
                flex-shrink: 0;
                padding: 1rem 1.5rem;
            }
            
            #checkoutModal .modal-body {
                flex-direction: column;
                gap: 1rem;
                flex: 1;
                overflow-y: auto;
                padding: 1rem 1.5rem;
                -webkit-overflow-scrolling: touch;
            }
            
            #checkoutModal .checkout-form {
                flex: none;
                order: 1;
                padding-right: 0;
            }
            
            #checkoutModal .order-summary {
                flex: none;
                order: 2;
                position: static;
                max-height: none;
                overflow-y: visible;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .modal-overlay {
                padding: 0.5rem;
            }
            
            .modal-content {
                max-height: 98vh;
                border-radius: 15px;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
            
            .modal-footer {
                padding: 1rem;
                gap: 0.5rem;
            }
            
            .btn-secondary,
            .btn-primary {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            #checkoutModal .modal-body {
                padding: 1rem;
            }
            
            #checkoutModal .form-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
        }
        
        /* =====================================
           WELCOME ADDRESS MODAL STYLES
           ===================================== */
        .welcome-address-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .welcome-address-modal-overlay.active {
            display: flex;
        }
        
        .welcome-address-modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }
        
        .welcome-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            text-align: center;
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
        .welcome-icon {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #667eea;
        }
        
        .welcome-modal-header h3 {
            margin: 0 0 0.5rem;
            font-size: 1.5rem;
        }
        
        .welcome-subtitle {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .welcome-modal-content {
            padding: 2rem;
        }
        
        .address-form-welcome .form-row {
            margin-bottom: 1rem;
        }
        
        .address-form-welcome .form-group {
            flex: 1;
        }
        
        .address-form-welcome label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .address-form-welcome input,
        .address-form-welcome select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .address-form-welcome input:focus,
        .address-form-welcome select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .address-form-welcome .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .address-form-welcome .form-row .form-group:first-child {
            grid-column: 1 / -1;
        }
        
        .welcome-modal-footer {
            padding: 1.5rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .btn-skip {
            padding: 0.75rem 1.5rem;
            border: 2px solid #ddd;
            background: white;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-skip:hover {
            background: #f5f5f5;
            border-color: #999;
            transform: translateY(-2px);
        }
        
        .btn-save-address {
            padding: 0.75rem 1.5rem;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-save-address:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn-verify-welcome-address {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .btn-verify-welcome-address:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        .btn-verify-welcome-address:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .welcome-coordinates-display {
            margin-top: 15px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 640px) {
            .welcome-address-modal {
                max-width: 100%;
                margin: 1rem;
            }
            
            .welcome-modal-header {
                padding: 1.5rem;
            }
            
            .welcome-icon {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
            
            .welcome-modal-header h3 {
                font-size: 1.25rem;
            }
            
            .welcome-modal-content {
                padding: 1.5rem;
            }
            
            .address-form-welcome .form-row {
                grid-template-columns: 1fr;
            }
            
            .welcome-modal-footer {
                flex-direction: column;
            }
            
            .btn-skip,
            .btn-save-address {
                width: 100%;
            }
        }
    </style>
</head>
<body class="shop-page">
    <!-- Hidden user data (improved debugging) -->
    <script type="application/json" id="user-data">null</script>
    
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <h1><a href="/" style="text-decoration: none; color: inherit;">TECH HAVEN</a></h1>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <div class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            
            <div class="nav-menu">
                <a href="/">TRANG CH·ª¶</a>
                <a href="/shop" class="active">C·ª¨A H√ÄNG</a>
                <div class="admin-dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.stopPropagation();">ADMIN <i class="fas fa-chevron-down"></i></a>
                    <div class="dropdown-menu">
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/input'); return false;">INPUT</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/edit'); return false;">EDIT</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/coupon'); return false;">COUPON</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/bill'); return false;">BILL</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/revenue'); return false;">REVENUE</a>

                    </div>
                </div>
                <a href="/shop?category=laptop" onclick="event.preventDefault(); if (typeof applyCategoryFilter === 'function') { applyCategoryFilter('laptop'); } else { window.location.href='/shop?category=laptop'; } return false;">LAPTOP</a>
                <a href="/shop?category=component" onclick="event.preventDefault(); if (typeof applyCategoryFilter === 'function') { applyCategoryFilter('component'); } else { window.location.href='/shop?category=component'; } return false;">LINH KI·ªÜN</a>
                <a href="/shop?category=peripheral" onclick="event.preventDefault(); if (typeof applyCategoryFilter === 'function') { applyCategoryFilter('peripheral'); } else { window.location.href='/shop?category=peripheral'; } return false;">PH·ª§ KI·ªÜN</a>
                <a href="/build-pc" class="build-btn">X√ÇY D·ª∞NG PC</a>
                <div class="mobile-nav-icons">
                    <a href="#" onclick="event.preventDefault(); toggleSearch(); return false;"><i class="fas fa-search"></i> T√¨m ki·∫øm</a>
                    <a href="#" id="mobileCartLink" style="display: flex; align-items: center; text-decoration: none; color: inherit;"><i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng (<span id="mobileCartCount">0</span>)</a>
                    <a href="#" id="mobileUserLink" onclick="event.preventDefault(); openLoginModal(); return false;"><i class="fas fa-user"></i> T√†i kho·∫£n</a>
                </div>
            </div>
            <div class="nav-icons">
                <i class="fas fa-search" onclick="toggleSearch()"></i>
                <div class="cart-icon-wrapper" id="cartIcon" onclick="toggleCart()">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-badge" id="cartBadge">0</span>
                    <div class="cart-state-tooltip" id="cartStateTooltip">D·ªØ li·ªáu c·ª•c b·ªô</div>
                </div>
                <div id="userIconContainer">
                    <i class="fas fa-user" onclick="openLoginModal()" style="cursor: pointer;"></i>
                </div>
            </div>
        </nav>
    </header>

    <!-- Search Bar -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-container">
            <div class="search-header">
                <h3>T√¨m ki·∫øm s·∫£n ph·∫©m</h3>
                <button class="search-close" onclick="toggleSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..." autocomplete="off">
                <button class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="search-suggestions" id="searchSuggestions">
                <!-- Default search suggestions -->
                <div class="suggestion-item" onclick="selectCategoryFromSearch('laptop')">
                    <i class="fas fa-laptop"></i>
                    <div class="suggestion-text">
                        <h4>Laptop Gaming</h4>
                        <p>ASUS, MSI, Acer, Alienware</p>
                    </div>
                </div>
                <div class="suggestion-item" onclick="selectCategoryFromSearch('cpu')">
                    <i class="fas fa-microchip"></i>
                    <div class="suggestion-text">
                        <h4>CPU</h4>
                        <p>Intel Core, AMD Ryzen</p>
                    </div>
                </div>
                <div class="suggestion-item" onclick="selectCategoryFromSearch('vga')">
                    <i class="fas fa-memory"></i>
                    <div class="suggestion-text">
                        <h4>Card ƒë·ªì h·ªça</h4>
                        <p>RTX 4080, RTX 4070, RTX 4060</p>
                    </div>
                </div>
                <div class="suggestion-item" onclick="selectCategoryFromSearch('monitor')">
                    <i class="fas fa-desktop"></i>
                    <div class="suggestion-text">
                        <h4>M√†n h√¨nh</h4>
                        <p>Gaming, 4K, Ultrawide</p>
                    </div>
                </div>
                <div class="suggestion-item" onclick="selectCategoryFromSearch('keyboard')">
                    <i class="fas fa-keyboard"></i>
                    <div class="suggestion-text">
                        <h4>B√†n ph√≠m</h4>
                        <p>Mechanical, Gaming, Wireless</p>
                    </div>
                </div>
                <div class="suggestion-item" onclick="selectCategoryFromSearch('mouse')">
                    <i class="fas fa-mouse"></i>
                    <div class="suggestion-text">
                        <h4>Chu·ªôt gaming</h4>
                        <p>Wireless, Pro, RGB</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Header -->
    <div class="shop-header">
        <div class="container">
            <div class="breadcrumb">
                <a href="/"><i class="fas fa-home"></i></a>
                <span>/</span>
                <span>C·ª≠a H√†ng</span>
            </div>
            <h1 class="shop-title">
                <i class="fas fa-store"></i>
                C·ª≠a H√†ng TECH HAVEN
            </h1>
            <p class="shop-subtitle">Kh√°m ph√° h√†ng ngh√¨n s·∫£n ph·∫©m c√¥ng ngh·ªá ch·∫•t l∆∞·ª£ng cao</p>
            
            <!-- Debug Test Button -->
            <button onclick="toggleCart()" style="background: red; color: white; padding: 10px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                üõí TEST CART TOGGLE
            </button>
            <button onclick="testCartCount()" style="background: blue; color: white; padding: 10px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                üî¢ TEST CART COUNT
            </button>
            <button onclick="window.debugCart ? window.debugCart() : console.log('debugCart not available')" style="background: green; color: white; padding: 10px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                üîç DEBUG CART
            </button>
            <button onclick="testSmartCartState()" style="background: purple; color: white; padding: 10px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                üß† TEST SMART CART
            </button>
            <button onclick="window.forceUpdateCartUI ? window.forceUpdateCartUI() : console.log('forceUpdateCartUI not available')" style="background: orange; color: white; padding: 10px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                üîß FORCE CART UPDATE
            </button>
            <button onclick="window.testMobileCart ? window.testMobileCart() : console.log('testMobileCart not available')" style="background: teal; color: white; padding: 10px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                üì± TEST MOBILE CART
            </button>
            <!-- Removed TEST ADD TO CART button - use script.js implementation instead -->
        </div>
    </div>

    <!-- Shop Content -->
    <div class="shop-content">
        <div class="container">
            <div class="shop-layout">
                <!-- Filter Sidebar -->
                <div class="filter-sidebar" id="filterSidebar">
                    <div class="filter-header">
                        <h3><i class="fas fa-filter"></i> B·ªô L·ªçc S·∫£n Ph·∫©m</h3>
                        <button class="filter-close" onclick="toggleFilters()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Category Filter -->
                    <div class="filter-section">
                        <h4><i class="fas fa-tags"></i> Danh M·ª•c</h4>
                        <div class="filter-options">
                            <label class="filter-option">
                                <input type="checkbox" value="all" id="categoryAll" checked>
                                <span class="checkmark"></span>
                                T·∫•t C·∫£ S·∫£n Ph·∫©m
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="pc" class="category-filter">
                                <span class="checkmark"></span>
                                M√°y T√≠nh PC
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="laptop" class="category-filter">
                                <span class="checkmark"></span>
                                Laptop Gaming
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="cpu" class="category-filter">
                                <span class="checkmark"></span>
                                Vi X·ª≠ L√Ω (CPU)
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="gpu" class="category-filter">
                                <span class="checkmark"></span>
                                Card ƒê·ªì H·ªça (GPU)
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="ram" class="category-filter">
                                <span class="checkmark"></span>
                                RAM
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="storage" class="category-filter">
                                <span class="checkmark"></span>
                                ·ªî C·ª©ng & SSD
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="monitor" class="category-filter">
                                <span class="checkmark"></span>
                                M√†n H√¨nh
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="peripheral" class="category-filter">
                                <span class="checkmark"></span>
                                Ph·ª• Ki·ªán Gaming
                            </label>
                        </div>
                    </div>

                    <!-- Price Range Filter -->
                    <div class="filter-section">
                        <h4><i class="fas fa-dollar-sign"></i> Kho·∫£ng Gi√°</h4>
                        <div class="price-range">
                            <div class="price-inputs">
                                <input type="number" id="minPrice" placeholder="T·ª´" min="0">
                                <span>-</span>
                                <input type="number" id="maxPrice" placeholder="ƒê·∫øn" min="0">
                            </div>
                            <div class="price-suggestions">
                                <button class="price-tag" data-min="0" data-max="5000000">D∆∞·ªõi 5 tri·ªáu</button>
                                <button class="price-tag" data-min="5000000" data-max="15000000">5 - 15 tri·ªáu</button>
                                <button class="price-tag" data-min="15000000" data-max="30000000">15 - 30 tri·ªáu</button>
                                <button class="price-tag" data-min="30000000" data-max="999999999">Tr√™n 30 tri·ªáu</button>
                            </div>
                        </div>
                    </div>

                    <!-- Brand Filter -->
                    <div class="filter-section">
                        <h4><i class="fas fa-building"></i> Th∆∞∆°ng Hi·ªáu</h4>
                        <div class="filter-options">
                            <label class="filter-option">
                                <input type="checkbox" value="asus" class="brand-filter">
                                <span class="checkmark"></span>
                                ASUS
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="msi" class="brand-filter">
                                <span class="checkmark"></span>
                                MSI
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="intel" class="brand-filter">
                                <span class="checkmark"></span>
                                Intel
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="amd" class="brand-filter">
                                <span class="checkmark"></span>
                                AMD
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="nvidia" class="brand-filter">
                                <span class="checkmark"></span>
                                NVIDIA
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="corsair" class="brand-filter">
                                <span class="checkmark"></span>
                                Corsair
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="samsung" class="brand-filter">
                                <span class="checkmark"></span>
                                Samsung
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="lg" class="brand-filter">
                                <span class="checkmark"></span>
                                LG
                            </label>
                        </div>
                    </div>

                    <!-- Rating Filter -->
                    <div class="filter-section">
                        <h4><i class="fas fa-star"></i> ƒê√°nh Gi√°</h4>
                        <div class="rating-filters">
                            <label class="rating-filter">
                                <input type="radio" name="rating" value="5">
                                <div class="stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                </div>
                                <span>5 sao</span>
                            </label>
                            <label class="rating-filter">
                                <input type="radio" name="rating" value="4">
                                <div class="stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                </div>
                                <span>4 sao tr·ªü l√™n</span>
                            </label>
                            <label class="rating-filter">
                                <input type="radio" name="rating" value="3">
                                <div class="stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    <i class="far fa-star"></i>
                                </div>
                                <span>3 sao tr·ªü l√™n</span>
                            </label>
                        </div>
                    </div>

                    <!-- Clear Filters -->
                    <div class="filter-actions">
                        <button class="clear-filters-btn" onclick="clearAllFilters()">
                            <i class="fas fa-refresh"></i>
                            X√≥a B·ªô L·ªçc
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="shop-main">
                    <!-- Toolbar -->
                    <div class="shop-toolbar">
                        <div class="toolbar-left">
                            <button class="filter-toggle" onclick="toggleFilters()">
                                <i class="fas fa-filter"></i>
                                B·ªô L·ªçc
                            </button>
                            <span class="result-count" id="resultCount">Hi·ªÉn th·ªã t·∫•t c·∫£ s·∫£n ph·∫©m</span>
                        </div>
                        <div class="toolbar-right">
                            <div class="sort-options">
                                <label>S·∫Øp x·∫øp:</label>
                                <select id="sortSelect">
                                    <option value="default">M·∫∑c ƒë·ªãnh</option>
                                    <option value="name-asc">T√™n A-Z</option>
                                    <option value="name-desc">T√™n Z-A</option>
                                    <option value="price-asc">Gi√° tƒÉng d·∫ßn</option>
                                    <option value="price-desc">Gi√° gi·∫£m d·∫ßn</option>
                                    <option value="rating-desc">ƒê√°nh gi√° cao nh·∫•t</option>
                                    <option value="newest">M·ªõi nh·∫•t</option>
                                </select>
                            </div>
                            <div class="view-options">
                                <button class="view-btn grid-view active" data-view="grid">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button class="view-btn list-view" data-view="list">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Products Grid -->
                    <div class="products-grid" id="productsGrid">
                        <!-- Products will be loaded here -->
                    </div>

                    <!-- Load More Button -->
                    <div class="load-more-section">
                        <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreProducts()">
                            <i class="fas fa-plus"></i>
                            Xem Th√™m S·∫£n Ph·∫©m
                        </button>
                    </div>

                    <!-- No Results -->
                    <div class="no-results" id="noResults" style="display: none;">
                        <div class="no-results-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h3>
                        <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t·ª´ kh√≥a t√¨m ki·∫øm</p>
                        <button class="clear-filters-btn" onclick="clearAllFilters()">
                            X√≥a B·ªô L·ªçc
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shopping Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> Gi·ªè H√†ng</h3>
            <button class="close-cart" onclick="toggleCart()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="empty-cart">
                <i class="fas fa-shopping-cart" style="font-size: 3rem; color: #ccc;"></i>
                <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <strong>T·ªïng c·ªông: <span id="cartTotal">0 VNƒê</span></strong>
            </div>
            <button class="checkout-btn" onclick="
                console.log('üõí Checkout button clicked - delegating to script.js'); 
                
                // Delegate to script.js for all cart operations
                if (typeof window.proceedToCheckout === 'function') {
                    window.proceedToCheckout();
                } else {
                    console.log('‚ö†Ô∏è script.js proceedToCheckout not ready, trying direct modal');
                    const modal = document.getElementById('checkoutModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        modal.classList.add('active');
                        console.log('‚úÖ Modal opened directly');
                    } else {
                        console.error('‚ùå Modal not found!');
                    }
                }
            " id="checkoutBtn">
                <i class="fas fa-credit-card"></i> THANH TO√ÅN
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> Thanh To√°n ƒê∆°n H√†ng</h3>
                <button class="close-modal" onclick="closeCheckoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="checkout-form">
                    <div class="form-section">
                        <h4><i class="fas fa-user"></i> Th√¥ng Tin Kh√°ch H√†ng</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>H·ªç v√† t√™n *</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group">
                                <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                                <input type="tel" id="customerPhone" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="customerEmail" required>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-map-marker-alt"></i> ƒê·ªãa Ch·ªâ Giao H√†ng</h4>
                        
                        <!-- Saved Addresses Section -->
                        <div class="saved-addresses" id="savedAddresses">
                            <div class="address-header">
                                <label>Ch·ªçn ƒë·ªãa ch·ªâ ƒë√£ l∆∞u:</label>
                                <button type="button" class="add-address-btn" onclick="toggleNewAddressForm()">
                                    <i class="fas fa-plus"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi
                                </button>
                            </div>
                            <div class="address-list" id="addressList">
                                <!-- Saved addresses will be loaded here -->
                                <div class="no-addresses" id="noAddresses">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <p>Ch∆∞a c√≥ ƒë·ªãa ch·ªâ ƒë√£ l∆∞u</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- New/Edit Address Form -->
                        <div class="new-address-form" id="newAddressForm" style="display: none;">
                            <div class="form-header">
                                <h5 id="addressFormTitle">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h5>
                                <button type="button" class="cancel-address-btn" onclick="cancelAddressForm()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label>ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
                                <textarea id="newShippingAddress" rows="3" required placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng XYZ"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Th√†nh ph·ªë *</label>
                                    <select id="newShippingCity" required>
                                        <option value="">Ch·ªçn th√†nh ph·ªë</option>
                                        <option value="hanoi">H√† N·ªôi</option>
                                        <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                                        <option value="danang">ƒê√† N·∫µng</option>
                                        <option value="haiphong">H·∫£i Ph√≤ng</option>
                                        <option value="cantho">C·∫ßn Th∆°</option>
                                        <option value="angiang">An Giang</option>
                                        <option value="bacgiang">B·∫Øc Giang</option>
                                        <option value="backan">B·∫Øc K·∫°n</option>
                                        <option value="baclieu">B·∫°c Li√™u</option>
                                        <option value="bacninh">B·∫Øc Ninh</option>
                                        <option value="baria">B√† R·ªãa - V≈©ng T√†u</option>
                                        <option value="bentre">B·∫øn Tre</option>
                                        <option value="binhdinh">B√¨nh ƒê·ªãnh</option>
                                        <option value="binhduong">B√¨nh D∆∞∆°ng</option>
                                        <option value="binhphuoc">B√¨nh Ph∆∞·ªõc</option>
                                        <option value="binhthuan">B√¨nh Thu·∫≠n</option>
                                        <option value="camau">C√† Mau</option>
                                        <option value="caobang">Cao B·∫±ng</option>
                                        <option value="daklak">ƒê·∫Øk L·∫Øk</option>
                                        <option value="daknong">ƒê·∫Øk N√¥ng</option>
                                        <option value="dienbien">ƒêi·ªán Bi√™n</option>
                                        <option value="dongnai">ƒê·ªìng Nai</option>
                                        <option value="dongthap">ƒê·ªìng Th√°p</option>
                                        <option value="gialai">Gia Lai</option>
                                        <option value="hagiang">H√† Giang</option>
                                        <option value="hanam">H√† Nam</option>
                                        <option value="hatinh">H√† Tƒ©nh</option>
                                        <option value="haiduong">H·∫£i D∆∞∆°ng</option>
                                        <option value="haugiang">H·∫≠u Giang</option>
                                        <option value="hoabinh">H√≤a B√¨nh</option>
                                        <option value="hungyen">H∆∞ng Y√™n</option>
                                        <option value="khanhhoa">Kh√°nh H√≤a</option>
                                        <option value="kiengiang">Ki√™n Giang</option>
                                        <option value="kontum">Kon Tum</option>
                                        <option value="laichau">Lai Ch√¢u</option>
                                        <option value="lamdong">L√¢m ƒê·ªìng</option>
                                        <option value="langson">L·∫°ng S∆°n</option>
                                        <option value="laocai">L√†o Cai</option>
                                        <option value="longan">Long An</option>
                                        <option value="namdinh">Nam ƒê·ªãnh</option>
                                        <option value="nghean">Ngh·ªá An</option>
                                        <option value="ninhbinh">Ninh B√¨nh</option>
                                        <option value="ninhthuan">Ninh Thu·∫≠n</option>
                                        <option value="phutho">Ph√∫ Th·ªç</option>
                                        <option value="phuyen">Ph√∫ Y√™n</option>
                                        <option value="quangbinh">Qu·∫£ng B√¨nh</option>
                                        <option value="quangnam">Qu·∫£ng Nam</option>
                                        <option value="quangngai">Qu·∫£ng Ng√£i</option>
                                        <option value="quangninh">Qu·∫£ng Ninh</option>
                                        <option value="quangtri">Qu·∫£ng Tr·ªã</option>
                                        <option value="soctrang">S√≥c TrƒÉng</option>
                                        <option value="sonla">S∆°n La</option>
                                        <option value="tayninh">T√¢y Ninh</option>
                                        <option value="thaibinh">Th√°i B√¨nh</option>
                                        <option value="thainguyen">Th√°i Nguy√™n</option>
                                        <option value="thanhhoa">Thanh H√≥a</option>
                                        <option value="thuathienhue">Th·ª´a Thi√™n Hu·∫ø</option>
                                        <option value="tiengiang">Ti·ªÅn Giang</option>
                                        <option value="travinh">Tr√† Vinh</option>
                                        <option value="tuyenquang">Tuy√™n Quang</option>
                                        <option value="vinhlong">Vƒ©nh Long</option>
                                        <option value="vinhphuc">Vƒ©nh Ph√∫c</option>
                                        <option value="yenbai">Y√™n B√°i</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Qu·∫≠n/Huy·ªán *</label>
                                    <input type="text" id="newShippingDistrict" required placeholder="V√≠ d·ª•: Qu·∫≠n 1, Huy·ªán C·ªß Chi">
                                </div>
                            </div>
                            
                            <div class="form-options">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="setAsDefault">
                                    ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                                </label>
                            </div>
                            
                            <div class="address-verification-info" style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                                <i class="fas fa-info-circle" style="color: #856404;"></i>
                                <span style="color: #856404; font-size: 14px; margin-left: 8px;">
                                    Vui l√≤ng x√°c th·ª±c ƒë·ªãa ch·ªâ tr√™n Google Maps tr∆∞·ªõc khi l∆∞u ƒë·ªÉ ƒë·∫£m b·∫£o giao h√†ng ch√≠nh x√°c.
                                </span>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="verify-address-btn" onclick="verifyAddressWithGoogleMaps()" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
                                    <i class="fas fa-map-marker-alt"></i> X√°c th·ª±c ƒë·ªãa ch·ªâ tr√™n Google Maps
                                </button>
                                <button type="button" class="save-address-btn" onclick="saveNewAddress()" style="display: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-save"></i> L∆∞u ƒë·ªãa ch·ªâ
                                </button>
                                <button type="button" class="cancel-btn" onclick="cancelAddressForm()">
                                    H·ªßy
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selected Address Display -->
                        <div class="selected-address" id="selectedAddressDisplay" style="display: none;">
                            <div class="address-info">
                                <h6>ƒê·ªãa ch·ªâ giao h√†ng:</h6>
                                <p id="selectedAddressText"></p>
                                <button type="button" class="change-address-btn" onclick="changeSelectedAddress()">
                                    <i class="fas fa-edit"></i> Thay ƒë·ªïi
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4><i class="fas fa-credit-card"></i> Ph∆∞∆°ng Th·ª©c Thanh To√°n</h4>
                        <div class="payment-methods">
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="cod" checked>
                                <span class="payment-icon"><i class="fas fa-money-bill-wave"></i></span>
                                <span>Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="banking">
                                <span class="payment-icon"><i class="fas fa-university"></i></span>
                                <span>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="momo">
                                <span class="payment-icon"><i class="fas fa-mobile-alt"></i></span>
                                <span>V√≠ MoMo</span>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="vnpay">
                                <span class="payment-icon"><i class="fas fa-credit-card"></i></span>
                                <span>VNPay - Thanh to√°n online</span>
                            </label>
                        </div>
                    </div>

                    <!-- Discount Code Section -->
                    <div class="form-section">
                        <h4><i class="fas fa-tag"></i> M√£ Gi·∫£m Gi√°</h4>
                        
                        <!-- Available Discount Codes -->
                        <div class="discount-options">
                            <div class="discount-codes-list" id="discountCodesList">
                                <div class="no-coupons-message">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>ƒêang t·∫£i m√£ gi·∫£m gi√°...</p>
                                </div>
                            </div>
                            
                            <!-- Manual Code Entry -->
                            <div class="manual-code-entry">
                                <div class="code-input-group">
                                    <input type="text" id="manualDiscountCode" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" maxlength="20">
                                    <button type="button" class="apply-code-btn" onclick="applyManualDiscountCode()">
                                        <i class="fas fa-check"></i> √Åp d·ª•ng
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Applied Discount Display -->
                            <div class="applied-discount" id="appliedDiscount" style="display: none;">
                                <div class="applied-discount-info">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="appliedDiscountText">ƒê√£ √°p d·ª•ng m√£: 12345 (-10%)</span>
                                </div>
                                <button type="button" class="remove-discount-btn" onclick="removeDiscountCode()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Coin Usage Section -->
                    <div class="form-section" id="coinUsageSection" style="display: block;">
                        <h4><i class="fas fa-coins"></i> S·ª≠ D·ª•ng Coin</h4>
                        
                        <div class="coin-usage-container">
                            <div class="coin-balance-display-checkout">
                                <div class="coin-balance-info-checkout">
                                    <span class="coin-label-checkout">S·ªë d∆∞ hi·ªán t·∫°i:</span>
                                    <span class="coin-balance-value-checkout">
                                        <span id="checkoutCoinBalance">0</span> coin
                                        <span class="coin-vnd-value-checkout">(<span id="checkoutCoinValue">0</span> VNƒê)</span>
                                    </span>
                                </div>
                                <button type="button" class="use-all-coin-btn" onclick="useAllCoin()" id="useAllCoinBtn" style="display: none;">
                                    <i class="fas fa-check-circle"></i> S·ª≠ d·ª•ng t·∫•t c·∫£
                                </button>
                            </div>

                            <div class="coin-input-group-checkout" id="coinInputGroup" style="display: none;">
                                <label for="coinToUse">Nh·∫≠p s·ªë coin mu·ªën s·ª≠ d·ª•ng:</label>
                                <div class="coin-input-wrapper-checkout">
                                    <input 
                                        type="number" 
                                        id="coinToUse" 
                                        min="0" 
                                        max="0"
                                        value="0"
                                        placeholder="Nh·∫≠p s·ªë coin"
                                        oninput="updateCoinUsage(this.value)"
                                    >
                                    <span class="coin-unit-checkout">coin</span>
                                </div>
                                <div class="coin-slider-container-checkout">
                                    <input 
                                        type="range" 
                                        id="coinSlider"
                                        min="0" 
                                        max="0"
                                        value="0"
                                        step="1000"
                                        oninput="updateCoinUsage(this.value)"
                                    >
                                </div>
                                <div class="coin-usage-info-checkout">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Gi·∫£m gi√°: <strong id="coinDiscountDisplay">0 VNƒê</strong></span>
                                </div>
                            </div>
                            
                            <div class="no-coin-message-checkout" id="noCoinMessage">
                                <i class="fas fa-info-circle"></i>
                                <span>B·∫°n ch∆∞a c√≥ coin. Ho√†n th√†nh ƒë∆°n h√†ng ƒë·ªÉ nh·∫≠n 10% gi√° tr·ªã ƒë∆°n h√†ng th√†nh coin!</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="order-summary">
                    <h4><i class="fas fa-receipt"></i> T√≥m T·∫Øt ƒê∆°n H√†ng</h4>
                    <div class="order-items" id="orderSummaryItems"></div>
                    <div class="order-totals">
                        <div class="total-line">
                            <span>T·∫°m t√≠nh:</span>
                            <span id="subtotalAmount">0 VNƒê</span>
                        </div>
                        <div class="total-line discount-line" id="discountLine" style="display: none;">
                            <span>Gi·∫£m gi√°:</span>
                            <span class="discount-amount" id="discountAmount">-0 VNƒê</span>
                        </div>
                        <div class="total-line coin-discount-line" id="coinDiscountLine" style="display: none;">
                            <span>Gi·∫£m t·ª´ Coin:</span>
                            <span class="coin-discount-amount" id="coinDiscountAmountInTotal">-0 VNƒê</span>
                        </div>
                        <div class="total-line">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <span>50.000 VNƒê</span>
                        </div>
                        <div class="total-line total">
                            <span>T·ªïng c·ªông:</span>
                            <span id="finalTotal">0 VNƒê</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCheckoutModal()">H·ªßy</button>
                <button class="btn-primary" onclick="completeOrder()">Ho√†n T·∫•t ƒê∆°n H√†ng</button>
            </div>
        </div>
    </div>

    <!-- OTP Verification Modal -->
    <div class="modal-overlay" id="otpModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> X√°c Th·ª±c Email</h3>
                <button class="close-modal" onclick="closeOtpModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="otp-form">
                    <div class="otp-step" id="otpStep1">
                        <h4>G·ª≠i M√£ X√°c Th·ª±c</h4>
                        <p>Vui l√≤ng nh·∫≠p email ƒë·ªÉ nh·∫≠n m√£ OTP x√°c th·ª±c cho ƒë∆°n h√†ng:</p>
                        <div class="form-group">
                            <label for="otpEmail">Email:</label>
                            <input type="email" id="otpEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
                        </div>
                        <div class="form-actions">
                            <button class="btn-secondary" onclick="closeOtpModal()">H·ªßy</button>
                            <button class="btn-primary" onclick="sendOtpCode()" id="sendOtpBtn">
                                <i class="fas fa-paper-plane"></i> G·ª≠i M√£ OTP
                            </button>
                        </div>
                    </div>
                    
                    <div class="otp-step" id="otpStep2" style="display: none;">
                        <h4>Nh·∫≠p M√£ X√°c Th·ª±c</h4>
                        <p>M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email: <strong id="otpEmailDisplay"></strong></p>
                        <div class="form-group">
                            <label for="otpCode">M√£ OTP (6 s·ªë):</label>
                            <input type="text" id="otpCode" placeholder="Nh·∫≠p m√£ OTP" maxlength="6" required>
                        </div>
                        <div class="otp-timer">
                            <p>M√£ OTP s·∫Ω h·∫øt h·∫°n sau: <span id="otpTimer">10:00</span></p>
                        </div>
                        <div class="form-actions">
                            <button class="btn-secondary" onclick="backToOtpStep1()">Quay L·∫°i</button>
                            <button class="btn-primary" onclick="verifyOtpCode()" id="verifyOtpBtn">
                                <i class="fas fa-check"></i> X√°c Th·ª±c
                            </button>
                        </div>
                        <div class="resend-otp" style="margin-top: 15px; text-align: center;">
                            <button class="btn-link" onclick="resendOtpCode()" id="resendOtpBtn">
                                G·ª≠i l·∫°i m√£ OTP
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Variant Selection Modal -->
    <div class="modal-overlay" id="variantSelectionModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-layer-group"></i> Ch·ªçn S·∫£n Ph·∫©m</h3>
                <button class="close-modal" onclick="closeVariantModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="variant-selection">
                    <div class="main-product-info">
                        <p class="variant-info-text">
                            <i class="fas fa-info-circle"></i>
                            S·∫£n ph·∫©m n√†y c√≥ nhi·ªÅu bi·∫øn th·ªÉ. Vui l√≤ng ch·ªçn s·∫£n ph·∫©m b·∫°n mu·ªën th√™m v√†o gi·ªè h√†ng:
                        </p>
                    </div>
                    
                    <div class="variant-options" id="variantOptions">
                        <!-- Variant options will be populated here -->
                    </div>
                    
                    <div class="variant-actions">
                        <button class="btn-secondary" onclick="closeVariantModal()">
                            <i class="fas fa-times"></i> H·ªßy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>V·ªÄ CH√öNG T√îI</h4>
                <ul>
                    <li><a href="#">Gi·ªõi thi·ªáu</a></li>
                    <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
                    <li><a href="#">Tin t·ª©c</a></li>
                    <li><a href="#">Li√™n h·ªá</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>H·ªñ TR·ª¢ KH√ÅCH H√ÄNG</h4>
                <ul>
                    <li><a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
                    <li><a href="#">Ch√≠nh s√°ch b·∫£o h√†nh</a></li>
                    <li><a href="#">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</a></li>
                    <li><a href="#">FAQ</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>CH√çNH S√ÅCH</h4>
                <ul>
                    <li><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></li>
                    <li><a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
                    <li><a href="#">Ch√≠nh s√°ch v·∫≠n chuy·ªÉn</a></li>
                    <li><a href="#">Ch√≠nh s√°ch thanh to√°n</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>T√ÄI KHO·∫¢N C·ª¶A T√îI</h4>
                <ul>
                    <li><a href="#">ƒêƒÉng nh·∫≠p</a></li>
                    <li><a href="#">ƒêƒÉng k√Ω</a></li>
                    <li><a href="#">Theo d√µi ƒë∆°n h√†ng</a></li>
                    <li><a href="#">L·ªãch s·ª≠ mua h√†ng</a></li>
                </ul>
            </div>
            <div class="footer-social">
                <h4>THEO D√ïI CH√öNG T√îI</h4>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
                <div class="contact-info">
                    <p><i class="fas fa-phone"></i> Hotline: 1800-1234</p>
                    <p><i class="fas fa-envelope"></i> info@techhaven.vn</p>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2024 TECH HAVEN. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u</p>
        </div>
    </footer>

    <!-- Login Modal - styled like index.ejs -->
    <div class="login-modal-overlay" id="loginModal">
        <div class="login-modal">
            <div class="login-modal-header">
                <h3 id="modalTitle">ƒêƒÉng Nh·∫≠p</h3>
                <button class="close-login-modal" onclick="closeLoginModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="login-modal-content">
                <!-- Login Form -->
                <div class="login-form" id="loginForm" style="display: block;">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">M·∫≠t kh·∫©u</label>
                        <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="form-options">
                        <label class="remember-me">
                            <input type="checkbox" id="rememberMe">
                            <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
                        </label>
                        <a href="#" class="forgot-password" onclick="handleForgotPassword(); return false;">Qu√™n m·∫≠t kh·∫©u?</a>
                    </div>
                    <button class="login-btn" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p
                    </button>
                </div>

                <!-- Register Form -->
                <div class="register-form" id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerName">H·ªç v√† t√™n</label>
                        <input type="text" id="registerName" placeholder="Nh·∫≠p h·ªç v√† t√™n" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPhone">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="registerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">M·∫≠t kh·∫©u</label>
                        <input type="password" id="registerPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <input type="password" id="confirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="form-options">
                        <label class="agree-terms">
                            <input type="checkbox" id="agreeTerms" required>
                            <span>T√¥i ƒë·ªìng √Ω v·ªõi <a href="#">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a></span>
                        </label>
                    </div>
                    <button class="register-btn" onclick="handleRegister()">
                        <i class="fas fa-user-plus"></i> ƒêƒÉng K√Ω
                    </button>
                </div>

                <!-- Social Login -->
                <div class="social-login">
                    <div class="divider">
                        <span>ho·∫∑c</span>
                    </div>
                    <button onclick="signInWithGoogle()" class="google-signin-btn" type="button">
                        <i class="fab fa-google"></i>
                        ƒêƒÉng nh·∫≠p v·ªõi Google
                    </button>
                    
                    <!-- Backup direct link for testing -->
                    <div style="margin-top: 10px; text-align: center;">
                        <button onclick="signInWithGoogle()" style="color: #4285f4; font-size: 14px; background: none; border: none; cursor: pointer; text-decoration: underline;">
                            üîó Firebase Auth (n·∫øu n√∫t kh√¥ng ho·∫°t ƒë·ªông)
                        </button>
                    </div>
                </div>

                <!-- Toggle between Login/Register -->
                <div class="modal-footer">
                    <p id="toggleText">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" onclick="toggleAuthMode()">ƒêƒÉng k√Ω ngay</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Address Modal - For New Users -->
    <div class="welcome-address-modal-overlay" id="welcomeAddressModal">
        <div class="welcome-address-modal">
            <div class="welcome-modal-header">
                <div class="welcome-icon">
                    <i class="fas fa-home"></i>
                </div>
                <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi TECH HAVEN! üéâ</h3>
                <p class="welcome-subtitle">ƒê·ªÉ tr·∫£i nghi·ªám mua s·∫Øm t·ªët nh·∫•t, vui l√≤ng th√™m ƒë·ªãa ch·ªâ giao h√†ng c·ªßa b·∫°n</p>
            </div>
            
            <div class="welcome-modal-content">
                <div class="address-form-welcome">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
                            <input type="text" id="welcomeAddress" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>T·ªânh/Th√†nh ph·ªë *</label>
                            <select id="welcomeCity" required>
                                <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
                                <option value="hanoi">H√† N·ªôi</option>
                                <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                                <option value="danang">ƒê√† N·∫µng</option>
                                <option value="haiphong">H·∫£i Ph√≤ng</option>
                                <option value="cantho">C·∫ßn Th∆°</option>
                                <option value="angiang">An Giang</option>
                                <option value="bacgiang">B·∫Øc Giang</option>
                                <option value="backan">B·∫Øc K·∫°n</option>
                                <option value="baclieu">B·∫°c Li√™u</option>
                                <option value="bacninh">B·∫Øc Ninh</option>
                                <option value="baria">B√† R·ªãa - V≈©ng T√†u</option>
                                <option value="bentre">B·∫øn Tre</option>
                                <option value="binhdinh">B√¨nh ƒê·ªãnh</option>
                                <option value="binhduong">B√¨nh D∆∞∆°ng</option>
                                <option value="binhphuoc">B√¨nh Ph∆∞·ªõc</option>
                                <option value="binhthuan">B√¨nh Thu·∫≠n</option>
                                <option value="camau">C√† Mau</option>
                                <option value="caobang">Cao B·∫±ng</option>
                                <option value="daklak">ƒê·∫Øk L·∫Øk</option>
                                <option value="daknong">ƒê·∫Øk N√¥ng</option>
                                <option value="dienbien">ƒêi·ªán Bi√™n</option>
                                <option value="dongnai">ƒê·ªìng Nai</option>
                                <option value="dongthap">ƒê·ªìng Th√°p</option>
                                <option value="gialai">Gia Lai</option>
                                <option value="hagiang">H√† Giang</option>
                                <option value="hanam">H√† Nam</option>
                                <option value="hatinh">H√† Tƒ©nh</option>
                                <option value="haiduong">H·∫£i D∆∞∆°ng</option>
                                <option value="haugiang">H·∫≠u Giang</option>
                                <option value="hoabinh">H√≤a B√¨nh</option>
                                <option value="hungyen">H∆∞ng Y√™n</option>
                                <option value="khanhhoa">Kh√°nh H√≤a</option>
                                <option value="kiengiang">Ki√™n Giang</option>
                                <option value="kontum">Kon Tum</option>
                                <option value="laichau">Lai Ch√¢u</option>
                                <option value="lamdong">L√¢m ƒê·ªìng</option>
                                <option value="langson">L·∫°ng S∆°n</option>
                                <option value="laocai">L√†o Cai</option>
                                <option value="longan">Long An</option>
                                <option value="namdinh">Nam ƒê·ªãnh</option>
                                <option value="nghean">Ngh·ªá An</option>
                                <option value="ninhbinh">Ninh B√¨nh</option>
                                <option value="ninhthuan">Ninh Thu·∫≠n</option>
                                <option value="phutho">Ph√∫ Th·ªç</option>
                                <option value="phuyen">Ph√∫ Y√™n</option>
                                <option value="quangbinh">Qu·∫£ng B√¨nh</option>
                                <option value="quangnam">Qu·∫£ng Nam</option>
                                <option value="quangngai">Qu·∫£ng Ng√£i</option>
                                <option value="quangninh">Qu·∫£ng Ninh</option>
                                <option value="quangtri">Qu·∫£ng Tr·ªã</option>
                                <option value="soctrang">S√≥c TrƒÉng</option>
                                <option value="sonla">S∆°n La</option>
                                <option value="tayninh">T√¢y Ninh</option>
                                <option value="thaibinh">Th√°i B√¨nh</option>
                                <option value="thainguyen">Th√°i Nguy√™n</option>
                                <option value="thanhhoa">Thanh H√≥a</option>
                                <option value="thuathienhue">Th·ª´a Thi√™n Hu·∫ø</option>
                                <option value="tiengiang">Ti·ªÅn Giang</option>
                                <option value="travinh">Tr√† Vinh</option>
                                <option value="tuyenquang">Tuy√™n Quang</option>
                                <option value="vinhlong">Vƒ©nh Long</option>
                                <option value="vinhphuc">Vƒ©nh Ph√∫c</option>
                                <option value="yenbai">Y√™n B√°i</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Qu·∫≠n/Huy·ªán *</label>
                            <input type="text" id="welcomeDistrict" placeholder="V√≠ d·ª•: Qu·∫≠n 1, Huy·ªán C·ªß Chi" required>
                        </div>
                    </div>
                    
                    <div class="form-options">
                        <label class="checkbox-option">
                            <input type="checkbox" id="welcomeSetDefault" checked>
                            ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                        </label>
                    </div>
                    
                    <!-- Coordinates Display (hidden by default) -->
                    <div class="welcome-coordinates-display" style="display: none; margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="display: flex; align-items: center; gap: 8px; color: #2e7d32; font-weight: 500;">
                            <i class="fas fa-check-circle"></i>
                            <span>ƒê·ªãa ch·ªâ ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: #555;">
                            <strong>T·ªça ƒë·ªô:</strong>
                            <span class="welcome-coordinates-text"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="welcome-modal-footer">
                <button class="btn-skip" onclick="skipWelcomeAddress()">
                    <i class="fas fa-forward"></i> B·ªè qua
                </button>
                <button class="btn-verify-welcome-address verify-address-btn" onclick="verifyWelcomeAddress()" style="background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.3s ease;">
                    <i class="fas fa-map-marker-alt"></i> X√°c th·ª±c ƒë·ªãa ch·ªâ
                </button>
                <button class="btn-save-address" onclick="saveWelcomeAddress()" style="display: none;">
                    <i class="fas fa-check"></i> L∆∞u ƒë·ªãa ch·ªâ
                </button>
            </div>
        </div>
    </div>

    <!-- User Profile Panel - Comprehensive version from index.ejs -->
    <div class="user-profile-panel" id="userProfilePanel">
        <div class="user-profile-container">
            <div class="user-profile-header">
                <div class="user-avatar">
                    <img id="profileAvatar" src="" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.3);" width="40" height="40" loading="lazy" decoding="async">
                    <div class="avatar-placeholder" style="display: none; width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; border: 3px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="user-info">
                    <h3 id="profileName">Loading...</h3>
                    <p id="profileEmail">Loading...</p>
                    <span class="user-badge">
                        <i class="fas fa-user"></i> ƒê√£ x√°c th·ª±c
                    </span>
                    <!-- Membership Badge -->
                    <div class="membership-badge" id="membershipBadge" style="display: none; margin-top: 8px;">
                        <span class="membership-tier" id="membershipTier">
                            <span id="membershipIcon">‚≠ê</span>
                            <span id="membershipName">Ti√™u Chu·∫©n</span>
                        </span>
                        <span class="membership-points" id="membershipPoints">0 ƒëi·ªÉm</span>
                    </div>
                </div>
                <button class="close-profile-btn" onclick="closeUserProfile()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="user-profile-content">
                <!-- Membership Level Section -->
                <div class="profile-section" id="membershipSection" style="display: none;">
                    <h4><i class="fas fa-trophy"></i> H·∫°ng Th√†nh Vi√™n</h4>
                    <div class="membership-info">
                        <div class="membership-current">
                            <div class="membership-tier-display">
                                <span class="tier-icon" id="tierIcon">‚≠ê</span>
                                <div class="tier-details">
                                    <span class="tier-name" id="tierName">Ti√™u Chu·∫©n</span>
                                    <span class="tier-points" id="tierPoints">0 ƒëi·ªÉm t√≠ch l≈©y</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coin Balance Display -->
                        <div class="coin-balance-section">
                            <div class="coin-balance-card">
                                <div class="coin-icon">ü™ô</div>
                                <div class="coin-details">
                                    <div class="coin-label">S·ªë d∆∞ Coin</div>
                                    <div class="coin-amount">
                                        <span id="coinBalance" data-coin-balance>0</span> coin
                                    </div>
                                    <div class="coin-value-info">
                                        Tr·ªã gi√°: <span id="coinValue" data-coin-value>0</span> VNƒê
                                    </div>
                                </div>
                            </div>
                            <div class="coin-info-note">
                                <i class="fas fa-info-circle"></i>
                                Nh·∫≠n 10% gi√° tr·ªã ƒë∆°n h√†ng khi ho√†n th√†nh. S·ª≠ d·ª•ng ƒë·ªÉ thanh to√°n (1 coin = 1 VNƒê)
                            </div>
                        </div>
                        
                        <div class="membership-progress" id="membershipProgress" style="display: none;">
                            <div class="progress-info">
                                <span>C√≤n <strong id="pointsToNext">0</strong> ƒëi·ªÉm ƒë·ªÉ ƒë·∫°t h·∫°ng <strong id="nextTierName">B·∫°c</strong></span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="membership-tiers-legend">
                            <div class="tier-item">
                                <span class="tier-badge standard">‚≠ê Ti√™u Chu·∫©n</span>
                                <span class="tier-requirement">0 ƒëi·ªÉm</span>
                            </div>
                            <div class="tier-item">
                                <span class="tier-badge silver">ü•à B·∫°c</span>
                                <span class="tier-requirement">500,000 ƒëi·ªÉm</span>
                            </div>
                            <div class="tier-item">
                                <span class="tier-badge gold">ü•á V√†ng</span>
                                <span class="tier-requirement">1,000,000 ƒëi·ªÉm</span>
                            </div>
                            <div class="tier-item">
                                <span class="tier-badge diamond">üíé Kim C∆∞∆°ng</span>
                                <span class="tier-requirement">2,000,000 ƒëi·ªÉm</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4><i class="fas fa-user-edit"></i> Th√¥ng Tin C√° Nh√¢n</h4>
                    <div class="profile-info">
                        <div class="info-row">
                            <label>H·ªç v√† t√™n:</label>
                            <span id="profileInfoName">Loading...</span>
                        </div>
                        <div class="info-row">
                            <label>Email:</label>
                            <span id="profileInfoEmail">Loading...</span>
                        </div>
                        <div class="info-row">
                            <label>Lo·∫°i t√†i kho·∫£n:</label>
                            <span>
                                <i class="fab fa-google text-danger"></i> Google OAuth
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Ng√†y tham gia:</label>
                            <span id="joinDate">Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4><i class="fas fa-shopping-bag"></i> ƒê∆°n H√†ng G·∫ßn ƒê√¢y</h4>
                    <div class="recent-orders" id="recentOrders">
                        <div class="loading-orders">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i ƒë∆°n h√†ng...
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4><i class="fas fa-heart"></i> S·∫£n Ph·∫©m Y√™u Th√≠ch</h4>
                    <div class="favorite-products" id="favoriteProducts">
                        <div class="loading-favorites">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i s·∫£n ph·∫©m y√™u th√≠ch...
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4><i class="fas fa-history"></i> S·∫£n Ph·∫©m ƒê√£ Xem</h4>
                    <div class="recent-products" id="recentProducts">
                        <div class="loading-recent">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i s·∫£n ph·∫©m ƒë√£ xem...
                        </div>
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="btn btn-primary" onclick="editUserProfile()">
                        <i class="fas fa-edit"></i> Ch·ªânh S·ª≠a H·ªì S∆°
                    </button>
                    <button class="btn btn-secondary" onclick="viewOrderHistory()">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ ƒê∆°n H√†ng
                    </button>
                    <button class="btn btn-danger" onclick="handleShopLogout()">
                        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main JavaScript -->
    <script>
        // L·∫•y user data t·ª´ server
        const userDataElement = document.getElementById('user-data');
        const userData = userDataElement ? JSON.parse(userDataElement.textContent) : null;
        window.currentUser = userData;
        
        if (window.currentUser) {
            console.log('‚úÖ Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:', window.currentUser);
        } else {
            console.log('üë§ Ch∆∞a ƒëƒÉng nh·∫≠p');
        }
        
        // C·∫≠p nh·∫≠t giao di·ªán d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded - updating UI based on auth status');
            // Wait for other scripts to load before updating UI
            setTimeout(() => {
                updateUIBasedOnAuthStatus();
            }, 100);
        });
        
        function showErrorMessages() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const message = urlParams.get('message');
            
            if (error) {
                let errorMessage = 'C√≥ l·ªói x·∫£y ra';
                switch(error) {
                    case 'auth':
                        errorMessage = message || 'L·ªói x√°c th·ª±c';
                        break;
                    case 'verification':
                        errorMessage = message || 'L·ªói x√°c minh email';
                        break;
                    case 'user_not_found':
                        errorMessage = 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng';
                        break;
                    default:
                        errorMessage = decodeURIComponent(message || error);
                }
                
                if (window.showNotification) {
                    window.showNotification(errorMessage, 'error');
                } else {
                    console.error('Error:', errorMessage);
                }
                
                // Clean URL
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }
        
        async function updateUIBasedOnAuthStatus() {
            console.log('üîÑ Shop: Updating UI based on auth status, currentUser:', window.currentUser);
            
            // Update SmartCart authentication status
            if (window.smartCart && window.currentUser) {
                console.log('üîÑ Shop: Updating SmartCart with user object');
                await window.smartCart.setAuthStatus(true, window.currentUser);
            }
        }
        
        // Make functions globally available
        window.showErrorMessages = showErrorMessages;
        window.updateUIBasedOnAuthStatus = updateUIBasedOnAuthStatus;
        
        // Debug function for mobile cart testing
        window.testMobileCart = function() {
            console.log('üß™ Testing mobile cart functionality...');
            console.log('üîç Current user:', window.currentUser ? window.currentUser.uid : 'guest');
            console.log('üîç Cart elements:', {
                sidebar: !!document.getElementById('cartSidebar'),
                overlay: !!document.getElementById('cartOverlay'),
                mobileLink: !!document.getElementById('mobileCartLink'),
                mobileCount: !!document.getElementById('mobileCartCount')
            });
            
            const cartSidebar = document.getElementById('cartSidebar');
            const cartOverlay = document.getElementById('cartOverlay');
            
            if (cartSidebar && cartOverlay) {
                console.log('üîç Current cart classes:', {
                    sidebarClasses: cartSidebar.className,
                    overlayClasses: cartOverlay.className,
                    sidebarStyles: {
                        right: getComputedStyle(cartSidebar).right,
                        width: getComputedStyle(cartSidebar).width,
                        zIndex: getComputedStyle(cartSidebar).zIndex,
                        display: getComputedStyle(cartSidebar).display
                    }
                });
                
                // Test toggle
                console.log('üß™ Testing toggleCart...');
                if (typeof window.toggleCart === 'function') {
                    toggleCart();
                } else {
                    console.error('‚ùå toggleCart function not available');
                }
            } else {
                console.error('‚ùå Cart elements not found');
            }
        };

        // =====================================
        // FAVORITE PRODUCTS LOADING FUNCTIONS (from index.ejs)
        // =====================================
        
        // Load favorite products for user profile
        async function loadFavoriteProducts() {
            console.log('üíñ Loading favorite products for user profile...');
            
            const favoriteProductsContainer = document.getElementById('favoriteProducts');
            if (!favoriteProductsContainer || !window.currentUser) {
                console.log('‚ùå No favorite products container or user found');
                return;
            }

            try {
                // Show loading state
                favoriteProductsContainer.innerHTML = `
                    <div class="loading-favorites">
                        <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i s·∫£n ph·∫©m y√™u th√≠ch...
                    </div>
                `;

                let favoriteItems = [];
                
                // Try to get wishlist data from Firebase directly
                if (window.firebase && window.firebase.firestore && window.currentUser) {
                    console.log('üîç Loading wishlist directly from Firebase for user:', window.currentUser.uid);
                    
                    const db = window.firebase.firestore();
                    const userId = window.currentUser.uid;
                    
                    const wishlistSnapshot = await db.collection('wishlists')
                        .where('userId', '==', userId)
                        .get();
                    
                    wishlistSnapshot.forEach(doc => {
                        const item = doc.data();
                        favoriteItems.push({
                            id: doc.id,
                            firebaseDocId: doc.id,
                            productId: item.productId,
                            name: item.name || item.productName,
                            price: item.price || item.productPrice,
                            image: item.image || item.productImage,
                            userId: item.userId,
                            createdAt: item.createdAt
                        });
                    });
                    
                    console.log('üìã Loaded favorite items from Firebase:', favoriteItems.length);
                } else {
                    // Fallback: Get from global variable if available
                    if (window.wishlistItems && Array.isArray(window.wishlistItems)) {
                        favoriteItems = window.wishlistItems;
                        console.log('üìã Used global wishlistItems:', favoriteItems.length);
                    } else {
                        console.log('‚ö†Ô∏è No Firebase or global wishlist data available');
                    }
                }

                if (favoriteItems.length === 0) {
                    favoriteProductsContainer.className = 'favorite-products';
                    favoriteProductsContainer.innerHTML = `
                        <div class="empty-favorites">
                            <i class="far fa-heart" style="font-size: 2rem; color: #e5e7eb; margin-bottom: 1rem;"></i>
                            <p style="color: #6b7280; margin: 0;">Ch∆∞a c√≥ s·∫£n ph·∫©m y√™u th√≠ch n√†o</p>
                            <p style="color: #9ca3af; font-size: 0.875rem; margin: 0.5rem 0 0 0;">Th√™m s·∫£n ph·∫©m v√†o danh s√°ch y√™u th√≠ch ƒë·ªÉ xem ·ªü ƒë√¢y</p>
                        </div>
                    `;
                    return;
                }
                
                // Add class for styling when there are favorites
                favoriteProductsContainer.className = 'favorite-products has-favorites';
                
                // Display favorite products
                const favoritesHtml = favoriteItems.slice(0, 6).map(item => `
                    <div class="favorite-item" data-product-id="${item.productId}">
                        <div class="favorite-image">
                            <img src="${item.image || '/images/default-product.png'}" alt="${item.name}" loading="lazy" width="800" height="600" decoding="async">
                        </div>
                        <div class="favorite-info">
                            <h5>${item.name}</h5>
                            <p class="favorite-price">${item.price}</p>
                            <div class="favorite-actions">
                                <button class="btn btn-sm btn-primary" onclick="addFavoriteToCart('${item.productId}', '${item.name}', '${item.price}', '${item.image}')">
                                    <i class="fas fa-shopping-cart"></i> Th√™m v√†o gi·ªè
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFavoriteFromProfile('${item.productId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                favoriteProductsContainer.innerHTML = `
                    <div class="favorites-grid">
                        ${favoritesHtml}
                    </div>
                    ${favoriteItems.length > 6 ? `
                        <div class="favorites-more">
                            <button class="btn btn-outline-primary btn-sm" onclick="showAllFavorites()">
                                <i class="fas fa-heart"></i> Xem t·∫•t c·∫£ (${favoriteItems.length})
                            </button>
                        </div>
                    ` : ''}
                `;
                
                console.log('‚úÖ Favorite products loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading favorite products:', error);
                favoriteProductsContainer.innerHTML = `
                    <div class="error-favorites">
                        <i class="fas fa-exclamation-circle" style="color: #ef4444; margin-bottom: 0.5rem;"></i>
                        <p style="color: #ef4444; margin: 0; font-size: 0.875rem;">C√≥ l·ªói khi t·∫£i s·∫£n ph·∫©m y√™u th√≠ch</p>
                    </div>
                `;
            }
        }

        // Add favorite product to cart
        async function addFavoriteToCart(productId, productName, productPrice, productImage) {
            console.log('üõí Adding favorite to cart:', productName);
            
            if (typeof window.addToCart === 'function') {
                await window.addToCart(productName, productPrice, productId, productImage, 1);
            } else {
                console.warn('‚ö†Ô∏è addToCart function not available');
            }
        }

        // Remove favorite from profile
        async function removeFavoriteFromProfile(productId) {
            console.log('üíî Removing favorite from profile:', productId);
            
            if (typeof window.removeFromWishlist === 'function') {
                await window.removeFromWishlist(productId);
                // Reload favorites after removal
                setTimeout(() => {
                    loadFavoriteProducts();
                }, 500);
            } else {
                console.warn('‚ö†Ô∏è removeFromWishlist function not available');
            }
        }

        // Load Recently Viewed Products
        async function loadRecentProducts() {
            console.log('üëÅÔ∏è Loading recently viewed products for user profile...');
            
            const recentProductsContainer = document.getElementById('recentProducts');
            if (!recentProductsContainer || !window.currentUser) {
                console.log('‚ùå No recent products container or user found');
                return;
            }

            try {
                // Show loading state
                recentProductsContainer.innerHTML = `
                    <div class="loading-recent">
                        <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i s·∫£n ph·∫©m ƒë√£ xem...
                    </div>
                `;

                // Get Firebase ID token for authentication
                let idToken = null;
                if (window.firebaseCompatAuth && window.firebaseCompatAuth.currentUser) {
                    idToken = await window.firebaseCompatAuth.currentUser.getIdToken();
                    console.log('üîë Got Firebase token for recent products API');
                } else if (window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
                    idToken = await window.firebase.auth().currentUser.getIdToken();
                    console.log('üîë Got Firebase token (v8 compat) for recent products API');
                } else {
                    // Try to get stored token for manual users (fallback)
                    idToken = localStorage.getItem('firebaseIdToken');
                    if (idToken) {
                        console.log('üîë Got Firebase token from localStorage for manual user (recent products)');
                    }
                }

                if (!idToken) {
                    console.warn('‚ö†Ô∏è No Firebase token available, cannot load recent products');
                    throw new Error('User not authenticated');
                }

                console.log('üì° Fetching recent products from API...');
                const response = await fetch('/api/user/recent-products', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì¶ Recent products API response:', data);

                if (!data.success || !data.products || data.products.length === 0) {
                    recentProductsContainer.className = 'recent-products';
                    recentProductsContainer.innerHTML = `
                        <div class="empty-recent">
                            <i class="far fa-eye" style="font-size: 2rem; color: #e5e7eb; margin-bottom: 1rem;"></i>
                            <p style="color: #6b7280; margin: 0;">Ch∆∞a c√≥ s·∫£n ph·∫©m ƒë√£ xem</p>
                            <p style="color: #9ca3af; font-size: 0.875rem; margin: 0.5rem 0 0 0;">Xem s·∫£n ph·∫©m ƒë·ªÉ ch√∫ng xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
                        </div>
                    `;
                    return;
                }

                const recentProducts = data.products;
                
                // Add class for styling when there are recent products
                recentProductsContainer.className = 'recent-products has-recent';
                
                // Display recent products
                const recentHtml = recentProducts.slice(0, 6).map(product => `
                    <div class="recent-item" data-product-id="${product.id}">
                        <div class="recent-image">
                            <img src="${product.image || product.imageUrl || '/images/default-product.png'}" alt="${product.name}" loading="lazy" width="800" height="600" decoding="async">
                        </div>
                        <div class="recent-info">
                            <h5>${product.name}</h5>
                            <p class="recent-price">${product.price || product.priceFormatted || 'Li√™n h·ªá'}</p>
                            <div class="recent-actions">
                                <a href="/product/${product.id}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> Xem L·∫°i
                                </a>
                                <button class="btn btn-sm btn-primary" onclick="addRecentToCart('${product.id}', '${product.name}', '${product.price || product.priceFormatted}', '${product.image || product.imageUrl}')">
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                recentProductsContainer.innerHTML = `
                    <div class="recent-grid">
                        ${recentHtml}
                    </div>
                    ${recentProducts.length > 6 ? `
                        <div class="recent-more">
                            <button class="btn btn-outline-primary btn-sm" onclick="showAllRecent()">
                                <i class="fas fa-history"></i> Xem t·∫•t c·∫£ (${recentProducts.length})
                            </button>
                        </div>
                    ` : ''}
                `;
                
                console.log('‚úÖ Recent products loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading recent products:', error);
                recentProductsContainer.innerHTML = `
                    <div class="error-recent">
                        <i class="fas fa-exclamation-circle" style="color: #ef4444; margin-bottom: 0.5rem;"></i>
                        <p style="color: #ef4444; margin: 0; font-size: 0.875rem;">C√≥ l·ªói khi t·∫£i s·∫£n ph·∫©m ƒë√£ xem</p>
                    </div>
                `;
            }
        }

        // Add recent product to cart
        async function addRecentToCart(productId, productName, productPrice, productImage) {
            console.log('üõí Adding recent product to cart:', productName);
            
            if (typeof window.addToCart === 'function') {
                await window.addToCart(productName, productPrice, productId, productImage, 1);
            } else {
                console.warn('‚ö†Ô∏è addToCart function not available');
            }
        }

        // Show all recent products (placeholder)
        function showAllRecent() {
            alert('T√≠nh nƒÉng xem t·∫•t c·∫£ s·∫£n ph·∫©m ƒë√£ xem s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t s·ªõm!');
        }

        // Load Recent Orders (Bills)
        async function loadRecentOrders() {
            console.log('üìã Loading recent orders for user profile...');
            
            const recentOrdersContainer = document.getElementById('recentOrders');
            if (!recentOrdersContainer || !window.currentUser) {
                console.log('‚ùå No recent orders container or user found');
                return;
            }

            try {
                recentOrdersContainer.innerHTML = `
                    <div class="loading-orders">
                        <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i ƒë∆°n h√†ng...
                    </div>
                `;

                let idToken = null;
                if (window.firebaseCompatAuth && window.firebaseCompatAuth.currentUser) {
                    idToken = await window.firebaseCompatAuth.currentUser.getIdToken();
                } else if (window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
                    idToken = await window.firebase.auth().currentUser.getIdToken();
                } else {
                    // Try to get stored token for manual users (fallback)
                    idToken = localStorage.getItem('firebaseIdToken');
                    if (idToken) {
                        console.log('üîë Got Firebase token from localStorage for manual user (recent orders)');
                    }
                }

                if (!idToken) {
                    console.warn('‚ö†Ô∏è No Firebase token available');
                    throw new Error('User not authenticated');
                }

                const response = await fetch('/api/user/recent-orders', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}`, 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();
                if (!data.success || !data.orders || data.orders.length === 0) {
                    recentOrdersContainer.innerHTML = `<div class="empty-orders"><i class="far fa-file-alt" style="font-size: 2rem; color: #e5e7eb; margin-bottom: 1rem;"></i><p style="color: #6b7280; margin: 0;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p></div>`;
                    return;
                }

                const formatStatus = (status) => {
                    const statusMap = {
                        'pending': { text: 'Ch·ªù x·ª≠ l√Ω', class: 'status-pending', icon: 'fa-clock' },
                        'processing': { text: 'ƒêang x·ª≠ l√Ω', class: 'status-processing', icon: 'fa-cog' },
                        'shipping': { text: 'ƒêang giao', class: 'status-shipping', icon: 'fa-shipping-fast' },
                        'completed': { text: 'Ho√†n th√†nh', class: 'status-completed', icon: 'fa-check-circle' },
                        'cancelled': { text: 'ƒê√£ h·ªßy', class: 'status-cancelled', icon: 'fa-times-circle' }
                    };
                    return statusMap[status] || { text: status, class: 'status-default', icon: 'fa-question-circle' };
                };

                const formatDate = (timestamp) => {
                    if (!timestamp) return 'N/A';
                    try {
                        let date;
                        if (typeof timestamp === 'string') {
                            date = new Date(timestamp);
                        } else if (timestamp.toDate) {
                            date = timestamp.toDate();
                        } else {
                            date = new Date(timestamp);
                        }
                        if (isNaN(date.getTime())) return 'N/A';
                        return date.toLocaleDateString('vi-VN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        return 'N/A';
                    }
                };

                const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

                const ordersHtml = data.orders.map(order => {
                    const statusInfo = formatStatus(order.status);
                    return `<div class="order-item"><div class="order-header"><div class="order-id"><i class="fas fa-receipt"></i><span>#${order.orderId}</span></div><div class="order-status ${statusInfo.class}"><i class="fas ${statusInfo.icon}"></i><span>${statusInfo.text}</span></div></div><div class="order-info"><div class="order-detail"><i class="fas fa-calendar-alt"></i><span>${formatDate(order.createdAt)}</span></div><div class="order-detail"><i class="fas fa-box"></i><span>${order.itemCount} s·∫£n ph·∫©m</span></div><div class="order-detail"><i class="fas fa-money-bill-wave"></i><span class="order-total">${formatCurrency(order.total)}</span></div></div><div class="order-actions"><a href="/bill/${order.id}" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i> Chi ti·∫øt</a></div></div>`;
                }).join('');
                
                recentOrdersContainer.innerHTML = `<div class="orders-list">${ordersHtml}</div>${data.orders.length >= 5 ? '<div class="orders-more"><button class="btn btn-outline-primary btn-sm" onclick="viewOrderHistory()"><i class="fas fa-history"></i> Xem t·∫•t c·∫£</button></div>' : ''}`;
                console.log('‚úÖ Recent orders loaded');
            } catch (error) {
                console.error('‚ùå Error loading orders:', error);
                recentOrdersContainer.innerHTML = `<div class="error-orders"><i class="fas fa-exclamation-circle" style="color: #ef4444;"></i><p style="color: #ef4444; margin: 0;">C√≥ l·ªói khi t·∫£i ƒë∆°n h√†ng</p></div>`;
            }
        }

        // Make functions globally available
        window.loadFavoriteProducts = loadFavoriteProducts;
        window.addFavoriteToCart = addFavoriteToCart;
        window.removeFavoriteFromProfile = removeFavoriteFromProfile;
        window.loadRecentProducts = loadRecentProducts;
        window.addRecentToCart = addRecentToCart;
        window.showAllRecent = showAllRecent;
        window.loadRecentOrders = loadRecentOrders;

        // View order history - redirect to bill_detail page
        function viewOrderHistory() {
            console.log('üìã View order history clicked');
            window.location.href = '/bill-detail';
        }

        // Make viewOrderHistory globally available
        window.viewOrderHistory = viewOrderHistory;
    </script>

    <script src="/js/script.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/shop.js"></script>
    <script src="/js/address-management.js"></script>
    
    <!-- Tier Promotion Manager - Global tier monitoring across all pages -->
    <script src="/js/tier-promotion-manager.js"></script>
    
    <!-- Coin Sync Manager - Global coin monitoring across all pages -->
    <script src="/js/coin-sync-manager.js"></script>
    
    <!-- Checkout Coin Manager - Coin usage in checkout modal -->
    <script src="/js/checkout-coin-manager.js"></script>
    
    <!-- Guest Cart Synchronization -->
    <script>
        // Cross-tab cart synchronization (similar to index.ejs)
        let isTabSyncActive = false;
        
        // Listen for storage changes from other tabs
        window.addEventListener('storage', function(e) {
            if (!isTabSyncActive && (e.key === 'techHavenCart' || e.key === 'techHavenCartCount')) {
                console.log('üîÑ Shop: Cross-tab storage change detected:', e.key);
                isTabSyncActive = true;
                
                // Small delay to prevent rapid fire updates
                setTimeout(function() {
                    // Update cart UI based on new localStorage data
                    if (window.smartCart) {
                        window.smartCart.refreshCartData().then(() => {
                            console.log('‚úÖ Shop: Cart synced across tabs via SmartCart');
                            isTabSyncActive = false;
                        });
                    } else if (window.updateCartUI) {
                        window.updateCartUI();
                        console.log('‚úÖ Shop: Cart synced across tabs via updateCartUI');
                        isTabSyncActive = false;
                    } else {
                        isTabSyncActive = false;
                    }
                }, 100);
            }
        });
        
        // Ensure guest cart is properly synchronized when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for all scripts to load
            setTimeout(function() {
                console.log('üîÑ Shop: Guest cart sync check started...');
                
                // Check if there are items in localStorage that aren't showing in UI
                const localCart = localStorage.getItem('techHavenCart');
                const localCount = localStorage.getItem('techHavenCartCount');
                const cartBadge = document.getElementById('cartBadge');
                const mobileCartCount = document.getElementById('mobileCartCount');
                
                if (localCart && localCount && !window.currentUser) {
                    try {
                        const parsedCart = JSON.parse(localCart);
                        const parsedCount = parseInt(localCount) || 0;
                        
                        console.log('üì¶ Shop: Found localStorage cart for guest user:', {
                            items: parsedCart.length,
                            count: parsedCount,
                            currentUICount: cartBadge ? cartBadge.textContent : 'N/A'
                        });
                        
                        // If localStorage has items but UI doesn't show them, force sync
                        if (parsedCount > 0) {
                            console.log('‚ö†Ô∏è Shop: Forcing guest cart UI sync...');
                            
                            // Update global cart variables if they exist
                            if (typeof window.cartItems !== 'undefined') {
                                window.cartItems = parsedCart;
                            }
                            if (typeof window.cartCount !== 'undefined') {
                                window.cartCount = parsedCount;
                            }
                            
                            // Force UI update
                            if (cartBadge) {
                                cartBadge.textContent = parsedCount;
                                cartBadge.style.display = 'flex';
                                console.log('‚úÖ Shop: Cart badge force updated:', parsedCount);
                            }
                            if (mobileCartCount) {
                                mobileCartCount.textContent = parsedCount;
                                console.log('üì± Shop: Mobile cart count force updated:', parsedCount);
                            }
                            
                            // Try to call script.js updateCartUI if available
                            if (typeof window.updateCartUI === 'function') {
                                window.updateCartUI();
                                console.log('üîÑ Shop: Called updateCartUI()');
                            }
                        }
                    } catch (e) {
                        console.error('‚ùå Shop: Failed to parse localStorage cart:', e);
                    }
                } else {
                    console.log('‚ÑπÔ∏è Shop: No guest cart to sync or user is logged in');
                }
            }, 1000); // Wait 1 second for all scripts to load
        });

        // SmartCart test function
        function testSmartCartState() {
            console.log('üß† Testing SmartCart state...');
            console.log('SmartCart exists:', !!window.smartCart);
            console.log('Current user:', window.currentUser ? window.currentUser.name : 'Not logged in');
            
            if (window.smartCart) {
                console.log('SmartCart isLoggedIn:', window.smartCart.isLoggedIn);
                console.log('SmartCart lastUpdateSource:', window.smartCart.lastUpdateSource);
                console.log('SmartCart cartData:', window.smartCart.cartData);
                
                // Force refresh cart data
                window.smartCart.refreshCartData().then(data => {
                    console.log('‚úÖ SmartCart refresh result:', data);
                });
            } else {
                console.log('‚ùå SmartCart not available!');
            }
        }

        // Test cart count function
        function testCartCount() {
            console.log('üî¢ Testing cart count...');
            console.log('localStorage count:', localStorage.getItem('techHavenCartCount'));
            console.log('cartCount variable:', typeof cartCount !== 'undefined' ? cartCount : 'undefined');
            console.log('cartItems array:', typeof cartItems !== 'undefined' ? cartItems.length : 'undefined');
            console.log('Cart badge element:', document.getElementById('cartBadge')?.textContent);
            
            // Also test SmartCart if available
            if (window.smartCart) {
                console.log('SmartCart data:', window.smartCart.cartData);
            }
        }
    </script>
    
    <!-- Firebase Configuration and Authentication -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, sendEmailVerification, sendPasswordResetEmail, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpzgsxZ1Jfs5hWAfS-gDbYfgkVte_jXoA",
            authDomain: "tech-haven-5368b.firebaseapp.com",
            projectId: "tech-haven-5368b",
            storageBucket: "tech-haven-5368b.firebasestorage.app",
            messagingSenderId: "442337591630",
            appId: "1:442337591630:web:7005525c7664f513a55e1f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global variables for user state
        window.currentUser = null;
        window.auth = auth;
        window.db = db;
        window.storage = storage;

        // Authentication functions
        window.getIdToken = async function() {
            if (auth.currentUser) {
                try {
                    return await auth.currentUser.getIdToken();
                } catch (error) {
                    console.error('Error getting ID token:', error);
                    return null;
                }
            }
            return null;
        };

        // Check authentication state on page load
        onAuthStateChanged(auth, async (user) => {
            console.log('üîê Auth state changed:', user ? user.email : 'No user');
            
            if (user) {
                // Clear local cart data for Google users (Firebase cart takes precedence)
                if (user.providerData && user.providerData.some(provider => provider.providerId === 'google.com')) {
                    console.log('üßπ Clearing local cart for Google user on auth state change...');
                    localStorage.removeItem('techHavenCart');
                    localStorage.removeItem('techHavenCartCount');
                }
                window.currentUser = {
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName,
                    photo: user.photoURL,
                    provider: 'firebase',
                    emailVerified: user.emailVerified
                };
                
                // Get additional user data from server including fresh photo from Firestore
                try {
                    const idToken = await user.getIdToken();
                    const response = await fetch('/api/user', {
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üîç API /api/user response:', data);
                        if (data.success && data.user) {
                            console.log('üìä User data from server:', data.user);
                            console.log('üîß Admin status from server:', data.user.is_admin);
                            
                            // Merge data but prioritize Firestore photo over Firebase Auth photoURL
                            window.currentUser = { 
                                ...window.currentUser, 
                                ...data.user,
                                photo: data.user.photo || window.currentUser.photo // Firestore photo takes priority
                            };
                            console.log('‚úÖ Enhanced user data with admin status:', {
                                is_admin: window.currentUser.is_admin,
                                photo: window.currentUser.photo,
                                fullUser: window.currentUser
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                }
            } else {
                // Check for manual authentication in localStorage
                const storedUser = localStorage.getItem('techHavenUser');
                if (storedUser) {
                    try {
                        window.currentUser = JSON.parse(storedUser);
                        console.log('üì± User from localStorage:', window.currentUser);
                        console.log('üîß Admin status from localStorage:', window.currentUser.is_admin);
                        
                        // Refresh user data from server for manual users too
                        await refreshUserDataFromServer();
                    } catch (error) {
                        console.error('Error parsing stored user:', error);
                        localStorage.removeItem('techHavenUser');
                        window.currentUser = null;
                    }
                } else {
                    window.currentUser = null;
                }
            }
            
            // Update UI
            updateUIBasedOnAuthStatus();
        });

        // Update UI based on authentication status
        async function updateUIBasedOnAuthStatus() {
            console.log('üîÑ Updating UI, currentUser:', window.currentUser);
            updateUserIcons();
            
            // Update SmartCart authentication status with user object
            if (window.smartCart) {
                console.log('üîÑ Updating SmartCart auth status:', !!window.currentUser);
                if (window.currentUser) {
                    await window.smartCart.setAuthStatus(true, window.currentUser);
                } else {
                    await window.smartCart.setAuthStatus(false);
                }
            }
            
            // Start or stop cart real-time listener based on auth state
            if (window.currentUser && window.startCartRealtimeListener) {
                console.log('üéß Starting cart real-time listener for user:', window.currentUser.uid);
                window.startCartRealtimeListener(window.currentUser.uid);
            } else if (window.stopCartRealtimeListener) {
                console.log('üîá Stopping cart real-time listener');
                window.stopCartRealtimeListener();
            }
            
            // Load cart if user is logged in
            if (window.currentUser && window.loadCartFromDatabase) {
                console.log('üõí User logged in, loading cart for:', window.currentUser.email);
                window.loadCartFromDatabase();
            }
        }

        // Update user icons in header with enhanced photo detection
        function updateUserIcons() {
            const userIconContainer = document.getElementById('userIconContainer');
            const mobileUserLink = document.getElementById('mobileUserLink');
            
            if (userIconContainer) {
                if (window.currentUser) {
                    const isAdmin = window.currentUser.is_admin ? ' üëë' : '';
                    // Prioritize photo from Firestore database, then Firebase Auth, then picture field
                    const avatar = window.currentUser.photo || window.currentUser.photoURL || window.currentUser.picture;
                    
                    console.log('üñºÔ∏è Avatar sources - photo:', window.currentUser.photo, 'photoURL:', window.currentUser.photoURL, 'picture:', window.currentUser.picture);
                    console.log('üñºÔ∏è Final avatar URL:', avatar);
                    
                    if (avatar) {
                        userIconContainer.innerHTML = `
                            <div class="user-icon-authenticated" onclick="openUserProfile()">
                                <img src="${avatar}" alt="${window.currentUser.name}" class="user-avatar-small" width="40" height="40" loading="lazy" decoding="async">
                                <span class="user-name-display">${window.currentUser.name || window.currentUser.email}${isAdmin}</span>
                            </div>
                        `;
                    } else {
                        userIconContainer.innerHTML = `
                            <div class="user-icon-authenticated" onclick="openUserProfile()">
                                <i class="fas fa-user-circle" style="margin-right: 8px; font-size: 20px; color: #667eea;"></i>
                                <span class="user-name-display">${window.currentUser.name || window.currentUser.email}${isAdmin}</span>
                            </div>
                        `;
                    }
                } else {
                    userIconContainer.innerHTML = `<i class="fas fa-user" onclick="openLoginModal()" style="cursor: pointer;"></i>`;
                }
            }
            
            if (mobileUserLink) {
                if (window.currentUser) {
                    mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openUserProfile();');
                    const userName = window.currentUser.name || window.currentUser.email;
                    const displayName = userName.length > 15 ? userName.substring(0, 15) + '...' : userName;
                    const isAdmin = window.currentUser.is_admin ? ' üëë' : '';
                    mobileUserLink.innerHTML = `<i class="fas fa-user-circle"></i> ${displayName}${isAdmin}`;
                } else {
                    mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openLoginModal();');
                    mobileUserLink.innerHTML = `<i class="fas fa-user"></i> T√†i kho·∫£n`;
                }
            }
        }

        // Make functions globally available
        window.updateUIBasedOnAuthStatus = updateUIBasedOnAuthStatus;
        window.updateUserIcons = updateUserIcons;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.sendEmailVerification = sendEmailVerification;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.signOut = signOut;
        
        // Function to refresh user data from server for manual auth users
        async function refreshUserDataFromServer() {
            if (!window.currentUser) return;
            
            try {
                console.log('üîÑ Refreshing user data from server...');
                
                // For manual users, use the profile API with UID parameter
                let apiUrl = `/api/user/profile?uid=${window.currentUser.uid}`;
                let requestOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // For Firebase Auth users, use token-based API
                if (window.currentUser.provider === 'firebase' && window.auth.currentUser) {
                    try {
                        const idToken = await window.auth.currentUser.getIdToken();
                        apiUrl = '/api/user/profile';
                        requestOptions.headers['Authorization'] = `Bearer ${idToken}`;
                    } catch (tokenError) {
                        console.log('‚ö†Ô∏è Could not get ID token, using UID-based API');
                    }
                }
                
                const response = await fetch(apiUrl, requestOptions);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üîç Refresh API response:', data);
                    if (data.success && data.user) {
                        console.log('üìä Fresh user data from server:', data.user);
                        console.log('üîß Admin status in fresh data:', data.user.is_admin);
                        
                        // Update currentUser with fresh data, prioritizing Firestore photo
                        const freshData = {
                            ...window.currentUser,
                            ...data.user,
                            photo: data.user.photo || window.currentUser.photo // Keep Firestore photo priority
                        };
                        
                        window.currentUser = freshData;
                        console.log('‚úÖ Updated currentUser with fresh data:', {
                            is_admin: window.currentUser.is_admin,
                            uid: window.currentUser.uid,
                            email: window.currentUser.email
                        });
                        
                        // Update localStorage for manual users
                        if (window.currentUser.provider === 'manual') {
                            localStorage.setItem('techHavenUser', JSON.stringify(window.currentUser));
                        }
                        
                        console.log('‚úÖ User data refreshed with latest photo:', window.currentUser.photo);
                        return true;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing user data:', error);
            }
            
            return false;
        }
        
        // Make refresh function globally available
        window.refreshUserDataFromServer = refreshUserDataFromServer;
        
        // User Profile Panel Functions
        window.openUserProfile = async function() {
            console.log('üöÄ Opening user profile panel');
            
            if (!window.currentUser) {
                console.log('‚ùå No user logged in, opening login modal instead');
                openLoginModal();
                return;
            }
            
            // Refresh user data to get latest info including photo
            console.log('üîÑ Refreshing user data before opening profile...');
            await refreshUserDataFromServer();
            
            // Update profile panel with current user data
            updateUserProfilePanel();
            
            // Show the profile panel
            const panel = document.getElementById('userProfilePanel');
            if (panel) {
                panel.classList.add('active');
                console.log('‚úÖ Profile panel opened');
            }
        };
        
        window.closeUserProfile = function() {
            const panel = document.getElementById('userProfilePanel');
            if (panel) {
                panel.classList.remove('active');
                console.log('‚úÖ Profile panel closed');
            }
        };
        
        // Update user profile panel with current user data and enhanced photo detection
        function updateUserProfilePanel() {
            if (!window.currentUser) return;
            
            // Update profile name and email
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profileInfoName = document.getElementById('profileInfoName');
            const profileInfoEmail = document.getElementById('profileInfoEmail');
            const profileAvatar = document.getElementById('profileAvatar');
            const avatarPlaceholder = document.querySelector('.avatar-placeholder');
            
            if (profileName) profileName.textContent = window.currentUser.name || window.currentUser.email;
            if (profileEmail) profileEmail.textContent = window.currentUser.email;
            if (profileInfoName) profileInfoName.textContent = window.currentUser.name || window.currentUser.email;
            if (profileInfoEmail) profileInfoEmail.textContent = window.currentUser.email;
            
            // Handle avatar display with priority: Firestore photo > Firebase Auth photoURL > picture field
            const avatar = window.currentUser.photo || window.currentUser.photoURL || window.currentUser.picture;
            console.log('üñºÔ∏è Profile avatar sources - photo:', window.currentUser.photo, 'photoURL:', window.currentUser.photoURL, 'picture:', window.currentUser.picture);
            
            if (avatar) {
                if (profileAvatar) {
                    profileAvatar.src = avatar;
                    profileAvatar.style.display = 'block';
                    console.log('‚úÖ Profile avatar set to:', avatar);
                }
                if (avatarPlaceholder) {
                    avatarPlaceholder.style.display = 'none';
                }
            } else {
                console.log('‚ùå No avatar found, showing placeholder');
                if (profileAvatar) {
                    profileAvatar.style.display = 'none';
                }
                if (avatarPlaceholder) {
                    avatarPlaceholder.style.display = 'flex';
                }
            }
            
            // Update join date
            const joinDateElement = document.getElementById('joinDate');
            if (joinDateElement) {
                joinDateElement.textContent = new Date().toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // Load favorite products when user profile is updated
            if (typeof loadFavoriteProducts === 'function') {
                loadFavoriteProducts();
            }
            
            // Load recently viewed products when user profile is updated
            if (typeof loadRecentProducts === 'function') {
                loadRecentProducts();
            }
            
            // Load recent orders when user profile is updated
            if (typeof loadRecentOrders === 'function') {
                loadRecentOrders();
            }
            
            // Load membership level
            if (typeof window.loadMembershipLevel === 'function') {
                window.loadMembershipLevel();
            }
        }
        
        // Simple notification function
        window.showNotification = function(message, type = 'info') {
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transition: all 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // Set color based on type
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ffc107';
                    notification.style.color = '#000';
                    break;
                default:
                    notification.style.backgroundColor = '#667eea';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        };

        // Shop-specific logout function
        window.handleShopLogout = function() {
            console.log('üö™ Shop logout initiated...');
            
            try {
                // Clear Firebase auth if user is signed in
                if (window.auth && window.auth.currentUser) {
                    window.auth.signOut().then(() => {
                        console.log('‚úÖ Firebase user signed out');
                    }).catch((error) => {
                        console.error('‚ùå Firebase signout error:', error);
                    });
                }
            } catch (error) {
                console.error('‚ùå Error during Firebase signout:', error);
            }
            
            // Clear localStorage
            localStorage.removeItem('techHavenUser');
            localStorage.removeItem('rememberMe');
            
            // Clear global user
            window.currentUser = null;
            
            // Update specific shop UI elements
            const userIconContainer = document.getElementById('userIconContainer');
            if (userIconContainer) {
                userIconContainer.innerHTML = `<i class="fas fa-user" onclick="openLoginModal()" style="cursor: pointer;"></i>`;
            }
            
            // Update mobile nav
            const mobileUserLink = document.getElementById('mobileUserLink');
            if (mobileUserLink) {
                mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openLoginModal();');
                mobileUserLink.innerHTML = `<i class="fas fa-user"></i> T√†i kho·∫£n`;
            }
            
            // Close user profile panel if open
            const userProfilePanel = document.getElementById('userProfilePanel');
            if (userProfilePanel) {
                userProfilePanel.classList.remove('active');
            }
            
            // Show logout success message
            showNotification('ƒêƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
            
            console.log('‚úÖ Shop logout completed');
        };

        // Admin navigation function compatible with Firebase v9 compat and v8
        window.navigateToAdmin = async function(adminPath) {
            console.log('üîß Navigating to admin:', adminPath);
            
            if (!window.currentUser) {
                console.warn('‚ö†Ô∏è No user logged in for admin access');
                if (window.showNotification) {
                    window.showNotification('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang admin', 'warning');
                } else {
                    alert('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang admin');
                }
                if (window.openLoginModal) {
                    window.openLoginModal();
                }
                return false;
            }
            
            console.log('üë§ Current user for admin access:', {
                uid: window.currentUser.uid,
                email: window.currentUser.email,
                name: window.currentUser.name,
                is_admin: window.currentUser.is_admin,
                provider: window.currentUser.provider
            });
            
            // Check if user has admin privileges
            if (!window.currentUser.is_admin) {
                console.warn('‚ö†Ô∏è User is not an admin:', window.currentUser.is_admin);
                if (window.showNotification) {
                    window.showNotification('‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin', 'warning');
                } else {
                    alert('‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin');
                }
                return false;
            }
            
            // Try different auth methods based on available systems
            let adminUrl = adminPath;
            let authToken = null;
            
            // Method 1: Try Firebase v8/compat auth (authCompat)
            if (window.authCompat && window.authCompat.currentUser) {
                try {
                    authToken = await window.authCompat.currentUser.getIdToken();
                    console.log('üîë Got auth token from Firebase compat (v8)');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not get Firebase compat token:', error.message);
                }
            }
            
            // Method 2: Try Firebase v8 direct access 
            if (!authToken && window.firebaseAuth && window.firebaseAuth.currentUser) {
                try {
                    authToken = await window.firebaseAuth.currentUser.getIdToken();
                    console.log('üîë Got auth token from Firebase auth (v8)');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not get Firebase auth token:', error.message);
                }
            }
            
            // Method 3: Try Firebase v9 modular auth  
            if (!authToken && window.auth && window.auth.currentUser) {
                try {
                    authToken = await window.auth.currentUser.getIdToken();
                    console.log('üîë Got auth token from Firebase modular (v9)');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not get Firebase modular token:', error.message);
                }
            }
            
            // Build admin URL with authentication
            if (authToken) {
                adminUrl = `${adminPath}?token=${authToken}`;
                console.log('üîë Using auth token for admin access');
            } else {
                // Fallback to UID-based authentication
                adminUrl = `${adminPath}?uid=${window.currentUser.uid}&email=${encodeURIComponent(window.currentUser.email)}`;
                console.log('üîë Fallback to UID-based authentication');
            }
            
            console.log('üîó Navigating to admin URL (token hidden for security)');
            
            // Navigate to admin page
            try {
                window.location.href = adminUrl;
            } catch (error) {
                console.error('‚ùå Navigation error:', error);
                if (window.showNotification) {
                    window.showNotification('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p trang admin', 'error');
                } else {
                    alert('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p trang admin');
                }
            }
            
            return false;
        };

        // Global variables for products
        let allProducts = [];
        let filteredProducts = [];
        let currentPage = 0;
        let productsPerPage = 12;
        let totalProducts = 0;
        
        // Load products from database
        async function loadProducts(filters = {}) {
            try {
                console.log('üì¶ Loading products from database...', filters);
                
                const queryParams = new URLSearchParams({
                    limit: productsPerPage,
                    offset: Math.max(0, (currentPage - 1) * productsPerPage), // Fix pagination offset
                    ...filters
                });
                
                console.log('üîó API URL:', `/api/products?${queryParams}`);
                const response = await fetch(`/api/products?${queryParams}`);
                
                if (!response.ok) {
                    console.error('‚ùå API Response not OK:', response.status, response.statusText);
                    throw new Error('Failed to fetch products');
                }
                
                const data = await response.json();
                console.log('üì° API Response:', data);
                
                if (data.success) {
                    if (currentPage <= 1) {
                        // Reset products on first page
                        allProducts = data.products;
                        filteredProducts = data.products;
                    } else {
                        // Append products for pagination
                        allProducts = [...allProducts, ...data.products];
                        filteredProducts = [...filteredProducts, ...data.products];
                    }
                    
                    totalProducts = data.pagination.total;
                    
                    console.log(`‚úÖ Loaded ${data.products.length} products (${totalProducts} total)`);
                    
                    renderProducts();
                    updateResultCount();
                    updateLoadMoreButton(data.pagination.hasMore);
                    
                    return data.products;
                } else {
                    throw new Error(data.error || 'Failed to load products');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                showNoResults();
                return [];
            }
        }
        
        // Render products to the grid
        function renderProducts(products = filteredProducts) {
            const productsGrid = document.getElementById('productsGrid');
            
            if (!products || products.length === 0) {
                showNoResults();
                return;
            }
            
            let html = '';
            
            products.forEach(product => {
                const discountBadge = product.discount ? `<div class="product-badge">SALE</div>` : '';
                const oldPriceHtml = product.oldPrice ? `<span class="product-old-price">${formatPrice(product.oldPrice)}</span>` : '';
                const categoryIcon = getCategoryIcon(product.category);
                // Use 0 as default rating if no rating data
                const productRating = product.rating || 0;
                const rating = generateStarRating(productRating);
                
                // Get first image from images array or fallback to image field
                let productImage = '';
                let productImageUrl = '';
                if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                    // Use first image from images array
                    productImageUrl = product.images[0];
                    productImage = `<img src="${productImageUrl}" alt="${product.name}" style="width: 100%; height: 200px; object-fit: cover;" / width="800" height="600" loading="lazy" decoding="async">`;
                } else if (product.image) {
                    // Fallback to single image field
                    productImageUrl = product.image;
                    productImage = `<img src="${productImageUrl}" alt="${product.name}" style="width: 100%; height: 200px; object-fit: cover;" / width="800" height="600" loading="lazy" decoding="async">`;
                } else {
                    // Fallback to category icon
                    productImageUrl = '';
                    productImage = categoryIcon;
                }
                
                html += `
                    <div class="product-card" data-product-id="${product.id}" data-category="${product.category || ''}" data-brand="${product.brand || ''}" onclick="goToProductDetail('${product.id}')">
                        <div class="product-image">
                            ${productImage}
                            ${discountBadge}
                        </div>
                        <div class="product-info">
                            <div class="product-rating">${rating}</div>
                            <h4>${product.name}</h4>
                            <div class="product-price">
                                <span>${formatPrice(product.price)}</span>
                                ${oldPriceHtml}
                            </div>
                            <button class="add-to-cart" onclick="event.stopPropagation(); addToCart('${product.name}', '${formatPrice(product.price)}', '${product.id}', '${productImageUrl}')">
                                <i class="fas fa-cart-plus"></i> TH√äM V√ÄO GI·ªé
                            </button>
                        </div>
                    </div>
                `;
            });
            
            if (currentPage === 0) {
                productsGrid.innerHTML = html;
            } else {
                productsGrid.innerHTML += html;
            }
            
            hideNoResults();
        }
        
        // Helper functions
        function formatPrice(price) {
            // Use same format as script.js
            return new Intl.NumberFormat('vi-VN').format(price);
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'laptop': '<i class="fas fa-laptop" style="color: #3b82f6;"></i>',
                'cpu': '<i class="fas fa-microchip" style="color: #a855f7;"></i>',
                'gpu': '<i class="fas fa-memory" style="color: #ec4899;"></i>',
                'ram': '<i class="fas fa-memory" style="color: #10b981;"></i>',
                'storage': '<i class="fas fa-hdd" style="color: #f59e0b;"></i>',
                'monitor': '<i class="fas fa-desktop" style="color: #6366f1;"></i>',
                'peripheral': '<i class="fas fa-keyboard" style="color: #ef4444;"></i>'
            };
            return icons[category] || '<i class="fas fa-laptop" style="color: #3b82f6;"></i>';
        }
        
        function generateStarRating(rating) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    html += '<i class="fas fa-star"></i>';
                } else {
                    html += '<i class="far fa-star"></i>';
                }
            }
            return html;
        }
        
        function updateResultCount() {
            const resultCount = document.getElementById('resultCount');
            if (resultCount) {
                const showing = Math.min(filteredProducts.length, (currentPage + 1) * productsPerPage);
                resultCount.textContent = `Hi·ªÉn th·ªã ${showing} / ${totalProducts} s·∫£n ph·∫©m`;
            }
        }
        
        function updateLoadMoreButton(hasMore) {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = hasMore ? 'block' : 'none';
            }
        }
        
        function showNoResults() {
            const noResults = document.getElementById('noResults');
            const productsGrid = document.getElementById('productsGrid');
            
            if (noResults) noResults.style.display = 'block';
            if (productsGrid) productsGrid.style.display = 'none';
        }
        
        function hideNoResults() {
            const noResults = document.getElementById('noResults');
            const productsGrid = document.getElementById('productsGrid');
            
            if (noResults) noResults.style.display = 'none';
            if (productsGrid) productsGrid.style.display = 'grid';
        }
        
        // Load more products
        function loadMoreProducts() {
            currentPage++;
            loadProducts(getCurrentFilters());
        }
        
        // Get current filter values
        function getCurrentFilters() {
            console.log('üîç Getting current filters...');
            const filters = {};
            
            // Category filters with expanded matching
            const categoryFilters = document.querySelectorAll('.category-filter:checked');
            console.log('üìÇ Category checkboxes checked:', categoryFilters.length);
            categoryFilters.forEach((checkbox, index) => {
                console.log(`   ${index + 1}. ${checkbox.value} (${checkbox.id})`);
            });
            
            if (categoryFilters.length > 0) {
                const selectedCategories = Array.from(categoryFilters).map(cb => cb.value);
                
                // Expand laptop category to include Laptop Gaming
                const expandedCategories = [];
                selectedCategories.forEach(cat => {
                    if (cat.toLowerCase() === 'laptop') {
                        // Include both laptop and Laptop Gaming
                        expandedCategories.push('laptop', 'Laptop Gaming');
                    } else {
                        expandedCategories.push(cat);
                    }
                });
                
                // Remove duplicates
                const uniqueCategories = [...new Set(expandedCategories)];
                filters.category = uniqueCategories.join(',');
                
                console.log('üìÇ Category filter expanded:', selectedCategories, '‚Üí', uniqueCategories);
                console.log('üìÇ Final category filter string:', filters.category);
            }
            
            // Brand filters
            const brandFilters = document.querySelectorAll('.brand-filter:checked');
            if (brandFilters.length > 0) {
                filters.brand = Array.from(brandFilters).map(cb => cb.value).join(',');
            }
            
            // Price range
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;
            if (minPrice) filters.minPrice = minPrice;
            if (maxPrice) filters.maxPrice = maxPrice;
            
            // Rating filter
            const ratingFilter = document.querySelector('input[name="rating"]:checked');
            if (ratingFilter) {
                filters.rating = ratingFilter.value;
            }
            
            // Sort option
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                filters.sort = sortSelect.value;
            }
            
            console.log('üîç Final filters object:', filters);
            return filters;
        }
        
        // Apply filters
        function applyFilters() {
            currentPage = 0;
            allProducts = [];
            filteredProducts = [];
            loadProducts(getCurrentFilters());
        }
        
        // Clear all filters
        function clearAllFilters() {
            // Clear checkboxes
            document.querySelectorAll('.category-filter, .brand-filter').forEach(cb => cb.checked = false);
            document.getElementById('categoryAll').checked = true;
            
            // Clear price inputs
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            
            // Clear rating filter
            document.querySelectorAll('input[name="rating"]').forEach(radio => radio.checked = false);
            
            // Reset sort
            document.getElementById('sortSelect').value = 'default';
            
            // Reload products
            applyFilters();
        }
        
        // Initialize shop page
        async function initializeShop() {
            console.log('üè™ Initializing shop page...');
            
            // Load initial products
            await loadProducts();
            
            // Check for URL parameters and apply them
            checkAndApplyUrlParameters();
            
            // Setup event listeners for filters
            setupFilterEventListeners();
            
            // Setup cart observer
            setupCartObserver();
            
            // Load cart if user is logged in - delegate to script.js
            if (window.currentUser && typeof window.updateCartUI === 'function') {
                window.updateCartUI();
            }
            
            console.log('‚úÖ Shop page initialized');
        }
        
        // Check and apply URL parameters
        function checkAndApplyUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryParam = urlParams.get('category');
            const searchParam = urlParams.get('search');
            
            console.log('üîç Checking URL parameters:', {
                category: categoryParam,
                search: searchParam
            });
            
            if (categoryParam) {
                console.log('üè∑Ô∏è Applying category filter from URL:', categoryParam);
                applyCategoryFilter(categoryParam);
                
                // Show notification
                if (typeof showNotification === 'function') {
                    showNotification(`L·ªçc theo danh m·ª•c: ${categoryParam.toUpperCase()}`, 'info');
                }
                
                // Clean URL to remove the parameter
                setTimeout(() => {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }, 1000);
            }
            
            if (searchParam) {
                console.log('üîç Applying search filter from URL:', searchParam);
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = searchParam;
                    // Trigger search
                    if (typeof handleSearch === 'function') {
                        handleSearch();
                    }
                }
                
                // Clean URL to remove the parameter
                setTimeout(() => {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }, 1000);
            }
        }
        
        // Apply category filter by checking the appropriate checkbox
        function applyCategoryFilter(category) {
            console.log('üè∑Ô∏è Applying category filter:', category);
            
            // Clear all existing category filters first
            console.log('üßπ Clearing all existing category filters...');
            
            // Uncheck "All" checkbox
            const categoryAll = document.getElementById('categoryAll');
            if (categoryAll) {
                categoryAll.checked = false;
                console.log('‚úÖ Unchecked "All" category checkbox');
            }
            
            // Uncheck all category filter checkboxes
            document.querySelectorAll('.category-filter').forEach((checkbox, index) => {
                if (checkbox.checked) {
                    console.log(`üßπ Unchecking category filter: ${checkbox.value}`);
                    checkbox.checked = false;
                }
            });
            
            console.log('‚úÖ All existing category filters cleared');
            
            // Map suggestion categories to checkbox values
            let checkboxValue = category;
            let multipleCategories = []; // For categories that span multiple checkboxes
            
            switch(category.toLowerCase()) {
                case 'vga':
                    checkboxValue = 'gpu';
                    break;
                case 'keyboard':
                case 'mouse':
                    checkboxValue = 'peripheral';
                    break;
                case 'component':
                case 'components':
                    // "LINH KI·ªÜN" includes CPU, GPU, RAM, Storage
                    multipleCategories = ['cpu', 'gpu', 'ram', 'storage'];
                    console.log('üè∑Ô∏è Component category detected - will check multiple categories:', multipleCategories);
                    break;
                default:
                    checkboxValue = category.toLowerCase();
            }
            
            // Handle multiple categories (e.g., "component")
            if (multipleCategories.length > 0) {
                let checkedCount = 0;
                multipleCategories.forEach(cat => {
                    const checkbox = document.querySelector(`input[value="${cat}"].category-filter`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkedCount++;
                        console.log('‚úÖ Category checkbox checked:', cat);
                    }
                });
                
                if (checkedCount > 0) {
                    console.log(`‚úÖ Checked ${checkedCount} component categories`);
                    console.log('üîÑ Calling applyFilters()...');
                    applyFilters();
                } else {
                    console.log('‚ö†Ô∏è No component category checkboxes found');
                }
            } else {
                // Single category
                console.log(`üè∑Ô∏è Mapped category "${category}" ‚Üí checkbox value "${checkboxValue}"`);
                
                // Find and check the appropriate category checkbox
                const categoryCheckbox = document.querySelector(`input[value="${checkboxValue}"].category-filter`);
                if (categoryCheckbox) {
                    categoryCheckbox.checked = true;
                    console.log('‚úÖ Category checkbox checked:', checkboxValue);
                    console.log('‚úÖ Checkbox element:', categoryCheckbox);
                    
                    // Apply filters
                    console.log('üîÑ Calling applyFilters()...');
                    applyFilters();
                } else {
                    console.log('‚ö†Ô∏è Category checkbox not found for:', checkboxValue);
                    console.log('üîç Available category checkboxes:');
                    document.querySelectorAll('.category-filter').forEach((cb, index) => {
                        console.log(`   ${index + 1}. value="${cb.value}" id="${cb.id}"`);
                    });
                    
                    // If checkbox doesn't exist, use filtering logic directly
                    console.log('üîÑ Fallback: calling filterProductsByCategory()...');
                    filterProductsByCategory(category);
                }
            }
        }
        
        // Export function immediately for use by script.js
        window.applyCategoryFilter = applyCategoryFilter;
        console.log('‚úÖ applyCategoryFilter exported to window object');
        
        function setupFilterEventListeners() {
            // Filter checkboxes
            document.querySelectorAll('.category-filter, .brand-filter').forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
            
            // Category "All" checkbox
            document.getElementById('categoryAll').addEventListener('change', function(e) {
                if (e.target.checked) {
                    document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
                    applyFilters();
                }
            });
            
            // Price range inputs
            document.getElementById('minPrice').addEventListener('change', applyFilters);
            document.getElementById('maxPrice').addEventListener('change', applyFilters);
            
            // Price suggestion buttons
            document.querySelectorAll('.price-tag').forEach(button => {
                button.addEventListener('click', function() {
                    document.getElementById('minPrice').value = this.dataset.min;
                    document.getElementById('maxPrice').value = this.dataset.max;
                    applyFilters();
                });
            });
            
            // Rating filters
            document.querySelectorAll('input[name="rating"]').forEach(radio => {
                radio.addEventListener('change', applyFilters);
            });
            
            // Sort dropdown
            document.getElementById('sortSelect').addEventListener('change', applyFilters);
        }
        
        // Make functions globally available
        window.loadMoreProducts = loadMoreProducts;
        window.clearAllFilters = clearAllFilters;
        window.goToProductDetail = function(productId) {
            window.location.href = `/product/${productId}`;
        };

        // =====================================
        // SIMPLIFIED CART - DELEGATE TO SCRIPT.JS  
        // =====================================
        
        console.log('üè™ Shop page - using script.js for ALL cart operations');
        
        // Minimal cart variables for compatibility only
        let cart = [];
        let cartTotal = 0;
        
        // Simple initialization wrapper
        function initializeCart() {
            console.log('üè™ Shop cart init - delegating to script.js');
            window.cart = cart;
            window.cartItems = [...cart];
        }
        
        initializeCart();
        
        // All cart functions below will delegate to script.js
        
        // Simple wrapper functions that delegate to script.js
        function loadCartWrapper() {
            console.log('ÔøΩ Shop loadCart - delegating to script.js');
            if (typeof window.loadCartFromDatabase === 'function') {
                window.loadCartFromDatabase();
            } else if (typeof window.updateCartUI === 'function') {
                window.updateCartUI();
            } else {
                console.log('‚è≥ script.js not ready, waiting...');
                setTimeout(() => {
                    if (typeof window.loadCartFromDatabase === 'function') {
                        window.loadCartFromDatabase();
                    } else if (typeof window.updateCartUI === 'function') {
                        window.updateCartUI();
                    }
                }, 1000);
            }
        }
        
        // NO COMPLEX CART FUNCTIONS - ALL DELEGATED TO SCRIPT.JS
        // script.js will handle all cart operations: add, remove, update, load, sync
        
        console.log('üè™ Shop page ready - ALL cart operations delegated to script.js');
        
        // REMOVED ALL CART FUNCTIONS TO PREVENT INFINITE LOOPS
        // Let script.js handle everything completely
        console.log('üè™ Shop page - removed all cart functions, delegating to script.js');
        
        // Simple cart sync wrapper - delegate to script.js
        async function syncCartFromDatabase() {
            console.log('üîÑ Shop syncCartFromDatabase - delegating to script.js');
            
            // Let script.js handle cart syncing
            if (typeof window.updateCartUI === 'function') {
                console.log('‚úÖ Using script.js updateCartUI for cart sync');
                window.updateCartUI();
            } else {
                console.log('‚è≥ script.js not ready for cart sync');
            }
        }
        
        // Make simple wrapper available globally
        window.syncCartFromDatabase = syncCartFromDatabase;
        
        // Render cart items
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotalElement = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (!cartItems) return;
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; color: #ccc;"></i>
                        <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
                    </div>
                `;
                if (checkoutBtn) checkoutBtn.disabled = true;
            } else {
                let html = '';
                
                cart.forEach(item => {
                    const productImage = item.productImage ? 
                        `<img src="${item.productImage}" alt="${item.productName}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" / width="800" height="600" loading="lazy" decoding="async">` :
                        `<i class="fas fa-cube" style="color: #667eea; font-size: 2rem;"></i>`;
                    
                    html += `
                        <div class="cart-item" data-product-id="${item.productId}" data-cart-id="${item.id}">
                            <div class="cart-item-image">
                                ${productImage}
                            </div>
                            <div class="cart-item-details">
                                <div class="cart-item-name">${item.productName}</div>
                                <div class="cart-item-price">${formatPrice(item.productPrice)}</div>
                                <div class="cart-item-controls">
                                    <button class="quantity-btn decrease-qty" data-cart-id="${item.id}" data-current-quantity="${item.quantity}">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="cart-item-quantity">${item.quantity}</span>
                                    <button class="quantity-btn increase-qty" data-cart-id="${item.id}" data-current-quantity="${item.quantity}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="remove-item" data-cart-id="${item.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = html;
                if (checkoutBtn) checkoutBtn.disabled = false;
                
                // NEW SIMPLE EVENT HANDLING APPROACH
                console.log('üîß Setting up NEW SIMPLE cart event listeners');
                setupSimpleCartEventListeners();
                
                // Debug logging for cart buttons
                const quantityBtns = document.querySelectorAll('.quantity-btn');
                console.log('üîç Found', quantityBtns.length, 'quantity buttons after rendering');
                quantityBtns.forEach((btn, index) => {
                    console.log(`Button ${index}:`, {
                        classes: btn.className,
                        cartId: btn.getAttribute('data-cart-id'),
                        quantity: btn.getAttribute('data-current-quantity')
                    });
                });
            }
            
            if (cartTotalElement) {
                cartTotalElement.textContent = formatPrice(cartTotal);
            }
            
            // Re-setup event listeners after cart is rendered
            setTimeout(() => {
                console.log('üîÑ Re-setting up cart event listeners after renderCart...');
                setupSimpleCartEventListeners();
            }, 50);
        }
        
        // Use updateCartQuantityById function from script.js instead of overriding
        // The script.js version has better error handling and duplicate prevention
        
        // Use removeFromCartById function from script.js instead of overriding
        // The script.js version has better error handling and duplicate prevention
        
        // NEW SIMPLE CART EVENT LISTENERS - Direct approach
        function setupSimpleCartEventListeners() {
            console.log('üîß Setting up SIMPLE cart event listeners');
            
            // Get all quantity buttons and add direct event listeners
            const decreaseBtns = document.querySelectorAll('.decrease-qty');
            const increaseBtns = document.querySelectorAll('.increase-qty');
            const removeBtns = document.querySelectorAll('.remove-item');
            
            console.log('üîç Found buttons:', {
                decrease: decreaseBtns.length,
                increase: increaseBtns.length,
                remove: removeBtns.length
            });
            
            // Handle decrease buttons
            decreaseBtns.forEach((btn, index) => {
                console.log(`üìâ Setting up decrease button ${index}`);
                btn.addEventListener('click', async function(e) {
                    console.log('üñ±Ô∏è DECREASE BUTTON CLICKED!', e.target);
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const cartId = this.getAttribute('data-cart-id');
                    const currentQuantity = parseInt(this.getAttribute('data-current-quantity'));
                    const newQuantity = Math.max(0, currentQuantity - 1);
                    
                    console.log('üìâ Decrease data:', {
                        cartId: cartId,
                        currentQuantity: currentQuantity,
                        newQuantity: newQuantity
                    });
                    
                    if (newQuantity <= 0) {
                        console.log('üóëÔ∏è Quantity is 0, removing item');
                        await simpleRemoveFromCart(cartId);
                    } else {
                        console.log('üìâ Updating quantity to:', newQuantity);
                        await simpleUpdateQuantity(cartId, newQuantity);
                    }
                });
            });
            
            // Handle increase buttons
            increaseBtns.forEach((btn, index) => {
                console.log(`üìà Setting up increase button ${index}`);
                btn.addEventListener('click', async function(e) {
                    console.log('üñ±Ô∏è INCREASE BUTTON CLICKED!', e.target);
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const cartId = this.getAttribute('data-cart-id');
                    const currentQuantity = parseInt(this.getAttribute('data-current-quantity'));
                    const newQuantity = currentQuantity + 1;
                    
                    console.log('üìà Increase data:', {
                        cartId: cartId,
                        currentQuantity: currentQuantity,
                        newQuantity: newQuantity
                    });
                    
                    console.log('üìà Updating quantity to:', newQuantity);
                    await simpleUpdateQuantity(cartId, newQuantity);
                });
            });
            
            // Handle remove buttons
            removeBtns.forEach((btn, index) => {
                console.log(`üóëÔ∏è Setting up remove button ${index}`);
                btn.addEventListener('click', async function(e) {
                    console.log('üñ±Ô∏è REMOVE BUTTON CLICKED!', e.target);
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const cartId = this.getAttribute('data-cart-id');
                    console.log('üóëÔ∏è Remove data:', { cartId: cartId });
                    
                    await simpleRemoveFromCart(cartId);
                });
            });
            
            console.log('‚úÖ SIMPLE cart event listeners setup completed');
        }
        
        // Simple update quantity function
        async function simpleUpdateQuantity(cartId, newQuantity) {
            console.log('üìà SIMPLE updating quantity:', cartId, 'to', newQuantity);
            
            // Check if user is logged in or guest
            if (!window.currentUser) {
                console.log('üë§ Guest user: Delegating to script.js universal cart system');
                
                // Use script.js universal cart system for guest users
                if (typeof window.handleCartQuantityUpdate === 'function') {
                    window.handleCartQuantityUpdate(cartId, newQuantity);
                    return;
                } else if (typeof window.updateGuestCartQuantity === 'function') {
                    window.updateGuestCartQuantity(cartId, newQuantity);
                    return;
                } else {
                    console.warn('‚ö†Ô∏è Universal cart functions not available yet, retrying...');
                    // Wait for script.js to load and retry
                    setTimeout(() => {
                        if (typeof window.handleCartQuantityUpdate === 'function') {
                            window.handleCartQuantityUpdate(cartId, newQuantity);
                        } else if (typeof window.updateGuestCartQuantity === 'function') {
                            window.updateGuestCartQuantity(cartId, newQuantity);
                        } else {
                            console.error('‚ùå Universal cart functions still not available after retry');
                            showNotification('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi·ªè h√†ng guest. H√£y th·ª≠ l·∫°i sau.', 'error');
                        }
                    }, 1000);
                    return;
                }
            }
            
            try {
                console.log('üì° Making API request...');
                const response = await fetch(`/api/cart/${cartId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity: newQuantity })
                });
                
                console.log('üìä API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã API response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Quantity updated successfully');
                        showNotification('ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng', 'success');
                        
                        // Refresh cart to show updated data - delegate to script.js
                        if (typeof window.updateCartUI === 'function') {
                            window.updateCartUI();
                        }
                    } else {
                        throw new Error(data.error || 'Failed to update quantity');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå API error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('‚ùå Error updating quantity:', error);
                showNotification('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng', 'error');
            }
        }
        
        // Simple remove from cart function
        async function simpleRemoveFromCart(cartId) {
            console.log('üóëÔ∏è SIMPLE removing from cart:', cartId);
            
            // Check if user is logged in or guest
            if (!window.currentUser) {
                console.log('üë§ Guest user: Delegating to script.js universal cart system');
                
                // Use script.js universal cart system for guest users
                if (typeof window.handleCartRemove === 'function') {
                    window.handleCartRemove(cartId);
                    return;
                } else if (typeof window.removeGuestCartItem === 'function') {
                    window.removeGuestCartItem(cartId);
                    return;
                } else {
                    console.warn('‚ö†Ô∏è Universal cart functions not available yet, retrying...');
                    // Wait for script.js to load and retry
                    setTimeout(() => {
                        if (typeof window.handleCartRemove === 'function') {
                            window.handleCartRemove(cartId);
                        } else if (typeof window.removeGuestCartItem === 'function') {
                            window.removeGuestCartItem(cartId);
                        } else {
                            console.error('‚ùå Universal cart functions still not available after retry');
                            showNotification('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m guest. H√£y th·ª≠ l·∫°i sau.', 'error');
                        }
                    }, 1000);
                    return;
                }
            }
            
            try {
                console.log('üì° Making API request to remove...');
                const response = await fetch(`/api/cart/${cartId}`, {
                    method: 'DELETE'
                });
                
                console.log('üìä API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã API response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Item removed successfully');
                        showNotification('ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng', 'success');
                        
                        // Refresh cart to show updated data - delegate to script.js
                        if (typeof window.updateCartUI === 'function') {
                            window.updateCartUI();
                        }
                    } else {
                        throw new Error(data.error || 'Failed to remove item');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå API error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('‚ùå Error removing item:', error);
                showNotification('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m', 'error');
            }
        }
        
        // OLD COMPLEX RETRY MECHANISM REMOVED - USING SIMPLE APPROACH ABOVE
        
        // Update cart badge
        // Update cart badge (both desktop and mobile) - DELEGATE TO SCRIPT.JS
        function updateCartBadge() {
            // Delegate to script.js if available (primary cart system)
            if (typeof window.updateCartUI === 'function') {
                console.log('üéØ Delegating badge update to script.js (primary cart system)');
                window.updateCartUI();
                return;
            }
            
            // Fallback: Use script.js cart data if available
            let totalItems = 0;
            let sourceCart = [];
            
            if (window.cartItems && window.cartItems.length > 0) {
                sourceCart = window.cartItems;
                totalItems = window.cartCount || sourceCart.reduce((sum, item) => sum + (item.quantity || 1), 0);
                console.log('üéØ Using script.js cart data - totalItems:', totalItems, 'from cartItems:', sourceCart.length);
            } else if (window.cartCount !== undefined) {
                totalItems = window.cartCount;
                console.log('üéØ Using script.js cartCount directly:', totalItems);
            } else {
                // Last resort: use local cart
                sourceCart = cart;
                totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
                console.log('‚ö†Ô∏è Fallback to local cart - totalItems:', totalItems, 'from local cart:', cart.length);
            }
            
            const cartBadge = document.getElementById('cartBadge');
            const mobileCartCount = document.getElementById('mobileCartCount');
            
            // Debug: Add caller information
            console.log('üîÑ updateCartBadge called - totalItems:', totalItems, 'source:', sourceCart.length > 0 ? 'script.js' : 'local');
            console.log('üìç Called from:', new Error().stack.split('\n')[2].trim());
            
            // Update desktop cart badge
            if (cartBadge) {
                if (totalItems > 0) {
                    cartBadge.textContent = totalItems;
                    cartBadge.style.display = 'flex';
                    console.log('‚úÖ Cart badge updated to:', totalItems, '(source: script.js compatible)');
                } else {
                    cartBadge.style.display = 'none';
                    console.log('üö´ Cart badge hidden (no items)');
                }
            } else {
                console.log('‚ùå Cart badge element not found!');
            }
            
            // Update mobile cart count
            if (mobileCartCount) {
                mobileCartCount.textContent = totalItems;
                console.log('üì± Updated mobile cart count:', totalItems, '(source: script.js compatible)');
            }
        }
        
        // Debounce timer for UI updates
        let uiUpdateTimer = null;
        
        // Force update cart UI with current data (no localStorage interference)
        function forceUpdateCartUI(skipDebounce = false) {
            // Debounce rapid UI updates unless explicitly skipped
            if (!skipDebounce) {
                if (uiUpdateTimer) {
                    clearTimeout(uiUpdateTimer);
                }
                uiUpdateTimer = setTimeout(() => forceUpdateCartUI(true), 100);
                return;
            }
            
            console.log('üîß Force updating cart UI with current data:', cart.length, 'items');
            
            // Ensure global state is correct
            window.cart = cart;
            
            // CRITICAL: Only sync to script.js if we have valid fresh data
            if (cart && Array.isArray(cart)) {
                // Add timestamp check to prevent overwriting newer data
                const currentTime = Date.now();
                const lastSyncTime = window.lastCartSyncTime || 0;
                
                // Only sync if this update is recent (within 5 seconds) or forced
                if (currentTime - lastSyncTime < 5000 || !window.lastCartSyncTime) {
                    window.cartItems = [...cart];
                    if (typeof localStorage !== 'undefined') {
                        localStorage.setItem('techHavenCart', JSON.stringify(cart));
                        localStorage.setItem('techHavenCartCount', cart.length.toString());
                    }
                    window.lastCartSyncTime = currentTime;
                    console.log('üîÑ Synced cart from shop.ejs to script.js system (fresh data)');
                } else {
                    console.log('‚è≠Ô∏è Skipped sync - data may be stale (age:', ((currentTime - lastSyncTime) / 1000).toFixed(1), 'seconds)');
                }
            }
            
            // Update UI immediately
            renderCart();
            
            // Only update badge if script.js is not available (avoid conflicts)
            if (typeof window.updateCartUI !== 'function') {
                console.log('üîÑ Using shop.ejs badge update (script.js not available)');
                updateCartBadge();
            } else {
                console.log('üéØ Delegating badge update to script.js (avoiding conflict)');
                // Let script.js handle the badge update
            }
            
            // Update order summary for checkout modal
            if (window.updateOrderSummary && typeof window.updateOrderSummary === 'function') {
                console.log('üìä Calling updateOrderSummary from forceUpdateCartUI');
                window.updateOrderSummary();
            } else {
                console.log('‚ö†Ô∏è updateOrderSummary not found, will wait for script.js to load');
            }
            
            // Update SmartCart if available
            if (window.smartCart && window.smartCart.updateCartIcon) {
                console.log('üîß Updating SmartCart with current data');
                window.smartCart.cartData = {
                    items: cart,
                    count: cart.reduce((sum, item) => sum + item.quantity, 0),
                    total: cartTotal
                };
                window.smartCart.lastUpdateSource = 'firebase';
                window.smartCart.updateCartIcon();
            }
            
            // Re-setup event listeners after cart HTML is updated
            setTimeout(() => {
                console.log('üîÑ Re-setting up cart event listeners after UI update...');
                setupSimpleCartEventListeners();
            }, 100);
            
            console.log('‚úÖ Force update completed');
        }
        
        // Cart DOM observer to re-setup event listeners when cart HTML changes
        function setupCartObserver() {
            const cartItemsContainer = document.getElementById('cartItems');
            if (!cartItemsContainer) {
                console.log('‚ö†Ô∏è Cart items container not found for observer');
                return;
            }
            
            const observer = new MutationObserver((mutations) => {
                let shouldResetupListeners = false;
                
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Check if any added nodes are cart items
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE && 
                                (node.classList.contains('cart-item') || 
                                 node.querySelector && node.querySelector('.cart-item'))) {
                                shouldResetupListeners = true;
                            }
                        });
                    }
                });
                
                if (shouldResetupListeners) {
                    console.log('üîÑ Cart DOM changed, re-setting up event listeners...');
                    setTimeout(() => {
                        setupSimpleCartEventListeners();
                    }, 100);
                }
            });
            
            observer.observe(cartItemsContainer, {
                childList: true,
                subtree: true
            });
            
            console.log('üëÄ Cart observer setup completed');
        }
        
        // Make functions globally available
        window.updateCartBadge = updateCartBadge;
        window.forceUpdateCartUI = forceUpdateCartUI;
        window.setupSimpleCartEventListeners = setupSimpleCartEventListeners;
        
        // Test functions for debugging
        window.testCartCount = function() {
            console.log('üß™ Testing cart count...');
            console.log('Current cart:', window.cart);
            
            // Simulate cart with items
            window.cart = [{quantity: 2}, {quantity: 1}];
            console.log('Updated cart:', window.cart);
            
            // Only update badge if script.js is not available
            if (typeof window.updateCartUI !== 'function') {
                updateCartBadge();
            } else {
                console.log('üéØ Delegating badge update to script.js (test case)');
            }
            console.log('‚úÖ Cart count test completed');
        };
        
        // Test cart button functionality
        window.testCartButtons = function() {
            console.log('üß™ Testing cart buttons...');
            const decreaseBtns = document.querySelectorAll('.decrease-qty');
            const increaseBtns = document.querySelectorAll('.increase-qty');
            const removeBtns = document.querySelectorAll('.remove-item');
            
            console.log('Found buttons:', {
                decrease: decreaseBtns.length,
                increase: increaseBtns.length,
                remove: removeBtns.length
            });
            
            // Test click on first increase button if it exists
            if (increaseBtns.length > 0) {
                console.log('üîº Simulating click on first increase button...');
                increaseBtns[0].click();
            }
        };
        
        // Removed testAddToCart function - use script.js addToCart instead
        
        // Toggle cart sidebar
        window.toggleCart = function() {
            console.log('üõí toggleCart called');
            
            const cartSidebar = document.getElementById('cartSidebar');
            const cartOverlay = document.getElementById('cartOverlay');
            
            console.log('üõí Cart elements found:', {
                sidebar: !!cartSidebar,
                overlay: !!cartOverlay,
                sidebarElement: cartSidebar,
                overlayElement: cartOverlay
            });
            
            if (cartSidebar && cartOverlay) {
                const isActive = cartSidebar.classList.contains('active');
                console.log('üõí Current cart state:', { isActive });
                
                if (isActive) {
                    cartSidebar.classList.remove('active');
                    cartOverlay.classList.remove('active');
                    console.log('‚úÖ Cart closed');
                } else {
                    cartSidebar.classList.add('active');
                    cartOverlay.classList.add('active');
                    
                    // Handle cart loading based on user status
                    if (window.currentUser) {
                        console.log('üîÑ User logged in - syncing cart from database');
                        syncCartFromDatabase();
                    } else {
                        console.log('üë§ Guest user - loading cart from localStorage');
                        // For guest users, load from localStorage and delegate to script.js if available
                        if (typeof window.loadCartFromStorage === 'function') {
                            window.loadCartFromStorage();
                            // Also sync with local cart for shop.ejs compatibility
                            setTimeout(() => {
                                if (window.cartItems) {
                                    cart = window.cartItems;
                                    console.log('üì¶ Synced cart from script.js:', cart.length, 'items');
                                    renderCart();
                                    updateCartBadge();
                                    
                                    // Force update mobile cart count for guest users
                                    const mobileCartCount = document.getElementById('mobileCartCount');
                                    if (mobileCartCount && window.cartCount !== undefined) {
                                        mobileCartCount.textContent = window.cartCount;
                                        console.log('üì± Updated mobile cart count for guest:', window.cartCount);
                                    }
                                }
                            }, 100);
                        } else {
                            // Fallback: load from localStorage directly
                            const savedCart = localStorage.getItem('techHavenCart');
                            const savedCount = localStorage.getItem('techHavenCartCount');
                            
                            if (savedCart) {
                                try {
                                    const parsedCart = JSON.parse(savedCart);
                                    cart = parsedCart;
                                    console.log('üì¶ Guest cart loaded from localStorage:', cart.length, 'items');
                                } catch (e) {
                                    console.error('‚ùå Error parsing saved cart:', e);
                                    cart = [];
                                }
                            } else {
                                cart = [];
                            }
                            
                            // Update UI
                            renderCart();
                            updateCartBadge();
                        }
                    }
                    
                    console.log('‚úÖ Cart opened - classes added');
                    
                    // Extra debug - check actual styles
                    setTimeout(() => {
                        const sidebarStyles = window.getComputedStyle(cartSidebar);
                        console.log('üé® Cart sidebar computed styles:', {
                            right: sidebarStyles.right,
                            display: sidebarStyles.display,
                            visibility: sidebarStyles.visibility,
                            zIndex: sidebarStyles.zIndex
                        });
                    }, 100);
                }
            } else {
                console.error('‚ùå Cart elements not found!');
                if (!cartSidebar) console.error('‚ùå cartSidebar not found');
                if (!cartOverlay) console.error('‚ùå cartOverlay not found');
            }
        };
        
        // Debug function for testing mobile cart
        window.testMobileCart = function() {
            console.log('üß™ Testing mobile cart functionality...');
            console.log('üîç Current user:', window.currentUser ? window.currentUser.uid : 'guest');
            console.log('üîç Cart elements:', {
                sidebar: !!document.getElementById('cartSidebar'),
                overlay: !!document.getElementById('cartOverlay'),
                mobileLink: !!document.getElementById('mobileCartLink'),
                mobileCount: !!document.getElementById('mobileCartCount')
            });
            console.log('üîç Cart data:', {
                localCart: cart.length,
                scriptCart: window.cartItems ? window.cartItems.length : 'undefined',
                localStorage: localStorage.getItem('techHavenCart') ? JSON.parse(localStorage.getItem('techHavenCart')).length : 0
            });
            
            // Test toggle function
            console.log('üß™ Testing toggleCart...');
            toggleCart();
        };
        
        // Hook into checkout modal opening to load coupons
        function hookCheckoutModal() {
            console.log('  Setting up checkout modal hooks...');
            
            // Method 1: Override the original proceedToCheckout
            const originalProceedToCheckout = window.proceedToCheckout;
            window.proceedToCheckout = function() {
                console.log('üõí Shop: Enhanced proceedToCheckout called');
                console.log('üîç originalProceedToCheckout exists:', !!originalProceedToCheckout);
                console.log('üîç Modal element exists:', !!document.getElementById('checkoutModal'));
                
                // FORCE RELOAD CART FROM LOCALSTORAGE FOR GUEST USERS
                if (!window.currentUser) {
                    console.log('üë§ Guest user - force reloading cart from localStorage');
                    const savedCart = localStorage.getItem('techHavenCart');
                    if (savedCart) {
                        try {
                            cart = JSON.parse(savedCart);
                            console.log('üîÑ Reloaded cart from localStorage:', cart.length, 'items');
                            // Also update global cartItems
                            window.cartItems = cart;
                            window.cart = cart;
                        } catch (e) {
                            console.error('‚ùå Failed to parse cart from localStorage:', e);
                            cart = [];
                        }
                    } else {
                        cart = [];
                        console.log('üì≠ No cart found in localStorage');
                    }
                    
                    // Update cart count from localStorage
                    const savedCount = localStorage.getItem('techHavenCartCount');
                    if (savedCount) {
                        window.cartCount = parseInt(savedCount) || 0;
                    }
                } else {
                    console.log('üîê Logged user - using Firebase cart');
                }
                
                // Call the original function first
                if (originalProceedToCheckout) {
                    console.log('‚úÖ Calling original proceedToCheckout');
                    originalProceedToCheckout();
                } else {
                    console.log('‚ö†Ô∏è Original proceedToCheckout not found, using fallback');
                    // Fallback: Open modal directly and handle the complete checkout process
                    const checkoutModal = document.getElementById('checkoutModal');
                    if (checkoutModal) {
                        // Check if cart has items
                        if (cart.length === 0) {
                            alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!');
                            return;
                        }
                        
                        checkoutModal.style.display = 'flex';
                        document.body.style.overflow = 'hidden'; // Prevent background scrolling
                        console.log('‚úÖ Opened checkout modal via fallback');
                        
                        // Update order summary
                        updateOrderSummaryInModal();
                        
                        // Fill user information if logged in
                        if (typeof fillUserInformationIfLoggedIn === 'function') {
                            fillUserInformationIfLoggedIn();
                        } else if (window.currentUser) {
                            console.log('‚ö†Ô∏è fillUserInformationIfLoggedIn not found, using basic fill');
                            // Basic user info fill
                            const customerName = document.getElementById('customerName');
                            const customerEmail = document.getElementById('customerEmail');
                            const customerPhone = document.getElementById('customerPhone');
                            
                            if (customerName && window.currentUser.name) {
                                customerName.value = window.currentUser.name;
                                customerName.disabled = true;
                                customerName.style.backgroundColor = '#f8f9fa';
                                customerName.style.color = '#6c757d';
                            }
                            if (customerEmail && window.currentUser.email) {
                                customerEmail.value = window.currentUser.email;
                                customerEmail.disabled = true;
                                customerEmail.style.backgroundColor = '#f8f9fa';
                                customerEmail.style.color = '#6c757d';
                            }
                            if (customerPhone && window.currentUser.phone) {
                                customerPhone.value = window.currentUser.phone;
                                customerPhone.disabled = true;
                                customerPhone.style.backgroundColor = '#f8f9fa';
                                customerPhone.style.color = '#6c757d';
                            }
                        }
                    } else {
                        console.error('‚ùå Checkout modal not found!');
                        return;
                    }
                }
                
                // Then load coupons and initialize coin section after a small delay to ensure modal is open
                setTimeout(async () => {
                    console.log('üìß Shop: Loading available coupons...');
                    loadAvailableCoupons();
                    
                    // Initialize coin section if user is logged in
                    if (window.currentUser && window.currentUser.uid) {
                        console.log('üí∞ Initializing coin section for user:', window.currentUser.uid);
                        
                        // Calculate order total
                        const subtotalElement = document.getElementById('subtotalAmount');
                        let orderTotal = 0;
                        if (subtotalElement) {
                            const subtotalText = subtotalElement.textContent.replace(/[^\d]/g, '');
                            orderTotal = parseInt(subtotalText) || 0;
                        }
                        
                        // Initialize coin section
                        if (typeof initializeCoinSection === 'function') {
                            await initializeCoinSection(window.currentUser.uid, orderTotal);
                        } else {
                            console.warn('‚ö†Ô∏è initializeCoinSection function not found');
                        }
                    } else {
                        console.log('‚ÑπÔ∏è User not logged in, skipping coin section initialization');
                    }
                }, 100);
            };
            
            // Method 2: Watch for modal visibility changes
            const checkoutModal = document.getElementById('checkoutModal');
            if (checkoutModal) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(async function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            const isVisible = checkoutModal.style.display === 'flex' || 
                                            checkoutModal.classList.contains('active');
                            if (isVisible) {
                                console.log('üëÄ Checkout modal opened, loading coupons...');
                                loadAvailableCoupons();
                                
                                // Initialize coin section if user is logged in
                                if (window.currentUser && window.currentUser.uid) {
                                    console.log('üí∞ Initializing coin section for user:', window.currentUser.uid);
                                    
                                    // Calculate order total
                                    const subtotalElement = document.getElementById('subtotalAmount');
                                    let orderTotal = 0;
                                    if (subtotalElement) {
                                        const subtotalText = subtotalElement.textContent.replace(/[^\d]/g, '');
                                        orderTotal = parseInt(subtotalText) || 0;
                                    }
                                    
                                    // Initialize coin section
                                    if (typeof initializeCoinSection === 'function') {
                                        await initializeCoinSection(window.currentUser.uid, orderTotal);
                                    } else {
                                        console.warn('‚ö†Ô∏è initializeCoinSection function not found');
                                    }
                                }
                            }
                        }
                    });
                });
                
                observer.observe(checkoutModal, { attributes: true });
                console.log('üëÅÔ∏è Modal observer set up');
                
                // Method 3: Add event listener to email field for guest checkout
                const customerEmailField = document.getElementById('customerEmail');
                if (customerEmailField) {
                    // Debounce function to avoid too many requests
                    let emailTimeout;
                    
                    // Email validation helper function
                    function isValidEmail(email) {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        return email && emailRegex.test(email);
                    }
                    
                    customerEmailField.addEventListener('input', function() {
                        clearTimeout(emailTimeout);
                        
                        emailTimeout = setTimeout(() => {
                            const email = this.value.trim();
                            console.log('üìß Email field changed:', email);
                            
                            // Only reload coupons if modal is open and email is valid
                            const modalVisible = checkoutModal.style.display === 'flex' || 
                                               checkoutModal.classList.contains('active');
                            
                            if (modalVisible && email && isValidEmail(email)) {
                                console.log('üîÑ Reloading coupons for valid email:', email);
                                loadAvailableCoupons();
                            }
                        }, 800); // Wait 800ms after user stops typing
                    });
                    
                    console.log('üìß Email field event listener added');
                }
            }
        }

        // Initialize checkout modal hooks when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè™ Shop page DOM loaded, setting up coupon system...');
            
            // Wait longer for script.js to load, with multiple checks
            let checkCount = 0;
            const maxChecks = 10;
            
            const checkAndHook = () => {
                checkCount++;
                console.log(`üîÑ Checking for script.js (attempt ${checkCount}/${maxChecks})`);
                
                if (window.scriptJsLoaded || typeof window.proceedToCheckout === 'function') {
                    console.log('‚úÖ script.js detected, setting up checkout hooks');
                    hookCheckoutModal();
                } else if (checkCount < maxChecks) {
                    console.log('‚è≥ script.js not ready yet, retrying...');
                    setTimeout(checkAndHook, 500);
                } else {
                    console.log('‚ö†Ô∏è script.js still not detected after max attempts, setting up anyway');
                    hookCheckoutModal();
                }
            };
            
            checkAndHook();
        });
        
        // Update order summary in checkout modal (fallback function)
        function updateOrderSummaryInModal() {
            console.log('üìä Updating order summary in modal...');
            
            const orderSummaryItems = document.getElementById('orderSummaryItems');
            const subtotalAmount = document.getElementById('subtotalAmount');
            const finalTotal = document.getElementById('finalTotal');
            
            if (!orderSummaryItems) {
                console.log('‚ö†Ô∏è Order summary elements not found');
                return;
            }
            
            // Clear existing items
            orderSummaryItems.innerHTML = '';
            
            // Add cart items
            let subtotal = 0;
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'order-item';
                
                const itemName = item.name || item.productName || 'Unknown Product';
                const itemQuantity = item.quantity || 1;
                const itemPrice = parseFloat(item.price) || parseFloat(item.numericPrice) || 0;
                const itemTotal = itemPrice * itemQuantity;
                subtotal += itemTotal;
                
                itemElement.innerHTML = `
                    <span class="order-item-name">${itemName} x${itemQuantity}</span>
                    <span class="order-item-price">${new Intl.NumberFormat('vi-VN').format(itemTotal)} VNƒê</span>
                `;
                orderSummaryItems.appendChild(itemElement);
            });
            
            // Update totals
            const shipping = subtotal > 0 ? 50000 : 0;
            const total = subtotal + shipping;
            
            if (subtotalAmount) {
                subtotalAmount.textContent = new Intl.NumberFormat('vi-VN').format(subtotal) + ' VNƒê';
            }
            if (finalTotal) {
                finalTotal.textContent = new Intl.NumberFormat('vi-VN').format(total) + ' VNƒê';
            }
            
            console.log(`‚úÖ Order summary updated: ${cart.length} items, subtotal: ${subtotal}`);
        }
        
        // Populate order summary in checkout modal
        function populateOrderSummary() {
            const orderSummaryItems = document.getElementById('orderSummaryItems');
            
            if (!orderSummaryItems) return;
            
            let html = '';
            cart.forEach(item => {
                html += `
                    <div class="order-item">
                        <span>${item.productName} √ó ${item.quantity}</span>
                        <span>${formatPrice(item.total)}</span>
                    </div>
                `;
            });
            
            orderSummaryItems.innerHTML = html;
        }
        
        // Close checkout modal
        window.closeCheckoutModal = function() {
            const checkoutModal = document.getElementById('checkoutModal');
            if (checkoutModal) {
                checkoutModal.style.display = 'none';
            }
        };
        
        // Complete order with VNPay support
        window.completeOrder = async function() {
            console.log('üõí Completing order from shop.ejs...');
            
            if (cart.length === 0) {
                showNotification('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng', 'warning');
                return;
            }

            // Get payment method
            const paymentMethodEl = document.querySelector('input[name="paymentMethod"]:checked');
            const paymentMethod = paymentMethodEl ? paymentMethodEl.value : 'cod';
            
            console.log('üí≥ Selected payment method:', paymentMethod);
            
            // Check if payment method is VNPay
            if (paymentMethod === 'vnpay') {
                // Allow VNPay for both logged users and guest users with OTP verification
                if (!window.currentUser) {
                    console.log('üîë VNPay guest checkout - checking OTP verification...');
                    
                    // Get customer email from checkout form
                    const customerEmailField = document.getElementById('customerEmail');
                    const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                    
                    if (!customerEmail) {
                        showNotification('Vui l√≤ng nh·∫≠p email ƒë·ªÉ s·ª≠ d·ª•ng VNPay', 'warning');
                        return;
                    }
                    
                    // Email validation helper function
                    if (typeof isValidEmail === 'undefined') {
                        window.isValidEmail = function(email) {
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            return email && emailRegex.test(email);
                        };
                    }
                    
                    if (!isValidEmail(customerEmail)) {
                        showNotification('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá ƒë·ªÉ s·ª≠ d·ª•ng VNPay', 'warning');
                        return;
                    }
                    
                    // Check OTP verification status for guest users
                    try {
                        const normalizedEmail = customerEmail.toLowerCase().trim();
                        const otpResponse = await fetch(`/api/guest-checkout/otp-status/${encodeURIComponent(normalizedEmail)}`);
                        const otpData = await otpResponse.json();
                        
                        if (!otpData.success || !otpData.verified) {
                            // OTP not verified, show OTP modal
                            showNotification('Vui l√≤ng x√°c th·ª±c email ƒë·ªÉ s·ª≠ d·ª•ng VNPay thanh to√°n', 'info');
                            showOtpModal(customerEmail);
                            
                            // Store payment method for after OTP verification
                            sessionStorage.setItem('pendingVNPayPayment', 'true');
                            return;
                        }
                        
                        console.log('‚úÖ Guest OTP verified, proceeding with VNPay payment');
                    } catch (error) {
                        console.error('‚ùå Error checking OTP status:', error);
                        showNotification('L·ªói ki·ªÉm tra x√°c th·ª±c. Vui l√≤ng th·ª≠ l·∫°i', 'error');
                        return;
                    }
                }
                
                console.log('üí≥ Processing VNPay payment for', window.currentUser ? 'logged user' : 'guest user');
                
                // Calculate order totals with discount
                const subtotal = calculateCartSubtotal();
                const shippingFee = 50000;
                const finalTotal = subtotal - discountAmount + shippingFee;
                
                // Get customer info for both logged users and guest users
                let customerInfo;
                let userId;
                let orderInfo;
                
                if (window.currentUser) {
                    // Logged user
                    userId = window.currentUser.uid;
                    orderInfo = `Thanh toan don hang Tech Haven - ${window.currentUser.displayName || window.currentUser.email}`;
                    customerInfo = {
                        name: window.currentUser.displayName || 'Customer',
                        phone: window.currentUser.phoneNumber || '',
                        email: window.currentUser.email,
                        address: 'Shop checkout',
                        city: 'N/A',
                        district: 'N/A'
                    };
                } else {
                    // Guest user - get data from checkout form
                    const customerNameField = document.getElementById('customerName');
                    const customerPhoneField = document.getElementById('customerPhone');
                    const customerEmailField = document.getElementById('customerEmail');
                    
                    const customerName = customerNameField ? customerNameField.value.trim() : '';
                    const customerPhone = customerPhoneField ? customerPhoneField.value.trim() : '';
                    const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                    
                    userId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    orderInfo = `Thanh toan don hang Tech Haven - ${customerName || customerEmail}`;
                    customerInfo = {
                        name: customerName || 'Guest Customer',
                        phone: customerPhone,
                        email: customerEmail,
                        address: 'Shop checkout (Guest)',
                        city: 'N/A',
                        district: 'N/A'
                    };
                }
                
                // Get guest temp address from localStorage if exists
                let guestTempAddress = null;
                if (!window.currentUser) {
                    const storedAddress = localStorage.getItem('guestTempAddress');
                    if (storedAddress) {
                        try {
                            guestTempAddress = JSON.parse(storedAddress);
                            console.log('üìç Found guest temp address:', guestTempAddress);
                        } catch (e) {
                            console.error('Error parsing guest temp address:', e);
                        }
                    }
                }
                
                const paymentData = {
                    amount: finalTotal,
                    orderInfo: orderInfo,
                    orderType: 'billpayment',
                    userId: userId,
                    cartData: cart.map(item => ({
                        productId: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity || 1,
                        image: item.image || item.imageUrl
                    })),
                    customerInfo: customerInfo,
                    guestTempAddress: guestTempAddress,
                    discountCode: appliedDiscountCode ? appliedDiscountCode.code : null,
                    discountAmount: discountAmount,
                    isGuestCheckout: !window.currentUser
                };
                
                try {
                    console.log('üîÑ Creating VNPay payment URL...');
                    
                    // Show loading
                    const loadingOverlay = document.createElement('div');
                    loadingOverlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10001;
                        color: white;
                        font-size: 1.2rem;
                    `;
                    loadingOverlay.innerHTML = `
                        <div style="text-align: center;">
                            <div style="width: 50px; height: 50px; border: 3px solid #fff; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                            <div>ƒêang chuy·ªÉn ƒë·∫øn VNPay...</div>
                        </div>
                    `;
                    
                    // Add spin animation
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                    document.body.appendChild(loadingOverlay);
                    
                    const response = await fetch('/api/vnpay/create-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    const result = await response.json();
                    
                    // Remove loading
                    document.body.removeChild(loadingOverlay);
                    document.head.removeChild(style);
                    
                    if (result.success) {
                        console.log('‚úÖ VNPay URL created, redirecting...');
                        // Close checkout modal before redirect
                        closeCheckoutModal();
                        // Redirect to VNPay
                        window.location.href = result.paymentUrl;
                        return;
                    } else {
                        console.error('‚ùå VNPay payment creation failed:', result);
                        showNotification('L·ªói t·∫°o thanh to√°n VNPay: ' + (result.message || 'Unknown error'), 'error');
                        return;
                    }
                } catch (error) {
                    console.error('‚ùå VNPay payment error:', error);
                    // Remove loading on error
                    const loadingOverlay = document.querySelector('[style*="rgba(0,0,0,0.8)"]');
                    if (loadingOverlay) {
                        try {
                            document.body.removeChild(loadingOverlay);
                        } catch (e) {
                            // Ignore if already removed
                        }
                    }
                    showNotification('L·ªói k·∫øt n·ªëi VNPay: ' + error.message, 'error');
                    return;
                }
            }
            
            // Continue with normal payment flow for other payment methods
            console.log('üí∞ Processing normal payment flow for', window.currentUser ? 'logged user' : 'guest user');
            
            // For guest users, require OTP verification for all payment methods
            if (!window.currentUser) {
                console.log('üîë Guest checkout - checking OTP verification...');
                
                const customerEmailField = document.getElementById('customerEmail');
                const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                
                if (!customerEmail) {
                    showNotification('Vui l√≤ng nh·∫≠p email ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng', 'warning');
                    return;
                }
                
                // Email validation helper function
                if (typeof isValidEmail === 'undefined') {
                    window.isValidEmail = function(email) {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        return email && emailRegex.test(email);
                    };
                }
                
                if (!isValidEmail(customerEmail)) {
                    showNotification('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá', 'warning');
                    return;
                }
                
                // Check OTP verification status for guest users
                try {
                    const normalizedEmail = customerEmail.toLowerCase().trim();
                    const otpResponse = await fetch(`/api/guest-checkout/otp-status/${encodeURIComponent(normalizedEmail)}`);
                    const otpData = await otpResponse.json();
                    
                    if (!otpData.success || !otpData.verified) {
                        // OTP not verified, show OTP modal
                        showNotification('Vui l√≤ng x√°c th·ª±c email ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng', 'info');
                        showOtpModal(customerEmail);
                        
                        // Store payment method for after OTP verification
                        sessionStorage.setItem('pendingPayment', paymentMethod);
                        return;
                    }
                    
                    console.log('‚úÖ Guest OTP verified, proceeding with checkout');
                } catch (error) {
                    console.error('‚ùå Error checking OTP status:', error);
                    showNotification('L·ªói ki·ªÉm tra x√°c th·ª±c. Vui l√≤ng th·ª≠ l·∫°i', 'error');
                    return;
                }
            }
            
            try {
                // Calculate order totals with discount
                const subtotal = calculateCartSubtotal();
                const shippingFee = 50000;
                const finalTotal = subtotal - discountAmount + shippingFee;
                
                // Get user ID for both logged and guest users
                let userId;
                if (window.currentUser) {
                    userId = window.currentUser.uid;
                } else {
                    const customerEmailField = document.getElementById('customerEmail');
                    const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                    userId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                }
                
                // Prepare order data with discount information
                const orderData = {
                    userId: userId,
                    items: cart,
                    subtotal: subtotal,
                    shippingFee: shippingFee,
                    discountCode: appliedDiscountCode ? appliedDiscountCode.code : null,
                    discountAmount: discountAmount,
                    finalTotal: finalTotal,
                    timestamp: new Date().toISOString(),
                    isGuestCheckout: !window.currentUser
                };
                
                console.log('üì¶ Order data:', orderData);
                
                // If user used a discount code, track it in Firebase
                if (appliedDiscountCode) {
                    console.log('üí´ Tracking coupon usage for:', appliedDiscountCode.code);
                    
                    const couponUsageResponse = await fetch('/api/coupons/use', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: appliedDiscountCode.code,
                            userId: userId,
                            orderData: orderData
                        })
                    });

                    if (!couponUsageResponse.ok) {
                        const error = await couponUsageResponse.json();
                        throw new Error(error.error || 'Failed to use coupon');
                    }
                    
                    console.log('‚úÖ Coupon usage tracked successfully');
                }
                
                // Clear cart from Firebase (only for logged users)
                if (window.currentUser) {
                    const response = await fetch(`/api/cart/user/${window.currentUser.uid}`, {
                        method: 'DELETE'
                    });
                } else {
                    // For guest users, clear cart from localStorage and UI
                    const response = { ok: true };
                }
                
                if (response.ok) {
                    let successMessage = 'üéâ Thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng.';
                    if (appliedDiscountCode) {
                        successMessage += ` B·∫°n ƒë√£ ti·∫øt ki·ªám ${formatPrice(discountAmount)} t·ª´ m√£ gi·∫£m gi√° ${appliedDiscountCode.code}.`;
                    }
                    
                    // Show Lottie congratulations animation for normal payment
                    console.log('üéâ Showing congratulation animation for normal payment');
                    if (typeof window.showCongratulationAnimation === 'function') {
                        try {
                            showCongratulationAnimation(() => {
                                console.log('‚úÖ Normal payment congratulation animation completed');
                                // Show success notification after animation
                                showNotification(successMessage, 'success');
                            });
                        } catch (error) {
                            console.error('‚ùå Error showing congratulation animation:', error);
                            // Fallback: show notification without animation
                            showNotification(successMessage, 'success');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è showCongratulationAnimation function not available, showing notification directly');
                        // Fallback: show notification without animation
                        showNotification(successMessage, 'success');
                    }
                    
                    // Reset discount code
                    removeDiscountCode();
                    
                    // Close checkout modal and cart
                    closeCheckoutModal();
                    // Refresh cart - delegate to script.js
                    if (typeof window.updateCartUI === 'function') {
                        window.updateCartUI();
                    }
                    toggleCart(); // Close cart sidebar
                    
                    // Reload available coupons (to hide used ones)
                    setTimeout(() => {
                        loadAvailableCoupons();
                    }, 1000);
                    
                } else {
                    throw new Error('Failed to process order');
                }
                
            } catch (error) {
                console.error('‚ùå Error completing order:', error);
                showNotification(`Kh√¥ng th·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng: ${error.message}`, 'error');
            }
        };

        // Admin dropdown handler for mobile menu
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Shop page DOM loaded');
            
            // Load cart if user is already logged in (from localStorage or Firebase Auth)
            setTimeout(() => {
                if (window.currentUser) {
                    console.log('üõí User already logged in, loading cart on page load');
                    // Delegate to script.js
                    if (typeof window.updateCartUI === 'function') {
                        window.updateCartUI();
                    }
                }
            }, 500);
            
            // Test cart elements immediately
            setTimeout(() => {
                const cartSidebar = document.getElementById('cartSidebar');
                const cartOverlay = document.getElementById('cartOverlay');
                const cartIcon = document.getElementById('cartIcon');
                
                console.log('üß™ Testing cart elements:', {
                    cartSidebar: !!cartSidebar,
                    cartOverlay: !!cartOverlay, 
                    cartIcon: !!cartIcon,
                    cartSidebarHTML: cartSidebar ? 'Found' : 'Not found',
                    cartOverlayHTML: cartOverlay ? 'Found' : 'Not found'
                });
                
                if (cartSidebar) {
                    console.log('üé® Cart sidebar initial styles:', {
                        display: cartSidebar.style.display,
                        right: cartSidebar.style.right,
                        classes: cartSidebar.className
                    });
                }
            }, 500);
            
            // Initialize shop functionality
            initializeShop();
            
            // Setup admin dropdown
            const adminDropdown = document.querySelector('.admin-dropdown');
            const dropdownToggle = document.querySelector('.admin-dropdown .dropdown-toggle');
            
            if (dropdownToggle) {
                dropdownToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Toggle dropdown
                    adminDropdown.classList.toggle('active');
                    
                    console.log('üîß Admin dropdown toggled:', adminDropdown.classList.contains('active'));
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (adminDropdown && !adminDropdown.contains(e.target)) {
                    adminDropdown.classList.remove('active');
                }
            });
            
            // Setup cart icon click handler with delay to ensure DOM is ready
            setTimeout(() => {
                const cartIcon = document.getElementById('cartIcon');
                const mobileCartLink = document.getElementById('mobileCartLink');
                
                console.log('üîç Looking for cart elements after delay...');
                console.log('Cart icon element:', cartIcon);
                console.log('Mobile cart link element:', mobileCartLink);
                console.log('Cart icon found:', !!cartIcon);
                console.log('Mobile cart link found:', !!mobileCartLink);
                
                if (cartIcon) {
                    console.log('‚úÖ Cart icon found, adding event listener');
                    
                    // Remove any existing event listeners by cloning the element
                    const cartIconClone = cartIcon.cloneNode(true);
                    cartIcon.parentNode.replaceChild(cartIconClone, cartIcon);
                    
                    // Add fresh event listener
                    cartIconClone.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üñ±Ô∏è Cart icon clicked from delayed setup');
                        toggleCart();
                    });
                    
                    // Also add event listener to the shopping cart icon inside
                    const cartIconInner = cartIconClone.querySelector('i.fa-shopping-cart');
                    if (cartIconInner) {
                        cartIconInner.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('üñ±Ô∏è Cart icon inner clicked');
                            toggleCart();
                        });
                    }
                    
                } else {
                    console.error('‚ùå Cart icon still not found after delay');
                }
                
                if (mobileCartLink) {
                    console.log('‚úÖ Mobile cart link found, adding event listener');
                    
                    // Remove any existing event listeners by cloning
                    const mobileCartClone = mobileCartLink.cloneNode(true);
                    mobileCartLink.parentNode.replaceChild(mobileCartClone, mobileCartLink);
                    
                    // Add fresh event listener
                    mobileCartClone.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üì± Mobile cart link clicked from event listener');
                        
                        // Use same pattern as TEST MOBILE CART button
                        if (window.testMobileCart) {
                            console.log('‚úÖ Using testMobileCart function');
                            window.testMobileCart();
                        } else {
                            console.log('‚ùå testMobileCart not available, calling toggleCart directly');
                            toggleCart();
                        }
                    });
                } else {
                    console.error('‚ùå Mobile cart link not found after delay');
                }
            }, 1000); // Wait 1 second to ensure everything is loaded
            
            // Backup event delegation for cart icon clicks
            document.body.addEventListener('click', function(e) {
                // Check if clicked element is cart icon or its children
                const cartIconWrapper = e.target.closest('.cart-icon-wrapper');
                if (cartIconWrapper && cartIconWrapper.id === 'cartIcon') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üñ±Ô∏è Cart icon clicked via event delegation');
                    toggleCart();
                    return;
                }
                
                // Check if clicked element is mobile cart link
                const mobileCartLink = e.target.closest('#mobileCartLink');
                if (mobileCartLink) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üì± Mobile cart link clicked via delegation');
                    toggleCart();
                    return;
                }
                
                // Check if clicked on cart badge or cart icon specifically
                if (e.target.classList.contains('fa-shopping-cart') || 
                    e.target.id === 'cartBadge' ||
                    e.target.id === 'mobileCartCount' ||
                    e.target.closest('#cartIcon') ||
                    e.target.closest('#mobileCartLink')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üñ±Ô∏è Cart element clicked via delegation');
                    toggleCart();
                    return;
                }
            });
            
            // Setup cart overlay click to close
            const cartOverlay = document.getElementById('cartOverlay');
            if (cartOverlay) {
                cartOverlay.addEventListener('click', function() {
                    toggleCart();
                });
            }
        });

        // =====================================
        // DISCOUNT CODE FUNCTIONALITY - FIREBASE INTEGRATION
        // =====================================

        let availableCoupons = [];
        let appliedDiscountCode = null;
        let discountAmount = 0;

        // Load available coupons from Firebase
        async function loadAvailableCoupons() {
            try {
                console.log('üìß Loading available coupons from Firebase...');
                
                // Get user info from localStorage if available
                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = storedUser.uid || (window.currentUser && window.currentUser.uid);
                
                // Get email from form for guest checkout
                const customerEmailField = document.getElementById('customerEmail');
                const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                
                // Build URL with userId parameter if user is logged in
                let url = '/api/coupons/available';
                if (userId) {
                    url += `?userId=${userId}`;
                    console.log('üë§ Loading coupons for user:', userId);
                } else {
                    console.log('üë§ Loading coupons for anonymous user');
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã Response data:', data);
                    
                    if (data.success && data.coupons) {
                        console.log('üé´ Raw coupons from API:', data.coupons);
                        
                        // Get used coupons if valid email is provided for guest checkout
                        let usedCoupons = [];
                        
                        // Email validation helper function (if not already defined)
                        if (typeof isValidEmail === 'undefined') {
                            window.isValidEmail = function(email) {
                                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                return email && emailRegex.test(email);
                            };
                        }
                        
                        if (customerEmail && !userId && isValidEmail(customerEmail)) { // Only check for guest users with valid email
                            try {
                                // Normalize email to lowercase to handle case sensitivity
                                const normalizedEmail = customerEmail.toLowerCase().trim();
                                console.log('üìß Checking used coupons for email:', customerEmail, '-> normalized:', normalizedEmail);
                                const usageResponse = await fetch(`/api/coupon-usage/check-by-email?email=${encodeURIComponent(normalizedEmail)}`);
                                if (usageResponse.ok) {
                                    const usageData = await usageResponse.json();
                                    if (usageData.success) {
                                        usedCoupons = usageData.usedCoupons || [];
                                        console.log('üö´ Used coupons:', usedCoupons);
                                    }
                                }
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Error checking used coupons:', error);
                                // Continue with all coupons if check fails
                            }
                        }
                        
                        // Extract used coupon IDs for filtering
                        const usedCouponIds = usedCoupons.map(used => used.couponId);
                        
                        availableCoupons = data.coupons.filter(coupon => {
                            // Additional client-side validation
                            const now = new Date();
                            const expiredDate = coupon.expiredDate ? new Date(coupon.expiredDate) : null;
                            const isNotExpired = !expiredDate || now <= expiredDate;
                            const isActive = coupon.usedCount < coupon.usageLimit;
                            const isNotUsed = !usedCouponIds.includes(coupon.id);
                            
                            console.log(`üé´ Coupon ${coupon.code}: active=${isActive}, notExpired=${isNotExpired}, notUsed=${isNotUsed}`);
                            return isActive && isNotExpired && isNotUsed;
                        });
                        
                        console.log('‚úÖ Filtered coupons:', availableCoupons);
                        console.log('üé® Calling renderDiscountCodes...');
                        renderDiscountCodes();
                    } else {
                        console.warn('‚ö†Ô∏è No coupons found or API error:', data);
                        availableCoupons = [];
                        renderDiscountCodes();
                    }
                } else {
                    const errorData = await response.text();
                    console.error('‚ùå Failed to load coupons. Status:', response.status);
                    console.error('‚ùå Error details:', errorData);
                    
                    // Show error in UI
                    const discountCodesContainer = document.getElementById('discountCodesContainer');
                    if (discountCodesContainer) {
                        discountCodesContainer.innerHTML = `
                            <div class="coupon-error">
                                <p><i class="fas fa-exclamation-triangle"></i> Kh√¥ng th·ªÉ t·∫£i m√£ gi·∫£m gi√°</p>
                                <button onclick="loadAvailableCoupons()" class="retry-btn">
                                    <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                                </button>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading coupons:', error);
                availableCoupons = [];
                renderDiscountCodes();
                
                // Show error in UI
                const discountCodesContainer = document.getElementById('discountCodesContainer');
                if (discountCodesContainer) {
                    discountCodesContainer.innerHTML = `
                        <div class="coupon-error">
                            <p><i class="fas fa-exclamation-triangle"></i> L·ªói khi t·∫£i m√£ gi·∫£m gi√°</p>
                            <button onclick="loadAvailableCoupons()" class="retry-btn">
                                <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Render discount codes from database
        function renderDiscountCodes() {
            console.log('üé® renderDiscountCodes called with', availableCoupons.length, 'coupons');
            
            const discountCodesList = document.getElementById('discountCodesList');
            if (!discountCodesList) {
                console.error('‚ùå discountCodesList element not found');
                return;
            }

            console.log('üìã discountCodesList element found:', discountCodesList);

            if (availableCoupons.length === 0) {
                console.log('üö´ No coupons available, showing empty message');
                
                // Check if user email is provided (for different messaging)
                const customerEmailField = document.getElementById('customerEmail');
                const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                const isLoggedIn = storedUser.uid || (window.currentUser && window.currentUser.uid);
                
                let message = 'Hi·ªán t·∫°i kh√¥ng c√≥ m√£ gi·∫£m gi√° kh·∫£ d·ª•ng';
                if (!isLoggedIn && customerEmail && isValidEmail(customerEmail)) {
                    message = 'T·∫•t c·∫£ m√£ gi·∫£m gi√° kh·∫£ d·ª•ng ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng v·ªõi email n√†y';
                }
                
                discountCodesList.innerHTML = `
                    <div class="no-coupons-message" style="text-align: center; padding: 20px; color: #6b7280;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        <p>${message}</p>
                    </div>
                `;
                return;
            }

            console.log('‚ú® Rendering', availableCoupons.length, 'coupons...');

            const couponsHTML = availableCoupons.map(coupon => {
                const discountDisplay = formatDiscount(coupon.discountAmount);
                const expirationInfo = coupon.expiredDate 
                    ? `H·∫øt h·∫°n: ${new Date(coupon.expiredDate).toLocaleDateString('vi-VN')}`
                    : 'Kh√¥ng th·ªùi h·∫°n';
                
                return `
                    <div class="discount-code-item" onclick="selectDiscountCode('${coupon.code}', ${coupon.discountAmount}, '${coupon.id}')">
                        <div class="discount-code-info">
                            <div class="discount-code-title">
                                <i class="fas fa-tag"></i>
                                <strong>${coupon.code}</strong>
                                <span class="discount-badge">${discountDisplay}</span>
                            </div>
                            <div class="discount-code-desc">${coupon.description || 'M√£ gi·∫£m gi√°'}</div>
                            <div class="discount-code-details" style="font-size: 0.9em; color: #6b7280; margin-top: 5px;">
                                <span class="discount-code-id">C√≤n l·∫°i: ${coupon.usageLimit - coupon.usedCount}</span>
                                <span class="discount-expiration" style="margin-left: 10px;">${expirationInfo}</span>
                            </div>
                        </div>
                        <button type="button" class="select-discount-btn" onclick="event.stopPropagation(); selectDiscountCode('${coupon.code}', ${coupon.discountAmount}, '${coupon.id}')">
                            Ch·ªçn
                        </button>
                    </div>
                `;
            }).join('');

            console.log('üîÑ Setting innerHTML with HTML length:', couponsHTML.length);
            discountCodesList.innerHTML = couponsHTML;
            console.log('‚úÖ Coupons rendered successfully');
        }

        // Format discount for display
        function formatDiscount(amount) {
            if (amount >= 1000000) {
                return `-${Math.round(amount/1000000)}M`;
            } else if (amount >= 1000) {
                return `-${Math.round(amount/1000)}K`;
            } else {
                return `-${formatPrice(amount)}`;
            }
        }

        // Validate coupon
        function validateCoupon(coupon) {
            const now = new Date();
            
            // Check if expired
            if (coupon.expiredDate && now > new Date(coupon.expiredDate)) {
                return { valid: false, message: 'M√£ gi·∫£m gi√° ƒë√£ h·∫øt h·∫°n' };
            }
            
            // Check if used up
            if (coupon.usedCount >= coupon.usageLimit) {
                return { valid: false, message: 'M√£ gi·∫£m gi√° ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng' };
            }
            
            return { valid: true, message: 'M√£ h·ª£p l·ªá' };
        }

        // Select discount code from available coupons
        window.selectDiscountCode = function(couponCode, discountValue, couponId) {
            console.log('üé´ Selecting discount code:', couponCode, 'Value:', discountValue, 'ID:', couponId);
            
            // Find the coupon in available coupons to validate it
            const coupon = availableCoupons.find(c => c.id === couponId || c.code === couponCode);
            if (coupon) {
                const validation = validateCoupon(coupon);
                if (!validation.valid) {
                    showNotification(validation.message, 'error');
                    return;
                }
            }
            
            // Apply the discount
            appliedDiscountCode = {
                id: couponId,
                code: couponCode,
                value: discountValue,
                type: 'fixed', // Assuming fixed amount for now
                description: `M√£ gi·∫£m gi√° ${couponCode}`
            };

            // Store for order completion tracking
            window.currentAppliedCoupon = {
                id: couponId,
                code: couponCode,
                discountAmount: discountValue
            };
            
            // Calculate and apply discount
            calculateDiscount();
            showAppliedDiscount();
            updateOrderSummaryWithDiscount();
            
            // Hide discount codes section (close modal/collapse)
            hideDiscountCodes();
            
            showNotification(`ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√° ${couponCode}`, 'success');
        };

        // Format datetime helper
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Apply manual discount code (updated for Firebase validation)
        window.applyManualDiscountCode = async function() {
            const input = document.getElementById('manualDiscountCode');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                showNotification('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!', 'warning');
                return;
            }

            console.log('üîç Validating manual discount code:', code);

            // Check if user is logged in
            const currentUser = window.currentUser;
            if (!currentUser || !currentUser.uid) {
                showNotification('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng m√£ gi·∫£m gi√°!', 'warning');
                input.value = '';
                return;
            }

            try {
                // First check if user has already used this coupon
                console.log('üîç Checking if user already used coupon:', code);
                const usageCheckResponse = await fetch(`/api/coupon-usage/check?userId=${currentUser.uid}&couponCode=${code}`);
                const usageCheckData = await usageCheckResponse.json();
                
                if (usageCheckResponse.ok && usageCheckData.hasUsed) {
                    showNotification('B·∫°n ƒë√£ s·ª≠ d·ª•ng m√£ gi·∫£m gi√° n√†y r·ªìi!', 'error');
                    input.value = '';
                    return;
                }

                // First check in loaded coupons
                const coupon = availableCoupons.find(c => c.code === code);
                if (coupon) {
                    // Validate the coupon
                    const validation = validateCoupon(coupon);
                    if (!validation.valid) {
                        showNotification(validation.message, 'error');
                        input.value = '';
                        return;
                    }
                    
                    selectDiscountCode(coupon.code, coupon.discountAmount, coupon.id);
                    input.value = '';
                    return;
                }

                // If not found in loaded coupons, validate with API
                const response = await fetch('/api/coupons/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        cartTotal: calculateCartSubtotal()
                    })
                });

                const data = await response.json();

                if (response.ok && data.success && data.coupon) {
                    const validatedCoupon = data.coupon;
                    
                    appliedDiscountCode = {
                        id: validatedCoupon.id,
                        code: validatedCoupon.code,
                        value: validatedCoupon.discountAmount,
                        type: 'fixed',
                        description: validatedCoupon.description
                    };

                    // Store for order completion tracking
                    window.currentAppliedCoupon = {
                        id: validatedCoupon.id,
                        code: validatedCoupon.code,
                        discountAmount: validatedCoupon.discountAmount
                    };
                    
                    calculateDiscount();
                    showAppliedDiscount();
                    updateOrderSummaryWithDiscount();
                    input.value = '';
                    showNotification(`ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√° ${code}`, 'success');
                } else {
                    showNotification(data.message || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n', 'error');
                    input.value = '';
                }
            } catch (error) {
                console.error('‚ùå Error validating coupon:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra m√£ gi·∫£m gi√°', 'error');
                input.value = '';
            }
        };

        // Remove discount code
        window.removeDiscountCode = function() {
            console.log('üóëÔ∏è Removing discount code');
            
            appliedDiscountCode = null;
            discountAmount = 0;

            // Clear tracking for order completion
            window.currentAppliedCoupon = null;
            
            // Hide applied discount display
            const appliedDiscountEl = document.getElementById('appliedDiscount');
            if (appliedDiscountEl) {
                appliedDiscountEl.style.display = 'none';
            }
            
            // Update order summary
            updateOrderSummaryWithDiscount();
            
            showNotification('ƒê√£ h·ªßy m√£ gi·∫£m gi√°', 'info');
        };

        // Calculate discount amount
        function calculateDiscount() {
            if (!appliedDiscountCode) {
                discountAmount = 0;
                return;
            }
            
            // Use script.js calculateCartTotal() if available, fallback to local calculation
            let subtotal = 0;
            if (window.calculateCartTotal && typeof window.calculateCartTotal === 'function') {
                subtotal = window.calculateCartTotal();
                console.log('üí∞ Using script.js calculateCartTotal:', subtotal);
            } else {
                subtotal = calculateCartSubtotal();
                console.log('üí∞ Fallback to calculateCartSubtotal:', subtotal);
            }
            
            if (appliedDiscountCode.type === 'percentage') {
                discountAmount = Math.floor(subtotal * appliedDiscountCode.value / 100);
            } else {
                discountAmount = appliedDiscountCode.value;
            }
            
            // Ensure discount doesn't exceed subtotal
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            console.log('üí∞ Calculated discount:', discountAmount, 'from subtotal:', subtotal);
        }

        // Show applied discount
        function showAppliedDiscount() {
            const appliedDiscountEl = document.getElementById('appliedDiscount');
            const appliedDiscountText = document.getElementById('appliedDiscountText');
            
            if (appliedDiscountEl && appliedDiscountText && appliedDiscountCode) {
                let discountDisplay = '';
                if (appliedDiscountCode.type === 'percentage') {
                    discountDisplay = `-${appliedDiscountCode.value}%`;
                } else {
                    discountDisplay = `-${formatPrice(appliedDiscountCode.value)}`;
                }
                
                appliedDiscountText.textContent = `ƒê√£ √°p d·ª•ng m√£: ${appliedDiscountCode.code} (${discountDisplay})`;
                appliedDiscountEl.style.display = 'flex';
            }
        }

        // Hide discount codes section
        function hideDiscountCodes() {
            const discountCodesSection = document.getElementById('discountCodes');
            if (discountCodesSection) {
                discountCodesSection.style.display = 'none';
            }
            
            // Also collapse if it's in a collapsible section
            const collapseElement = discountCodesSection?.closest('.collapse');
            if (collapseElement && collapseElement.classList.contains('show')) {
                // If using Bootstrap collapse, hide it
                const bsCollapse = bootstrap?.Collapse?.getInstance(collapseElement);
                if (bsCollapse) {
                    bsCollapse.hide();
                }
            }
        }

        // Calculate cart subtotal (with Firebase cart support)
        function calculateCartSubtotal() {
            console.log('üîç calculateCartSubtotal called');
            
            // Use window.cartItems (synced from Firebase) if available, fallback to localStorage
            let cartItems = [];
            
            if (window.cartItems && Array.isArray(window.cartItems) && window.cartItems.length > 0) {
                cartItems = window.cartItems;
                console.log('üì¶ Using window.cartItems (Firebase data):', cartItems.length, 'items');
            } else if (window.cart && Array.isArray(window.cart) && window.cart.length > 0) {
                cartItems = window.cart;
                console.log('üì¶ Using window.cart (shop.ejs data):', cartItems.length, 'items');
            } else {
                cartItems = JSON.parse(localStorage.getItem('techHavenCart')) || [];
                console.log('üì¶ Fallback to localStorage:', cartItems.length, 'items');
            }
            
            let subtotal = 0;
            
            cartItems.forEach(item => {
                let price = 0;
                
                // Handle different price field names from different sources
                if (item.numericPrice && typeof item.numericPrice === 'number') {
                    price = item.numericPrice;
                } else if (item.productPrice && typeof item.productPrice === 'number') {
                    price = item.productPrice;
                } else if (item.price && typeof item.price === 'number') {
                    price = item.price;
                } else if (item.price && typeof item.price === 'string') {
                    price = parseFloat(item.price.toString().replace(/[^\d]/g, '')) || 0;
                } else if (item.productPrice && typeof item.productPrice === 'string') {
                    price = parseFloat(item.productPrice.toString().replace(/[^\d]/g, '')) || 0;
                } else {
                    console.warn('‚ùå No valid price found for item:', item);
                    price = 0;
                }
                
                const quantity = item.quantity || 1;
                const itemTotal = price * quantity;
                subtotal += itemTotal;
                
                console.log(`üí∞ calculateCartSubtotal - Item: ${item.name}, Price: ${price}, Quantity: ${quantity}, Total: ${itemTotal}`);
            });
            
            console.log('üí∞ calculateCartSubtotal result:', subtotal);
            return subtotal;
        }

        // Update order summary with discount
        function updateOrderSummaryWithDiscount() {
            // Use script.js calculateCartTotal() if available, fallback to local calculation
            let subtotal = 0;
            if (window.calculateCartTotal && typeof window.calculateCartTotal === 'function') {
                subtotal = window.calculateCartTotal();
                console.log('üí∞ updateOrderSummaryWithDiscount using script.js calculateCartTotal:', subtotal);
            } else {
                subtotal = calculateCartSubtotal();
                console.log('üí∞ updateOrderSummaryWithDiscount fallback to calculateCartSubtotal:', subtotal);
            }
            
            const shippingFee = 50000;
            
            // Calculate discount if applied
            if (appliedDiscountCode) {
                calculateDiscount();
            }
            
            // Get coin discount from checkout-coin-manager.js if available
            const coinDiscount = (typeof window.getCoinUsageData === 'function') 
                ? window.getCoinUsageData().coinUsed 
                : 0;
            
            const finalTotal = subtotal - discountAmount - coinDiscount + shippingFee;
            
            // Update UI - only update what's needed for discount
            const subtotalEl = document.getElementById('subtotalAmount');
            const discountLineEl = document.getElementById('discountLine');
            const discountAmountEl = document.getElementById('discountAmount');
            const finalTotalEl = document.getElementById('finalTotal');
            
            // Always update subtotal to ensure it's correct
            if (subtotalEl) {
                subtotalEl.textContent = formatPrice(subtotal) + ' VNƒê';
                console.log('‚úÖ Updated subtotal in discount function:', formatPrice(subtotal));
            }
            
            // Update discount line
            if (discountLineEl && discountAmountEl) {
                if (discountAmount > 0) {
                    discountLineEl.style.display = 'flex';
                    discountAmountEl.textContent = '-' + formatPrice(discountAmount) + ' VNƒê';
                    console.log('‚úÖ Showing discount:', formatPrice(discountAmount));
                } else {
                    discountLineEl.style.display = 'none';
                    console.log('‚úÖ Hiding discount line');
                }
            }
            
            // Update final total
            if (finalTotalEl) {
                finalTotalEl.textContent = formatPrice(finalTotal) + ' VNƒê';
                console.log('‚úÖ Updated final total with coin discount:', formatPrice(finalTotal), '(coin:', coinDiscount + ')');
            }
            
            // Update coin discount display if exists
            if (typeof window.updateOrderTotalWithCoin === 'function') {
                window.updateOrderTotalWithCoin();
            }
        }

        // Don't override updateOrderSummary - just update discount when needed
        // updateOrderSummaryWithDiscount will be called when discount is applied/removed

        // Apply discount code when Enter key is pressed
        document.addEventListener('keydown', function(e) {
            if (e.target.id === 'manualDiscountCode' && e.key === 'Enter') {
                e.preventDefault();
                applyManualDiscountCode();
            }
        });

        // =====================================
        // OTP VERIFICATION FUNCTIONS
        // =====================================

        let otpTimer = null;
        let otpTimeLeft = 600; // 10 minutes in seconds
        
        // Show OTP modal for guest checkout
        window.showOtpModal = function(email = '') {
            const modal = document.getElementById('otpModal');
            const emailInput = document.getElementById('otpEmail');
            
            if (email && emailInput) {
                emailInput.value = email;
            }
            
            // Reset to step 1
            showOtpStep1();
            
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }
        };

        // Close OTP modal
        window.closeOtpModal = function() {
            const modal = document.getElementById('otpModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
            }
            
            // Clear timer
            if (otpTimer) {
                clearInterval(otpTimer);
                otpTimer = null;
            }
            
            // Reset form
            resetOtpForm();
        };

        // Show step 1 (email input)
        function showOtpStep1() {
            document.getElementById('otpStep1').style.display = 'block';
            document.getElementById('otpStep2').style.display = 'none';
        }

        // Show step 2 (OTP input)
        function showOtpStep2(email) {
            document.getElementById('otpStep1').style.display = 'none';
            document.getElementById('otpStep2').style.display = 'block';
            document.getElementById('otpEmailDisplay').textContent = email;
            
            // Start countdown timer
            startOtpTimer();
        }

        // Back to step 1
        window.backToOtpStep1 = function() {
            showOtpStep1();
            if (otpTimer) {
                clearInterval(otpTimer);
                otpTimer = null;
            }
        };

        // Send OTP code
        window.sendOtpCode = async function() {
            const emailInput = document.getElementById('otpEmail');
            const sendBtn = document.getElementById('sendOtpBtn');
            
            if (!emailInput.value) {
                alert('Vui l√≤ng nh·∫≠p email');
                return;
            }

            // Get customer name from checkout form if available
            const customerNameEl = document.getElementById('customerName');
            const customerName = customerNameEl ? customerNameEl.value : '';

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang g·ª≠i...';

            try {
                const response = await fetch('/api/guest-checkout/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: emailInput.value,
                        customerName: customerName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showOtpStep2(emailInput.value);
                    
                    if (typeof showNotification === 'function') {
                        showNotification('M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞!', 'success');
                    } else {
                        alert('M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!');
                    }
                } else {
                    alert(result.error || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i OTP');
                }
            } catch (error) {
                console.error('Error sending OTP:', error);
                alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i OTP');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> G·ª≠i M√£ OTP';
            }
        };

        // Verify OTP code
        window.verifyOtpCode = async function() {
            const emailInput = document.getElementById('otpEmail');
            const otpInput = document.getElementById('otpCode');
            const verifyBtn = document.getElementById('verifyOtpBtn');

            if (!otpInput.value || otpInput.value.length !== 6) {
                alert('Vui l√≤ng nh·∫≠p m√£ OTP 6 s·ªë');
                return;
            }

            // Get customer info from checkout form
            const customerNameEl = document.getElementById('customerName');
            const customerPhoneEl = document.getElementById('customerPhone');

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√°c th·ª±c...';

            try {
                const response = await fetch('/api/guest-checkout/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: emailInput.value,
                        otp: otpInput.value,
                        customerName: customerNameEl ? customerNameEl.value : '',
                        customerPhone: customerPhoneEl ? customerPhoneEl.value : ''
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Store OTP verification result globally with timestamp
                    window.otpVerificationResult = {
                        ...result,
                        verifiedAt: Date.now(),
                        validUntil: Date.now() + (30 * 60 * 1000) // Valid for 30 minutes
                    };
                    
                    // Close OTP modal
                    closeOtpModal();
                    
                    // Show success message
                    if (typeof showNotification === 'function') {
                        showNotification('Email ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c th√†nh c√¥ng!', 'success');
                    } else {
                        alert('Email ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c th√†nh c√¥ng!');
                    }
                    
                    // If user was created, show welcome message
                    if (result.isNewUser) {
                        if (typeof showNotification === 'function') {
                            showNotification('T√†i kho·∫£n m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o! B·∫°n c√≥ th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u sau khi ho√†n t·∫•t ƒë∆°n h√†ng.', 'info');
                        } else {
                            alert('T√†i kho·∫£n m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o! B·∫°n c√≥ th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u sau khi ho√†n t·∫•t ƒë∆°n h√†ng.');
                        }
                    }
                    
                    // Proceed with checkout
                    if (typeof completeOrder === 'function') {
                        completeOrder();
                    }
                } else {
                    alert(result.error || 'M√£ OTP kh√¥ng ch√≠nh x√°c');
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x√°c th·ª±c OTP');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check"></i> X√°c Th·ª±c';
            }
        };

        // Resend OTP code
        window.resendOtpCode = async function() {
            const emailInput = document.getElementById('otpEmail');
            const resendBtn = document.getElementById('resendOtpBtn');

            resendBtn.disabled = true;
            resendBtn.textContent = 'ƒêang g·ª≠i l·∫°i...';

            try {
                const response = await fetch('/api/guest-checkout/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: emailInput.value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reset timer
                    otpTimeLeft = 600;
                    startOtpTimer();
                    
                    if (typeof showNotification === 'function') {
                        showNotification('M√£ OTP m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!', 'success');
                    } else {
                        alert('M√£ OTP m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!');
                    }
                } else {
                    alert(result.error || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i l·∫°i OTP');
                }
            } catch (error) {
                console.error('Error resending OTP:', error);
                alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i l·∫°i OTP');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'G·ª≠i l·∫°i m√£ OTP';
            }
        };

        // Start OTP countdown timer
        function startOtpTimer() {
            const timerDisplay = document.getElementById('otpTimer');
            
            if (otpTimer) {
                clearInterval(otpTimer);
            }
            
            otpTimer = setInterval(() => {
                const minutes = Math.floor(otpTimeLeft / 60);
                const seconds = otpTimeLeft % 60;
                
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (otpTimeLeft <= 0) {
                    clearInterval(otpTimer);
                    timerDisplay.textContent = 'H·∫øt h·∫°n';
                    
                    if (typeof showNotification === 'function') {
                        showNotification('M√£ OTP ƒë√£ h·∫øt h·∫°n. Vui l√≤ng g·ª≠i l·∫°i.', 'warning');
                    }
                }
                
                otpTimeLeft--;
            }, 1000);
        }

        // Reset OTP form
        function resetOtpForm() {
            document.getElementById('otpEmail').value = '';
            document.getElementById('otpCode').value = '';
            document.getElementById('otpEmailDisplay').textContent = '';
            otpTimeLeft = 600;
        }

        // Handle Enter key in OTP input
        document.addEventListener('keydown', function(e) {
            if (e.target.id === 'otpCode' && e.key === 'Enter') {
                e.preventDefault();
                verifyOtpCode();
            }
            if (e.target.id === 'otpEmail' && e.key === 'Enter') {
                e.preventDefault();
                sendOtpCode();
            }
        });

        // Test SmartCart state function
        window.testSmartCartState = function() {
            console.log('üß† Testing SmartCart state...');
            
            if (window.smartCart) {
                console.log('‚úÖ SmartCart exists:', {
                    isLoggedIn: window.smartCart.isLoggedIn,
                    lastUpdateSource: window.smartCart.lastUpdateSource,
                    cartData: window.smartCart.cartData
                });
                
                // Force refresh cart data
                window.smartCart.refreshCartData().then(() => {
                    console.log('üîÑ SmartCart refreshed');
                });
            } else {
                console.log('‚ùå SmartCart not available');
            }
            
            // Test authentication status
            console.log('üë§ Current user:', window.currentUser);
            console.log('üíæ Stored user:', localStorage.getItem('techHavenUser'));
        };
    </script>

    <!-- Variant Selection Enhancement -->
    <script>
        // Enhanced addToCart wrapper that checks variants
        window.addToCartWithVariantCheck = function(productName, productPrice, productId, productImage) {
            // Call the enhanced addToCart function from script.js
            if (typeof window.addToCart === 'function') {
                window.addToCart(productName, productPrice, productId, productImage);
            } else {
                console.error('‚ùå addToCart function not available');
            }
        };
        
        // Update all existing add-to-cart buttons to use the new function
        document.addEventListener('DOMContentLoaded', function() {
            const addToCartButtons = document.querySelectorAll('.add-to-cart');
            addToCartButtons.forEach(button => {
                // Get the original onclick content
                const originalOnclick = button.getAttribute('onclick');
                if (originalOnclick && originalOnclick.includes('addToCart(')) {
                    // Replace addToCart with addToCartWithVariantCheck
                    const newOnclick = originalOnclick.replace('addToCart(', 'addToCartWithVariantCheck(');
                    button.setAttribute('onclick', newOnclick);
                    console.log('‚úÖ Updated button onclick for variant checking');
                }
            });
        });

        // Close variant modal on overlay click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('variantSelectionModal');
            if (e.target === modal) {
                closeVariantModal();
            }
        });

        // Close variant modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('variantSelectionModal');
                if (modal && modal.style.display === 'flex') {
                    closeVariantModal();
                }
            }
        });
    </script>

    <!-- Lottie Animation Functions -->
    <script>
        // Function to show Lottie congratulations animation
        function showCongratulationAnimation(callback) {
            // Create animation container
            const animationContainer = document.createElement('div');
            animationContainer.id = 'congratulation-animation';
            animationContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: transparent;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            `;
            
            // Create Lottie animation div
            const lottieDiv = document.createElement('div');
            lottieDiv.id = 'lottie-congratulation';
            lottieDiv.style.cssText = `
                width: 100vw;
                height: 100vh;
                transform: scale(0.8);
                transition: transform 0.3s ease;
                background: transparent;
                border-radius: 0;
                box-shadow: none;
                padding: 0;
                pointer-events: auto;
            `;
            
            animationContainer.appendChild(lottieDiv);
            document.body.appendChild(animationContainer);
            
            // Fade in animation
            setTimeout(() => {
                animationContainer.style.opacity = '1';
                lottieDiv.style.transform = 'scale(1)';
            }, 50);
            
            // Load Lottie animation
            const animation = lottie.loadAnimation({
                container: lottieDiv,
                renderer: 'svg',
                loop: false,
                autoplay: true,
                path: '/congratulation.json'
            });
            
            // Handle animation complete
            animation.addEventListener('complete', function() {
                setTimeout(() => {
                    // Fade out animation
                    animationContainer.style.opacity = '0';
                    lottieDiv.style.transform = 'scale(0.8)';
                    
                    setTimeout(() => {
                        if (animationContainer.parentNode) {
                            animationContainer.remove();
                        }
                        if (callback && typeof callback === 'function') {
                            callback();
                        }
                    }, 300);
                }, 800); // Show animation for 800ms after completion
            });
            
            // Allow clicking to close early
            animationContainer.addEventListener('click', function() {
                animationContainer.style.opacity = '0';
                setTimeout(() => {
                    if (animationContainer.parentNode) {
                        animationContainer.remove();
                    }
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                }, 300);
            });
        }
        
        // Make function available globally
        window.showCongratulationAnimation = showCongratulationAnimation;
    </script>

    <!-- VNPay Result Handlers -->
    <script>
        // VNPay result handlers for shop page
        async function showVNPaySuccess(orderInfo, amount) {
            // Clear cart immediately when payment is successful
            await clearCartAfterPayment();
            
            // Show Lottie congratulations animation first for VNPay
            console.log('üéâ Showing congratulation animation for VNPay payment');
            if (typeof window.showCongratulationAnimation === 'function') {
                try {
                    showCongratulationAnimation(() => {
                        console.log('‚úÖ VNPay congratulation animation completed');
                        // Show success modal after animation completes
                        showVNPaySuccessModal(orderInfo, amount);
                    });
                } catch (error) {
                    console.error('‚ùå Error showing VNPay congratulation animation:', error);
                    // Fallback: show modal without animation
                    showVNPaySuccessModal(orderInfo, amount);
                }
            } else {
                console.warn('‚ö†Ô∏è showCongratulationAnimation function not available for VNPay, showing modal directly');
                // Fallback: show modal without animation
                showVNPaySuccessModal(orderInfo, amount);
            }
        }
        
        // Separate function for the success modal
        function showVNPaySuccessModal(orderInfo, amount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, rgb(76, 175, 80), rgb(69, 160, 73)); color: white; padding: 30px 40px; border-radius: 15px; box-shadow: rgba(0, 0, 0, 0.3) 0px 10px 30px; z-index: 10002; text-align: center; font-family: Inter, sans-serif; max-width: 400px; width: 90%;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 600;">Thanh to√°n th√†nh c√¥ng!</h3>
                    <p style="margin: 0.5rem 0; opacity: 0.9;">M√£ ƒë∆°n h√†ng: <strong>${orderInfo}</strong></p>
                    <p style="margin: 0.5rem 0; opacity: 0.9;">T·ªïng ti·ªÅn: <strong>${amount}</strong></p>
                    <p style="margin: 1rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong v√≤ng 24h ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.</p>
                    <button onclick="this.parentElement.parentElement.remove(); location.reload();" style="
                        margin-top: 1.5rem;
                        padding: 10px 20px;
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        border-radius: 8px;
                        color: white;
                        cursor: pointer;
                        font-size: 0.9rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        ƒê√≥ng
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Function to clear cart after successful payment
        async function clearCartAfterPayment() {
            console.log('üõí Clearing cart after successful payment...');
            
            // Clear localStorage cart immediately
            localStorage.removeItem('techHavenCart');
            localStorage.removeItem('techHavenCartCount');
            console.log('‚úÖ LocalStorage cart cleared');
            
            // Clear global cart variables if available
            if (typeof cartItems !== 'undefined') {
                cartItems.length = 0; // Clear array contents
                console.log('‚úÖ Global cartItems cleared');
            }
            if (typeof cartCount !== 'undefined') {
                cartCount = 0;
                console.log('‚úÖ Global cartCount cleared');
            }
            
            // Wait for Firebase auth to be ready and clear Firebase cart
            try {
                // Wait for Firebase auth to be fully initialized
                await new Promise((resolve) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });
                
                const user = firebase.auth().currentUser;
                if (user) {
                    console.log('üîë User authenticated, clearing Firebase cart');
                    const idToken = await user.getIdToken();
                    
                    // Multiple methods to ensure cart is cleared
                    const clearPromises = [];
                    
                    // Method 1: Use clearCartInFirebase function if available
                    if (typeof clearCartInFirebase === 'function') {
                        clearPromises.push(clearCartInFirebase(idToken));
                    }
                    
                    // Method 2: Direct API call to clear user cart
                    clearPromises.push(
                        fetch(`/api/cart/user/${user.uid}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${idToken}`,
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                            if (response.ok) {
                                console.log('‚úÖ Firebase cart cleared via user API');
                            } else {
                                console.warn('‚ö†Ô∏è User cart API call failed');
                            }
                        })
                    );
                    
                    // Method 3: Clear cart by UID (alternative method)
                    clearPromises.push(
                        fetch(`/api/cart/by-uid/${user.uid}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                            if (response.ok) {
                                console.log('‚úÖ Firebase cart cleared via UID API');
                            } else {
                                console.warn('‚ö†Ô∏è UID cart API call failed');
                            }
                        })
                    );
                    
                    // Wait for all clearing methods to complete
                    await Promise.allSettled(clearPromises);
                    
                } else {
                    console.log('üë§ Guest user - cart cleared from localStorage only');
                }
            } catch (error) {
                console.error('‚ùå Error clearing Firebase cart:', error);
            }
            
            // Force update cart UI multiple times to ensure it reflects changes
            try {
                // Update cart UI if function is available
                if (typeof updateCartUI === 'function') {
                    updateCartUI();
                    console.log('üîÑ Cart UI updated');
                }
                
                // Force update cart count in header
                const cartCountElements = document.querySelectorAll('.cart-count');
                cartCountElements.forEach(element => {
                    element.textContent = '0';
                });
                
                // Force hide cart count badges
                const cartBadges = document.querySelectorAll('.cart-badge');
                cartBadges.forEach(badge => {
                    badge.style.display = 'none';
                });
                
                // Clear cart sidebar content
                const cartItemsContainer = document.getElementById('cartItems');
                if (cartItemsContainer) {
                    cartItemsContainer.innerHTML = '<p class="empty-cart-message">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>';
                }
                
                // Update cart total
                const cartTotal = document.getElementById('cartTotal');
                if (cartTotal) {
                    cartTotal.textContent = '0 VNƒê';
                }
                
                console.log('‚úÖ Cart UI forcefully updated');
                
            } catch (uiError) {
                console.error('‚ùå Error updating cart UI:', uiError);
            }
            
            console.log('‚úÖ Cart clearing completed - all methods executed');
        }
        
        function showVNPayFailure(orderInfo, message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center;">
                    <div style="color: #ef4444; font-size: 4rem; margin-bottom: 1rem;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <h2 style="color: #ef4444; margin-bottom: 1rem;">Thanh to√°n th·∫•t b·∫°i!</h2>
                    <p style="margin-bottom: 1rem;">ƒê∆°n h√†ng: ${orderInfo}</p>
                    <p style="margin-bottom: 2rem;">L√Ω do: ${message}</p>
                    <button onclick="this.closest('[style*=\"position: fixed\"]').remove();" 
                            style="background: #ef4444; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                        ƒê√≥ng
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showVNPayError(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center;">
                    <div style="color: #f59e0b; font-size: 4rem; margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 style="color: #f59e0b; margin-bottom: 1rem;">L·ªói thanh to√°n!</h2>
                    <p style="margin-bottom: 2rem;">${message}</p>
                    <button onclick="this.closest('[style*=\"position: fixed\"]').remove();" 
                            style="background: #f59e0b; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                        ƒê√≥ng
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Check VNPay result on page load
        async function checkVNPayResult() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const orderId = urlParams.get('orderId');
            const amount = urlParams.get('amount');
            const error = urlParams.get('error');
            
            if (paymentStatus) {
                // Clean URL parameters
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                if (paymentStatus === 'success') {
                    // Ensure bill creation with fallback API call
                    await ensureBillCreation(orderId, amount);
                    
                    // Wait a moment for backend processing to complete
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const formattedAmount = parseFloat(amount).toLocaleString('vi-VN');
                    await showVNPaySuccess(orderId, formattedAmount + ' VNƒê');
                } else if (paymentStatus === 'failed') {
                    showVNPayFailure(orderId, error);
                } else if (paymentStatus === 'error') {
                    showVNPayError(urlParams.get('message'));
                }
            } else {
                // Check for old VNPay format (backward compatibility)
                const vnpResponseCode = urlParams.get('vnp_ResponseCode');
                if (vnpResponseCode !== null) {
                    const orderInfo = urlParams.get('vnp_OrderInfo') || 'N/A';
                    const vnpAmount = urlParams.get('vnp_Amount');
                    const formattedAmount = vnpAmount ? new Intl.NumberFormat('vi-VN').format(vnpAmount / 100) + ' VNƒê' : 'N/A';
                    
                    if (vnpResponseCode === '00') {
                        // For old format, we don't have orderId directly, use orderInfo
                        await showVNPaySuccess(orderInfo, formattedAmount);
                    } else {
                        const errorMessage = getVNPayErrorMessage(vnpResponseCode);
                        showVNPayFailure(orderInfo, errorMessage);
                    }
                    
                    // Clean URL
                    setTimeout(() => {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 3000);
                }
            }
        }
        
        // Ensure bill creation with fallback API call
        async function ensureBillCreation(orderId, amount) {
            try {
                console.log('üîÑ Ensuring bill creation for order:', orderId);
                
                const response = await fetch('/api/vnpay/process-success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: parseFloat(amount)
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ Bill creation ensured:', result.message);
                } else {
                    console.error('‚ùå Bill creation failed:', result.message);
                }
            } catch (error) {
                console.error('‚ùå Error ensuring bill creation:', error);
            }
        }

        
        function getVNPayErrorMessage(responseCode) {
            const errorMessages = {
                '01': 'Giao d·ªãch ch∆∞a ho√†n t·∫•t',
                '02': 'Giao d·ªãch b·ªã l·ªói',
                '04': 'Giao d·ªãch ƒë·∫£o (Kh√°ch h√†ng ƒë√£ b·ªã tr·ª´ ti·ªÅn t·∫°i Ng√¢n h√†ng nh∆∞ng GD ch∆∞a th√†nh c√¥ng ·ªü VNPAY)',
                '05': 'VNPAY ƒëang x·ª≠ l√Ω giao d·ªãch n√†y (GD ho√†n ti·ªÅn)',
                '06': 'VNPAY ƒë√£ g·ª≠i y√™u c·∫ßu ho√†n ti·ªÅn sang Ng√¢n h√†ng (GD ho√†n ti·ªÅn)',
                '07': 'Giao d·ªãch b·ªã nghi ng·ªù',
                '09': 'GD Ho√†n tr·∫£ b·ªã t·ª´ ch·ªëi',
                '10': 'Kh√°ch h√†ng h·ªßy giao d·ªãch',
                '11': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: H·∫øt th·ªùi gian th·ª±c hi·ªán giao d·ªãch',
                '12': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: Th·∫ª/T√†i kho·∫£n c·ªßa kh√°ch h√†ng b·ªã kh√≥a',
                '13': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do Qu√Ω kh√°ch nh·∫≠p sai m·∫≠t kh·∫©u x√°c th·ª±c giao d·ªãch (OTP)',
                '24': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: Kh√°ch h√†ng h·ªßy giao d·ªãch',
                '51': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: T√†i kho·∫£n c·ªßa qu√Ω kh√°ch kh√¥ng ƒë·ªß s·ªë d∆∞ ƒë·ªÉ th·ª±c hi·ªán giao d·ªãch',
                '65': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: T√†i kho·∫£n c·ªßa Qu√Ω kh√°ch ƒë√£ v∆∞·ª£t qu√° h·∫°n m·ª©c giao d·ªãch trong ng√†y',
                '75': 'Ng√¢n h√†ng thanh to√°n ƒëang b·∫£o tr√¨',
                '79': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: KH nh·∫≠p sai m·∫≠t kh·∫©u thanh to√°n qu√° s·ªë l·∫ßn quy ƒë·ªãnh',
                '99': 'L·ªói kh√¥ng x√°c ƒë·ªãnh'
            };
            
            return errorMessages[responseCode] || `L·ªói kh√¥ng x√°c ƒë·ªãnh (${responseCode})`;
        }
        
        // Make functions global
        window.showVNPaySuccess = showVNPaySuccess;
        window.showVNPayFailure = showVNPayFailure;
        window.showVNPayError = showVNPayError;
        window.checkVNPayResult = checkVNPayResult;
        
        // Check VNPay result on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkVNPayResult, 500);
        });

        // =====================================
        // SHOP PAGE SEARCH FUNCTIONALITY
        // =====================================

        // Function to filter products by category
        function filterProductsByCategory(category) {
            console.log('üîç Filtering products by category:', category);
            
            const productsGrid = document.getElementById('productsGrid');
            if (!productsGrid) {
                console.error('‚ùå Products grid not found');
                return;
            }
            
            const productCards = productsGrid.querySelectorAll('.product-card');
            let visibleCount = 0;
            
            productCards.forEach(card => {
                const productName = card.querySelector('h4')?.textContent.toLowerCase() || '';
                const productDescription = card.querySelector('p')?.textContent.toLowerCase() || '';
                const allText = productName + ' ' + productDescription;
                
                // Also check data attributes if they exist
                const productCategory = card.getAttribute('data-category')?.toLowerCase() || '';
                const productId = card.getAttribute('data-product-id') || '';
                
                console.log(`üîç Checking product: ${productName}`);
                console.log(`   Category data: ${productCategory}`);
                console.log(`   All text: ${allText}`);
                
                let shouldShow = false;
                
                // Enhanced category matching logic
                switch(category.toLowerCase()) {
                    case 'laptop':
                        shouldShow = productCategory.includes('laptop') ||
                                   productCategory.includes('laptop gaming') ||
                                   allText.includes('laptop') || allText.includes('notebook') ||
                                   allText.includes('gaming') || allText.includes('game') ||
                                   allText.includes('pc') || allText.includes('m√°y t√≠nh') ||
                                   allText.includes('workstation') || allText.includes('ultrabook') ||
                                   // Fallback: show test products for demo purposes
                                   (productName.includes('test') && !allText.includes('mouse') && !allText.includes('keyboard'));
                        break;
                    case 'cpu':
                        shouldShow = productCategory.includes('cpu') || productCategory.includes('processor') ||
                                   allText.includes('cpu') || allText.includes('processor') || 
                                   allText.includes('intel') || allText.includes('amd') || 
                                   allText.includes('ryzen') || allText.includes('core');
                        break;
                    case 'vga':
                    case 'gpu':
                        shouldShow = productCategory.includes('vga') || productCategory.includes('gpu') ||
                                   productCategory.includes('graphics') ||
                                   allText.includes('vga') || allText.includes('gpu') || 
                                   allText.includes('card ƒë·ªì h·ªça') || allText.includes('rtx') || 
                                   allText.includes('gtx') || allText.includes('radeon');
                        break;
                    case 'monitor':
                        shouldShow = productCategory.includes('monitor') || productCategory.includes('display') ||
                                   allText.includes('monitor') || allText.includes('m√†n h√¨nh') || 
                                   allText.includes('screen') || allText.includes('display');
                        break;
                    case 'keyboard':
                        shouldShow = productCategory.includes('keyboard') ||
                                   allText.includes('keyboard') || allText.includes('b√†n ph√≠m') || 
                                   allText.includes('mechanical') || allText.includes('gaming keyboard');
                        break;
                    case 'mouse':
                        shouldShow = productCategory.includes('mouse') ||
                                   allText.includes('mouse') || allText.includes('chu·ªôt') || 
                                   allText.includes('gaming mouse');
                        break;
                    default:
                        shouldShow = true; // Show all if category not recognized
                }
                
                console.log(`   Should show: ${shouldShow}`);
                
                if (shouldShow) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            const noResults = document.getElementById('noResults');
            const loadMoreSection = document.querySelector('.load-more-section');
            
            if (visibleCount === 0) {
                if (noResults) {
                    noResults.style.display = 'block';
                }
                if (loadMoreSection) {
                    loadMoreSection.style.display = 'none';
                }
            } else {
                if (noResults) {
                    noResults.style.display = 'none';
                }
                if (loadMoreSection) {
                    loadMoreSection.style.display = 'block';
                }
            }
            
            console.log(`‚úÖ Filtered products: ${visibleCount} visible out of ${productCards.length} total`);
        }
        
        // Export function for use by script.js
        window.filterProductsByCategory = filterProductsByCategory;
        // applyCategoryFilter already exported above

        // Function to clear all filters and show all products
        window.clearAllFilters = function() {
            console.log('üßπ Clearing all filters');
            
            const productsGrid = document.getElementById('productsGrid');
            if (!productsGrid) return;
            
            const productCards = productsGrid.querySelectorAll('.product-card');
            productCards.forEach(card => {
                card.style.display = 'block';
            });
            
            // Hide no results message
            const noResults = document.getElementById('noResults');
            if (noResults) {
                noResults.style.display = 'none';
            }
            
            // Show load more section
            const loadMoreSection = document.querySelector('.load-more-section');
            if (loadMoreSection) {
                loadMoreSection.style.display = 'block';
            }
            
            // Clear search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Show notification
            if (typeof showNotification === 'function') {
                showNotification('ƒê√£ x√≥a t·∫•t c·∫£ b·ªô l·ªçc', 'success');
            }
            
            console.log('‚úÖ All filters cleared');
        };

        // Enhanced search functionality for shop page
        window.handleSearchOnShopPage = function() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const query = searchInput.value.trim().toLowerCase();
            
            if (!query) {
                clearAllFilters();
                return;
            }
            
            console.log('üîç Searching products on shop page:', query);
            
            const productsGrid = document.getElementById('productsGrid');
            if (!productsGrid) return;
            
            const productCards = productsGrid.querySelectorAll('.product-card');
            let visibleCount = 0;
            
            productCards.forEach(card => {
                const productName = card.querySelector('h4')?.textContent.toLowerCase() || '';
                const productDescription = card.querySelector('p')?.textContent.toLowerCase() || '';
                const allText = productName + ' ' + productDescription;
                
                if (allText.includes(query)) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            const noResults = document.getElementById('noResults');
            const loadMoreSection = document.querySelector('.load-more-section');
            
            if (visibleCount === 0) {
                if (noResults) {
                    noResults.style.display = 'block';
                }
                if (loadMoreSection) {
                    loadMoreSection.style.display = 'none';
                }
            } else {
                if (noResults) {
                    noResults.style.display = 'none';
                }
                if (loadMoreSection) {
                    loadMoreSection.style.display = 'block';
                }
            }
            
            // Hide search suggestions
            if (typeof hideSearchSuggestions === 'function') {
                hideSearchSuggestions();
            }
            
            console.log(`‚úÖ Search results: ${visibleCount} visible out of ${productCards.length} total`);
        };

        // Add event listener for search input
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // Handle Enter key
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSearchOnShopPage();
                    }
                });
                
                // Handle real-time search
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        setTimeout(() => {
                            if (this.value.trim() === query) {
                                handleSearchOnShopPage();
                            }
                        }, 500); // Debounce search
                    } else if (query.length === 0) {
                        clearAllFilters();
                    }
                });
            }
            
            // Add click handler for search button
            const searchBtn = document.querySelector('.search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    handleSearchOnShopPage();
                });
            }
        });
    </script>
    
    <!-- Clear guest temp address after successful payment -->
    <script>
        // Check if returning from successful VNPay payment
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('payment');
        
        if (paymentStatus === 'success') {
            console.log('‚úÖ Payment successful - clearing guest temp address');
            
            // Clear guest temporary address from localStorage
            const tempAddress = localStorage.getItem('guestTempAddress');
            if (tempAddress) {
                localStorage.removeItem('guestTempAddress');
                console.log('üßπ Guest temp address cleared after successful payment');
            }
            
            // Show success notification
            if (typeof showNotification === 'function') {
                const orderId = urlParams.get('orderId');
                const amount = urlParams.get('amount');
                showNotification(
                    `‚úÖ Thanh to√°n th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${orderId || 'N/A'}`, 
                    'success'
                );
            }
        } else if (paymentStatus === 'failed') {
            console.log('‚ùå Payment failed');
            if (typeof showNotification === 'function') {
                const errorCode = urlParams.get('error');
                showNotification(
                    `‚ùå Thanh to√°n th·∫•t b·∫°i. M√£ l·ªói: ${errorCode || 'Unknown'}`, 
                    'error'
                );
            }
        }
    </script>
    
    <!-- Performance Monitoring (Async Load) -->
    <script src="/js/performance-monitor.js" defer></script>
    <script src="/js/lazy-load.js" defer></script>
    
    <!-- AI Chat Widget -->
    <script src="/js/ai-chat-widget.js"></script>
</body>
</html>
