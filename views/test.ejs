
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.name || 'S·∫£n ph·∫©m' %> - TECH HAVEN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/product_detail.css">
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Google Fonts for Vietnamese Support -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/user-profile.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase Authentication SDK (loaded early for auth) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Lottie Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    
    <script>
        console.log('üîê S·ª≠ d·ª•ng Firebase Authentication tr·ª±c ti·∫øp');
        
        // Firebase Configuration (Compat Version)
        const firebaseCompatConfig = {
            apiKey: "AIzaSyDpzgsxZ1Jfs5hWAfS-gDbYfgkVte_jXoA",
            authDomain: "tech-haven-5368b.firebaseapp.com",
            projectId: "tech-haven-5368b",
            storageBucket: "tech-haven-5368b.firebasestorage.app",
            messagingSenderId: "442337591630",
            appId: "1:442337591630:web:7005525c7664f513a55e1f"
        };

        // Initialize Firebase (Compat Version)
        firebase.initializeApp(firebaseCompatConfig);
        const firebaseCompatAuth = firebase.auth();
        const firebaseCompatFirestore = firebase.firestore();

        console.log('‚úÖ Firebase initialized successfully');

        // Current user state
        window.currentUser = null;
        
        // Make Firebase v8 functions globally available for email verification and cart listener
        window.firebaseAuth = firebaseCompatAuth;
        window.firebase = firebase; // Make entire Firebase v8 compat available for script.js
        window.signInWithEmailAndPassword = firebaseCompatAuth.signInWithEmailAndPassword.bind(firebaseCompatAuth);
        window.sendEmailVerification = function(user, settings) {
            return user.sendEmailVerification(settings);
        };
        window.signOut = firebaseCompatAuth.signOut.bind(firebaseCompatAuth);

        // Google Sign In
        window.signInWithGoogle = async function() {
            try {
                console.log('üöÄ Attempting Google sign-in...');
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await firebaseCompatAuth.signInWithPopup(provider);
                console.log('‚úÖ Google sign-in successful:', result.user.displayName);
                
                // IMMEDIATELY clear local cart upon successful Google sign-in
                console.log('üßπ Clearing local cart for Google sign-in...');
                localStorage.removeItem('techHavenCart');
                localStorage.removeItem('techHavenCartCount');
                
                // Reset global variables
                if (window.cartItems) window.cartItems.length = 0;
                if (typeof window.cartCount !== 'undefined') window.cartCount = 0;
                
                // Clear SmartCart if initialized
                if (window.smartCart) {
                    window.smartCart.clearCartForGoogleLogin();
                }
                
                // Get ID token and send to server
                const idToken = await result.user.getIdToken();
                await sendTokenToServer(idToken);
                
                // Close login modal after successful login
                closeLoginModal();
                
            } catch (error) {
                console.error('‚ùå Google sign-in error:', error);
                alert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + error.message);
            }
        };

        // Sign Out
        window.signOutUser = async function() {
            try {
                console.log('üö™ Signing out...');
                await firebaseCompatAuth.signOut();
                console.log('‚úÖ Sign out successful');
                window.currentUser = null;
                updateUIBasedOnAuthStatus();
                location.reload();
            } catch (error) {
                console.error('‚ùå Sign out error:', error);
            }
        };

        // Send ID token to server for verification
        async function sendTokenToServer(idToken) {
            try {
                console.log('üì° Sending token to server...');
                const response = await fetch('/api/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (result.authenticated && result.user) {
                    console.log('‚úÖ Server verification successful:', result.user);
                    window.currentUser = result.user;
                    
                    // Load full user profile from Firestore
                    await loadUserProfile(idToken);
                    
                    updateUIBasedOnAuthStatus();
                } else {
                    console.log('‚ùå Server verification failed');
                }
            } catch (error) {
                console.error('‚ùå Error sending token to server:', error);
            }
        }

        // Load full user profile from Firestore
        async function loadUserProfile(idToken) {
            try {
                console.log('üìä Loading full user profile...');
                const response = await fetch('/api/user/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (result.success && result.profile) {
                    console.log('‚úÖ User profile loaded:', result.profile);
                    window.currentUser = {
                        ...window.currentUser,
                        ...result.profile,
                        fullProfile: true
                    };
                    console.log('üíæ Enhanced user data:', window.currentUser);
                } else {
                    console.log('‚ùå Failed to load user profile');
                }
            } catch (error) {
                console.error('‚ùå Error loading user profile:', error);
            }
        }

        // Function to add item to wishlist
        window.addToWishlist = async function(productId, productName, productPrice, productImage) {
            if (!window.currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m v√†o danh s√°ch y√™u th√≠ch!');
                openLoginModal();
                return;
            }
            
            try {
                const idToken = await firebaseCompatAuth.currentUser.getIdToken();
                const response = await fetch('/api/user/wishlist', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId,
                        productName,
                        productPrice,
                        productImage
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('ƒê√£ th√™m v√†o danh s√°ch y√™u th√≠ch!');
                } else {
                    alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
                }
            } catch (error) {
                console.error('‚ùå Error adding to wishlist:', error);
                alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
            }
        };

        // Function to navigate to admin pages with authentication
        window.navigateToAdmin = async function(adminPath) {
            console.log('üîê Starting admin navigation to:', adminPath);
            
            try {
                if (!window.currentUser) {
                    console.warn('‚ö†Ô∏è No current user, opening login modal');
                    alert('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang admin');
                    openLoginModal();
                    return false;
                }
                
                console.log('üë§ Current user found:', window.currentUser.displayName);
                
                // Get fresh token
                const user = firebaseCompatAuth.currentUser;
                if (!user) {
                    console.warn('‚ö†Ô∏è No Firebase auth user, opening login modal');
                    alert('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ truy c·∫≠p trang admin');
                    openLoginModal();
                    return false;
                }
                
                console.log('üîÑ Getting fresh token...');
                const idToken = await user.getIdToken(true); // Force refresh token
                console.log('üîë Got fresh token, checking admin access...');
                
                // Check admin status first
                const adminCheckResponse = await fetch('/api/user/admin-status', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Admin check response status:', adminCheckResponse.status);
                const adminResult = await adminCheckResponse.json();
                console.log('üëë Admin check result:', adminResult);
                
                if (!adminResult.success || !adminResult.user.is_admin) {
                    console.warn('‚ùå Admin access denied:', adminResult);
                    alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin. Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c c·∫•p quy·ªÅn.');
                    return false;
                }
                
                console.log('‚úÖ Admin access confirmed, navigating to:', adminPath);
                
                // Navigate to admin page with token as query parameter
                const fullUrl = `${adminPath}?token=${encodeURIComponent(idToken)}`;
                console.log('üîó Navigating to URL:', fullUrl);
                window.location.href = fullUrl;
                return false;
                
            } catch (error) {
                console.error('‚ùå Error navigating to admin:', error);
                console.error('‚ùå Error stack:', error.stack);
                alert(`‚ùå C√≥ l·ªói x·∫£y ra khi truy c·∫≠p trang admin: ${error.message}`);
                return false;
            }
        };

        // Auth state listener
        firebaseCompatAuth.onAuthStateChanged(async (user) => {
            console.log('üîÑ Auth state changed:', user ? user.displayName : 'No user');
            
            if (user) {
                console.log('‚úÖ User signed in:', user.displayName);
                
                // IMMEDIATELY clear local cart when logging in with Google
                console.log('üßπ Clearing local cart for Google login...');
                localStorage.removeItem('techHavenCart');
                localStorage.removeItem('techHavenCartCount');
                
                // Reset global cart variables
                if (window.cartItems) window.cartItems.length = 0;
                if (window.cartCount !== undefined) window.cartCount = 0;
                
                // Clear SmartCart data if available
                if (window.smartCart) {
                    window.smartCart.cartItems = [];
                    window.smartCart.cartCount = 0;
                }
                
                window.currentUser = {
                    uid: user.uid,
                    name: user.displayName,
                    email: user.email,
                    photo: user.photoURL,
                    provider: 'google'
                };
                
                console.log('üîÑ Updating UI, currentUser:', window.currentUser);
                
                // Start real-time cart listener for cross-tab synchronization
                if (typeof startCartRealtimeListener === 'function') {
                    startCartRealtimeListener(user.uid);
                }
                
                // Get fresh token and send to server
                const idToken = await user.getIdToken();
                await sendTokenToServer(idToken);
                
                updateUIBasedOnAuthStatus();
            } else {
                console.log('‚ùå Firebase user signed out, checking for manual user...');
                
                // Check if we're in the middle of a logout process
                const isLoggingOut = localStorage.getItem('isLoggingOut');
                if (isLoggingOut) {
                    console.log('üö™ Logout in progress, clearing all user data');
                    localStorage.removeItem('isLoggingOut');
                    localStorage.removeItem('techHavenUser');
                    localStorage.removeItem('techHavenUserToken');
                    window.currentUser = null;
                    updateUIBasedOnAuthStatus();
                    return;
                }
                
                // Don't clear currentUser if it's a manual login user (not during logout)
                if (window.currentUser && window.currentUser.provider === 'manual') {
                    console.log('‚úÖ Preserving manual login user:', window.currentUser.name);
                    // Don't clear manual user data
                    return;
                } else {
                    console.log('‚ùå No manual user found, clearing currentUser');
                    window.currentUser = null;
                    updateUIBasedOnAuthStatus();
                }
            }
        });

        // Update UI based on auth state
        function updateUI() {
            console.log('üîÑ Updating UI, currentUser:', currentUser);
            
            // Load fresh user data before updating UI
            loadFreshUserData().then(() => {
                // Update user icons
                updateUserIcons();
                
                // Update profile panel
                if (currentUser) {
                    updateUserProfilePanel();
                }
            });
        }

        // Load fresh user data from database
        async function loadFreshUserData() {
            console.log('üìä Loading fresh user data from database...');
            
            if (!window.currentUser) {
                console.log('‚ùå No currentUser to refresh');
                return;
            }
            
            try {
                let apiUrl, headers;
                
                // Try Firebase Auth token first
                const firebaseUser = firebaseCompatAuth.currentUser;
                if (firebaseUser) {
                    const idToken = await firebaseUser.getIdToken();
                    apiUrl = '/api/user/profile';
                    headers = {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    };
                } else {
                    // Use manual authentication with UID
                    apiUrl = `/api/user/profile?uid=${window.currentUser.uid}`;
                    headers = {
                        'Content-Type': 'application/json'
                    };
                }
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: headers
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.user) {
                        console.log('‚úÖ Fresh user data loaded:', result.user);
                        
                        // Update window.currentUser with fresh data
                        window.currentUser = {
                            ...window.currentUser,
                            ...result.user,
                            photo: result.user.photo || window.currentUser.photo || window.currentUser.picture
                        };
                        
                        // Update localStorage for manual users
                        if (window.currentUser.provider === 'manual') {
                            localStorage.setItem('techHavenUser', JSON.stringify(window.currentUser));
                        }
                        
                        console.log('üîÑ Updated currentUser with fresh data:', window.currentUser);
                    }
                } else {
                    console.log('‚ö†Ô∏è Failed to load fresh user data, using cached data');
                }
            } catch (error) {
                console.error('‚ùå Error loading fresh user data:', error);
                console.log('‚ö†Ô∏è Using cached user data');
            }
        }

        // Update user icons in header
        function updateUserIcons() {
            console.log('üîÑ EJS updateUserIcons called, window.currentUser:', window.currentUser);
            
            const userIconContainer = document.getElementById('userIconContainer');
            if (userIconContainer) {
                if (window.currentUser) {
                    console.log('‚úÖ EJS: User found, updating icon for:', window.currentUser.name);
                    console.log('‚úÖ EJS: User provider:', window.currentUser.provider);
                    
                    const isAdmin = window.currentUser.is_admin ? ' üëë' : '';
                    
                    // Priority: Firestore photo > Google picture > no avatar
                    const avatar = window.currentUser.photo || window.currentUser.picture;
                    console.log('üñºÔ∏è Avatar URL:', avatar);
                    
                    if (avatar) {
                        // User with avatar
                        userIconContainer.innerHTML = `
                            <div class="user-icon-authenticated" onclick="openUserProfile()">
                                <img src="${avatar}" alt="${window.currentUser.name}" class="user-avatar-small" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"
                                     style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
                                <i class="fas fa-user-circle" style="display: none; margin-right: 8px; font-size: 20px; color: #667eea;"></i>
                                <span class="user-name-display">${window.currentUser.name || window.currentUser.email}${isAdmin}</span>
                            </div>
                        `;
                    } else {
                        // User without avatar
                        userIconContainer.innerHTML = `
                            <div class="user-icon-authenticated" onclick="openUserProfile()">
                                <i class="fas fa-user-circle" style="margin-right: 8px; font-size: 20px; color: #667eea;"></i>
                                <span class="user-name-display">${window.currentUser.name || window.currentUser.email}${isAdmin}</span>
                            </div>
                        `;
                    }
                    console.log('‚úÖ EJS: User icon updated successfully');
                } else {
                    console.log('‚ùå EJS: No currentUser, showing login icon');
                    userIconContainer.innerHTML = `<i class="fas fa-user" onclick="openLoginModal()" style="cursor: pointer;"></i>`;
                }
            } else {
                console.log('‚ùå EJS: userIconContainer not found');
            }
            
            // Update mobile nav user link
            const mobileUserLink = document.getElementById('mobileUserLink');
            if (mobileUserLink) {
                if (window.currentUser) {
                    mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openUserProfile();');
                    const userName = window.currentUser.name || window.currentUser.email;
                    const displayName = userName.length > 15 ? userName.substring(0, 15) + '...' : userName;
                    const isAdmin = window.currentUser.is_admin ? ' üëë' : '';
                    mobileUserLink.innerHTML = `<i class="fas fa-user-circle"></i> ${displayName}${isAdmin}`;
                    console.log('‚úÖ Mobile nav updated for logged in user:', displayName);
                } else {
                    mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openLoginModal();');
                    mobileUserLink.innerHTML = `<i class="fas fa-user"></i> T√†i kho·∫£n`;
                    console.log('‚úÖ Mobile nav updated for guest user');
                }
            } else {
                console.log('‚ùå Mobile user link not found');
            }
        }

        // H√†m x·ª≠ l√Ω click v√†o user icon
        function handleUserIconClick() {
            console.log('üë§ User icon clicked!');
            
            if (window.currentUser) {
                console.log('‚úÖ User is logged in, opening profile panel');
                openUserProfile();
            } else {
                console.log('‚ùå User not logged in, opening login modal');
                openLoginModal();
            }
        }

        // Update user profile panel with current user data
        async function updateUserProfilePanel() {
            console.log('üîÑ updateUserProfilePanel called');
            console.log('üîÑ window.currentUser:', window.currentUser);
            
            if (!window.currentUser) {
                console.log('‚ùå No currentUser found');
                return;
            }
            
            // Load fresh data first
            await loadFreshUserData();
            
            // Update profile name and email
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profileInfoName = document.getElementById('profileInfoName');
            const profileInfoEmail = document.getElementById('profileInfoEmail');
            const profileAvatar = document.getElementById('profileAvatar');
            const avatarPlaceholder = document.querySelector('.avatar-placeholder');
            
            if (profileName) profileName.textContent = window.currentUser.name || window.currentUser.email;
            if (profileEmail) profileEmail.textContent = window.currentUser.email;
            if (profileInfoName) profileInfoName.textContent = window.currentUser.name || window.currentUser.email;
            if (profileInfoEmail) profileInfoEmail.textContent = window.currentUser.email;
            
            // Handle avatar display with priority: Firestore photo > Google picture > placeholder
            const avatar = window.currentUser.photo || window.currentUser.picture;
            console.log('üñºÔ∏è Profile avatar URL:', avatar);
            
            if (avatar) {
                if (profileAvatar) {
                    profileAvatar.src = avatar;
                    profileAvatar.style.display = 'block';
                    profileAvatar.onerror = function() {
                        console.log('‚ùå Avatar failed to load, showing placeholder');
                        this.style.display = 'none';
                        if (avatarPlaceholder) {
                            avatarPlaceholder.style.display = 'flex';
                        }
                    };
                }
                if (avatarPlaceholder) {
                    avatarPlaceholder.style.display = 'none';
                }
            } else {
                if (profileAvatar) {
                    profileAvatar.style.display = 'none';
                }
                if (avatarPlaceholder) {
                    avatarPlaceholder.style.display = 'flex';
                }
            }
            
            // Update account type based on provider
            const accountTypeElement = document.querySelector('.info-row:nth-child(3) span');
            if (accountTypeElement) {
                if (window.currentUser.provider === 'manual') {
                    accountTypeElement.innerHTML = '<i class="fas fa-user-shield" style="color: #28a745;"></i> T√†i kho·∫£n th∆∞·ªùng';
                } else {
                    accountTypeElement.innerHTML = '<i class="fab fa-google text-danger"></i> Google OAuth';
                }
            }
            
            // Update join date
            const joinDateElement = document.getElementById('joinDate');
            if (joinDateElement) {
                const joinDate = window.currentUser.createdAt ? 
                    new Date(window.currentUser.createdAt).toLocaleDateString('vi-VN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) :
                    new Date().toLocaleDateString('vi-VN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                joinDateElement.textContent = joinDate;
            }
            
            console.log('‚úÖ User profile panel updated with fresh data');
        }

        // Function to open user profile panel
        async function openUserProfile() {
            console.log('üöÄ Opening user profile panel');
            
            if (!window.currentUser) {
                console.log('‚ùå No user logged in, opening login modal instead');
                openLoginModal();
                return;
            }
            
            // Show the profile panel first
            const panel = document.getElementById('userProfilePanel');
            if (panel) {
                panel.classList.add('active');
                console.log('‚úÖ Profile panel opened');
                
                // Update profile panel with fresh data (async)
                updateUserProfilePanel();
            } else {
                console.log('‚ùå Profile panel not found');
            }
        }

        // Function to close user profile panel
        function closeUserProfile() {
            const panel = document.getElementById('userProfilePanel');
            if (panel) {
                panel.classList.remove('active');
                console.log('‚úÖ Profile panel closed');
            }
        }

        // Legacy compatibility functions
        window.handleGoogleLogin = signInWithGoogle;
        window.handleLogout = signOutUser;
        
        // New logout function to handle both Google and manual login
        window.logoutCurrentUser = async function() {
            try {
                console.log('üö™ Logging out current user...');
                console.log('üîç Current user before logout:', window.currentUser);
                
                // Set logout flag to prevent auto-restore
                localStorage.setItem('isLoggingOut', 'true');
                
                // Close profile panel first
                closeUserProfile();
                
                // Clear manual user data from localStorage first
                localStorage.removeItem('techHavenUser');
                localStorage.removeItem('techHavenUserToken');
                console.log('‚úÖ Manual user data cleared from localStorage');
                
                // Sign out from Firebase Auth (for Google users)
                try {
                    await firebaseCompatAuth.signOut();
                    console.log('‚úÖ Firebase sign out successful');
                } catch (firebaseError) {
                    console.log('‚ÑπÔ∏è Firebase signout not needed (manual user):', firebaseError.message);
                }
                
                // Clear current user data completely
                window.currentUser = null;
                console.log('‚úÖ window.currentUser cleared');
                
                // Clear any other stored user data
                sessionStorage.clear();
                console.log('‚úÖ Session storage cleared');
                
                // Update UI immediately
                updateUIBasedOnAuthStatus();
                
                // Show notification
                console.log('‚úÖ User logged out successfully');
                alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
                
                // Force immediate reload without delay
                location.reload();
                
            } catch (error) {
                console.error('‚ùå Logout error:', error);
                
                // Force clear everything even on error
                localStorage.removeItem('techHavenUser');
                localStorage.removeItem('techHavenUserToken');
                localStorage.removeItem('isLoggingOut');
                sessionStorage.clear();
                window.currentUser = null;
                
                // Force reload even if there's an error
                location.reload();
            }
        };
        
        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåê DOM loaded, checking auth state...');
            // Auth state listener will handle the initial state
        });
        
        // Initialize user data from DOM
        window.currentUser = null;
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåê DOM loaded, checking user data...');
            
            const userDataElement = document.getElementById('user-data');
            if (userDataElement && userDataElement.textContent) {
                try {
                    window.currentUser = JSON.parse(userDataElement.textContent);
                    console.log('‚úÖ FRONTEND: Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:', window.currentUser);
                    console.log('‚úÖ FRONTEND: User name:', window.currentUser.name);
                    console.log('‚úÖ FRONTEND: User email:', window.currentUser.email);
                    
                    // G·ªçi API ƒë·ªÉ ki·ªÉm tra th√™m
                    checkUserStatus();
                } catch (e) {
                    console.log('‚ùå FRONTEND: Error parsing user data:', e);
                    console.log('‚ùå FRONTEND: Raw user data:', userDataElement.textContent);
                }
            } else {
                console.log('‚ùå FRONTEND: No user data element found');
                
                // Ki·ªÉm tra tr·ª±c ti·∫øp t·ª´ server
                checkUserStatus();
            }
        });
        
        // Ki·ªÉm tra tr·∫°ng th√°i user t·ª´ API
        async function checkUserStatus() {
            try {
                console.log('üîç Checking user status from API...');
                const response = await fetch('/api/user');
                const data = await response.json();
                
                console.log('üì° API Response:', data);
                
                if (data.authenticated && data.user) {
                    console.log('‚úÖ API: User is authenticated!');
                    console.log('‚úÖ API: User data:', data.user);
                    window.currentUser = data.user;
                    updateUIBasedOnAuthStatus();
                } else {
                    console.log('‚ùå API: User not authenticated');
                }
            } catch (error) {
                console.error('‚ùå Error checking user status:', error);
            }
        }
    </script>
    
    <!-- Hidden user data (improved debugging) -->
    <script type="application/json" id="user-data">null</script>
    
    <!-- Main JavaScript -->
    <script>
        // L·∫•y user data t·ª´ server
        const userDataElement = document.getElementById('user-data');
        const userData = userDataElement ? JSON.parse(userDataElement.textContent) : null;
        window.currentUser = userData;
        
        if (window.currentUser) {
            console.log('‚úÖ Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:', window.currentUser);
        } else {
            console.log('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p');
        }
        
        // C·∫≠p nh·∫≠t giao di·ªán d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        document.addEventListener('DOMContentLoaded', function() {
            // Show error messages from URL parameters
            showErrorMessages();
            updateUIBasedOnAuthStatus();
        });
        
        async function updateUIBasedOnAuthStatus() {
            console.log('üîÑ Updating UI based on auth status...');
            
            try {
                // Use the new updateUI function that loads fresh data
                await updateUI();
                
            } catch (error) {
                console.error('‚ùå Error updating UI:', error);
            }
        }
        
        // Function ƒë·ªÉ m·ªü user profile panel
        function openUserProfile() {
            console.log('üë§ Opening user profile panel');
            
            // Check if user is logged in (either Google or manual)
            if (!window.currentUser) {
                // Don't restore user if we're in logout process
                const isLoggingOut = localStorage.getItem('isLoggingOut');
                if (!isLoggingOut) {
                    // Check for stored manual user
                    const storedUser = localStorage.getItem('techHavenUser');
                    if (storedUser) {
                        try {
                            window.currentUser = JSON.parse(storedUser);
                            console.log('‚úÖ Found stored user:', window.currentUser.name);
                        } catch (e) {
                            console.log('‚ùå Error parsing stored user');
                        }
                    }
                } else {
                    console.log('üö™ Logout in progress, not restoring user');
                }
            }
            
            if (!window.currentUser) {
                console.log('‚ùå No user logged in, opening login modal instead');
                openLoginModal();
                return;
            }
            
            // Update UI first to ensure currentUser is properly displayed
            updateUserIcons();
            
            const userProfilePanel = document.getElementById('userProfilePanel');
            if (userProfilePanel) {
                userProfilePanel.classList.add('active');
                console.log('‚úÖ User profile panel opened');
                
                // Wait a bit for panel to be rendered, then update with user info
                setTimeout(() => {
                    console.log('üîÑ Calling updateUserProfilePanel from openUserProfile (after 100ms delay)');
                    updateUserProfilePanel();
                }, 100);
            } else {
                console.log('‚ùå User profile panel not found');
            }
        }
        
        // Make functions globally available
        window.openUserProfile = openUserProfile;
        window.closeUserProfile = closeUserProfile;
        window.editUserProfile = editUserProfile;
        window.viewOrderHistory = viewOrderHistory;
        window.loadFreshUserData = loadFreshUserData; // Make this globally available
        window.updateUI = updateUI; // Make this globally available
        
        // Function ƒë·ªÉ ƒë√≥ng user profile panel
        function closeUserProfile() {
            console.log('‚ùå Closing user profile panel');
            const userProfilePanel = document.getElementById('userProfilePanel');
            if (userProfilePanel) {
                userProfilePanel.classList.remove('active');
                console.log('‚úÖ User profile panel closed');
            }
        }
        
        // Update authentication state when user logs in
        
        // C√°c function cho user profile management
        function editUserProfile() {
            console.log('‚úèÔ∏è Edit user profile clicked');
            
            if (!window.currentUser) {
                alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ch·ªânh s·ª≠a h·ªì s∆°!');
                return;
            }
            
            showEditProfileModal();
        }
        
        // Show edit profile modal
        function showEditProfileModal() {
            const currentUser = window.currentUser;
            if (!currentUser) return;
            
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'edit-profile-modal';
            modal.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 500px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            `;
            
            modal.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h3 style="color: #333; margin-bottom: 10px;">‚úèÔ∏è Ch·ªânh S·ª≠a H·ªì S∆°</h3>
                    <p style="color: #666; font-size: 14px;">C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n c·ªßa b·∫°n</p>
                </div>
                
                <form id="editProfileForm">
                    <!-- Avatar Section -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="position: relative; display: inline-block;">
                            <div id="currentAvatar" style="
                                width: 80px;
                                height: 80px;
                                border-radius: 50%;
                                background: #f0f0f0;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 10px;
                                overflow: hidden;
                                border: 3px solid #ddd;
                            ">
                                ${currentUser.photo ? 
                                    `<img src="${currentUser.photo}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                    `<i class="fas fa-user" style="font-size: 35px; color: #999;"></i>`
                                }
                            </div>
                            <button type="button" onclick="triggerAvatarUpload()" style="
                                position: absolute;
                                bottom: 5px;
                                right: -5px;
                                background: #007bff;
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 30px;
                                height: 30px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <i class="fas fa-camera" style="font-size: 12px;"></i>
                            </button>
                        </div>
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(this)">
                        <p style="font-size: 12px; color: #666; margin: 0;">Click camera ƒë·ªÉ thay ƒë·ªïi ·∫£nh ƒë·∫°i di·ªán</p>
                    </div>
                    
                    <!-- Name Field -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                            <i class="fas fa-user"></i> H·ªç v√† t√™n
                        </label>
                        <input type="text" id="editName" value="${currentUser.name || ''}" style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            font-size: 14px;
                            box-sizing: border-box;
                        " placeholder="Nh·∫≠p h·ªç v√† t√™n">
                    </div>
                    
                    <!-- Phone Field -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                            <i class="fas fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i
                        </label>
                        <input type="tel" id="editPhone" value="${currentUser.phone || ''}" style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            font-size: 14px;
                            box-sizing: border-box;
                        " placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                    </div>
                    
                    <!-- Email Field (readonly) -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                            <i class="fas fa-envelope"></i> Email
                        </label>
                        <input type="email" value="${currentUser.email}" readonly style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            font-size: 14px;
                            background: #f8f9fa;
                            color: #666;
                            box-sizing: border-box;
                        ">
                        <small style="color: #666; font-size: 12px;">Email kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditProfileModal()" style="
                            padding: 12px 20px;
                            border: 1px solid #ddd;
                            background: white;
                            color: #666;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                        ">
                            H·ªßy
                        </button>
                        <button type="submit" style="
                            padding: 12px 20px;
                            border: none;
                            background: #007bff;
                            color: white;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                        ">
                            üíæ L∆∞u Thay ƒê·ªïi
                        </button>
                    </div>
                </form>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Add form submit handler
            document.getElementById('editProfileForm').addEventListener('submit', handleProfileUpdate);
            
            // Make functions global
            window.triggerAvatarUpload = function() {
                document.getElementById('avatarInput').click();
            };
            
            window.previewAvatar = function(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('currentAvatar').innerHTML = 
                            `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            };
            
            window.closeEditProfileModal = function() {
                overlay.remove();
                // Clean up global functions
                delete window.triggerAvatarUpload;
                delete window.previewAvatar;
                delete window.closeEditProfileModal;
            };
            
            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeEditProfileModal();
                }
            });
        }
        
        // Handle profile update
        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const avatarFile = document.getElementById('avatarInput').files[0];
            
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p h·ªç v√† t√™n!');
                return;
            }
            
            try {
                // Show loading
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '‚è≥ ƒêang l∆∞u...';
                submitBtn.disabled = true;
                
                let photoUrl = window.currentUser.photo;
                
                // Upload avatar if provided
                if (avatarFile) {
                    photoUrl = await uploadAvatar(avatarFile);
                }
                
                // Update profile via API
                const response = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uid: window.currentUser.uid,
                        name: name,
                        phone: phone,
                        photoUrl: photoUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update local user data
                    window.currentUser = { ...window.currentUser, ...data.user };
                    localStorage.setItem('techHavenUser', JSON.stringify(window.currentUser));
                    
                    // Update UI
                    updateUserProfilePanel();
                    updateUserIcons();
                    
                    // Close modal
                    closeEditProfileModal();
                    
                    // Show success message
                    if (typeof showNotification === 'function') {
                        showNotification('H·ªì s∆° ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                    } else {
                        alert('H·ªì s∆° ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    }
                } else {
                    throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra');
                }
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t h·ªì s∆°: ' + error.message);
                
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Upload avatar to a simple image hosting service or convert to base64
        async function uploadAvatar(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // For now, we'll use base64 data URL
                    // In production, you might want to upload to Firebase Storage
                    resolve(e.target.result);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function viewOrderHistory() {
            console.log('üìã View order history clicked');
            alert('Ch·ª©c nƒÉng xem l·ªãch s·ª≠ ƒë∆°n h√†ng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        }
        
        async function showUserMenu() {
            try {
                // G·ªçi API ƒë·ªÉ l·∫•y user menu HTML
                const menuResponse = await fetch('/api/user-menu');
                const menuData = await menuResponse.json();
                
                if (menuData.success && menuData.html) {
                    // Remove existing dropdown
                    const existing = document.getElementById('userDropdown');
                    if (existing) existing.remove();
                    
                    // Add new dropdown
                    document.body.insertAdjacentHTML('beforeend', menuData.html);
                    
                    // Close on click outside
                    setTimeout(() => {
                        document.addEventListener('click', function closeDropdown(e) {
                            if (!e.target.closest('#userDropdown')) {
                                const dropdown = document.getElementById('userDropdown');
                                if (dropdown) dropdown.remove();
                                document.removeEventListener('click', closeDropdown);
                            }
                        });
                    }, 100);
                }
            } catch (error) {
                console.error('‚ùå Error loading user menu:', error);
            }
        }
        
        // Wrapper function for login modal (compatibility with script.js)
        function openModal() {
            if (typeof openLoginModal === 'function') {
                openLoginModal();
            } else {
                console.error('‚ùå openLoginModal function not found');
                alert('Ch·ª©c nƒÉng ƒëƒÉng nh·∫≠p ƒëang ƒë∆∞·ª£c t·∫£i...');
            }
        }
    </script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"></script>
</head>
<body class="product-detail-page">
    <!-- Header with Navigation -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <h1>TECH HAVEN</h1>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <div class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            
            <div class="nav-menu">
                <a href="/">TRANG CH·ª¶</a>
                <a href="/shop">C·ª¨A H√ÄNG</a>
                <div class="admin-dropdown">
                    <a href="#" class="dropdown-toggle" onclick="event.stopPropagation();">ADMIN <i class="fas fa-chevron-down"></i></a>
                    <div class="dropdown-menu">
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/input'); return false;">INPUT</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/edit'); return false;">EDIT</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/coupon'); return false;">COUPON</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/bill'); return false;">BILL</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); navigateToAdmin('/admin/revenue'); return false;">REVENUE</a>
                    </div>
                </div>
                <a href="/laptops">LAPTOP</a>
                <a href="/components">LINH KI·ªÜN</a>
                <a href="/peripherals">PH·ª§ KI·ªÜN</a>
                <a href="/build-pc" class="build-btn">X√ÇY D·ª∞NG PC</a>
                <div class="mobile-nav-icons">
                    <a href="#" onclick="toggleSearch(); return false;"><i class="fas fa-search"></i> T√¨m ki·∫øm</a>
                    <a href="#" onclick="toggleCart(); return false;"><i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng :<span id="cartCount">0</span></a>
                    <a href="#" id="mobileUserLink" onclick="openLoginModal(); return false;"><i class="fas fa-user"></i> T√†i kho·∫£n</a>
                    <a href="/shop"><i class="fas fa-store"></i> C·ª≠a H√†ng</a>
                </div>
            </div>
            <div class="nav-icons">
                <i class="fas fa-search" onclick="toggleSearch()"></i>
                <div class="cart-icon-wrapper" onclick="toggleCart()">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-badge" id="cartBadge">0</span>
                </div>
                <!-- User icon - s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript d·ª±a v√†o tr·∫°ng th√°i ƒëƒÉng nh·∫≠p -->
                <div id="userIconContainer" class="user-icon-container">
                    <i class="fas fa-user" id="defaultUserIcon" onclick="handleUserIconClick();" style="cursor: pointer;"></i>
                </div>
            </div>
        </nav>
    </header>

    <!-- Product Detail Content -->
    <div class="product-detail-content">
        <div class="product-container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="/"><i class="fas fa-home"></i></a>
                <span class="separator"><i class="fas fa-chevron-right"></i></span>
                <a href="/shop">C·ª≠a h√†ng</a>
                <span class="separator"><i class="fas fa-chevron-right"></i></span>
                <a href="/shop?category=laptop">laptop</a>
                <span class="separator"><i class="fas fa-chevron-right"></i></span>
                <span class="current"><%= product.name || 'S·∫£n ph·∫©m' %></span>
            </nav>

            <!-- Product Detail Grid -->
            <div class="product-detail-grid" data-product-id="<%= product.id || '' %>">
                <!-- Product Gallery -->
                <div class="product-gallery">
                    <div class="main-image">
                        <% if (product.images && product.images.length > 0) { %>
                            <img src="<%= product.images[0] %>" alt="<%= product.name %>" id="mainProductImage">
                        <% } else { %>
                            <div class="placeholder-image">
                                <i class="fas fa-image" style="font-size: 4rem; color: #ccc;"></i>
                                <p>Kh√¥ng c√≥ h√¨nh ·∫£nh</p>
                            </div>
                        <% } %>
                    </div>
                    <div class="thumbnail-gallery">
                        <% if (product.images && product.images.length > 0) { %>
                            <% product.images.forEach((image, index) => { %>
                                <div class="thumbnail <%= index === 0 ? 'active' : '' %>" onclick="changeMainImage('<%= image %>', this)">
                                    <img src="<%= image %>" alt="<%= product.name %> - ·∫¢nh <%= index + 1 %>" loading="lazy">
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="thumbnail">
                                <i class="fas fa-image"></i>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Product Info -->
                <div class="product-info">
                    <% if (product.status && product.status === 'active') { %>
                        <% if (product.availability === 'in-stock') { %>
                            <div class="product-badge">C√≤n h√†ng</div>
                        <% } else if (product.availability === 'out-of-stock') { %>
                            <div class="product-badge out-of-stock">H·∫øt h√†ng</div>
                        <% } else if (product.availability === 'pre-order') { %>
                            <div class="product-badge pre-order">ƒê·∫∑t tr∆∞·ªõc</div>
                        <% } else { %>
                            <div class="product-badge">Li√™n h·ªá</div>
                        <% } %>
                    <% } else { %>
                        <div class="product-badge inactive">Ng·ª´ng kinh doanh</div>
                    <% } %>
                    
                    <h1 class="product-title"><%= product.name || 'T√™n s·∫£n ph·∫©m' %></h1>
                    
                    <div class="product-rating">
                        <div class="stars">
                            <% 
                                const rating = product.rating || 0;
                                const fullStars = Math.floor(rating);
                                const hasHalfStar = rating % 1 !== 0;
                                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                            %>
                            
                            <% for(let i = 0; i < fullStars; i++) { %>
                                <i class="fas fa-star"></i>
                            <% } %>
                            
                            <% if (hasHalfStar) { %>
                                <i class="fas fa-star-half-alt"></i>
                            <% } %>
                            
                            <% for(let i = 0; i < emptyStars; i++) { %>
                                <i class="far fa-star"></i>
                            <% } %>
                        </div>
                        <span class="rating-text">(<%= product.reviewCount || 0 %> ƒë√°nh gi√°)</span>
                    </div>
                    
                    <div class="product-price">
                        <span class="current-price">
                            <%= new Intl.NumberFormat('vi-VN').format(product.price || 0) %> VNƒê
                        </span>
                        <% if (product.oldPrice && product.oldPrice > product.price) { %>
                            <span class="old-price">
                                <%= new Intl.NumberFormat('vi-VN').format(product.oldPrice) %> VNƒê
                            </span>
                            <span class="discount-badge">
                                <% 
                                    const discountPercent = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
                                %>
                                -<%= discountPercent %>%
                            </span>
                        <% } %>
                    </div>
                    
                    <div class="product-meta">
                        <div class="meta-item">
                            <span class="meta-label">T√¨nh tr·∫°ng:</span>
                            <span class="meta-value availability <%= product.availability || 'in-stock' %>">
                                <% if (product.availability === 'in-stock') { %>
                                    C√≤n h√†ng
                                <% } else if (product.availability === 'out-of-stock') { %>
                                    H·∫øt h√†ng
                                <% } else if (product.availability === 'pre-order') { %>
                                    ƒê·∫∑t tr∆∞·ªõc
                                <% } else { %>
                                    Li√™n h·ªá
                                <% } %>
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">SKU:</span>
                            <span class="meta-value"><%= product.sku || 'N/A' %></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Th∆∞∆°ng hi·ªáu:</span>
                            <span class="meta-value"><%= product.brand || 'N/A' %></span>
                        </div>
                        <% if (product.stock !== undefined) { %>
                        <div class="meta-item">
                            <span class="meta-label">C√≤n l·∫°i:</span>
                            <span class="meta-value"><%= product.stock %> s·∫£n ph·∫©m</span>
                        </div>
                        <% } %>
                    </div>
                    
                    <div class="product-description">
                        <% if (product.description && product.description.trim() !== '') { %>
                            <p><%= product.description %></p>
                        <% } else { %>
                            <p>M√¥ t·∫£ s·∫£n ph·∫©m ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</p>
                        <% } %>
                    </div>
                    
                    <div class="product-actions">
                        <div class="quantity-selector">
                            <span class="quantity-label">S·ªë l∆∞·ª£ng:</span>
                            <div class="quantity-controls">
                                <button class="quantity-btn decrease">-</button>
                                <input type="number" class="quantity-input" value="1" min="1" max="99">
                                <button class="quantity-btn increase">+</button>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="add-to-cart-btn" 
                                    data-product-name="<%= product.name || '' %>"
                                    data-product-price="<%= new Intl.NumberFormat('vi-VN').format(product.price || 0) %> VNƒê"
                                    data-product-id="<%= product.id || '' %>"
                                    data-product-image="<%= (product.images && product.images[0]) || '' %>">
                                <i class="fas fa-cart-plus"></i>
                                Th√™m v√†o gi·ªè h√†ng
                            </button>
                            <button class="buy-now-btn">
                                <i class="fas fa-bolt"></i>
                                Mua ngay
                            </button>
                            <button class="wishlist-btn">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Tabs -->
            <div class="product-tabs">
                <div class="tab-headers">
                    <div class="tab-header active">Th√¥ng s·ªë k·ªπ thu·∫≠t</div>
                    <div class="tab-header">T√≠nh nƒÉng n·ªïi b·∫≠t</div>
                    <div class="tab-header">ƒê√°nh gi√°</div>
                </div>
                
                <div class="tab-content active">
                    <div class="specs-grid">
                        <% if (product.specifications && Object.keys(product.specifications).length > 0) { %>
                            <% Object.entries(product.specifications).forEach(([key, value]) => { %>
                                <div class="spec-item">
                                    <span class="spec-label">
                                        <%= key %>:
                                    </span>
                                    <span class="spec-value"><%= value %></span>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="spec-item">
                                <span class="spec-label">Th√¥ng s·ªë:</span>
                                <span class="spec-value">ƒêang c·∫≠p nh·∫≠t...</span>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div class="tab-content">
                    <div class="features-list">
                        <% if (product.features && Array.isArray(product.features) && product.features.length > 0) { %>
                            <% product.features.forEach(feature => { %>
                                <div class="feature-item">
                                    <div class="feature-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="feature-text"><%= feature %></div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="feature-text">Th√¥ng tin t√≠nh nƒÉng ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</div>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div class="tab-content">
                    <div class="reviews-section">
                        <div class="reviews-summary">
                            <h3>ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h3>
                            <div class="rating-summary">
                                <div class="average-rating">
                                    <span class="rating-number">5.0</span>
                                    <div class="stars">
                                        
                                            
                                                <i class="fas fa-star"></i>
                                            
                                        
                                            
                                                <i class="fas fa-star"></i>
                                            
                                        
                                            
                                                <i class="fas fa-star"></i>
                                            
                                        
                                            
                                                <i class="fas fa-star"></i>
                                            
                                        
                                            
                                                <i class="fas fa-star"></i>
                                            
                                        
                                    </div>
                                    <span class="review-count">(152 ƒë√°nh gi√°)</span>
                                </div>
                            </div>
                        </div>
                        <div class="review-placeholder">
                            <p style="text-align: center; color: #666; padding: 2rem;">
                                <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                T√≠nh nƒÉng ƒë√°nh gi√° chi ti·∫øt s·∫Ω s·ªõm ƒë∆∞·ª£c c·∫≠p nh·∫≠t!
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related Products -->
            <div class="related-products">
                <h2 class="section-title">S·∫£n ph·∫©m li√™n quan</h2>
                <div class="related-container">
                    <button class="nav-btn prev-btn" id="prevBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="products-wrapper">
                        <div class="products-track" id="productsTrack">
                            
                                
                                    <div class="product-item" data-product-id="2">
                                        <div class="product-image">
                                            
                                                <img src="/images/laptop.jpg" alt="MSI Katana 17 B13V">
                                            
                                        </div>
                                        <h4 class="product-name">MSI Katana 17 B13V</h4>
                                        <p class="product-price">
                                            28.990.000 VNƒê
                                        </p>
                                    </div>
                                
                                    <div class="product-item" data-product-id="3">
                                        <div class="product-image">
                                            
                                                <img src="/images/laptop.jpg" alt="Acer Predator Helios 300">
                                            
                                        </div>
                                        <h4 class="product-name">Acer Predator Helios 300</h4>
                                        <p class="product-price">
                                            32.990.000 VNƒê
                                        </p>
                                    </div>
                                
                                    <div class="product-item" data-product-id="4">
                                        <div class="product-image">
                                            
                                                <img src="/images/laptop.jpg" alt="HP Omen 16-k0000">
                                            
                                        </div>
                                        <h4 class="product-name">HP Omen 16-k0000</h4>
                                        <p class="product-price">
                                            26.990.000 VNƒê
                                        </p>
                                    </div>
                                    <div class="product-item" data-product-id="5">
                                        <div class="product-image">
                                            
                                                <img src="/images/laptop.jpg" alt="HP ">
                                            
                                        </div>
                                        <h4 class="product-name">HP Omen 16-k0000</h4>
                                        <p class="product-price">
                                            26.990.000 VNƒê
                                        </p>
                                    </div>
                                    <div class="product-item" data-product-id="6">
                                        <div class="product-image">
                                            
                                                <img src="/images/laptop.jpg" alt="HP ">
                                            
                                        </div>
                                        <h4 class="product-name">HP Omen 16-k0000</h4>
                                        <p class="product-price">
                                            26.990.000 VNƒê
                                        </p>
                                    </div>
                                
                            
                        </div>
                    </div>
                    <button class="nav-btn next-btn" id="nextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Shopping Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> Gi·ªè H√†ng</h3>
            <button class="close-cart" onclick="toggleCart()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="empty-cart">
                <i class="fas fa-shopping-cart" style="font-size: 3rem; color: #ccc;"></i>
                <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <strong>T·ªïng c·ªông: <span id="cartTotal">0 VNƒê</span></strong>
            </div>
            <button class="checkout-btn" onclick="
                console.log('üõí Checkout button clicked'); 
                
                // First, ensure we reload cart data from Firebase for logged users
                (async function() {
                    if (window.currentUser) {
                        console.log('ÔøΩ User logged in, reloading cart from Firebase first');
                        await loadCart(); // This will load from Firebase and call syncCartEverywhere()
                    } else {
                        console.log('ÔøΩ No user, using local cart');
                        syncCartEverywhere();
                    }
                    
                    console.log('üõí cart.length in shop.ejs after reload:', cart ? cart.length : 'cart undefined');
                    console.log('üõí window.cartItems length after sync:', window.cartItems ? window.cartItems.length : 'cartItems undefined');
                    
                    // Now call proceedToCheckout
                    if (typeof window.proceedToCheckout === 'function') {
                        proceedToCheckout();
                    } else {
                        console.log('‚ö†Ô∏è proceedToCheckout not found, using direct modal opening');
                        const modal = document.getElementById('checkoutModal');
                        if (modal) {
                            modal.style.display = 'flex';
                            modal.classList.add('active');
                            console.log('‚úÖ Modal opened directly');
                        } else {
                            console.error('‚ùå Modal not found!');
                        }
                    }
                })();
            " id="checkoutBtn">
                <i class="fas fa-credit-card"></i> THANH TO√ÅN
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> Thanh To√°n ƒê∆°n H√†ng</h3>
                <button class="close-modal" onclick="closeCheckoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="checkout-form">
                    <div class="form-section">
                        <h4><i class="fas fa-user"></i> Th√¥ng Tin Kh√°ch H√†ng</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>H·ªç v√† t√™n *</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group">
                                <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                                <input type="tel" id="customerPhone" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="customerEmail" required>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-map-marker-alt"></i> ƒê·ªãa Ch·ªâ Giao H√†ng</h4>
                        
                        <!-- Saved Addresses Section -->
                        <div class="saved-addresses" id="savedAddresses">
                            <div class="address-header">
                                <label>Ch·ªçn ƒë·ªãa ch·ªâ ƒë√£ l∆∞u:</label>
                                <button type="button" class="add-address-btn" onclick="toggleNewAddressForm()">
                                    <i class="fas fa-plus"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi
                                </button>
                            </div>
                            <div class="address-list" id="addressList">
                                <!-- Saved addresses will be loaded here -->
                                <div class="no-addresses" id="noAddresses">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <p>Ch∆∞a c√≥ ƒë·ªãa ch·ªâ ƒë√£ l∆∞u</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- New/Edit Address Form -->
                        <div class="new-address-form" id="newAddressForm" style="display: none;">
                            <div class="form-header">
                                <h5 id="addressFormTitle">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h5>
                                <button type="button" class="cancel-address-btn" onclick="cancelAddressForm()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label>ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
                                <textarea id="newShippingAddress" rows="3" required placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng XYZ"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Th√†nh ph·ªë *</label>
                                    <select id="newShippingCity" required>
                                        <option value="">Ch·ªçn th√†nh ph·ªë</option>
                                        <option value="hanoi">H√† N·ªôi</option>
                                        <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                                        <option value="danang">ƒê√† N·∫µng</option>
                                        <option value="haiphong">H·∫£i Ph√≤ng</option>
                                        <option value="cantho">C·∫ßn Th∆°</option>
                                        <option value="angiang">An Giang</option>
                                        <option value="bacgiang">B·∫Øc Giang</option>
                                        <option value="backan">B·∫Øc K·∫°n</option>
                                        <option value="baclieu">B·∫°c Li√™u</option>
                                        <option value="bacninh">B·∫Øc Ninh</option>
                                        <option value="baria">B√† R·ªãa - V≈©ng T√†u</option>
                                        <option value="bentre">B·∫øn Tre</option>
                                        <option value="binhdinh">B√¨nh ƒê·ªãnh</option>
                                        <option value="binhduong">B√¨nh D∆∞∆°ng</option>
                                        <option value="binhphuoc">B√¨nh Ph∆∞·ªõc</option>
                                        <option value="binhthuan">B√¨nh Thu·∫≠n</option>
                                        <option value="camau">C√† Mau</option>
                                        <option value="caobang">Cao B·∫±ng</option>
                                        <option value="daklak">ƒê·∫Øk L·∫Øk</option>
                                        <option value="daknong">ƒê·∫Øk N√¥ng</option>
                                        <option value="dienbien">ƒêi·ªán Bi√™n</option>
                                        <option value="dongnai">ƒê·ªìng Nai</option>
                                        <option value="dongthap">ƒê·ªìng Th√°p</option>
                                        <option value="gialai">Gia Lai</option>
                                        <option value="hagiang">H√† Giang</option>
                                        <option value="hanam">H√† Nam</option>
                                        <option value="hatinh">H√† Tƒ©nh</option>
                                        <option value="haiduong">H·∫£i D∆∞∆°ng</option>
                                        <option value="haugiang">H·∫≠u Giang</option>
                                        <option value="hoabinh">H√≤a B√¨nh</option>
                                        <option value="hungyen">H∆∞ng Y√™n</option>
                                        <option value="khanhhoa">Kh√°nh H√≤a</option>
                                        <option value="kiengiang">Ki√™n Giang</option>
                                        <option value="kontum">Kon Tum</option>
                                        <option value="laichau">Lai Ch√¢u</option>
                                        <option value="lamdong">L√¢m ƒê·ªìng</option>
                                        <option value="langson">L·∫°ng S∆°n</option>
                                        <option value="laocai">L√†o Cai</option>
                                        <option value="longan">Long An</option>
                                        <option value="namdinh">Nam ƒê·ªãnh</option>
                                        <option value="nghean">Ngh·ªá An</option>
                                        <option value="ninhbinh">Ninh B√¨nh</option>
                                        <option value="ninhthuan">Ninh Thu·∫≠n</option>
                                        <option value="phutho">Ph√∫ Th·ªç</option>
                                        <option value="phuyen">Ph√∫ Y√™n</option>
                                        <option value="quangbinh">Qu·∫£ng B√¨nh</option>
                                        <option value="quangnam">Qu·∫£ng Nam</option>
                                        <option value="quangngai">Qu·∫£ng Ng√£i</option>
                                        <option value="quangninh">Qu·∫£ng Ninh</option>
                                        <option value="quangtri">Qu·∫£ng Tr·ªã</option>
                                        <option value="soctrang">S√≥c TrƒÉng</option>
                                        <option value="sonla">S∆°n La</option>
                                        <option value="tayninh">T√¢y Ninh</option>
                                        <option value="thaibinh">Th√°i B√¨nh</option>
                                        <option value="thainguyen">Th√°i Nguy√™n</option>
                                        <option value="thanhhoa">Thanh H√≥a</option>
                                        <option value="thuathienhue">Th·ª´a Thi√™n Hu·∫ø</option>
                                        <option value="tiengiang">Ti·ªÅn Giang</option>
                                        <option value="travinh">Tr√† Vinh</option>
                                        <option value="tuyenquang">Tuy√™n Quang</option>
                                        <option value="vinhlong">Vƒ©nh Long</option>
                                        <option value="vinhphuc">Vƒ©nh Ph√∫c</option>
                                        <option value="yenbai">Y√™n B√°i</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Qu·∫≠n/Huy·ªán *</label>
                                    <input type="text" id="newShippingDistrict" required placeholder="V√≠ d·ª•: Qu·∫≠n 1, Huy·ªán C·ªß Chi">
                                </div>
                            </div>
                            
                            <div class="form-options">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="setAsDefault">
                                    ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                                </label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="save-address-btn" onclick="saveNewAddress()">
                                    <i class="fas fa-save"></i> L∆∞u ƒë·ªãa ch·ªâ
                                </button>
                                <button type="button" class="cancel-btn" onclick="cancelAddressForm()">
                                    H·ªßy
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selected Address Display -->
                        <div class="selected-address" id="selectedAddressDisplay" style="display: none;">
                            <div class="address-info">
                                <h6>ƒê·ªãa ch·ªâ giao h√†ng:</h6>
                                <p id="selectedAddressText"></p>
                                <button type="button" class="change-address-btn" onclick="changeSelectedAddress()">
                                    <i class="fas fa-edit"></i> Thay ƒë·ªïi
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4><i class="fas fa-credit-card"></i> Ph∆∞∆°ng Th·ª©c Thanh To√°n</h4>
                        <div class="payment-methods">
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="cod" checked>
                                <span class="payment-icon"><i class="fas fa-money-bill-wave"></i></span>
                                <span>Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="banking">
                                <span class="payment-icon"><i class="fas fa-university"></i></span>
                                <span>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="momo">
                                <span class="payment-icon"><i class="fas fa-mobile-alt"></i></span>
                                <span>V√≠ MoMo</span>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="vnpay">
                                <span class="payment-icon"><i class="fas fa-credit-card"></i></span>
                                <span>VNPay - Thanh to√°n online</span>
                            </label>
                        </div>
                    </div>

                    <!-- Discount Code Section -->
                    <div class="form-section">
                        <h4><i class="fas fa-tag"></i> M√£ Gi·∫£m Gi√°</h4>
                        
                        <!-- Available Discount Codes -->
                        <div class="discount-options">
                            <div class="discount-codes-list" id="discountCodesList">
                                <div class="no-coupons-message">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>ƒêang t·∫£i m√£ gi·∫£m gi√°...</p>
                                </div>
                            </div>
                            
                            <!-- Manual Code Entry -->
                            <div class="manual-code-entry">
                                <div class="code-input-group">
                                    <input type="text" id="manualDiscountCode" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" maxlength="20">
                                    <button type="button" class="apply-code-btn" onclick="applyManualDiscountCode()">
                                        <i class="fas fa-check"></i> √Åp d·ª•ng
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Applied Discount Display -->
                            <div class="applied-discount" id="appliedDiscount" style="display: none;">
                                <div class="applied-discount-info">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="appliedDiscountText">ƒê√£ √°p d·ª•ng m√£: 12345 (-10%)</span>
                                </div>
                                <button type="button" class="remove-discount-btn" onclick="removeDiscountCode()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="order-summary">
                    <h4><i class="fas fa-receipt"></i> T√≥m T·∫Øt ƒê∆°n H√†ng</h4>
                    <div class="order-items" id="orderSummaryItems"></div>
                    <div class="order-totals">
                        <div class="total-line">
                            <span>T·∫°m t√≠nh:</span>
                            <span id="subtotalAmount">0 VNƒê</span>
                        </div>
                        <div class="total-line discount-line" id="discountLine" style="display: none;">
                            <span>Gi·∫£m gi√°:</span>
                            <span class="discount-amount" id="discountAmount">-0 VNƒê</span>
                        </div>
                        <div class="total-line">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <span>50.000 VNƒê</span>
                        </div>
                        <div class="total-line total">
                            <span>T·ªïng c·ªông:</span>
                            <span id="finalTotal">0 VNƒê</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCheckoutModal()">H·ªßy</button>
                <button class="btn-primary" onclick="completeOrder()">Ho√†n T·∫•t ƒê∆°n H√†ng</button>
            </div>
        </div>
    </div>

    <!-- OTP Verification Modal -->
    <div class="modal-overlay" id="otpModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> X√°c Th·ª±c Email</h3>
                <button class="close-modal" onclick="closeOtpModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="otp-form">
                    <div class="otp-step" id="otpStep1">
                        <h4>G·ª≠i M√£ X√°c Th·ª±c</h4>
                        <p>Vui l√≤ng nh·∫≠p email ƒë·ªÉ nh·∫≠n m√£ OTP x√°c th·ª±c cho ƒë∆°n h√†ng:</p>
                        <div class="form-group">
                            <label for="otpEmail">Email:</label>
                            <input type="email" id="otpEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
                        </div>
                        <div class="form-actions">
                            <button class="btn-secondary" onclick="closeOtpModal()">H·ªßy</button>
                            <button class="btn-primary" onclick="sendOtpCode()" id="sendOtpBtn">
                                <i class="fas fa-paper-plane"></i> G·ª≠i M√£ OTP
                            </button>
                        </div>
                    </div>
                    
                    <div class="otp-step" id="otpStep2" style="display: none;">
                        <h4>Nh·∫≠p M√£ X√°c Th·ª±c</h4>
                        <p>M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email: <strong id="otpEmailDisplay"></strong></p>
                        <div class="form-group">
                            <label for="otpCode">M√£ OTP (6 s·ªë):</label>
                            <input type="text" id="otpCode" placeholder="Nh·∫≠p m√£ OTP" maxlength="6" required>
                        </div>
                        <div class="otp-timer">
                            <p>M√£ OTP s·∫Ω h·∫øt h·∫°n sau: <span id="otpTimer">10:00</span></p>
                        </div>
                        <div class="form-actions">
                            <button class="btn-secondary" onclick="backToOtpStep1()">Quay L·∫°i</button>
                            <button class="btn-primary" onclick="verifyOtpCode()" id="verifyOtpBtn">
                                <i class="fas fa-check"></i> X√°c Th·ª±c
                            </button>
                        </div>
                        <div class="resend-otp" style="margin-top: 15px; text-align: center;">
                            <button class="btn-link" onclick="resendOtpCode()" id="resendOtpBtn">
                                G·ª≠i l·∫°i m√£ OTP
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Variant Selection Modal -->
    <div class="modal-overlay" id="variantSelectionModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-layer-group"></i> Ch·ªçn S·∫£n Ph·∫©m</h3>
                <button class="close-modal" onclick="closeVariantModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="variant-selection">
                    <div class="main-product-info">
                        <p class="variant-info-text">
                            <i class="fas fa-info-circle"></i>
                            S·∫£n ph·∫©m n√†y c√≥ nhi·ªÅu bi·∫øn th·ªÉ. Vui l√≤ng ch·ªçn s·∫£n ph·∫©m b·∫°n mu·ªën th√™m v√†o gi·ªè h√†ng:
                        </p>
                    </div>
                    
                    <div class="variant-options" id="variantOptions">
                        <!-- Variant options will be populated here -->
                    </div>
                    
                    <div class="variant-actions">
                        <button class="btn-secondary" onclick="closeVariantModal()">
                            <i class="fas fa-times"></i> H·ªßy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <div class="footer-logo">
                    <i class="fas fa-microchip"></i>
                    <span>TECH HAVEN</span>
                </div>
                <p>ƒêi·ªÉm ƒë·∫øn tin c·∫≠y cho m·ªçi nhu c·∫ßu c√¥ng ngh·ªá c·ªßa b·∫°n. Ch·∫•t l∆∞·ª£ng h√†ng ƒë·∫ßu, d·ªãch v·ª• t·∫≠n t√¢m.</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
            <div class="footer-section">
                <h4>S·∫£n ph·∫©m</h4>
                <ul>
                    <li><a href="/desktops">M√°y t√≠nh ƒë·ªÉ b√†n</a></li>
                    <li><a href="/laptops">Laptop</a></li>
                    <li><a href="/components">Linh ki·ªán</a></li>
                    <li><a href="/peripherals">Ph·ª• ki·ªán</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>D·ªãch v·ª•</h4>
                <ul>
                    <li><a href="/build-pc">X√¢y d·ª±ng PC</a></li>
                    <li><a href="#">B·∫£o h√†nh</a></li>
                    <li><a href="#">H·ªó tr·ª£ k·ªπ thu·∫≠t</a></li>
                    <li><a href="#">Giao h√†ng</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Li√™n h·ªá</h4>
                <div class="contact-info">
                    <p><i class="fas fa-phone"></i> 1800-1234</p>
                    <p><i class="fas fa-envelope"></i> info@techhaven.vn</p>
                    <p><i class="fas fa-map-marker-alt"></i> 123 Tech Street, H√† N·ªôi</p>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Tech Haven. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </div>
    </footer>
    <!-- Login Modal - Hi·ªÉn th·ªã khi ch∆∞a ƒëƒÉng nh·∫≠p -->
    
    <div class="login-modal-overlay" id="loginModal">
        <div class="login-modal">
            <div class="login-modal-header">
                <h3 id="modalTitle">ƒêƒÉng Nh·∫≠p</h3>
                <button class="close-login-modal" onclick="closeLoginModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="login-modal-content">
                <!-- Login Form -->
                <div class="login-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">M·∫≠t kh·∫©u</label>
                        <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="form-options">
                        <label class="remember-me">
                            <input type="checkbox" id="rememberMe">
                            <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
                        </label>
                        <a href="#" class="forgot-password" onclick="handleForgotPassword(); return false;">Qu√™n m·∫≠t kh·∫©u?</a>
                    </div>
                    <button class="login-btn" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p
                    </button>
                </div>

                <!-- Register Form -->
                <div class="register-form" id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerName">H·ªç v√† t√™n</label>
                        <input type="text" id="registerName" placeholder="Nh·∫≠p h·ªç v√† t√™n" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPhone">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="registerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">M·∫≠t kh·∫©u</label>
                        <input type="password" id="registerPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <input type="password" id="confirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="form-options">
                        <label class="agree-terms">
                            <input type="checkbox" id="agreeTerms" required>
                            <span>T√¥i ƒë·ªìng √Ω v·ªõi <a href="#">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a></span>
                        </label>
                    </div>
                    <button class="register-btn" onclick="handleRegister()">
                        <i class="fas fa-user-plus"></i> ƒêƒÉng K√Ω
                    </button>
                </div>

                <!-- Social Login -->
                <div class="social-login">
                    <div class="divider">
                        <span>ho·∫∑c</span>
                    </div>
                    <button onclick="signInWithGoogle()" class="google-signin-btn" type="button">
                        <i class="fab fa-google"></i>
                        ƒêƒÉng nh·∫≠p v·ªõi Google
                    </button>
                    
                    <!-- Backup direct link for testing -->
                    <div style="margin-top: 10px; text-align: center;">
                        <button onclick="signInWithGoogle()" style="color: #4285f4; font-size: 14px; background: none; border: none; cursor: pointer; text-decoration: underline;">
                            üîó Firebase Auth (n·∫øu n√∫t kh√¥ng ho·∫°t ƒë·ªông)
                        </button>
                    </div>
                </div>

                <!-- Toggle between Login/Register -->
                <div class="modal-footer">
                    <p id="toggleText">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" onclick="toggleAuthMode()">ƒêƒÉng k√Ω ngay</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Profile Panel - Hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p -->
    <div class="user-profile-panel" id="userProfilePanel">
        <div class="user-profile-container">
            <div class="user-profile-header">
                <div class="user-avatar">
                    <img id="profileAvatar" src="" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.3);">
                    <div class="avatar-placeholder" style="display: none; width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; border: 3px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="user-info">
                    <h3 id="profileName">Loading...</h3>
                    <p id="profileEmail">Loading...</p>
                    <span class="user-badge">
                        <i class="fas fa-user"></i> ƒê√£ x√°c th·ª±c
                    </span>
                </div>
                <button class="close-profile-btn" onclick="closeUserProfile()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="user-profile-content">
                <div class="profile-section">
                    <h4><i class="fas fa-user-edit"></i> Th√¥ng Tin C√° Nh√¢n</h4>
                    <div class="profile-info">
                        <div class="info-row">
                            <label>H·ªç v√† t√™n:</label>
                            <span id="profileInfoName">Loading...</span>
                        </div>
                        <div class="info-row">
                            <label>Email:</label>
                            <span id="profileInfoEmail">Loading...</span>
                        </div>
                        <div class="info-row">
                            <label>Lo·∫°i t√†i kho·∫£n:</label>
                            <span>
                                <i class="fab fa-google text-danger"></i> Google OAuth
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Ng√†y tham gia:</label>
                            <span id="joinDate">Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4><i class="fas fa-shopping-bag"></i> ƒê∆°n H√†ng G·∫ßn ƒê√¢y</h4>
                    <div class="recent-orders" id="recentOrders">
                        <div class="loading-orders">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i ƒë∆°n h√†ng...
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4><i class="fas fa-heart"></i> S·∫£n Ph·∫©m Y√™u Th√≠ch</h4>
                    <div class="favorite-products" id="favoriteProducts">
                        <div class="loading-favorites">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i s·∫£n ph·∫©m y√™u th√≠ch...
                        </div>
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="btn btn-primary" onclick="editUserProfile()">
                        <i class="fas fa-edit"></i> Ch·ªânh S·ª≠a H·ªì S∆°
                    </button>
                    <button class="btn btn-secondary" onclick="viewOrderHistory()">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ ƒê∆°n H√†ng
                    </button>
                    <button class="btn btn-danger" onclick="logoutCurrentUser()">
                        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-container">
            <div class="search-header">
                <h3>T√¨m ki·∫øm s·∫£n ph·∫©m</h3>
                <button class="search-close" onclick="toggleSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm...">
                <button class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="search-suggestions" id="searchSuggestions">
                <!-- Search suggestions will be populated here -->
            </div>
        </div>
    </div>

    <!-- Variant Selection Modal -->
    <div id="variantModal" class="variant-modal" style="display: none;">
        <div class="variant-modal-overlay"></div>
        <div class="variant-modal-content">
            <div class="variant-modal-header">
                <h3>Ch·ªçn phi√™n b·∫£n s·∫£n ph·∫©m</h3>
                <button class="variant-modal-close" onclick="closeVariantModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="variant-modal-body">
                <div id="variantOptions">
                    <!-- Variant options will be populated here -->
                </div>
            </div>
        </div>
    </div>

   
    <style>
        /* =====================================
           CART ICON CLICK HANDLING
           ===================================== */
        
        .cart-icon-wrapper {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .cart-icon-wrapper:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Make sure child elements don't block click events */
        .cart-icon-wrapper > * {
            pointer-events: none;
        }
        
        /* =====================================
           SHOPPING CART SIDEBAR STYLES
           ===================================== */
        
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .cart-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            z-index: 10000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .cart-sidebar.active {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .cart-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .close-cart:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .cart-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
        }
        
        .cart-item:hover {
            background: #f8fafc;
        }
        
        .cart-item-image {
            width: 60px;
            height: 60px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .cart-item-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .cart-item-name {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }
        
        .cart-item-price {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .quantity-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .cart-item-quantity {
            min-width: 30px;
            text-align: center;
            font-weight: 500;
        }
        
        .remove-item {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        
        .remove-item:hover {
            background: #fee2e2;
            border-color: #fca5a5;
        }
        
        .cart-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .cart-total {
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.125rem;
            color: #1f2937;
        }
        
        .checkout-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .checkout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .empty-cart {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        
        .empty-cart i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Mobile responsiveness for cart */
        @media (max-width: 480px) {
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
        }
        
        /* User Profile Panel Styles */
        .user-profile-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .user-profile-panel.active {
            right: 0;
        }
        
        .user-profile-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .user-profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }
        
        .user-avatar img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .avatar-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .user-info h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
        }
        
        .user-info p {
            margin: 0 0 8px 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .close-profile-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-profile-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .user-profile-content {
            flex: 1;
            padding: 20px;
        }
        
        .profile-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .profile-section:last-child {
            border-bottom: none;
        }
        
        .profile-section h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-info .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
        .profile-info label {
            font-weight: 600;
            color: #555;
        }
        
        .profile-info span {
            color: #333;
        }
        
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
        
        .recent-orders, .favorite-products {
            min-height: 60px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .loading-orders, .loading-favorites {
            color: #666;
            font-style: italic;
        }
        
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .profile-actions .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        @media (max-width: 768px) {
            .user-profile-panel {
                width: 100vw;
                right: -100vw;
            }
        }
        
        /* User Icon Container Styles */
        .user-icon-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-icon-authenticated {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 8px 12px;
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .user-icon-authenticated:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-name-display {
            font-size: 14px;
            font-weight: 500;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 768px) {
            .user-name-display {
                display: none;
            }
            .user-avatar-small {
                margin-right: 0;
            }
            
            /* Optimize loading screen for mobile */
            .loading-screen {
                animation: none;
                /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
            }
            
            .loading-screen .cute-mascot {
                transform: scale(0.9);
                animation: bounce 1s ease-in-out infinite;
            }
            
            .loading-screen .progress-bar {
                animation: none;
                transition: width 0.1s ease-out;
            }
            
            .loading-screen .progress-fill {
                transition: width 0.1s ease-out;
                background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
            }
            
            /* Reduce complex animations on mobile */
            .banner-slide, .product-card {
                transition: transform 0.3s ease;
            }
            
            /* Fast bounce animation for quick loading */
            @keyframes bounce {
                0%, 100% {
                    transform: scale(0.9) translateY(0);
                }
                50% {
                    transform: scale(0.9) translateY(-8px);
                }
            }
        }

        /* =====================================
           MODAL OVERLAY AND CONTENT STYLES
           ===================================== */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        .modal-overlay.active {
            display: flex !important;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .modal-body {
            padding: 1.5rem;
            display: flex;
            gap: 2rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        /* =====================================
           CHECKOUT FORM STYLES
           ===================================== */
        
        .checkout-form {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .form-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .form-section h4 {
            margin: 0 0 1.5rem 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-section h4 i {
            color: #667eea;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        
        .form-group {
            flex: 1;
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .payment-method:hover {
            border-color: #667eea;
            background: #f8fafc;
        }
        
        .payment-method input[type="radio"] {
            margin: 0;
            width: auto;
        }
        
        .payment-method input[type="radio"]:checked + .payment-icon + span {
            font-weight: 600;
            color: #667eea;
        }
        
        .payment-method:has(input:checked) {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .payment-icon {
            color: #6b7280;
            font-size: 1.125rem;
        }

        /* =====================================
           ORDER SUMMARY STYLES
           ===================================== */
        
        .order-summary {
            flex: 1;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 0;
        }
        
        .order-summary h4 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .order-items {
            margin-bottom: 1.5rem;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-item-info {
            flex: 1;
        }
        
        .order-item-name {
            font-weight: 500;
            color: #1f2937;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .order-item-details {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .order-item-price {
            font-weight: 600;
            color: #dc2626;
            white-space: nowrap;
            margin-left: 1rem;
        }
        
        .order-totals {
            border-top: 2px solid #e5e7eb;
            padding-top: 1rem;
            background: #f8fafc;
            margin-top: auto;
            flex-shrink: 0;
        }
        
        .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .total-line.total {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
            border-top: 1px solid #d1d5db;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        /* =====================================
           BUTTON STYLES
           ===================================== */
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        /* =====================================
           ADDRESS MANAGEMENT STYLES
           ===================================== */
        
        .saved-addresses {
            margin-bottom: 20px;
        }
        
        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .address-header label {
            font-weight: 600;
            color: #374151;
        }
        
        .add-address-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-address-btn:hover {
            background: #2563eb;
        }
        
        .add-address-btn i {
            margin-right: 6px;
        }
        
        .address-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .address-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        
        .address-item:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .address-item.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .address-item.default {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .address-item.default::before {
            content: "M·∫∂C ƒê·ªäNH";
            background: #10b981;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            float: right;
            margin-bottom: 5px;
        }
        
        .no-addresses {
            text-align: center;
            padding: 30px;
            color: #9ca3af;
        }
        
        .no-addresses i {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .new-address-form {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: #f9fafb;
            margin-top: 15px;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .form-header h5 {
            margin: 0;
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }
        
        .cancel-address-btn {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .cancel-address-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .form-options {
            margin: 15px 0;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
        }
        
        .checkbox-option input {
            margin-right: 8px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .save-address-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .save-address-btn:hover {
            background: #059669;
        }
        
        .save-address-btn i {
            margin-right: 6px;
        }
        
        .cancel-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cancel-btn:hover {
            background: #4b5563;
        }
        
        .selected-address {
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            background: #f0fdf4;
        }
        
        .address-info h6 {
            margin: 0 0 10px 0;
            color: #065f46;
            font-size: 14px;
            font-weight: 600;
        }
        
        .address-info p {
            margin: 0 0 10px 0;
            color: #374151;
            line-height: 1.5;
        }
        
        .change-address-btn {
            background: none;
            border: 1px solid #10b981;
            color: #10b981;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .change-address-btn:hover {
            background: #10b981;
            color: white;
        }
        
        .change-address-btn i {
            margin-right: 4px;
        }

        /* =====================================
           DISCOUNT CODE STYLES
           ===================================== */
        
        .discount-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .discount-codes-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .discount-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .discount-code-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        
        .discount-code-item.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }
        
        .discount-code-info {
            flex: 1;
        }
        
        .discount-code-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .discount-code-title i {
            color: #667eea;
            font-size: 16px;
        }
        
        .discount-code-title strong {
            color: #495057;
            font-size: 16px;
        }
        
        .discount-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .discount-code-desc {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .discount-code-id {
            color: #495057;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .select-discount-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .select-discount-btn:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
            transform: scale(1.05);
        }
        
        .manual-code-entry {
            border-top: 1px dashed #dee2e6;
            padding-top: 20px;
        }
        
        .code-input-group {
            display: flex;
            gap: 10px;
        }
        
        .code-input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            transition: border-color 0.3s ease;
        }
        
        .code-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .apply-code-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .apply-code-btn:hover {
            background: linear-gradient(135deg, #218838, #1ea080);
            transform: translateY(-1px);
        }
        
        .apply-code-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .applied-discount {
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .applied-discount-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #155724;
            font-weight: 500;
        }
        
        .applied-discount-info i {
            color: #28a745;
            font-size: 16px;
        }
        
        .remove-discount-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-discount-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .discount-line {
            color: #28a745;
            font-weight: 500;
        }
        
        .discount-line .discount-amount {
            color: #28a745;
        }
        
        .no-coupons-message {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
            background: #f9fafb;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .no-coupons-message i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
            color: #9ca3af;
        }
        
        .no-coupons-message p {
            margin: 0;
            font-size: 14px;
        }

        /* =====================================
           OTP VERIFICATION MODAL STYLES
           ===================================== */
        
        .otp-form {
            padding: 2rem;
            max-width: 100%;
            margin: 0 auto;
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(253, 242, 248, 0.8) 30%, 
                rgba(254, 247, 247, 0.9) 60%, 
                rgba(255, 241, 242, 0.8) 100%);
            position: relative;
        }
        
        .otp-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, 
                rgba(244, 114, 182, 0.1) 0%, transparent 50%),
                       radial-gradient(circle at 80% 70%, 
                rgba(236, 72, 153, 0.1) 0%, transparent 50%),
                       radial-gradient(circle at 50% 50%, 
                rgba(190, 24, 93, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .otp-step {
            animation: fadeInUp 0.6s ease-out;
            text-align: center;
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .otp-step h4 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            text-shadow: none;
        }
        
        .otp-step h4::before {
            content: "üîê";
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .otp-step p {
            color: #6b7280;
            margin-bottom: 2rem;
            line-height: 1.6;
            font-size: 1rem;
        }
        
        #otpCode {
            text-align: center !important;
            font-size: 2rem !important;
            font-weight: bold !important;
            letter-spacing: 8px !important;
            font-family: 'Courier New', monospace !important;
            padding: 1.5rem !important;
            background: linear-gradient(145deg, 
                rgba(255, 240, 245, 0.9) 0%, 
                rgba(253, 242, 248, 0.8) 30%,
                rgba(255, 228, 230, 0.9) 60%,
                rgba(254, 242, 242, 0.8) 100%) !important;
            border: 3px solid #f472b6 !important;
            color: #be185d !important;
            position: relative;
            animation: codeGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes codeGlow {
            0% {
                box-shadow: 0 0 15px rgba(244, 114, 182, 0.3),
                           inset 0 0 15px rgba(236, 72, 153, 0.1);
            }
            100% {
                box-shadow: 0 0 25px rgba(244, 114, 182, 0.5),
                           0 0 35px rgba(236, 72, 153, 0.3),
                           inset 0 0 20px rgba(190, 24, 93, 0.15);
            }
        }
        
        #otpCode:focus {
            border-color: #ec4899 !important;
            box-shadow: 0 0 0 6px rgba(244, 114, 182, 0.3),
                        0 15px 40px -5px rgba(236, 72, 153, 0.4),
                        0 0 30px rgba(190, 24, 93, 0.2) !important;
            animation: none;
        }
        
        .otp-timer {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fbbf24 100%);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 25px -5px rgba(245, 158, 11, 0.3),
                        0 4px 6px -1px rgba(245, 158, 11, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .otp-timer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .otp-timer p {
            margin: 0;
            color: #92400e;
            font-weight: 700;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }
        
        #otpTimer {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: #dc2626;
            margin-left: 0.5rem;
            text-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .resend-otp {
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }
        
        .btn-link {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        .btn-link:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #5a67d8;
            text-decoration: none;
            transform: translateY(-2px);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 8px 25px -5px rgba(102, 126, 234, 0.3);
        }
        
        .btn-link:disabled {
            color: #9ca3af;
            cursor: not-allowed;
            text-decoration: none;
            background: rgba(156, 163, 175, 0.1);
            border-color: rgba(156, 163, 175, 0.3);
            transform: none;
        }

        /* =====================================
           VARIANT SELECTION MODAL STYLES
           ===================================== */
        
        .variant-selection {
            padding: 0;
        }
        
        .main-product-info {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }
        
        .variant-info-text {
            margin: 0;
            color: #0c4a6e;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-info-text i {
            color: #0ea5e9;
            font-size: 16px;
        }
        
        .variant-options {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .variant-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ffffff;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .variant-option:hover {
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            transform: translateY(-2px);
        }
        
        .variant-option.main-product {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
        }
        
        .variant-option.main-product:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }
        
        .variant-option-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
        }
        
        .variant-option-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .variant-option-image i {
            font-size: 32px;
            color: #64748b;
        }
        
        .variant-option-info {
            flex: 1;
            min-width: 0;
        }
        
        .variant-option-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .variant-badge.main {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .variant-badge.variant {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .variant-option-price {
            font-size: 18px;
            font-weight: 700;
            color: #dc2626;
            margin: 4px 0;
        }
        
        .variant-option-price .old-price {
            font-size: 14px;
            font-weight: 400;
            color: #6b7280;
            text-decoration: line-through;
            margin-left: 8px;
        }
        
        .variant-option-desc {
            font-size: 13px;
            color: #6b7280;
            margin: 0;
            line-height: 1.4;
        }
        
        .variant-option-stock {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            display: inline-block;
        }
        
        .variant-option-stock.in-stock {
            background: #dcfce7;
            color: #166534;
        }
        
        .variant-option-stock.low-stock {
            background: #fef3c7;
            color: #92400e;
        }
        
        .variant-option-stock.out-stock {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .variant-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .variant-select-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        /* =====================================
           RESPONSIVE STYLES FOR MODALS
           ===================================== */
        
        @media (max-width: 768px) {
            /* Fix modal content for mobile scroll */
            .modal-content {
                max-height: 95vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            .modal-header {
                flex-shrink: 0;
            }
            
            .modal-footer {
                flex-shrink: 0;
                padding: 1rem 1.5rem;
            }
            
            .modal-body {
                flex-direction: column;
                gap: 1rem;
                flex: 1;
                overflow-y: auto;
                padding: 1rem 1.5rem;
                -webkit-overflow-scrolling: touch;
            }
            
            .checkout-form {
                order: 1;
                flex: none;
                padding: 0;
            }
            
            .order-summary {
                order: 2;
                position: static;
                flex: none;
                max-height: none;
                border-left: none;
                border-top: 1px solid #e5e7eb;
                padding: 1rem 0 0 0;
                overflow-y: visible;
            }
            
            .order-items {
                max-height: 150px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .address-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .save-address-btn,
            .cancel-btn {
                width: 100%;
            }
            
            .code-input-group {
                flex-direction: column;
            }
            
            .apply-code-btn {
                width: 100%;
            }
            
            .discount-code-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .select-discount-btn {
                align-self: flex-end;
            }
            
            .variant-option {
                flex-direction: column;
                text-align: center;
                padding: 12px;
            }
            
            .variant-option-image {
                width: 60px;
                height: 60px;
            }
            
            .variant-option-name {
                font-size: 14px;
            }
            
            .variant-option-price {
                font-size: 16px;
            }
            
            .variant-actions {
                flex-direction: column;
            }
            
            .otp-form {
                padding: 1.5rem;
            }
            
            #otpCode {
                font-size: 1.75rem !important;
                letter-spacing: 6px !important;
                padding: 1rem !important;
            }
            
            .otp-timer {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }
            
            #otpTimer {
                font-size: 1.25rem;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .modal-overlay {
                padding: 0.5rem;
            }
            
            .modal-content {
                max-height: 98vh;
                border-radius: 15px;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
            
            .modal-footer {
                padding: 1rem;
                gap: 0.5rem;
            }
            
            .btn-secondary,
            .btn-primary {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
        }

        /* =====================================
           CART BADGE POSITIONING
           ===================================== */
        
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc2626;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }
        
        /* Ensure cart icon wrapper has relative positioning for badge */
        .cart-icon-wrapper {
            position: relative !important;
        }
        
        /* Different badge colors for different data sources */
        .cart-badge.firebase-data {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #ffffff;
        }
        
        /* =====================================
           ADD TO CART BUTTON STYLING
           ===================================== */
        
        .add-to-cart {
            background: linear-gradient(135deg, #f472b6, #ec4899);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, #ec4899, #db2777);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }
        
        .add-to-cart:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);
        }
        
        .add-to-cart:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .add-to-cart i {
            font-size: 0.9rem;
        }
        
        .cart-badge.local-data {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: 2px solid #ffffff;
        }
        
        /* Hide badge when count is 0 */
        .cart-badge[style*="display: none"] {
            display: none !important;
        }
    </style>
    <!-- Variant Modal CSS -->
    <style>
        .variant-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .variant-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .variant-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 10001;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .variant-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
            border-radius: 20px 20px 0 0;
        }
        
        .variant-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
        }
        
        .variant-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .variant-modal-close:hover {
            background: #e5e7eb;
            color: #333;
        }
        
        .variant-modal-body {
            padding: 1.5rem;
        }
        
        .variant-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .variant-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .variant-image {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .variant-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .variant-image i {
            font-size: 2rem;
            color: #667eea;
        }
        
        .variant-info {
            flex: 1;
        }
        
        .variant-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .main-badge {
            background: #667eea;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .variant-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }
        
        .variant-availability {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .variant-availability.in-stock {
            color: #10b981;
        }
        
        .variant-availability.out-of-stock {
            color: #ef4444;
        }
        
        .variant-availability.pre-order {
            color: #f59e0b;
        }
        
        .variant-availability.contact {
            color: #6b7280;
        }
        
        .variant-stock {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .variant-action {
            flex-shrink: 0;
        }
        
        .variant-select-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .variant-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .variant-modal-content {
                width: 95%;
                max-height: 90vh;
            }
            
            .variant-option {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }
            
            .variant-image {
                width: 60px;
                height: 60px;
            }
            
            .variant-info {
                text-align: center;
            }
            
            .variant-select-btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }
        
        /* Buy Now mode styling for variant selection */
        .variant-select-btn.buy-now-mode {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            border-color: #f59e0b !important;
            color: white !important;
            font-weight: 600;
            animation: buyNowPulse 2s infinite;
        }
        
        .variant-select-btn.buy-now-mode:hover {
            background: linear-gradient(135deg, #d97706, #b45309) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }
        
        @keyframes buyNowPulse {
            0%, 100% { 
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); 
            }
            50% { 
                box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6); 
            }
        }
    </style>
    <script src="/js/script.js" defer></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/address-management.js"></script>

    
    <!-- Guest Cart Synchronization -->
    <script>
        // Ensure guest cart is properly synchronized when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for all scripts to load
            setTimeout(function() {
                console.log('üîÑ Guest cart sync check started...');
                
                // Check if there are items in localStorage that aren't showing in UI
                const localCart = localStorage.getItem('techHavenCart');
                const localCount = localStorage.getItem('techHavenCartCount');
                const cartBadge = document.getElementById('cartBadge');
                const mobileCartCount = document.getElementById('cartCount'); // Fixed: Use correct mobile cart ID
                
                if (localCart && localCount && !window.currentUser) {
                    try {
                        const parsedCart = JSON.parse(localCart);
                        const parsedCount = parseInt(localCount) || 0;
                        
                        console.log('üì¶ Found localStorage cart for guest user:', {
                            items: parsedCart.length,
                            count: parsedCount,
                            currentUICount: cartBadge ? cartBadge.textContent : 'N/A'
                        });
                        
                        // If localStorage has items but UI doesn't show them, force sync
                        if (parsedCount > 0) {
                            console.log('‚ö†Ô∏è Forcing guest cart UI sync...');
                            
                            // Update global cart variables if they exist
                            if (typeof window.cartItems !== 'undefined') {
                                window.cartItems = parsedCart;
                            }
                            if (typeof window.cartCount !== 'undefined') {
                                window.cartCount = parsedCount;
                            }
                            
                            // Force UI update
                            if (cartBadge) {
                                cartBadge.textContent = parsedCount;
                                cartBadge.style.display = 'flex';
                                console.log('‚úÖ Cart badge force updated:', parsedCount);
                            }
                            if (mobileCartCount) {
                                mobileCartCount.textContent = parsedCount;
                                console.log('üì± Mobile cart count force updated:', parsedCount);
                            }
                            
                            // Try to call script.js updateCartUI if available
                            if (typeof window.updateCartUI === 'function') {
                                window.updateCartUI();
                                console.log('üîÑ Called updateCartUI()');
                            }
                        }
                    } catch (e) {
                        console.error('‚ùå Failed to parse localStorage cart:', e);
                    }
                } else {
                    console.log('‚ÑπÔ∏è No guest cart to sync or user is logged in');
                }
            }, 1000); // Wait 1 second for all scripts to load
        });

        // SmartCart test function
        function testSmartCartState() {
            console.log('üß† Testing SmartCart state...');
            console.log('SmartCart exists:', !!window.smartCart);
            console.log('Current user:', window.currentUser ? window.currentUser.name : 'Not logged in');
            
            if (window.smartCart) {
                console.log('SmartCart isLoggedIn:', window.smartCart.isLoggedIn);
                console.log('SmartCart lastUpdateSource:', window.smartCart.lastUpdateSource);
                console.log('SmartCart cartData:', window.smartCart.cartData);
                
                // Force refresh cart data
                window.smartCart.refreshCartData().then(data => {
                    console.log('‚úÖ SmartCart refresh result:', data);
                });
            } else {
                console.log('‚ùå SmartCart not available!');
            }
        }

        // Test cart count function
        function testCartCount() {
            console.log('üî¢ Testing cart count...');
            console.log('localStorage count:', localStorage.getItem('techHavenCartCount'));
            console.log('cartCount variable:', typeof cartCount !== 'undefined' ? cartCount : 'undefined');
            console.log('cartItems array:', typeof cartItems !== 'undefined' ? cartItems.length : 'undefined');
            console.log('Cart badge element:', document.getElementById('cartBadge')?.textContent);
            
            // Also test SmartCart if available
            if (window.smartCart) {
                console.log('SmartCart data:', window.smartCart.cartData);
            }
        }
    </script>
    
    <!-- Firebase Configuration and Authentication -->
    <script type="module">
        // Separate Firebase v10 modular instance for Firestore and Storage only
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, addDoc, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpzgsxZ1Jfs5hWAfS-gDbYfgkVte_jXoA",
            authDomain: "tech-haven-5368b.firebaseapp.com",
            projectId: "tech-haven-5368b",
            storageBucket: "tech-haven-5368b.firebasestorage.app",
            messagingSenderId: "442337591630",
            appId: "1:442337591630:web:7005525c7664f513a55e1f"
        };

        // Initialize Firebase v10 modular for database and storage operations only
        const firestoreApp = initializeApp(firebaseConfig, 'firestore-app');
        const db = getFirestore(firestoreApp);
        const storage = getStorage(firestoreApp);

        // Global variables for user state
        window.currentUser = null;
        window.firestoreAuth = window.firebaseAuth; // Use v8 compat auth from header
        window.db = db;
        window.storage = storage;

        // Authentication functions using v8 compat
        window.getIdToken = async function() {
            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                try {
                    return await window.firebaseAuth.currentUser.getIdToken();
                } catch (error) {
                    console.error('Error getting ID token:', error);
                    return null;
                }
            }
            return null;
        };

        // Check authentication state on page load using v8 compat
        window.firebaseAuth.onAuthStateChanged(async (user) => {
            console.log('üîê Auth state changed:', user ? user.email : 'No user');
            
            if (user) {
                window.currentUser = {
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName,
                    photo: user.photoURL,
                    provider: 'firebase',
                    emailVerified: user.emailVerified
                };
                
                // Get additional user data from server including fresh photo from Firestore
                try {
                    const idToken = await user.getIdToken();
                    const response = await fetch('/api/user', {
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üîç API /api/user response:', data);
                        if (data.success && data.user) {
                            console.log('üìä User data from server:', data.user);
                            console.log('üîß Admin status from server:', data.user.is_admin);
                            
                            // Merge data but prioritize Firestore photo over Firebase Auth photoURL
                            window.currentUser = { 
                                ...window.currentUser, 
                                ...data.user,
                                photo: data.user.photo || window.currentUser.photo // Firestore photo takes priority
                            };
                            console.log('‚úÖ Enhanced user data with admin status:', {
                                is_admin: window.currentUser.is_admin,
                                photo: window.currentUser.photo,
                                fullUser: window.currentUser
                            });
                            
                            // Start real-time cart listener for cross-tab synchronization
                            if (typeof startCartRealtimeListener === 'function') {
                                startCartRealtimeListener(user.uid);
                            }
                            
                            // IMMEDIATE cart load after Firebase auth success
                            if (window.loadCartFromDatabase) {
                                window.loadCartFromDatabase().then(() => {
                                    console.log('‚úÖ Immediate cart loaded after Firebase auth success');
                                }).catch(error => {
                                    console.warn('‚ö†Ô∏è Immediate cart load failed after Firebase auth:', error);
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                }
            } else {
                // Check for manual authentication in localStorage
                const storedUser = localStorage.getItem('techHavenUser');
                if (storedUser) {
                    try {
                        window.currentUser = JSON.parse(storedUser);
                        console.log('üì± User from localStorage:', window.currentUser);
                        console.log('üîß Admin status from localStorage:', window.currentUser.is_admin);
                        
                        // Refresh user data from server for manual users too
                        await refreshUserDataFromServer();
                        
                        // IMMEDIATE cart load after manual auth detection
                        if (window.loadCartFromDatabase) {
                            window.loadCartFromDatabase().then(() => {
                                console.log('‚úÖ Immediate cart loaded after manual auth detection');
                            }).catch(error => {
                                console.warn('‚ö†Ô∏è Immediate cart load failed after manual auth:', error);
                            });
                        }
                    } catch (error) {
                        console.error('Error parsing stored user:', error);
                        localStorage.removeItem('techHavenUser');
                        window.currentUser = null;
                    }
                } else {
                    window.currentUser = null;
                }
            }
            
            // Update UI
            updateUIBasedOnAuthStatus();
        });

        // Update UI based on authentication status
        function updateUIBasedOnAuthStatus() {
            console.log('üîÑ Updating UI, currentUser:', window.currentUser);
            updateUserIcons();
            
            // Update SmartCart authentication status
            if (window.smartCartManager) {
                console.log('üîÑ Updating SmartCart auth status:', !!window.currentUser);
                window.smartCartManager.setAuthStatus(!!window.currentUser, window.currentUser);
                
                // Refresh cart data after auth change
                window.smartCartManager.refreshCartData();
            }
            
            // Load cart if user is logged in
            if (window.currentUser) {
                console.log('üõí User logged in, loading cart for:', window.currentUser.email);
                
                // Start real-time cart listener for cross-tab synchronization
                if (typeof startCartRealtimeListener === 'function') {
                    startCartRealtimeListener(window.currentUser.uid);
                }
                
                // IMMEDIATE cart load from database to prevent localStorage overwrite
                if (window.loadCartFromDatabase) {
                    window.loadCartFromDatabase().then(() => {
                        console.log('‚úÖ Immediate cart loaded in updateUIBasedOnAuthStatus');
                        // Force UI update after immediate load
                        if (window.forceUpdateCartUI) {
                            window.forceUpdateCartUI();
                        }
                    }).catch(error => {
                        console.warn('‚ö†Ô∏è Immediate cart load failed in updateUIBasedOnAuthStatus:', error);
                        // Fallback to regular loadCart
                        loadCart();
                    });
                } else {
                    // Fallback to regular loadCart function
                    loadCart();
                }
            } else {
                console.log('üë§ No user detected - checking for guest cart preservation');
                
                // Stop real-time cart listener when logged out
                if (typeof stopCartRealtimeListener === 'function') {
                    stopCartRealtimeListener();
                }
                
                // Don't clear cart if checkout is in progress
                if (window.checkoutInProgress) {
                    console.log('üõí Checkout in progress - preserving cart during process');
                    return;
                }
                
                // FOR GUEST MODE: DON'T override cart if script.js is managing it
                // Check if script.js has fresh cart data
                const scriptJsHasData = window.cartItems && Array.isArray(window.cartItems) && window.cartItems.length > 0;
                const freshLocalStorage = localStorage.getItem('techHavenCart');
                const hasLocalStorageCart = freshLocalStorage && JSON.parse(freshLocalStorage).length > 0;
                
                if (scriptJsHasData || hasLocalStorageCart) {
                    console.log('üõí Script.js or localStorage has cart data - preserving it');
                    
                    // Don't override - just sync if needed
                    if (hasLocalStorageCart && !scriptJsHasData) {
                        try {
                            const savedCart = JSON.parse(freshLocalStorage);
                            cart = savedCart || [];
                            
                            // Update script.js cart data if needed
                            if (typeof window.cartItems !== 'undefined') {
                                window.cartItems = [...savedCart];
                            }
                            if (typeof window.cartCount !== 'undefined') {
                                window.cartCount = savedCart.reduce((sum, item) => sum + (item.quantity || 1), 0);
                            }
                            
                            console.log('‚úÖ Synced localStorage to local cart:', cart.length, 'items');
                        } catch (error) {
                            console.error('‚ùå Error syncing localStorage cart:', error);
                        }
                    }
                    
                    // Update UI without overriding existing cart data
                    updateCartBadge(); // This will now use localStorage data for guests
                    return; // Don't continue with the reset logic below
                }
                
                // Only reset if no cart data exists anywhere
                console.log('üßπ No cart data found anywhere - initializing empty cart');
                cart = [];
                cartTotal = 0;
                
                // Initialize script.js cart data if available
                if (typeof window.cartItems !== 'undefined') {
                    window.cartItems = [];
                }
                if (typeof window.cartCount !== 'undefined') {
                    window.cartCount = 0;
                }
                
                // Update UI for empty cart
                renderCart();
                updateCartBadge();
            }
        }

        // Update user icons in header with enhanced photo detection
        function updateUserIcons() {
            const userIconContainer = document.getElementById('userIconContainer');
            const mobileUserLink = document.getElementById('mobileUserLink');
            
            if (userIconContainer) {
                if (window.currentUser) {
                    const isAdmin = window.currentUser.is_admin ? ' üëë' : '';
                    // Prioritize photo from Firestore database, then Firebase Auth, then picture field
                    const avatar = window.currentUser.photo || window.currentUser.photoURL || window.currentUser.picture;
                    
                    console.log('üñºÔ∏è Avatar sources - photo:', window.currentUser.photo, 'photoURL:', window.currentUser.photoURL, 'picture:', window.currentUser.picture);
                    console.log('üñºÔ∏è Final avatar URL:', avatar);
                    
                    if (avatar) {
                        userIconContainer.innerHTML = `
                            <div class="user-icon-authenticated" onclick="openUserProfile()">
                                <img src="${avatar}" alt="${window.currentUser.name}" class="user-avatar-small">
                                <span class="user-name-display">${window.currentUser.name || window.currentUser.email}${isAdmin}</span>
                            </div>
                        `;
                    } else {
                        userIconContainer.innerHTML = `
                            <div class="user-icon-authenticated" onclick="openUserProfile()">
                                <i class="fas fa-user-circle" style="margin-right: 8px; font-size: 20px; color: #667eea;"></i>
                                <span class="user-name-display">${window.currentUser.name || window.currentUser.email}${isAdmin}</span>
                            </div>
                        `;
                    }
                } else {
                    userIconContainer.innerHTML = `<i class="fas fa-user" onclick="openLoginModal()" style="cursor: pointer;"></i>`;
                }
            }
            
            if (mobileUserLink) {
                if (window.currentUser) {
                    mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openUserProfile();');
                    const userName = window.currentUser.name || window.currentUser.email;
                    const displayName = userName.length > 15 ? userName.substring(0, 15) + '...' : userName;
                    const isAdmin = window.currentUser.is_admin ? ' üëë' : '';
                    mobileUserLink.innerHTML = `<i class="fas fa-user-circle"></i> ${displayName}${isAdmin}`;
                } else {
                    mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openLoginModal();');
                    mobileUserLink.innerHTML = `<i class="fas fa-user"></i> T√†i kho·∫£n`;
                }
            }
        }

        // Make functions globally available (using v8 compat for auth operations)
        window.updateUIBasedOnAuthStatus = updateUIBasedOnAuthStatus;
        window.updateUserIcons = updateUserIcons;
        window.signInWithEmailAndPassword = window.firebaseAuth.signInWithEmailAndPassword.bind(window.firebaseAuth);
        window.createUserWithEmailAndPassword = window.firebaseAuth.createUserWithEmailAndPassword.bind(window.firebaseAuth);
        window.GoogleAuthProvider = firebase.auth.GoogleAuthProvider;
        window.signInWithPopup = window.firebaseAuth.signInWithPopup.bind(window.firebaseAuth);
        window.sendEmailVerification = function(user, settings) {
            return user.sendEmailVerification(settings);
        };
        window.sendPasswordResetEmail = window.firebaseAuth.sendPasswordResetEmail.bind(window.firebaseAuth);
        window.signOut = window.firebaseAuth.signOut.bind(window.firebaseAuth);
        
        // Function to refresh user data from server for manual auth users
        async function refreshUserDataFromServer() {
            if (!window.currentUser) return;
            
            try {
                console.log('üîÑ Refreshing user data from server...');
                
                // For manual users, use the profile API with UID parameter
                let apiUrl = `/api/user/profile?uid=${window.currentUser.uid}`;
                let requestOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // For Firebase Auth users, use token-based API
                if (window.currentUser.provider === 'firebase' && window.firebaseAuth.currentUser) {
                    try {
                        const idToken = await window.firebaseAuth.currentUser.getIdToken();
                        apiUrl = '/api/user/profile';
                        requestOptions.headers['Authorization'] = `Bearer ${idToken}`;
                    } catch (tokenError) {
                        console.log('‚ö†Ô∏è Could not get ID token, using UID-based API');
                    }
                }
                
                const response = await fetch(apiUrl, requestOptions);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üîç Refresh API response:', data);
                    if (data.success && data.user) {
                        console.log('üìä Fresh user data from server:', data.user);
                        console.log('üîß Admin status in fresh data:', data.user.is_admin);
                        
                        // Update currentUser with fresh data, prioritizing Firestore photo
                        const freshData = {
                            ...window.currentUser,
                            ...data.user,
                            photo: data.user.photo || window.currentUser.photo // Keep Firestore photo priority
                        };
                        
                        window.currentUser = freshData;
                        console.log('‚úÖ Updated currentUser with fresh data:', {
                            is_admin: window.currentUser.is_admin,
                            uid: window.currentUser.uid,
                            email: window.currentUser.email
                        });
                        
                        // Update localStorage for manual users
                        if (window.currentUser.provider === 'manual') {
                            localStorage.setItem('techHavenUser', JSON.stringify(window.currentUser));
                        }
                        
                        console.log('‚úÖ User data refreshed with latest photo:', window.currentUser.photo);
                        return true;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing user data:', error);
            }
            
            return false;
        }
        
        // Make refresh function globally available
        window.refreshUserDataFromServer = refreshUserDataFromServer;
        
        // User Profile Panel Functions
        window.openUserProfile = async function() {
            console.log('üöÄ Opening user profile panel');
            
            if (!window.currentUser) {
                console.log('‚ùå No user logged in, opening login modal instead');
                openLoginModal();
                return;
            }
            
            // Refresh user data to get latest info including photo
            console.log('üîÑ Refreshing user data before opening profile...');
            await refreshUserDataFromServer();
            
            // Update profile panel with current user data
            updateUserProfilePanel();
            
            // Show the profile panel
            const panel = document.getElementById('userProfilePanel');
            if (panel) {
                panel.classList.add('active');
                console.log('‚úÖ Profile panel opened');
            }
        };
        
        window.closeUserProfile = function() {
            const panel = document.getElementById('userProfilePanel');
            if (panel) {
                panel.classList.remove('active');
                console.log('‚úÖ Profile panel closed');
            }
        };
        
        // Update user profile panel with current user data and enhanced photo detection
        function updateUserProfilePanel() {
            if (!window.currentUser) return;
            
            // Update profile name and email
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profileInfoName = document.getElementById('profileInfoName');
            const profileInfoEmail = document.getElementById('profileInfoEmail');
            const profileAvatar = document.getElementById('profileAvatar');
            const avatarPlaceholder = document.querySelector('.avatar-placeholder');
            
            if (profileName) profileName.textContent = window.currentUser.name || window.currentUser.email;
            if (profileEmail) profileEmail.textContent = window.currentUser.email;
            if (profileInfoName) profileInfoName.textContent = window.currentUser.name || window.currentUser.email;
            if (profileInfoEmail) profileInfoEmail.textContent = window.currentUser.email;
            
            // Handle avatar display with priority: Firestore photo > Firebase Auth photoURL > picture field
            const avatar = window.currentUser.photo || window.currentUser.photoURL || window.currentUser.picture;
            console.log('üñºÔ∏è Profile avatar sources - photo:', window.currentUser.photo, 'photoURL:', window.currentUser.photoURL, 'picture:', window.currentUser.picture);
            
            if (avatar) {
                if (profileAvatar) {
                    profileAvatar.src = avatar;
                    profileAvatar.style.display = 'block';
                    console.log('‚úÖ Profile avatar set to:', avatar);
                }
                if (avatarPlaceholder) {
                    avatarPlaceholder.style.display = 'none';
                }
            } else {
                console.log('‚ùå No avatar found, showing placeholder');
                if (profileAvatar) {
                    profileAvatar.style.display = 'none';
                }
                if (avatarPlaceholder) {
                    avatarPlaceholder.style.display = 'flex';
                }
            }
            
            // Update join date
            const joinDateElement = document.getElementById('joinDate');
            if (joinDateElement) {
                joinDateElement.textContent = new Date().toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }
        
        // Simple notification function
        window.showNotification = function(message, type = 'info') {
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transition: all 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // Set color based on type
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ffc107';
                    notification.style.color = '#000';
                    break;
                default:
                    notification.style.backgroundColor = '#667eea';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        };

        // Shop-specific logout function
        window.handleShopLogout = function() {
            console.log('üö™ Shop logout initiated...');
            
            try {
                // Clear Firebase auth if user is signed in using v8 compat
                if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                    window.firebaseAuth.signOut().then(() => {
                        console.log('‚úÖ Firebase user signed out');
                    }).catch((error) => {
                        console.error('‚ùå Firebase signout error:', error);
                    });
                }
            } catch (error) {
                console.error('‚ùå Error during Firebase signout:', error);
            }
            
            // Clear localStorage
            localStorage.removeItem('techHavenUser');
            localStorage.removeItem('rememberMe');
            
            // Clear global user
            window.currentUser = null;
            
            // Update specific shop UI elements
            const userIconContainer = document.getElementById('userIconContainer');
            if (userIconContainer) {
                userIconContainer.innerHTML = `<i class="fas fa-user" onclick="openLoginModal()" style="cursor: pointer;"></i>`;
            }
            
            // Update mobile nav
            const mobileUserLink = document.getElementById('mobileUserLink');
            if (mobileUserLink) {
                mobileUserLink.setAttribute('onclick', 'event.preventDefault(); openLoginModal();');
                mobileUserLink.innerHTML = `<i class="fas fa-user"></i> T√†i kho·∫£n`;
            }
            
            // Close user profile panel if open
            const userProfilePanel = document.getElementById('userProfilePanel');
            if (userProfilePanel) {
                userProfilePanel.classList.remove('active');
            }
            
            // Show logout success message
            showNotification('ƒêƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
            
            console.log('‚úÖ Shop logout completed');
        };

        // Admin navigation function compatible with Firebase v9 compat and v8
        window.navigateToAdmin = async function(adminPath) {
            console.log('üîß Navigating to admin:', adminPath);
            
            if (!window.currentUser) {
                console.warn('‚ö†Ô∏è No user logged in for admin access');
                if (window.showNotification) {
                    window.showNotification('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang admin', 'warning');
                } else {
                    alert('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang admin');
                }
                if (window.openLoginModal) {
                    window.openLoginModal();
                }
                return false;
            }
            
            console.log('üë§ Current user for admin access:', {
                uid: window.currentUser.uid,
                email: window.currentUser.email,
                name: window.currentUser.name,
                is_admin: window.currentUser.is_admin,
                provider: window.currentUser.provider
            });
            
            // Check if user has admin privileges
            if (!window.currentUser.is_admin) {
                console.warn('‚ö†Ô∏è User is not an admin:', window.currentUser.is_admin);
                if (window.showNotification) {
                    window.showNotification('‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin', 'warning');
                } else {
                    alert('‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin');
                }
                return false;
            }
            
            // Try different auth methods based on available systems
            let adminUrl = adminPath;
            let authToken = null;
            
            // Method 1: Try Firebase v8/compat auth (firebaseAuth)
            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                try {
                    authToken = await window.firebaseAuth.currentUser.getIdToken();
                    console.log('üîë Got auth token from Firebase compat (v8)');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not get Firebase compat token:', error.message);
                }
            }
            
            // Method 2: Try Firebase v8 direct access 
            if (!authToken && window.firebaseAuth && window.firebaseAuth.currentUser) {
                try {
                    authToken = await window.firebaseAuth.currentUser.getIdToken();
                    console.log('üîë Got auth token from Firebase auth (v8)');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not get Firebase auth token:', error.message);
                }
            }
            
            // Method 3: Try Firebase v9 modular auth  
            if (!authToken && window.firestoreAuth && window.firestoreAuth.currentUser) {
                try {
                    authToken = await window.firestoreAuth.currentUser.getIdToken();
                    console.log('üîë Got auth token from Firebase modular (v9)');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not get Firebase modular token:', error.message);
                }
            }
            
            // Build admin URL with authentication
            if (authToken) {
                adminUrl = `${adminPath}?token=${authToken}`;
                console.log('üîë Using auth token for admin access');
            } else {
                // Fallback to UID-based authentication
                adminUrl = `${adminPath}?uid=${window.currentUser.uid}&email=${encodeURIComponent(window.currentUser.email)}`;
                console.log('üîë Fallback to UID-based authentication');
            }
            
            console.log('üîó Navigating to admin URL (token hidden for security)');
            
            // Navigate to admin page
            try {
                window.location.href = adminUrl;
            } catch (error) {
                console.error('‚ùå Navigation error:', error);
                if (window.showNotification) {
                    window.showNotification('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p trang admin', 'error');
                } else {
                    alert('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p trang admin');
                }
            }
            
            return false;
        };

        // =====================================
        // HOMEPAGE PRODUCT DISPLAY SYSTEM
        // =====================================
        
        // Global variables for homepage products
        let homepageProductsCache = {};
        
        // Load specific products for homepage sections
        async function loadHomepageProducts() {
            try {
                console.log('üè† Loading homepage products...');
                
                // Load all products from API
                const response = await fetch('/api/products?limit=50');
                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load products');
                }
                
                const allProducts = data.products;
                console.log('‚úÖ Loaded', allProducts.length, 'products for homepage');
                
                // Categorize products for different sections
                homepageProductsCache = {
                    newProducts: allProducts.filter(p => p.isNew || p.id >= 15).slice(0, 8),
                    bestSellers: allProducts.filter(p => p.isBestSeller || p.rating >= 4.5).slice(0, 8),
                    laptops: allProducts.filter(p => p.category === 'laptop').slice(0, 8),
                    monitors: allProducts.filter(p => p.category === 'monitor').slice(0, 8),
                    storage: allProducts.filter(p => p.category === 'storage').slice(0, 8)
                };
                
                // If not enough products in specific categories, fill with random products
                Object.keys(homepageProductsCache).forEach(section => {
                    if (homepageProductsCache[section].length < 4) {
                        const remaining = 4 - homepageProductsCache[section].length;
                        const otherProducts = allProducts
                            .filter(p => !homepageProductsCache[section].includes(p))
                            .slice(0, remaining);
                        homepageProductsCache[section] = [...homepageProductsCache[section], ...otherProducts];
                    }
                });
                
                console.log('üì¶ Homepage products categorized:', homepageProductsCache);
                
                // Render products to homepage sections
                renderHomepageSection('new-products', homepageProductsCache.newProducts);
                renderHomepageSection('best-sellers', homepageProductsCache.bestSellers);
                renderHomepageSection('laptops', homepageProductsCache.laptops);
                renderHomepageSection('monitors', homepageProductsCache.monitors);
                renderHomepageSection('storage', homepageProductsCache.storage);
                
            } catch (error) {
                console.error('‚ùå Error loading homepage products:', error);
            }
        }
        
        // Render products to a specific homepage section
        function renderHomepageSection(sectionId, products) {
            const container = document.getElementById(`${sectionId}-container`);
            if (!container || !products || products.length === 0) {
                console.log(`‚ö†Ô∏è No container or products for section: ${sectionId}`);
                return;
            }
            
            const productHTML = products.map(product => {
                const price = formatHomepagePrice(product.price);
                
                // Handle product images properly - check images array first, then image field, then fallback to category icon
                let imageHtml;
                if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                    // Use first image from images array
                    imageHtml = `<img src="${product.images[0]}" alt="${product.name}" loading="lazy" style="width: 100%; height: 200px; object-fit: cover;">`;
                } else if (product.image) {
                    // Fallback to single image field
                    imageHtml = `<img src="${product.image}" alt="${product.name}" loading="lazy" style="width: 100%; height: 200px; object-fit: cover;">`;
                } else {
                    // Fallback to category icon
                    imageHtml = getCategoryIcon(product.category);
                }
                
                const rating = generateStarRating(product.rating || 4);
                const stock = product.stock || 0;
                
                return `
                    <div class="product-card" onclick="goToProductDetail('${product.id}')" 
                         style="opacity: 1; transform: translateY(0px); transition: opacity 0.6s, transform 0.6s;">
                        <div class="product-image">
                            ${imageHtml}
                        </div>
                        <div class="product-info">
                            <div class="product-rating">
                                ${rating}
                            </div>
                            <h4>${product.name}</h4>
                            <div class="product-price">
                                <span>${price}</span>
                                <button class="add-to-cart" 
                                    onclick="event.stopPropagation(); addToCartWithVariantCheck('${escapeQuotes(product.name)}', '${price}', '${product.id}', '${escapeQuotes((product.images && product.images[0]) || product.image || '')}')"
                                    ${stock <= 0 ? 'disabled' : ''}>
                                    ${stock <= 0 ? 'H·∫æT H√ÄNG' : 'TH√äM V√ÄO GI·ªé'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = productHTML;
            console.log(`‚úÖ Rendered ${products.length} products to ${sectionId}`);
        }
        
        // Helper functions for homepage
        function formatHomepagePrice(price) {
            if (typeof price === 'number') {
                return new Intl.NumberFormat('vi-VN').format(price) + ' VNƒê';
            }
            if (typeof price === 'string' && price.includes('VNƒê')) {
                return price;
            }
            if (typeof price === 'string' && /^\d+$/.test(price)) {
                return new Intl.NumberFormat('vi-VN').format(parseInt(price)) + ' VNƒê';
            }
            return price || 'Li√™n h·ªá';
        }
        
        function getCategoryIcon(category) {
            const icons = {
                cpu: '<i class="fas fa-microchip" style="font-size: 3rem; color: #a855f7;"></i>',
                gpu: '<i class="fas fa-memory" style="font-size: 3rem; color: #ec4899;"></i>',
                ram: '<i class="fas fa-memory" style="font-size: 3rem; color: #f59e0b;"></i>',
                storage: '<i class="fas fa-hdd" style="font-size: 3rem; color: #10b981;"></i>',
                laptop: '<i class="fas fa-laptop" style="font-size: 3rem; color: #3b82f6;"></i>',
                monitor: '<i class="fas fa-desktop" style="font-size: 3rem; color: #8b5cf6;"></i>',
                peripheral: '<i class="fas fa-keyboard" style="font-size: 3rem; color: #f59e0b;"></i>',
                other: '<i class="fas fa-cube" style="font-size: 3rem; color: #6b7280;"></i>'
            };
            return icons[category] || icons.other;
        }
        
        function generateStarRating(rating) {
            let starsHTML = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    starsHTML += '<i class="fas fa-star"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    starsHTML += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHTML += '<i class="far fa-star"></i>';
                }
            }
            return starsHTML;
        }
        
        function escapeQuotes(str) {
            return (str || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        // Add to cart with variant checking (same as shop.ejs)
        window.addToCartWithVariantCheck = async function(productName, productPrice, productId, productImage = '') {
            console.log('üõí addToCartWithVariantCheck called with:', {
                productName, productPrice, productId, productImage
            });
            
            if (!productId) {
                console.error('‚ùå Product ID is required for variant checking');
                return;
            }
            
            try {
                // Check if product has variants
                console.log('üîç Checking for product variants...');
                const variantResponse = await fetch(`/api/products/${productId}/variants`);
                
                if (variantResponse.ok) {
                    const variantData = await variantResponse.json();
                    console.log('üì¶ Variant check response:', variantData);
                    
                    if (variantData.success && variantData.variants && variantData.variants.length > 0) {
                        console.log('üéØ Product has variants, showing selection modal');
                        
                        // Product has variants - show selection modal
                        if (typeof window.showVariantSelectionModal === 'function') {
                            window.showVariantSelectionModal(variantData.mainProduct, variantData.variants);
                        } else {
                            console.error('‚ùå showVariantSelectionModal function not found');
                            // Fallback: add main product directly
                            addToCartDirectly(productName, productPrice, productId, productImage);
                        }
                        return;
                    }
                }
                
                // No variants found - add directly to cart
                console.log('‚û°Ô∏è No variants found, adding directly to cart');
                addToCartDirectly(productName, productPrice, productId, productImage);
                
            } catch (error) {
                console.error('‚ùå Error checking variants:', error);
                // Fallback: add directly to cart
                addToCartDirectly(productName, productPrice, productId, productImage);
            }
        };
        
        // Add to cart directly (same as shop.ejs)
        function addToCartDirectly(productName, productPrice, productId, productImage) {
            console.log('üõí Adding to cart directly:', {
                productName, productPrice, productId, productImage
            });
            
            // Use the enhanced addToCart wrapper that waits for Firebase completion
            if (typeof window.addToCartAndUpdateBadge === 'function') {
                window.addToCartAndUpdateBadge(productName, productPrice, productId, productImage);
            } else if (typeof window.addToCart === 'function') {
                // Fallback: Call addToCart and wait longer for Firebase sync
                console.log('üîÑ Using fallback addToCart method...');
                window.addToCart(productName, productPrice, productId, productImage);
                
                // Wait longer for Firebase operations to complete
                setTimeout(() => {
                    console.log('üîÑ Fallback: Triggering cart update after Firebase should be complete...');
                    
                    // First reload cart from Firebase to get latest data
                    if (window.currentUser && typeof loadCart === 'function') {
                        loadCart().then(() => {
                            console.log('‚úÖ Fallback: Cart reloaded, now notifying systems');
                            if (typeof window.notifyCartChange === 'function') {
                                window.notifyCartChange();
                            }
                        });
                    } else {
                        // For guest users or if loadCart isn't available
                        if (typeof window.reloadCartAndNotify === 'function') {
                            window.reloadCartAndNotify();
                        } else {
                            // Final fallback
                            if (typeof window.updateCartBadge === 'function') {
                                window.updateCartBadge();
                            }
                            if (typeof window.notifyCartChange === 'function') {
                                window.notifyCartChange();
                            }
                        }
                    }
                }, 800); // Much longer delay to ensure Firebase operations complete
                
            } else {
                console.error('‚ùå addToCart function not available');
            }
        }

        
        // Initialize homepage products on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Only load homepage products if we're on the homepage
            if (document.body.classList.contains('index-page')) {
                console.log('üè† Index page detected, loading homepage products...');
                loadHomepageProducts();
            } else {
                console.log('‚ÑπÔ∏è Not on index page, skipping homepage product loading');
            }
        });
        
        // Make functions globally available
        window.loadHomepageProducts = loadHomepageProducts;
        window.goToProductDetail = function(productId) {
            window.location.href = `/product/${productId}`;
        };

        // =====================================
        // SHOPPING CART FUNCTIONALITY
        // =====================================
        
        // Cart state variables
        let cart = [];
        let cartTotal = 0;
        
        // Load cart from localStorage immediately on page load
        function initializeCart() {
            const savedCart = localStorage.getItem('techHavenCart');
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                    console.log('üì¶ Initialized cart from localStorage:', cart.length, 'items');
                } catch (e) {
                    console.error('‚ùå Failed to parse saved cart:', e);
                    cart = [];
                }
            }
            
            // Make cart globally available for debugging
            window.cart = cart;
            window.cartItems = [...cart]; // Sync with script.js cartItems
        }
        
        // Initialize cart immediately
        initializeCart();
        
        // Function to sync cart across all systems
        function syncCartEverywhere() {
            // Smart cart sync: prioritize Firebase data for logged users, localStorage for guests
            if (window.currentUser && cart && cart.length > 0) {
                // User is logged in and we have Firebase cart data - use it
                console.log('üì¶ Using Firebase cart data for logged user:', cart.length, 'items');
            } else {
                // User not logged in or no Firebase data - load from localStorage 
                const savedCart = localStorage.getItem('techHavenCart');
                if (savedCart) {
                    try {
                        cart = JSON.parse(savedCart);
                        console.log('üì¶ Loaded cart from localStorage for sync:', cart.length, 'items');
                    } catch (e) {
                        console.error('‚ùå Failed to parse saved cart:', e);
                        cart = [];
                    }
                } else {
                    cart = [];
                    console.log('üì¶ No saved cart found in localStorage');
                }
            }
            
            // Normalize cart items to have consistent field names
            const normalizedCart = cart.map(item => {
                // Create a normalized item with consistent field names
                const normalizedItem = {
                    id: item.id || item.productId,
                    name: item.productName || item.name,
                    price: item.productPrice || item.price,
                    numericPrice: item.productPrice || item.numericPrice || (
                        typeof item.price === 'number' ? item.price :
                        typeof item.price === 'string' ? parseInt(item.price.replace(/[^\d]/g, '')) || 0 : 0
                    ),
                    quantity: item.quantity || 1,
                    image: item.productImage || item.image,
                    // Keep original fields as well for compatibility
                    ...item
                };
                
                console.log('üîÑ Normalized item:', {
                    original: item,
                    normalized: normalizedItem
                });
                
                return normalizedItem;
            });
            
            // Sync with global window objects
            window.cart = cart;
            window.cartItems = normalizedCart; // Use normalized items
            
            // Sync with localStorage using normalized format
            localStorage.setItem('techHavenCart', JSON.stringify(normalizedCart));
            
            // Update cart count
            const totalCount = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
            localStorage.setItem('techHavenCartCount', totalCount.toString());
            
            console.log(`üîÑ Cart synced everywhere - ${cart.length} items, total count: ${totalCount}`);
            console.log('üîÑ Normalized cartItems for script.js:', window.cartItems);
        }
        
        // Make sync function globally available
        window.syncCartEverywhere = syncCartEverywhere;
        
        // DO NOT DEFINE addToCart HERE - let script.js handle it with duplicate prevention
        // The addToCart function from script.js has comprehensive safeguards against duplicate calls
        
        // Load cart from database
        async function loadCart() {
            console.log('üîÑ loadCart() called - currentUser:', window.currentUser ? window.currentUser.uid : 'not logged in');
            
            if (!window.currentUser) {
                console.log('üë§ Guest mode: Loading cart from localStorage');
                
                // Load cart from localStorage for guest users
                const storedCart = localStorage.getItem('techHavenCart');
                const storedCount = localStorage.getItem('techHavenCartCount');
                
                if (storedCart) {
                    try {
                        const localCartItems = JSON.parse(storedCart);
                        cart = localCartItems;
                        cartTotal = localCartItems.reduce((total, item) => {
                            const price = parseFloat(item.numericPrice) || parseFloat(item.price) || 0;
                            return total + (price * item.quantity);
                        }, 0);
                        
                        console.log('üõí Guest cart loaded:', {
                            items: cart.length,
                            total: cartTotal,
                            cart: cart
                        });
                        
                        // Update global state for guest
                        window.cart = cart;
                        
                    } catch (error) {
                        console.error('‚ùå Error parsing guest cart:', error);
                        cart = [];
                        cartTotal = 0;
                    }
                } else {
                    console.log('üì¶ No guest cart in localStorage');
                    cart = [];
                    cartTotal = 0;
                }
                
                renderCart();
                updateCartBadge();
                return;
            }
            
            try {
                console.log('üõí Loading cart for user:', window.currentUser.uid);
                
                const response = await fetch(`/api/cart?uid=${window.currentUser.uid}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üîç Raw Firebase cart data:', data);
                    if (data.success) {
                        cart = data.cartItems;
                        cartTotal = data.total;
                        
                        // Log each cart item structure for debugging
                        cart.forEach((item, index) => {
                            console.log(`üõí Cart item ${index}:`, {
                                name: item.productName || item.name,
                                price: item.productPrice || item.price,
                                numericPrice: item.numericPrice,
                                quantity: item.quantity,
                                fullItem: item
                            });
                        });
                        
                        // Don't call syncCartEverywhere() here - it will overwrite Firebase data with localStorage
                        // Instead, directly update global state and UI
                        window.cart = cart;
                        
                        // Set timestamp for fresh data from database
                        window.lastCartSyncTime = Date.now();
                        console.log('‚è∞ Set fresh cart data timestamp');
                        
                        // Normalize cart items for script.js compatibility
                        const normalizedCart = cart.map(item => ({
                            id: item.id || item.productId,
                            name: item.productName || item.name,
                            price: item.productPrice || item.price,
                            numericPrice: item.numericPrice || item.productPrice || item.price,
                            quantity: item.quantity || 1,
                            image: item.productImage || item.image,
                            cartId: item.cartId || item.id,
                            productId: item.productId || item.id,
                            productName: item.productName || item.name,
                            productPrice: item.productPrice || item.price,
                            productImage: item.productImage || item.image,
                            ...item
                        }));
                        
                        window.cartItems = normalizedCart;
                        
                        console.log('üîÑ Firebase cart loaded and normalized - NO localStorage overwrite');
                        
                        console.log(`‚úÖ Loaded ${cart.length} cart items, total: ${cartTotal}`);
                        
                        // Force update UI with Firebase data (no localStorage interference)
                        forceUpdateCartUI();
                        
                        // Also update order summary in checkout modal if available
                        if (window.updateOrderSummary && typeof window.updateOrderSummary === 'function') {
                            console.log('üìä Updating order summary after Firebase cart load');
                            window.updateOrderSummary();
                        }
                        
                        // Update SmartCart after loading cart data
                        if (window.smartCartManager) {
                            window.smartCartManager.refreshCartData();
                        }
                    }
                } else {
                    throw new Error('Failed to load cart');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading cart:', error);
                cart = [];
                cartTotal = 0;
                syncCartEverywhere();
                renderCart();
                updateCartBadge();
                
                // Update SmartCart after error
                if (window.smartCartManager) {
                    window.smartCartManager.refreshCartData();
                }
            }
        }
        
        // Make loadCart available globally for script.js
        window.loadCart = loadCart;
        window.loadCartFromDatabase = loadCart; // Alias for script.js compatibility
        
        // DO NOT override script.js functions to prevent circular calls
        // Let script.js keep its original functions and call our wrapper functions
        // Make our wrapper functions available with different names for optional use
        window.productDetailUpdateQuantity = simpleUpdateQuantity;
        window.productDetailRemoveFromCart = simpleRemoveFromCart;
        
        // Sync cart from database (for cart badge click)
        async function syncCartFromDatabase() {
            if (!window.currentUser) {
                console.log('üì≠ No user logged in, skipping cart sync');
                return;
            }
            
            console.log('üîÑ Syncing cart from database for user:', window.currentUser.uid);
            
            try {
                const response = await fetch(`/api/cart?uid=${window.currentUser.uid}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log(`üîÑ Synced ${data.cartItems.length} items from database`);
                        
                        // Update local cart state
                        cart = data.cartItems;
                        cartTotal = data.total;
                        syncCartEverywhere();
                        
                        // Update UI
                        renderCart();
                        updateCartBadge();
                        
                        console.log('‚úÖ Cart sync completed successfully');
                    } else {
                        console.warn('‚ö†Ô∏è Cart sync failed:', data.error);
                    }
                } else {
                    console.error('‚ùå Failed to sync cart from database');
                }
                
            } catch (error) {
                console.error('‚ùå Error syncing cart from database:', error);
            }
        }
        
        // Make syncCartFromDatabase available globally
        window.syncCartFromDatabase = syncCartFromDatabase;
        
        // Helper function to format price
        function formatPrice(price) {
            // Handle different price formats
            if (typeof price === 'string') {
                // Remove non-numeric characters and parse
                const numericPrice = parseInt(price.replace(/[^\d]/g, ''));
                return new Intl.NumberFormat('vi-VN').format(numericPrice);
            } else if (typeof price === 'number') {
                return new Intl.NumberFormat('vi-VN').format(price);
            } else {
                return '0';
            }
        }
        
        // Make formatPrice globally available
        window.formatPrice = formatPrice;
        
        // Render cart items
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotalElement = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (!cartItems) return;
            
            // SMART CART RENDERING: Use correct data source based on auth status
            let activeCart = cart;
            let activeTotal = cartTotal;
            
            if (!window.currentUser) {
                // GUEST MODE: Check if script.js has fresher cart data
                const freshCartItems = JSON.parse(localStorage.getItem('techHavenCart') || '[]');
                
                if (window.cartItems && Array.isArray(window.cartItems) && window.cartItems.length > 0) {
                    activeCart = window.cartItems;
                    activeTotal = window.cartItems.reduce((sum, item) => sum + (item.numericPrice || item.price || 0) * item.quantity, 0);
                    console.log('üõí Using script.js cart data for rendering:', activeCart.length, 'items');
                } else if (freshCartItems.length > 0) {
                    activeCart = freshCartItems;
                    activeTotal = freshCartItems.reduce((sum, item) => sum + (item.numericPrice || item.price || 0) * item.quantity, 0);
                    console.log('üõí Using fresh localStorage cart data for rendering:', activeCart.length, 'items');
                }
            }
            
            if (activeCart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; color: #ccc;"></i>
                        <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
                    </div>
                `;
                if (checkoutBtn) checkoutBtn.disabled = true;
            } else {
                let html = '';
                
                activeCart.forEach(item => {
                    // Handle different cart data structures
                    const itemName = item.productName || item.name || 'S·∫£n ph·∫©m';
                    const itemPrice = item.productPrice || item.price || 0;
                    const itemImage = item.productImage || item.image || null;
                    const itemQuantity = item.quantity || 1;
                    const itemId = item.id || item.productId;
                    
                    const productImage = itemImage ? 
                        `<img src="${itemImage}" alt="${itemName}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" />` :
                        `<i class="fas fa-cube" style="color: #667eea; font-size: 2rem;"></i>`;
                    
                    html += `
                        <div class="cart-item" data-product-id="${item.productId || itemId}" data-cart-id="${itemId}">
                            <div class="cart-item-image">
                                ${productImage}
                            </div>
                            <div class="cart-item-details">
                                <div class="cart-item-name">${itemName}</div>
                                <div class="cart-item-price">${formatPrice(itemPrice)}</div>
                                <div class="cart-item-controls">
                                    <button class="quantity-btn decrease-qty" data-cart-id="${itemId}" data-current-quantity="${itemQuantity}">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="cart-item-quantity">${itemQuantity}</span>
                                    <button class="quantity-btn increase-qty" data-cart-id="${itemId}" data-current-quantity="${itemQuantity}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="remove-item" data-cart-id="${itemId}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = html;
                if (checkoutBtn) checkoutBtn.disabled = false;
                
                // CART EVENT HANDLING DELEGATED TO SCRIPT.JS
                // All cart functionality (buttons, updates, remove) is now handled by script.js
                // This prevents multiple event handler conflicts and ensures consistent behavior
            }
            
            if (cartTotalElement) {
                cartTotalElement.textContent = formatPrice(activeTotal);
            }
        }
        
        // ================================
        // CART EVENT HANDLING MOVED TO SCRIPT.JS
        // ================================
        // All cart button event handling has been consolidated to script.js
        // to prevent conflicts between multiple cart systems.
        // script.js handles: increase-qty, decrease-qty, remove-item buttons
        // This includes both guest (localStorage) and logged users (Firebase) support
        
        /* REMOVED: setupSimpleCartEventListeners, simpleUpdateQuantity, simpleRemoveFromCart 
           All cart operations are now handled by script.js for consistency */
        
        // Update cart badge
        function setupSimpleCartEventListeners() {
            console.log('üîß Setting up SIMPLE cart event listeners');
            
            // Remove existing event listeners by cloning cart items container
            const cartItemsContainer = document.getElementById('cartItems');
            if (!cartItemsContainer) {
                console.error('‚ùå Cart items container not found');
                return;
            }
            
            // Use event delegation instead of adding multiple listeners
            // Remove existing delegated listener if any
            if (cartItemsContainer._hasCartListener) {
                cartItemsContainer.removeEventListener('click', cartItemsContainer._cartClickHandler);
            }
            
            // Create new delegated click handler
            const cartClickHandler = async function(e) {
                console.log('ÔøΩÔ∏è Cart click detected:', e.target);
                
                // Handle decrease buttons
                if (e.target.classList.contains('decrease-qty')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const cartId = e.target.getAttribute('data-cart-id');
                    const currentQuantity = parseInt(e.target.getAttribute('data-current-quantity'));
                    const newQuantity = Math.max(0, currentQuantity - 1);
                    
                    console.log('üìâ Decrease clicked:', { cartId, currentQuantity, newQuantity });
                    
                    if (newQuantity <= 0) {
                        console.log('üóëÔ∏è Quantity is 0, removing item');
                        await simpleRemoveFromCart(cartId);
                    } else {
                        console.log('üìâ Updating quantity to:', newQuantity);
                        await simpleUpdateQuantity(cartId, newQuantity);
                    }
                    return;
                }
                
                // Handle increase buttons
                if (e.target.classList.contains('increase-qty')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const cartId = e.target.getAttribute('data-cart-id');
                    const currentQuantity = parseInt(e.target.getAttribute('data-current-quantity'));
                    const newQuantity = currentQuantity + 1;
                    
                    console.log('üìà Increase clicked:', { cartId, currentQuantity, newQuantity });
                    
                    await simpleUpdateQuantity(cartId, newQuantity);
                    return;
                }
                
                // Handle remove buttons
                if (e.target.classList.contains('remove-item')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const cartId = e.target.getAttribute('data-cart-id');
                    console.log('üóëÔ∏è Remove clicked:', { cartId });
                    
                    await simpleRemoveFromCart(cartId);
                    return;
                }
            };
            
            // Add the new delegated listener
            cartItemsContainer.addEventListener('click', cartClickHandler);
            cartItemsContainer._cartClickHandler = cartClickHandler;
            cartItemsContainer._hasCartListener = true;
            
            console.log('‚úÖ SIMPLE cart event listeners setup completed with event delegation');
        }
        
        // Simple update quantity function (supports both guest and logged users)
        async function simpleUpdateQuantity(cartId, newQuantity) {
            // Prevent infinite loops
            if (window._productDetailUpdating) {
                console.log('‚ö†Ô∏è Update already in progress, skipping to prevent loop');
                return;
            }
            window._productDetailUpdating = true;
            
            try {
                console.log('üìà SIMPLE updating quantity:', cartId, 'to', newQuantity);
                
                // Check if user is logged in
                if (!window.currentUser) {
                    console.log('üë§ Guest mode: Using localStorage cart management');
                    
                    // Use script.js guest cart functions
                    if (typeof window.updateGuestCartQuantity === 'function') {
                        window.updateGuestCartQuantity(cartId, newQuantity);
                        
                        // Small delay to let script.js update localStorage, then refresh our UI
                        setTimeout(async () => {
                            await loadCart();
                            notifyCartChange();
                        }, 50); // Reduced delay for faster response
                        
                        console.log('‚úÖ Guest cart quantity update initiated');
                    } else {
                        console.error('‚ùå updateGuestCartQuantity function not found');
                        showNotification('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng', 'error');
                    }
                    return;
                }
                
                // Logged user: Use script.js updateCartQuantityById function for better Firebase integration
                if (typeof window.updateCartQuantityById === 'function') {
                    console.log('üîó Using script.js updateCartQuantityById for Firebase integration');
                    await window.updateCartQuantityById(cartId, newQuantity);
                    
                    // Update our local UI after script.js handles the update
                    setTimeout(async () => {
                        await loadCart();
                        notifyCartChange();
                    }, 200);
                    
                    console.log('‚úÖ Delegated to script.js updateCartQuantityById');
                    return;
                }
            } finally {
                // Always clear the flag
                window._productDetailUpdating = false;
            }
                
                // Update our local UI after script.js handles the update
                setTimeout(async () => {
                    await loadCart();
                    notifyCartChange();
                }, 200);
                
                console.log('‚úÖ Delegated to script.js updateCartQuantityById');
                return;
            }
            
            // Fallback: Direct API call (if script.js function not available)
            try {
                console.log('üì° Fallback: Making direct API request...');
                const response = await fetch(`/api/cart/${cartId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity: newQuantity })
                });
                
                console.log('üìä API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã API response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Quantity updated successfully');
                        
                        // Refresh cart to show updated data
                        await loadCart();
                        notifyCartChange();
                    } else {
                        throw new Error(data.error || 'Failed to update quantity');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå API error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('‚ùå Error updating quantity:', error);
                showNotification('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng', 'error');
            }
        
        
        // Simple remove from cart function (supports both guest and logged users)
        async function simpleRemoveFromCart(cartId) {
            // Prevent infinite loops
            if (window._productDetailRemoving) {
                console.log('‚ö†Ô∏è Remove already in progress, skipping to prevent loop');
                return;
            }
            window._productDetailRemoving = true;
            
            try {
                console.log('üóëÔ∏è SIMPLE removing from cart:', cartId);
                
                // Check if user is logged in
                if (!window.currentUser) {
                    console.log('üë§ Guest mode: Using localStorage cart management');
                    
                    // Use script.js guest cart functions
                    if (typeof window.removeGuestCartItem === 'function') {
                        window.removeGuestCartItem(cartId);
                        
                        // Small delay to let script.js update localStorage, then refresh our UI
                        setTimeout(async () => {
                            await loadCart();
                            notifyCartChange();
                        }, 50); // Reduced delay for faster response
                        
                        console.log('‚úÖ Guest cart item removal initiated');
                    } else {
                        console.error('‚ùå removeGuestCartItem function not found');
                        showNotification('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m', 'error');
                    }
                    return;
                }
                
                // Logged user: Use script.js removeFromCartById function for better Firebase integration
                if (typeof window.removeFromCartById === 'function') {
                    console.log('üîó Using script.js removeFromCartById for Firebase integration');
                    await window.removeFromCartById(cartId);
                    
                    // Update our local UI after script.js handles the removal
                    setTimeout(async () => {
                        await loadCart();
                        notifyCartChange();
                    }, 200);
                    
                    console.log('‚úÖ Delegated to script.js removeFromCartById');
                    return;
                }
            } finally {
                // Always clear the flag
                window._productDetailRemoving = false;
            }
            
            // Fallback: Direct API call (if script.js function not available)
            try {
                console.log('üì° Fallback: Making direct API request to remove...');
                const response = await fetch(`/api/cart/${cartId}`, {
                    method: 'DELETE'
                });
                
                console.log('üìä API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã API response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Item removed successfully');
                        
                        // Refresh cart to show updated data
                        await loadCart();
                        notifyCartChange();
                    } else {
                        throw new Error(data.error || 'Failed to remove item');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå API error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('‚ùå Error removing item:', error);
                showNotification('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m', 'error');
            }
        }
        
        // OLD COMPLEX RETRY MECHANISM REMOVED - USING SIMPLE APPROACH ABOVE
        
        // Update cart badge
        // Debounce timer for badge updates to prevent infinite loops
        let badgeUpdateTimer = null;
        let lastBadgeUpdate = 0;
        
        // Update cart badge (both desktop and mobile)
        function updateCartBadge() {
            // Debounce rapid badge updates to prevent infinite loops
            const now = Date.now();
            if (now - lastBadgeUpdate < 50) { // Minimum 50ms between updates
                if (badgeUpdateTimer) clearTimeout(badgeUpdateTimer);
                badgeUpdateTimer = setTimeout(updateCartBadge, 100);
                return;
            }
            lastBadgeUpdate = now;
            
            const cartBadge = document.getElementById('cartBadge');
            const mobileCartCount = document.getElementById('cartCount'); // Fixed: Use correct mobile cart ID
            
            // SMART CART COUNT: Use correct data source based on auth status
            let totalItems = 0;
            
            if (!window.currentUser) {
                // GUEST MODE: Prioritize fresh localStorage data over local cart variable
                const freshCartItems = JSON.parse(localStorage.getItem('techHavenCart') || '[]');
                const freshCartCount = parseInt(localStorage.getItem('techHavenCartCount') || '0');
                
                if (freshCartCount > 0) {
                    totalItems = freshCartCount;
                } else if (freshCartItems.length > 0) {
                    totalItems = freshCartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                } else if (window.cartItems && Array.isArray(window.cartItems)) {
                    totalItems = window.cartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                } else {
                    totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                }
            } else {
                // LOGGED MODE: Use local cart variable (Firebase data)
                totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            }
            
            // Debug: Add caller information (reduced frequency)
            if (Math.random() < 0.1) { // Only log 10% of calls to reduce spam
                console.log('üîÑ updateCartBadge called - totalItems:', totalItems, 'cart length:', cart.length, 'userMode:', window.currentUser ? 'logged' : 'guest');
                console.log('üìç Called from:', new Error().stack.split('\n')[2].trim());
            }
            
            // Update desktop cart badge
            if (cartBadge) {
                if (totalItems > 0) {
                    cartBadge.textContent = totalItems;
                    cartBadge.style.display = 'flex';
                    console.log('‚úÖ Desktop cart badge updated to:', totalItems);
                } else {
                    cartBadge.style.display = 'none';
                    console.log('üö´ Desktop cart badge hidden (no items)');
                }
            } else {
                console.log('‚ùå Desktop cart badge element not found!');
            }
            
            // Update mobile cart count (now using correct ID)
            if (mobileCartCount) {
                mobileCartCount.textContent = totalItems;
                console.log('üì± Mobile cart count updated to:', totalItems);
            } else {
                console.log('‚ùå Mobile cart count element not found!');
            }
        }
        
        // Debounce timer for UI updates
        let uiUpdateTimer = null;
        
        // Force update cart UI with current data (no localStorage interference)
        function forceUpdateCartUI(skipDebounce = false) {
            // Debounce rapid UI updates unless explicitly skipped
            if (!skipDebounce) {
                if (uiUpdateTimer) {
                    clearTimeout(uiUpdateTimer);
                }
                uiUpdateTimer = setTimeout(() => forceUpdateCartUI(true), 100);
                return;
            }
            
            console.log('üîß Force updating cart UI with current data:', cart.length, 'items');
            
            // Ensure global state is correct
            window.cart = cart;
            
            // CRITICAL: Only sync to script.js if we have valid fresh data
            if (cart && Array.isArray(cart)) {
                // Add timestamp check to prevent overwriting newer data
                const currentTime = Date.now();
                const lastSyncTime = window.lastCartSyncTime || 0;
                
                // Only sync if this update is recent (within 5 seconds) or forced
                if (currentTime - lastSyncTime < 5000 || !window.lastCartSyncTime) {
                    window.cartItems = [...cart];
                    if (typeof localStorage !== 'undefined') {
                        localStorage.setItem('techHavenCart', JSON.stringify(cart));
                        localStorage.setItem('techHavenCartCount', cart.length.toString());
                    }
                    window.lastCartSyncTime = currentTime;
                    console.log('üîÑ Synced cart from shop.ejs to script.js system (fresh data)');
                } else {
                    console.log('‚è≠Ô∏è Skipped sync - data may be stale (age:', ((currentTime - lastSyncTime) / 1000).toFixed(1), 'seconds)');
                }
            }
            
            // Update UI immediately
            renderCart();
            updateCartBadge();
            
            // Update order summary for checkout modal
            if (window.updateOrderSummary && typeof window.updateOrderSummary === 'function') {
                console.log('üìä Calling updateOrderSummary from forceUpdateCartUI');
                window.updateOrderSummary();
            } else {
                console.log('‚ö†Ô∏è updateOrderSummary not found, will wait for script.js to load');
            }
            
            // Update SmartCart if available
            if (window.smartCart && window.smartCart.updateCartIcon) {
                console.log('üîß Updating SmartCart with current data');
                window.smartCart.cartData = {
                    items: cart,
                    count: cart.reduce((sum, item) => sum + item.quantity, 0),
                    total: cartTotal
                };
                window.smartCart.lastUpdateSource = 'firebase';
                window.smartCart.updateCartIcon();
            }
            
            console.log('‚úÖ Force update completed');
        }
        
        // Global cart change notification system
        window.cartChangeCallbacks = window.cartChangeCallbacks || [];
        
        // Function to notify all systems when cart changes
        function notifyCartChange() {
            console.log('üì¢ Notifying all systems of cart change...');
            
            // Update local cart UI
            updateCartBadge();
            renderCart();
            
            // Call all registered callbacks
            window.cartChangeCallbacks.forEach((callback, index) => {
                try {
                    console.log(`üìû Calling cart change callback ${index + 1}`);
                    callback();
                } catch (error) {
                    console.error(`‚ùå Error in cart change callback ${index + 1}:`, error);
                }
            });
            
            console.log('‚úÖ Cart change notification completed');
        }
        
        // Register a callback for cart changes
        window.registerCartChangeCallback = function(callback) {
            if (typeof callback === 'function') {
                window.cartChangeCallbacks.push(callback);
                console.log('‚úÖ Registered cart change callback');
            }
        };
        
        // Enhanced cart reload function that notifies all systems
        window.reloadCartAndNotify = async function() {
            console.log('üîÑ Reloading cart and notifying all systems...');
            
            if (window.currentUser && typeof loadCart === 'function') {
                await loadCart();
            } else {
                // For guest users, sync from localStorage
                syncCartEverywhere();
            }
            
            // Notify all systems of the change
            notifyCartChange();
        };
        
        // Cart integration bridge for script.js
        window.onCartUpdatedByScriptJS = function(cartData) {
            console.log('üîÑ Cart updated by script.js, syncing to index.ejs...', cartData);
            
            // If cartData is provided, use it to update local cart
            if (cartData && Array.isArray(cartData)) {
                cart = cartData;
                cartTotal = cart.reduce((sum, item) => sum + (item.numericPrice || 0) * item.quantity, 0);
                console.log('üì¶ Updated local cart from script.js:', cart.length, 'items, total:', cartTotal);
            }
            
            // Immediately update all UI elements
            updateCartBadge();
            renderCart();
            
            // Notify other systems
            if (typeof window.notifyCartChange === 'function') {
                window.notifyCartChange();
            }
        };
        
        // Callback system for Firebase completion notification
        window.firebaseOperationCallbacks = [];
        
        window.registerFirebaseCallback = function(callback) {
            if (typeof callback === 'function') {
                window.firebaseOperationCallbacks.push(callback);
                console.log('‚úÖ Registered Firebase operation callback');
            }
        };
        
        // Function for script.js to call when Firebase operations complete
        window.onFirebaseCartOperationComplete = function(operation, success, data) {
            console.log('üî• Firebase cart operation completed:', {operation, success, data});
            
            if (success) {
                // Force reload cart data from Firebase to ensure we have latest state
                if (window.currentUser && typeof loadCart === 'function') {
                    console.log('üîÑ Reloading cart after Firebase operation completion...');
                    loadCart().then(() => {
                        console.log('‚úÖ Cart reloaded after Firebase completion');
                        
                        // Call all registered callbacks
                        window.firebaseOperationCallbacks.forEach((callback, index) => {
                            try {
                                console.log(`üìû Calling Firebase callback ${index + 1}`);
                                callback(operation, success, data);
                            } catch (error) {
                                console.error(`‚ùå Error in Firebase callback ${index + 1}:`, error);
                            }
                        });
                        
                        // Clear callbacks after use
                        window.firebaseOperationCallbacks = [];
                    });
                } else {
                    // For guest users, just call callbacks
                    window.firebaseOperationCallbacks.forEach((callback, index) => {
                        try {
                            callback(operation, success, data);
                        } catch (error) {
                            console.error(`‚ùå Error in Firebase callback ${index + 1}:`, error);
                        }
                    });
                    window.firebaseOperationCallbacks = [];
                }
            }
        };
        
        // Function for script.js to get current cart state from index.ejs
        window.getIndexCartState = function() {
            return {
                cart: cart || [],
                cartTotal: cartTotal || 0,
                cartCount: cart ? cart.reduce((sum, item) => sum + item.quantity, 0) : 0
            };
        };
        
        // Debounce timer for badge updates from any source
        let badgeFromAnySourceTimer = null;
        let lastBadgeFromAnySourceUpdate = 0;
        
        // Smart badge update that prioritizes correct data source based on user type
        window.updateBadgeFromAnySource = function() {
            // Debounce rapid badge updates to prevent infinite loops
            const now = Date.now();
            if (now - lastBadgeFromAnySourceUpdate < 50) { // Minimum 50ms between updates
                if (badgeFromAnySourceTimer) clearTimeout(badgeFromAnySourceTimer);
                badgeFromAnySourceTimer = setTimeout(window.updateBadgeFromAnySource, 100);
                return;
            }
            lastBadgeFromAnySourceUpdate = now;
            
            const cartBadge = document.getElementById('cartBadge');
            const mobileCartCount = document.getElementById('cartCount'); // Fixed: Use correct mobile cart ID
            
            let totalItems = 0;
            let dataSource = 'none';
            
            // For GUEST users: Prioritize fresh localStorage data over global variables
            if (!window.currentUser) {
                // 1. Check fresh localStorage data FIRST (most reliable and up-to-date)
                const freshCartItems = JSON.parse(localStorage.getItem('techHavenCart') || '[]');
                const freshCartCount = parseInt(localStorage.getItem('techHavenCartCount') || '0');
                
                if (freshCartCount > 0) {
                    totalItems = freshCartCount;
                    dataSource = 'fresh-localStorage-count';
                    console.log('üìä Badge count from fresh localStorage count (guest):', totalItems);
                }
                // 1b. Calculate from fresh localStorage items if count is missing
                else if (freshCartItems.length > 0) {
                    totalItems = freshCartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                    dataSource = 'fresh-localStorage-items';
                    console.log('üìä Badge count calculated from fresh localStorage items (guest):', totalItems);
                }
                // 2. Fallback: Check script.js cartCount (may be stale)
                else if (window.cartCount && typeof window.cartCount === 'number') {
                    totalItems = window.cartCount;
                    dataSource = 'script.js-cartCount-fallback';
                    console.log('üìä Badge count from script.js cartCount (fallback):', totalItems);
                }
                // 2. Check script.js cartItems array
                else if (window.cartItems && Array.isArray(window.cartItems) && window.cartItems.length > 0) {
                    totalItems = window.cartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                    dataSource = 'script.js-cartItems';
                    console.log('ÔøΩ Badge count from script.js cartItems (guest):', totalItems);
                }
                // 3. Fallback: Direct localStorage check
                else {
                    const localCart = localStorage.getItem('techHavenCart');
                    if (localCart) {
                        try {
                            const parsedCart = JSON.parse(localCart);
                            if (parsedCart.length > 0) {
                                totalItems = parsedCart.reduce((sum, item) => sum + (item.quantity || 1), 0);
                                dataSource = 'localStorage';
                                console.log('ÔøΩ Badge count from localStorage (guest):', totalItems);
                            }
                        } catch (e) {
                            console.error('‚ùå Failed to parse localStorage cart for badge update');
                        }
                    }
                }
            }
            // For LOGGED users: Prioritize Firebase cart data
            else {
                // 1. PRIORITY: script.js cart data (most up-to-date and reliable)
                if (window.cartItems && Array.isArray(window.cartItems) && window.cartItems.length > 0) {
                    totalItems = window.cartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                    dataSource = 'script.js-primary';
                    if (Math.random() < 0.1) {
                        console.log('üì¶ Badge count from script.js primary (logged):', totalItems);
                    }
                }
                // 2. Fallback: Check cartCount from script.js
                else if (typeof window.cartCount === 'number' && window.cartCount > 0) {
                    totalItems = window.cartCount;
                    dataSource = 'script.js-count';
                    if (Math.random() < 0.1) {
                        console.log('üî¢ Badge count from script.js cartCount (logged):', totalItems);
                    }
                }
                // 3. Last resort: Firebase cart data (may be outdated)
                else if (window.cart && Array.isArray(window.cart) && window.cart.length > 0) {
                    totalItems = window.cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
                    dataSource = 'firebase-cart-fallback';
                    if (Math.random() < 0.1) {
                        console.log('ÔøΩ Badge count from Firebase cart fallback (logged):', totalItems);
                    }
                }
            }
            
            // Always update for guest users if we have data, or for logged users with Firebase data
            const shouldUpdate = totalItems > 0 || 
                                (!window.currentUser && dataSource !== 'none') ||
                                (window.currentUser && dataSource.includes('firebase'));
            
            if (shouldUpdate) {
                // Update both desktop and mobile badges
                if (cartBadge) {
                    if (totalItems > 0) {
                        cartBadge.textContent = totalItems;
                        cartBadge.style.display = 'flex';
                        cartBadge.setAttribute('title', `${totalItems} items from ${dataSource}`);
                        
                        // Update badge class based on user type
                        cartBadge.className = 'cart-badge ' + (window.currentUser ? 'firebase-data' : 'local-data');
                    } else {
                        cartBadge.style.display = 'none';
                    }
                    console.log(`‚úÖ Desktop cart badge updated to: ${totalItems} (source: ${dataSource})`);
                }
                
                if (mobileCartCount) {
                    mobileCartCount.textContent = totalItems;
                    console.log(`üì± Mobile cart count updated to: ${totalItems} (source: ${dataSource})`);
                }
            } else {
                console.log('‚è≥ Badge update skipped - no reliable data source');
            }
            
            return totalItems;
        };
        
        // Enhanced addToCart wrapper that uses Firebase callback system
        window.addToCartAndUpdateBadge = function(productName, productPrice, productId, productImage) {
            console.log('üöÄ Enhanced addToCart called - using Firebase callback system:', {productName, productPrice, productId});
            
            let callbackExecuted = false;
            
            // For logged users: Register Firebase callback
            if (window.currentUser && typeof window.registerFirebaseCallback === 'function') {
                window.registerFirebaseCallback((operation, success, data) => {
                    if (operation === 'addToCart' && success && !callbackExecuted) {
                        callbackExecuted = true;
                        console.log('üéØ Firebase addToCart completed via callback, updating badge with fresh data');
                        
                        // Now we can safely update the badge since Firebase is complete
                        setTimeout(() => {
                            updateCartBadge();
                            renderCart();
                            
                            // Also notify all other systems
                            if (typeof window.notifyCartChange === 'function') {
                                window.notifyCartChange();
                            }
                        }, 100); // Small delay to ensure cart data is fully loaded
                    }
                });
                console.log('‚úÖ Registered Firebase completion callback for addToCart');
            }
            
            // Call original addToCart function first
            if (typeof window.addToCart === 'function') {
                window.addToCart(productName, productPrice, productId, productImage);
                
                // For guest users: Update badge immediately after script.js completes
                if (!window.currentUser) {
                    console.log('üë§ Guest user: Setting up immediate badge update');
                    setTimeout(() => {
                        if (!callbackExecuted) {
                            callbackExecuted = true;
                            console.log('‚úÖ Guest user: Updating badge from script.js cart data');
                            window.updateBadgeFromAnySource();
                            renderCart();
                            
                            if (typeof window.notifyCartChange === 'function') {
                                window.notifyCartChange();
                            }
                        }
                    }, 200); // Short delay to let script.js complete
                }
            } else {
                console.error('‚ùå addToCart function not available');
            }
            
            // Safety net - fallback timeout for both logged and guest users
            setTimeout(() => {
                if (!callbackExecuted) {
                    console.log('‚ö†Ô∏è Callback not executed, using fallback update');
                    callbackExecuted = true;
                    
                    // Force reload cart and update badge
                    if (window.currentUser && typeof loadCart === 'function') {
                        loadCart().then(() => {
                            console.log('‚úÖ Fallback: Cart reloaded for logged user');
                            updateCartBadge();
                            renderCart();
                            if (typeof window.notifyCartChange === 'function') {
                                window.notifyCartChange();
                            }
                        });
                    } else {
                        // For guest users
                        console.log('‚úÖ Fallback: Updating badge for guest user');
                        window.updateBadgeFromAnySource();
                        renderCart();
                        if (typeof window.notifyCartChange === 'function') {
                            window.notifyCartChange();
                        }
                    }
                }
            }, 1000); // 1 second fallback timeout
        };
        
        // Make functions globally available
        window.updateCartBadge = updateCartBadge;
        window.forceUpdateCartUI = forceUpdateCartUI;
        window.notifyCartChange = notifyCartChange;
        
        // Test functions for debugging
        window.testCartCount = function() {
            console.log('üß™ Testing cart count...');
            console.log('Current cart:', window.cart);
            
            // Simulate cart with items
            window.cart = [{quantity: 2}, {quantity: 1}];
            console.log('Updated cart:', window.cart);
            
            updateCartBadge();
            console.log('‚úÖ Cart count test completed');
        };
        
        // Test cart button functionality
        window.testCartButtons = function() {
            console.log('üß™ Testing cart buttons...');
            const decreaseBtns = document.querySelectorAll('.decrease-qty');
            const increaseBtns = document.querySelectorAll('.increase-qty');
            const removeBtns = document.querySelectorAll('.remove-item');
            
            console.log('Found buttons:', {
                decrease: decreaseBtns.length,
                increase: increaseBtns.length,
                remove: removeBtns.length
            });
            
            // Test click on first increase button if it exists
            if (increaseBtns.length > 0) {
                console.log('üîº Simulating click on first increase button...');
                increaseBtns[0].click();
            }
        };
        
        // Removed testAddToCart function - use script.js addToCart instead
        
        // Toggle cart sidebar
        window.toggleCart = function() {
            console.log('üõí toggleCart called');
            
            const cartSidebar = document.getElementById('cartSidebar');
            const cartOverlay = document.getElementById('cartOverlay');
            
            console.log('üõí Cart elements found:', {
                sidebar: !!cartSidebar,
                overlay: !!cartOverlay,
                sidebarElement: cartSidebar,
                overlayElement: cartOverlay
            });
            
            if (cartSidebar && cartOverlay) {
                const isActive = cartSidebar.classList.contains('active');
                console.log('üõí Current cart state:', { isActive });
                
                if (isActive) {
                    cartSidebar.classList.remove('active');
                    cartOverlay.classList.remove('active');
                    console.log('‚úÖ Cart closed');
                } else {
                    cartSidebar.classList.add('active');
                    cartOverlay.classList.add('active');
                    
                    // Sync cart from database when opening cart
                    if (window.currentUser) {
                        console.log('üîÑ Syncing cart from database before opening...');
                        syncCartFromDatabase();
                    } else {
                        console.log('üì≠ No user logged in, loading local cart');
                        loadCart(); // Fallback to local loading for non-logged users
                    }
                    
                    console.log('‚úÖ Cart opened - classes added');
                    
                    // Extra debug - check actual styles
                    setTimeout(() => {
                        const sidebarStyles = window.getComputedStyle(cartSidebar);
                        console.log('üé® Cart sidebar computed styles:', {
                            right: sidebarStyles.right,
                            display: sidebarStyles.display,
                            visibility: sidebarStyles.visibility,
                            zIndex: sidebarStyles.zIndex
                        });
                    }, 100);
                }
            } else {
                console.error('‚ùå Cart elements not found!');
                if (!cartSidebar) console.error('‚ùå cartSidebar not found');
                if (!cartOverlay) console.error('‚ùå cartOverlay not found');
            }
        };
        
        // Hook into checkout modal opening to load coupons
        function hookCheckoutModal() {
            console.log('  Setting up checkout modal hooks...');
            
            // Method 1: Override the original proceedToCheckout
            const originalProceedToCheckout = window.proceedToCheckout;
            window.proceedToCheckout = function() {
                console.log('üõí Shop: Enhanced proceedToCheckout called');
                console.log('üîç originalProceedToCheckout exists:', !!originalProceedToCheckout);
                console.log('üîç Modal element exists:', !!document.getElementById('checkoutModal'));
                
                // Call the original function first
                if (originalProceedToCheckout) {
                    console.log('‚úÖ Calling original proceedToCheckout');
                    originalProceedToCheckout();
                } else {
                    console.log('‚ö†Ô∏è Original proceedToCheckout not found, using fallback');
                    // Fallback: Open modal directly and handle the complete checkout process
                    const checkoutModal = document.getElementById('checkoutModal');
                    if (checkoutModal) {
                        // Check if cart has items
                        if (cart.length === 0) {
                            alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!');
                            return;
                        }
                        
                        checkoutModal.style.display = 'flex';
                        document.body.style.overflow = 'hidden'; // Prevent background scrolling
                        console.log('‚úÖ Opened checkout modal via fallback');
                        
                        // Update order summary
                        updateOrderSummaryInModal();
                        
                        // Fill user information if logged in
                        if (typeof fillUserInformationIfLoggedIn === 'function') {
                            fillUserInformationIfLoggedIn();
                        } else if (window.currentUser) {
                            console.log('‚ö†Ô∏è fillUserInformationIfLoggedIn not found, using basic fill');
                            // Basic user info fill
                            const customerName = document.getElementById('customerName');
                            const customerEmail = document.getElementById('customerEmail');
                            const customerPhone = document.getElementById('customerPhone');
                            
                            if (customerName && window.currentUser.name) {
                                customerName.value = window.currentUser.name;
                                customerName.disabled = true;
                                customerName.style.backgroundColor = '#f8f9fa';
                                customerName.style.color = '#6c757d';
                            }
                            if (customerEmail && window.currentUser.email) {
                                customerEmail.value = window.currentUser.email;
                                customerEmail.disabled = true;
                                customerEmail.style.backgroundColor = '#f8f9fa';
                                customerEmail.style.color = '#6c757d';
                            }
                            if (customerPhone && window.currentUser.phone) {
                                customerPhone.value = window.currentUser.phone;
                                customerPhone.disabled = true;
                                customerPhone.style.backgroundColor = '#f8f9fa';
                                customerPhone.style.color = '#6c757d';
                            }
                        }
                    } else {
                        console.error('‚ùå Checkout modal not found!');
                        return;
                    }
                }
                
                // Then load coupons after a small delay to ensure modal is open
                setTimeout(() => {
                    console.log('üìß Shop: Loading available coupons...');
                    loadAvailableCoupons();
                }, 100);
            };
            
            // Method 2: Watch for modal visibility changes
            const checkoutModal = document.getElementById('checkoutModal');
            if (checkoutModal) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            const isVisible = checkoutModal.style.display === 'flex' || 
                                            checkoutModal.classList.contains('active');
                            if (isVisible) {
                                console.log('üëÄ Checkout modal opened, loading coupons...');
                                loadAvailableCoupons();
                            }
                        }
                    });
                });
                
                observer.observe(checkoutModal, { attributes: true });
                console.log('üëÅÔ∏è Modal observer set up');
                
                // Method 3: Add event listener to email field for guest checkout
                const customerEmailField = document.getElementById('customerEmail');
                if (customerEmailField) {
                    // Debounce function to avoid too many requests
                    let emailTimeout;
                    
                    // Email validation helper function
                    function isValidEmail(email) {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        return email && emailRegex.test(email);
                    }
                    
                    customerEmailField.addEventListener('input', function() {
                        clearTimeout(emailTimeout);
                        
                        emailTimeout = setTimeout(() => {
                            const email = this.value.trim();
                            console.log('üìß Email field changed:', email);
                            
                            // Only reload coupons if modal is open and email is valid
                            const modalVisible = checkoutModal.style.display === 'flex' || 
                                               checkoutModal.classList.contains('active');
                            
                            if (modalVisible && email && isValidEmail(email)) {
                                console.log('üîÑ Reloading coupons for valid email:', email);
                                loadAvailableCoupons();
                            }
                        }, 800); // Wait 800ms after user stops typing
                    });
                    
                    console.log('üìß Email field event listener added');
                }
            }
        }

        // Initialize checkout modal hooks and cart callbacks when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè™ Index page DOM loaded, setting up cart system and coupon integration...');
            
            // Register cart update callbacks with script.js system
            if (typeof window.registerCartChangeCallback === 'function') {
                console.log('üîó Registering cart change callbacks...');
                
                // Register callback to update local cart UI
                window.registerCartChangeCallback(() => {
                    console.log('üìû Cart change callback triggered - updating local UI');
                    updateCartBadge();
                    renderCart();
                });
                
                console.log('‚úÖ Cart change callbacks registered');
            }
            
            // Wait longer for script.js to load, with multiple checks
            let checkCount = 0;
            const maxChecks = 10;
            
            const checkAndHook = () => {
                checkCount++;
                console.log(`üîÑ Checking for script.js (attempt ${checkCount}/${maxChecks})`);
                
                if (window.scriptJsLoaded || typeof window.proceedToCheckout === 'function') {
                    console.log('‚úÖ script.js detected, setting up checkout hooks');
                    hookCheckoutModal();
                    
                    // Register cart callbacks with script.js if available
                    if (typeof window.updateCartUI === 'function' && typeof window.registerCartChangeCallback === 'function') {
                        console.log('üîó Registering script.js cart update callback');
                        window.registerCartChangeCallback(() => {
                            console.log('üìû Triggering script.js updateCartUI');
                            window.updateCartUI();
                        });
                    }
                    
                } else if (checkCount < maxChecks) {
                    console.log('‚è≥ script.js not ready yet, retrying...');
                    setTimeout(checkAndHook, 500);
                } else {
                    console.log('‚ö†Ô∏è script.js still not detected after max attempts, setting up anyway');
                    hookCheckoutModal();
                }
            };
            
            checkAndHook();
            
            // Set up periodic cart badge sync ONLY for logged users (guests use event-driven updates)
            setInterval(() => {
                if (typeof window.updateBadgeFromAnySource === 'function' && window.currentUser) {
                    window.updateBadgeFromAnySource();
                }
            }, 5000); // Check every 5 seconds for logged users only
            
            console.log('‚úÖ Periodic cart badge sync enabled');
        });
        
        // Update order summary in checkout modal (fallback function)
        function updateOrderSummaryInModal() {
            console.log('üìä Updating order summary in modal...');
            
            const orderSummaryItems = document.getElementById('orderSummaryItems');
            const subtotalAmount = document.getElementById('subtotalAmount');
            const finalTotal = document.getElementById('finalTotal');
            
            if (!orderSummaryItems) {
                console.log('‚ö†Ô∏è Order summary elements not found');
                return;
            }
            
            // Clear existing items
            orderSummaryItems.innerHTML = '';
            
            // Add cart items
            let subtotal = 0;
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'order-item';
                
                const itemName = item.name || item.productName || 'Unknown Product';
                const itemQuantity = item.quantity || 1;
                const itemPrice = parseFloat(item.price) || parseFloat(item.numericPrice) || 0;
                const itemTotal = itemPrice * itemQuantity;
                subtotal += itemTotal;
                
                itemElement.innerHTML = `
                    <span class="order-item-name">${itemName} x${itemQuantity}</span>
                    <span class="order-item-price">${new Intl.NumberFormat('vi-VN').format(itemTotal)} VNƒê</span>
                `;
                orderSummaryItems.appendChild(itemElement);
            });
            
            // Update totals
            const shipping = subtotal > 0 ? 50000 : 0;
            const total = subtotal + shipping;
            
            if (subtotalAmount) {
                subtotalAmount.textContent = new Intl.NumberFormat('vi-VN').format(subtotal) + ' VNƒê';
            }
            if (finalTotal) {
                finalTotal.textContent = new Intl.NumberFormat('vi-VN').format(total) + ' VNƒê';
            }
            
            console.log(`‚úÖ Order summary updated: ${cart.length} items, subtotal: ${subtotal}`);
        }
        
        // Populate order summary in checkout modal
        function populateOrderSummary() {
            const orderSummaryItems = document.getElementById('orderSummaryItems');
            
            if (!orderSummaryItems) return;
            
            let html = '';
            cart.forEach(item => {
                html += `
                    <div class="order-item">
                        <span>${item.productName} √ó ${item.quantity}</span>
                        <span>${formatPrice(item.total)}</span>
                    </div>
                `;
            });
            
            orderSummaryItems.innerHTML = html;
        }
        
        // Close checkout modal
        window.closeCheckoutModal = function() {
            const checkoutModal = document.getElementById('checkoutModal');
            if (checkoutModal) {
                checkoutModal.style.display = 'none';
            }
        };
        
        // Complete order with VNPay support
        window.completeOrder = async function() {
            console.log('üõí Completing order from index.ejs...');
            
            if (cart.length === 0) {
                showNotification('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng', 'warning');
                return;
            }
            
            // For guest users (not logged in), check if we have required info
            if (!window.currentUser) {
                // Get customer info from checkout form
                const customerName = document.getElementById('customerName')?.value;
                const customerPhone = document.getElementById('customerPhone')?.value;
                const customerEmail = document.getElementById('customerEmail')?.value;
                
                if (!customerName || !customerPhone || !customerEmail) {
                    showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng', 'warning');
                    return;
                }
            }

            // Get payment method
            const paymentMethodEl = document.querySelector('input[name="paymentMethod"]:checked');
            const paymentMethod = paymentMethodEl ? paymentMethodEl.value : 'cod';
            
            console.log('üí≥ Selected payment method:', paymentMethod);
            
            // Check if payment method is VNPay
            if (paymentMethod === 'vnpay') {
                console.log('üí≥ Processing VNPay payment');
                
                // For guest users, verify OTP before proceeding
                if (!window.currentUser) {
                    const customerEmail = document.getElementById('customerEmail')?.value;
                    if (!customerEmail) {
                        showNotification('Vui l√≤ng nh·∫≠p email ƒë·ªÉ s·ª≠ d·ª•ng VNPay', 'warning');
                        return;
                    }
                    
                    // Check if OTP has been verified for this email
                    try {
                        const otpResponse = await fetch(`/api/guest-checkout/otp-status/${encodeURIComponent(customerEmail)}`);
                        const otpResult = await otpResponse.json();
                        
                        if (!otpResult.success || !otpResult.verified) {
                            showNotification('Vui l√≤ng x√°c th·ª±c OTP tr∆∞·ªõc khi s·ª≠ d·ª•ng VNPay. Nh·∫•n "X√°c th·ª±c OTP" ƒë·ªÉ ti·∫øp t·ª•c.', 'warning');
                            return;
                        }
                        
                        console.log('‚úÖ Guest OTP verified, proceeding with VNPay');
                    } catch (error) {
                        console.error('‚ùå Error checking OTP status:', error);
                        showNotification('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra x√°c th·ª±c. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                        return;
                    }
                }
                
                // Calculate order totals with discount
                const subtotal = calculateCartSubtotal();
                const shippingFee = 50000;
                const finalTotal = subtotal - discountAmount + shippingFee;
                
                // Get customer info - either from logged user or form
                let customerName, customerEmail, customerPhone, customerAddress;
                
                if (window.currentUser) {
                    customerName = window.currentUser.displayName || window.currentUser.name || 'Customer';
                    customerEmail = window.currentUser.email;
                    customerPhone = window.currentUser.phoneNumber || window.currentUser.phone || '';
                    customerAddress = 'Shop checkout';
                } else {
                    customerName = document.getElementById('customerName')?.value || 'Guest Customer';
                    customerEmail = document.getElementById('customerEmail')?.value;
                    customerPhone = document.getElementById('customerPhone')?.value || '';
                    customerAddress = document.getElementById('customerAddress')?.value || 'Guest address';
                }
                
                const orderInfo = `Thanh toan don hang Tech Haven - ${customerName}`;
                
                const paymentData = {
                    amount: finalTotal,
                    orderInfo: orderInfo,
                    orderType: 'billpayment',
                    userId: window.currentUser ? window.currentUser.uid : null,
                    isGuest: !window.currentUser,
                    cartData: cart.map(item => ({
                        productId: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity || 1,
                        image: item.image || item.imageUrl
                    })),
                    customerInfo: {
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress,
                        city: 'N/A',
                        district: 'N/A'
                    },
                    discountCode: appliedDiscountCode ? appliedDiscountCode.code : null,
                    discountAmount: discountAmount
                };
                
                try {
                    console.log('üîÑ Creating VNPay payment URL...');
                    
                    // Show loading
                    const loadingOverlay = document.createElement('div');
                    loadingOverlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10001;
                        color: white;
                        font-size: 1.2rem;
                    `;
                    loadingOverlay.innerHTML = `
                        <div style="text-align: center;">
                            <div style="width: 50px; height: 50px; border: 3px solid #fff; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                            <div>ƒêang chuy·ªÉn ƒë·∫øn VNPay...</div>
                        </div>
                    `;
                    
                    // Add spin animation
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                    document.body.appendChild(loadingOverlay);
                    
                    const response = await fetch('/api/vnpay/create-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    const result = await response.json();
                    
                    // Remove loading
                    document.body.removeChild(loadingOverlay);
                    document.head.removeChild(style);
                    
                    if (result.success) {
                        console.log('‚úÖ VNPay URL created, redirecting...');
                        // Close checkout modal before redirect
                        closeCheckoutModal();
                        // Redirect to VNPay
                        window.location.href = result.paymentUrl;
                        return;
                    } else {
                        console.error('‚ùå VNPay payment creation failed:', result);
                        showNotification('L·ªói t·∫°o thanh to√°n VNPay: ' + (result.message || 'Unknown error'), 'error');
                        return;
                    }
                } catch (error) {
                    console.error('‚ùå VNPay payment error:', error);
                    // Remove loading on error
                    const loadingOverlay = document.querySelector('[style*="rgba(0,0,0,0.8)"]');
                    if (loadingOverlay) {
                        try {
                            document.body.removeChild(loadingOverlay);
                        } catch (e) {
                            // Ignore if already removed
                        }
                    }
                    showNotification('L·ªói k·∫øt n·ªëi VNPay: ' + error.message, 'error');
                    return;
                }
            }
            
            // Continue with normal payment flow for other payment methods
            console.log('üí∞ Processing normal payment flow');
            
            try {
                // Calculate order totals with discount
                const subtotal = calculateCartSubtotal();
                const shippingFee = 50000;
                const finalTotal = subtotal - discountAmount + shippingFee;
                
                // Get customer info - either from logged user or form
                let customerName, customerEmail, customerPhone;
                
                if (window.currentUser) {
                    customerName = window.currentUser.displayName || window.currentUser.name || 'Customer';
                    customerEmail = window.currentUser.email;
                    customerPhone = window.currentUser.phoneNumber || window.currentUser.phone || '';
                } else {
                    customerName = document.getElementById('customerName')?.value || 'Guest Customer';
                    customerEmail = document.getElementById('customerEmail')?.value;
                    customerPhone = document.getElementById('customerPhone')?.value || '';
                }
                
                // Prepare order data with discount information
                const orderData = {
                    userId: window.currentUser ? window.currentUser.uid : null,
                    isGuest: !window.currentUser,
                    customerInfo: {
                        name: customerName,
                        email: customerEmail,
                        phone: customerPhone
                    },
                    items: cart,
                    subtotal: subtotal,
                    shippingFee: shippingFee,
                    discountCode: appliedDiscountCode ? appliedDiscountCode.code : null,
                    discountAmount: discountAmount,
                    finalTotal: finalTotal,
                    timestamp: new Date().toISOString()
                };
                
                console.log('üì¶ Order data:', orderData);
                
                // If user used a discount code, track it in Firebase
                if (appliedDiscountCode) {
                    console.log('üí´ Tracking coupon usage for:', appliedDiscountCode.code);
                    
                    const couponUsageResponse = await fetch('/api/coupons/use', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: appliedDiscountCode.code,
                            userId: window.currentUser ? window.currentUser.uid : null,
                            userEmail: customerEmail,
                            isGuest: !window.currentUser,
                            orderData: orderData
                        })
                    });

                    if (!couponUsageResponse.ok) {
                        const error = await couponUsageResponse.json();
                        throw new Error(error.error || 'Failed to use coupon');
                    }
                    
                    console.log('‚úÖ Coupon usage tracked successfully');
                }
                
                // Clear cart from Firebase
                const response = await fetch(`/api/cart/user/${window.currentUser.uid}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    let successMessage = 'üéâ Thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng.';
                    if (appliedDiscountCode) {
                        successMessage += ` B·∫°n ƒë√£ ti·∫øt ki·ªám ${formatPrice(discountAmount)} t·ª´ m√£ gi·∫£m gi√° ${appliedDiscountCode.code}.`;
                    }
                    
                    // Show Lottie congratulations animation for normal payment
                    console.log('üéâ Showing congratulation animation for normal payment (index.ejs)');
                    if (typeof window.showCongratulationAnimation === 'function') {
                        try {
                            showCongratulationAnimation(() => {
                                console.log('‚úÖ Normal payment congratulation animation completed (index.ejs)');
                                // Show success notification after animation
                                showNotification(successMessage, 'success');
                            });
                        } catch (error) {
                            console.error('‚ùå Error showing congratulation animation (index.ejs):', error);
                            // Fallback: show notification without animation
                            showNotification(successMessage, 'success');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è showCongratulationAnimation function not available (index.ejs), showing notification directly');
                        // Fallback: show notification without animation
                        showNotification(successMessage, 'success');
                    }
                    
                    // Reset discount code
                    removeDiscountCode();
                    
                    // Close checkout modal and cart
                    closeCheckoutModal();
                    await loadCart(); // Refresh cart
                    toggleCart(); // Close cart sidebar
                    
                    // Reload available coupons (to hide used ones)
                    setTimeout(() => {
                        loadAvailableCoupons();
                    }, 1000);
                    
                } else {
                    throw new Error('Failed to process order');
                }
                
            } catch (error) {
                console.error('‚ùå Error completing order:', error);
                showNotification(`Kh√¥ng th·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng: ${error.message}`, 'error');
            }
        };

        // Admin dropdown handler for mobile menu
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Shop page DOM loaded');
            
            // Load cart if user is already logged in (from localStorage or Firebase Auth)
            setTimeout(() => {
                if (window.currentUser) {
                    console.log('üõí User already logged in, loading cart on page load');
                    loadCart();
                }
            }, 500);
            
            // Test cart elements immediately
            setTimeout(() => {
                const cartSidebar = document.getElementById('cartSidebar');
                const cartOverlay = document.getElementById('cartOverlay');
                const cartIcon = document.getElementById('cartIcon');
                
                console.log('üß™ Testing cart elements:', {
                    cartSidebar: !!cartSidebar,
                    cartOverlay: !!cartOverlay, 
                    cartIcon: !!cartIcon,
                    cartSidebarHTML: cartSidebar ? 'Found' : 'Not found',
                    cartOverlayHTML: cartOverlay ? 'Found' : 'Not found'
                });
                
                if (cartSidebar) {
                    console.log('üé® Cart sidebar initial styles:', {
                        display: cartSidebar.style.display,
                        right: cartSidebar.style.right,
                        classes: cartSidebar.className
                    });
                }
            }, 500);
            
            // Initialize shop functionality
            initializeShop();
            
            // Setup admin dropdown
            const adminDropdown = document.querySelector('.admin-dropdown');
            const dropdownToggle = document.querySelector('.admin-dropdown .dropdown-toggle');
            
            if (dropdownToggle) {
                dropdownToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Toggle dropdown
                    adminDropdown.classList.toggle('active');
                    
                    console.log('üîß Admin dropdown toggled:', adminDropdown.classList.contains('active'));
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (adminDropdown && !adminDropdown.contains(e.target)) {
                    adminDropdown.classList.remove('active');
                }
            });
            
            // Setup cart icon click handler with delay to ensure DOM is ready
            setTimeout(() => {
                const cartIcon = document.getElementById('cartIcon');
                const mobileCartLink = document.getElementById('mobileCartLink');
                
                console.log('üîç Looking for cart elements after delay...');
                console.log('Cart icon element:', cartIcon);
                console.log('Mobile cart link element:', mobileCartLink);
                console.log('Cart icon found:', !!cartIcon);
                console.log('Mobile cart link found:', !!mobileCartLink);
                
                if (cartIcon) {
                    console.log('‚úÖ Cart icon found, adding event listener');
                    
                    // Remove any existing event listeners by cloning the element
                    const cartIconClone = cartIcon.cloneNode(true);
                    cartIcon.parentNode.replaceChild(cartIconClone, cartIcon);
                    
                    // Add fresh event listener
                    cartIconClone.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üñ±Ô∏è Cart icon clicked from delayed setup');
                        toggleCart();
                    });
                    
                    // Also add event listener to the shopping cart icon inside
                    const cartIconInner = cartIconClone.querySelector('i.fa-shopping-cart');
                    if (cartIconInner) {
                        cartIconInner.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('üñ±Ô∏è Cart icon inner clicked');
                            toggleCart();
                        });
                    }
                    
                } else {
                    console.error('‚ùå Cart icon still not found after delay');
                }
                
                if (mobileCartLink) {
                    console.log('‚úÖ Mobile cart link found, adding event listener');
                    
                    // Remove any existing event listeners by cloning
                    const mobileCartClone = mobileCartLink.cloneNode(true);
                    mobileCartLink.parentNode.replaceChild(mobileCartClone, mobileCartLink);
                    
                    // Add fresh event listener
                    mobileCartClone.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üì± Mobile cart link clicked');
                        toggleCart();
                    });
                } else {
                    console.error('‚ùå Mobile cart link not found after delay');
                }
            }, 1000); // Wait 1 second to ensure everything is loaded
            
            // Backup event delegation for cart icon clicks
            document.body.addEventListener('click', function(e) {
                // Check if clicked element is cart icon or its children
                const cartIconWrapper = e.target.closest('.cart-icon-wrapper');
                if (cartIconWrapper && cartIconWrapper.id === 'cartIcon') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üñ±Ô∏è Cart icon clicked via event delegation');
                    toggleCart();
                    return;
                }
                
                // Check if clicked element is mobile cart link
                const mobileCartLink = e.target.closest('#mobileCartLink');
                if (mobileCartLink) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üì± Mobile cart link clicked via delegation');
                    toggleCart();
                    return;
                }
                
                // Check if clicked on cart badge or cart icon specifically
                if (e.target.classList.contains('fa-shopping-cart') || 
                    e.target.id === 'cartBadge' ||
                    e.target.id === 'mobileCartCount' ||
                    e.target.closest('#cartIcon') ||
                    e.target.closest('#mobileCartLink')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üñ±Ô∏è Cart element clicked via delegation');
                    toggleCart();
                    return;
                }
            });
            
            // Setup cart overlay click to close
            const cartOverlay = document.getElementById('cartOverlay');
            if (cartOverlay) {
                cartOverlay.addEventListener('click', function() {
                    toggleCart();
                });
            }
        });

        // =====================================
        // DISCOUNT CODE FUNCTIONALITY - FIREBASE INTEGRATION
        // =====================================

        let availableCoupons = [];
        let appliedDiscountCode = null;
        let discountAmount = 0;

        // Load available coupons from Firebase
        async function loadAvailableCoupons() {
            try {
                console.log('üìß Loading available coupons from Firebase...');
                
                // Get user info from localStorage if available
                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = storedUser.uid || (window.currentUser && window.currentUser.uid);
                
                // Get email from form for guest checkout
                const customerEmailField = document.getElementById('customerEmail');
                const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                
                // Build URL with userId parameter if user is logged in
                let url = '/api/coupons/available';
                if (userId) {
                    url += `?userId=${userId}`;
                    console.log('üë§ Loading coupons for user:', userId);
                } else {
                    console.log('üë§ Loading coupons for anonymous user');
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã Response data:', data);
                    
                    if (data.success && data.coupons) {
                        console.log('üé´ Raw coupons from API:', data.coupons);
                        
                        // Get used coupons if valid email is provided for guest checkout
                        let usedCoupons = [];
                        
                        // Email validation helper function (if not already defined)
                        if (typeof isValidEmail === 'undefined') {
                            window.isValidEmail = function(email) {
                                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                return email && emailRegex.test(email);
                            };
                        }
                        
                        if (customerEmail && !userId && isValidEmail(customerEmail)) { // Only check for guest users with valid email
                            try {
                                // Normalize email to lowercase to handle case sensitivity
                                const normalizedEmail = customerEmail.toLowerCase().trim();
                                console.log('üìß Checking used coupons for email:', customerEmail, '-> normalized:', normalizedEmail);
                                const usageResponse = await fetch(`/api/coupon-usage/check-by-email?email=${encodeURIComponent(normalizedEmail)}`);
                                if (usageResponse.ok) {
                                    const usageData = await usageResponse.json();
                                    if (usageData.success) {
                                        usedCoupons = usageData.usedCoupons || [];
                                        console.log('üö´ Used coupons:', usedCoupons);
                                    }
                                }
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Error checking used coupons:', error);
                                // Continue with all coupons if check fails
                            }
                        }
                        
                        // Extract used coupon IDs for filtering
                        const usedCouponIds = usedCoupons.map(used => used.couponId);
                        
                        availableCoupons = data.coupons.filter(coupon => {
                            // Additional client-side validation
                            const now = new Date();
                            const expiredDate = coupon.expiredDate ? new Date(coupon.expiredDate) : null;
                            const isNotExpired = !expiredDate || now <= expiredDate;
                            const isActive = coupon.usedCount < coupon.usageLimit;
                            const isNotUsed = !usedCouponIds.includes(coupon.id);
                            
                            console.log(`üé´ Coupon ${coupon.code}: active=${isActive}, notExpired=${isNotExpired}, notUsed=${isNotUsed}`);
                            return isActive && isNotExpired && isNotUsed;
                        });
                        
                        console.log('‚úÖ Filtered coupons:', availableCoupons);
                        console.log('üé® Calling renderDiscountCodes...');
                        renderDiscountCodes();
                    } else {
                        console.warn('‚ö†Ô∏è No coupons found or API error:', data);
                        availableCoupons = [];
                        renderDiscountCodes();
                    }
                } else {
                    const errorData = await response.text();
                    console.error('‚ùå Failed to load coupons. Status:', response.status);
                    console.error('‚ùå Error details:', errorData);
                    
                    // Show error in UI
                    const discountCodesContainer = document.getElementById('discountCodesContainer');
                    if (discountCodesContainer) {
                        discountCodesContainer.innerHTML = `
                            <div class="coupon-error">
                                <p><i class="fas fa-exclamation-triangle"></i> Kh√¥ng th·ªÉ t·∫£i m√£ gi·∫£m gi√°</p>
                                <button onclick="loadAvailableCoupons()" class="retry-btn">
                                    <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                                </button>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading coupons:', error);
                availableCoupons = [];
                renderDiscountCodes();
                
                // Show error in UI
                const discountCodesContainer = document.getElementById('discountCodesContainer');
                if (discountCodesContainer) {
                    discountCodesContainer.innerHTML = `
                        <div class="coupon-error">
                            <p><i class="fas fa-exclamation-triangle"></i> L·ªói khi t·∫£i m√£ gi·∫£m gi√°</p>
                            <button onclick="loadAvailableCoupons()" class="retry-btn">
                                <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Render discount codes from database
        function renderDiscountCodes() {
            console.log('üé® renderDiscountCodes called with', availableCoupons.length, 'coupons');
            
            const discountCodesList = document.getElementById('discountCodesList');
            if (!discountCodesList) {
                console.error('‚ùå discountCodesList element not found');
                return;
            }

            console.log('üìã discountCodesList element found:', discountCodesList);

            if (availableCoupons.length === 0) {
                console.log('üö´ No coupons available, showing empty message');
                
                // Check if user email is provided (for different messaging)
                const customerEmailField = document.getElementById('customerEmail');
                const customerEmail = customerEmailField ? customerEmailField.value.trim() : '';
                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                const isLoggedIn = storedUser.uid || (window.currentUser && window.currentUser.uid);
                
                let message = 'Hi·ªán t·∫°i kh√¥ng c√≥ m√£ gi·∫£m gi√° kh·∫£ d·ª•ng';
                if (!isLoggedIn && customerEmail && isValidEmail(customerEmail)) {
                    message = 'T·∫•t c·∫£ m√£ gi·∫£m gi√° kh·∫£ d·ª•ng ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng v·ªõi email n√†y';
                }
                
                discountCodesList.innerHTML = `
                    <div class="no-coupons-message" style="text-align: center; padding: 20px; color: #6b7280;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        <p>${message}</p>
                    </div>
                `;
                return;
            }

            console.log('‚ú® Rendering', availableCoupons.length, 'coupons...');

            const couponsHTML = availableCoupons.map(coupon => {
                const discountDisplay = formatDiscount(coupon.discountAmount);
                const expirationInfo = coupon.expiredDate 
                    ? `H·∫øt h·∫°n: ${new Date(coupon.expiredDate).toLocaleDateString('vi-VN')}`
                    : 'Kh√¥ng th·ªùi h·∫°n';
                
                return `
                    <div class="discount-code-item" onclick="selectDiscountCode('${coupon.code}', ${coupon.discountAmount}, '${coupon.id}')">
                        <div class="discount-code-info">
                            <div class="discount-code-title">
                                <i class="fas fa-tag"></i>
                                <strong>${coupon.code}</strong>
                                <span class="discount-badge">${discountDisplay}</span>
                            </div>
                            <div class="discount-code-desc">${coupon.description || 'M√£ gi·∫£m gi√°'}</div>
                            <div class="discount-code-details" style="font-size: 0.9em; color: #6b7280; margin-top: 5px;">
                                <span class="discount-code-id">C√≤n l·∫°i: ${coupon.usageLimit - coupon.usedCount}</span>
                                <span class="discount-expiration" style="margin-left: 10px;">${expirationInfo}</span>
                            </div>
                        </div>
                        <button type="button" class="select-discount-btn" onclick="event.stopPropagation(); selectDiscountCode('${coupon.code}', ${coupon.discountAmount}, '${coupon.id}')">
                            Ch·ªçn
                        </button>
                    </div>
                `;
            }).join('');

            console.log('üîÑ Setting innerHTML with HTML length:', couponsHTML.length);
            discountCodesList.innerHTML = couponsHTML;
            console.log('‚úÖ Coupons rendered successfully');
        }

        // Format discount for display
        function formatDiscount(amount) {
            if (amount >= 1000000) {
                return `-${Math.round(amount/1000000)}M`;
            } else if (amount >= 1000) {
                return `-${Math.round(amount/1000)}K`;
            } else {
                return `-${formatPrice(amount)}`;
            }
        }

        // Validate coupon
        function validateCoupon(coupon) {
            const now = new Date();
            
            // Check if expired
            if (coupon.expiredDate && now > new Date(coupon.expiredDate)) {
                return { valid: false, message: 'M√£ gi·∫£m gi√° ƒë√£ h·∫øt h·∫°n' };
            }
            
            // Check if used up
            if (coupon.usedCount >= coupon.usageLimit) {
                return { valid: false, message: 'M√£ gi·∫£m gi√° ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng' };
            }
            
            return { valid: true, message: 'M√£ h·ª£p l·ªá' };
        }

        // Select discount code from available coupons
        window.selectDiscountCode = function(couponCode, discountValue, couponId) {
            console.log('üé´ Selecting discount code:', couponCode, 'Value:', discountValue, 'ID:', couponId);
            
            // Find the coupon in available coupons to validate it
            const coupon = availableCoupons.find(c => c.id === couponId || c.code === couponCode);
            if (coupon) {
                const validation = validateCoupon(coupon);
                if (!validation.valid) {
                    showNotification(validation.message, 'error');
                    return;
                }
            }
            
            // Apply the discount
            appliedDiscountCode = {
                id: couponId,
                code: couponCode,
                value: discountValue,
                type: 'fixed', // Assuming fixed amount for now
                description: `M√£ gi·∫£m gi√° ${couponCode}`
            };

            // Store for order completion tracking
            window.currentAppliedCoupon = {
                id: couponId,
                code: couponCode,
                discountAmount: discountValue
            };
            
            // Calculate and apply discount
            calculateDiscount();
            showAppliedDiscount();
            updateOrderSummaryWithDiscount();
            
            // Hide discount codes section (close modal/collapse)
            hideDiscountCodes();
            
            showNotification(`ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√° ${couponCode}`, 'success');
        };

        // Format datetime helper
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Apply manual discount code (updated for Firebase validation)
        window.applyManualDiscountCode = async function() {
            const input = document.getElementById('manualDiscountCode');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                showNotification('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!', 'warning');
                return;
            }

            console.log('üîç Validating manual discount code:', code);

            // Check if user is logged in
            const currentUser = window.currentUser;
            if (!currentUser || !currentUser.uid) {
                showNotification('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng m√£ gi·∫£m gi√°!', 'warning');
                input.value = '';
                return;
            }

            try {
                // First check if user has already used this coupon
                console.log('üîç Checking if user already used coupon:', code);
                const usageCheckResponse = await fetch(`/api/coupon-usage/check?userId=${currentUser.uid}&couponCode=${code}`);
                const usageCheckData = await usageCheckResponse.json();
                
                if (usageCheckResponse.ok && usageCheckData.hasUsed) {
                    showNotification('B·∫°n ƒë√£ s·ª≠ d·ª•ng m√£ gi·∫£m gi√° n√†y r·ªìi!', 'error');
                    input.value = '';
                    return;
                }

                // First check in loaded coupons
                const coupon = availableCoupons.find(c => c.code === code);
                if (coupon) {
                    // Validate the coupon
                    const validation = validateCoupon(coupon);
                    if (!validation.valid) {
                        showNotification(validation.message, 'error');
                        input.value = '';
                        return;
                    }
                    
                    selectDiscountCode(coupon.code, coupon.discountAmount, coupon.id);
                    input.value = '';
                    return;
                }

                // If not found in loaded coupons, validate with API
                const response = await fetch('/api/coupons/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        cartTotal: calculateCartSubtotal()
                    })
                });

                const data = await response.json();

                if (response.ok && data.success && data.coupon) {
                    const validatedCoupon = data.coupon;
                    
                    appliedDiscountCode = {
                        id: validatedCoupon.id,
                        code: validatedCoupon.code,
                        value: validatedCoupon.discountAmount,
                        type: 'fixed',
                        description: validatedCoupon.description
                    };

                    // Store for order completion tracking
                    window.currentAppliedCoupon = {
                        id: validatedCoupon.id,
                        code: validatedCoupon.code,
                        discountAmount: validatedCoupon.discountAmount
                    };
                    
                    calculateDiscount();
                    showAppliedDiscount();
                    updateOrderSummaryWithDiscount();
                    input.value = '';
                    showNotification(`ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√° ${code}`, 'success');
                } else {
                    showNotification(data.message || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n', 'error');
                    input.value = '';
                }
            } catch (error) {
                console.error('‚ùå Error validating coupon:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra m√£ gi·∫£m gi√°', 'error');
                input.value = '';
            }
        };

        // Remove discount code
        window.removeDiscountCode = function() {
            console.log('üóëÔ∏è Removing discount code');
            
            appliedDiscountCode = null;
            discountAmount = 0;

            // Clear tracking for order completion
            window.currentAppliedCoupon = null;
            
            // Hide applied discount display
            const appliedDiscountEl = document.getElementById('appliedDiscount');
            if (appliedDiscountEl) {
                appliedDiscountEl.style.display = 'none';
            }
            
            // Update order summary
            updateOrderSummaryWithDiscount();
            
            showNotification('ƒê√£ h·ªßy m√£ gi·∫£m gi√°', 'info');
        };

        // Calculate discount amount
        function calculateDiscount() {
            if (!appliedDiscountCode) {
                discountAmount = 0;
                return;
            }
            
            // Use script.js calculateCartTotal() if available, fallback to local calculation
            let subtotal = 0;
            if (window.calculateCartTotal && typeof window.calculateCartTotal === 'function') {
                subtotal = window.calculateCartTotal();
                console.log('üí∞ Using script.js calculateCartTotal:', subtotal);
            } else {
                subtotal = calculateCartSubtotal();
                console.log('üí∞ Fallback to calculateCartSubtotal:', subtotal);
            }
            
            if (appliedDiscountCode.type === 'percentage') {
                discountAmount = Math.floor(subtotal * appliedDiscountCode.value / 100);
            } else {
                discountAmount = appliedDiscountCode.value;
            }
            
            // Ensure discount doesn't exceed subtotal
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            console.log('üí∞ Calculated discount:', discountAmount, 'from subtotal:', subtotal);
        }

        // Show applied discount
        function showAppliedDiscount() {
            const appliedDiscountEl = document.getElementById('appliedDiscount');
            const appliedDiscountText = document.getElementById('appliedDiscountText');
            
            if (appliedDiscountEl && appliedDiscountText && appliedDiscountCode) {
                let discountDisplay = '';
                if (appliedDiscountCode.type === 'percentage') {
                    discountDisplay = `-${appliedDiscountCode.value}%`;
                } else {
                    discountDisplay = `-${formatPrice(appliedDiscountCode.value)}`;
                }
                
                appliedDiscountText.textContent = `ƒê√£ √°p d·ª•ng m√£: ${appliedDiscountCode.code} (${discountDisplay})`;
                appliedDiscountEl.style.display = 'flex';
            }
        }

        // Hide discount codes section
        function hideDiscountCodes() {
            const discountCodesSection = document.getElementById('discountCodes');
            if (discountCodesSection) {
                discountCodesSection.style.display = 'none';
            }
            
            // Also collapse if it's in a collapsible section
            const collapseElement = discountCodesSection?.closest('.collapse');
            if (collapseElement && collapseElement.classList.contains('show')) {
                // If using Bootstrap collapse, hide it
                const bsCollapse = bootstrap?.Collapse?.getInstance(collapseElement);
                if (bsCollapse) {
                    bsCollapse.hide();
                }
            }
        }

        // Calculate cart subtotal (with Firebase cart support)
        function calculateCartSubtotal() {
            console.log('üîç calculateCartSubtotal called');
            
            // Use window.cartItems (synced from Firebase) if available, fallback to localStorage
            let cartItems = [];
            
            if (window.cartItems && Array.isArray(window.cartItems) && window.cartItems.length > 0) {
                cartItems = window.cartItems;
                console.log('üì¶ Using window.cartItems (Firebase data):', cartItems.length, 'items');
            } else if (window.cart && Array.isArray(window.cart) && window.cart.length > 0) {
                cartItems = window.cart;
                console.log('üì¶ Using window.cart (shop.ejs data):', cartItems.length, 'items');
            } else {
                cartItems = JSON.parse(localStorage.getItem('techHavenCart')) || [];
                console.log('üì¶ Fallback to localStorage:', cartItems.length, 'items');
            }
            
            let subtotal = 0;
            
            cartItems.forEach(item => {
                let price = 0;
                
                // Handle different price field names from different sources
                if (item.numericPrice && typeof item.numericPrice === 'number') {
                    price = item.numericPrice;
                } else if (item.productPrice && typeof item.productPrice === 'number') {
                    price = item.productPrice;
                } else if (item.price && typeof item.price === 'number') {
                    price = item.price;
                } else if (item.price && typeof item.price === 'string') {
                    price = parseFloat(item.price.toString().replace(/[^\d]/g, '')) || 0;
                } else if (item.productPrice && typeof item.productPrice === 'string') {
                    price = parseFloat(item.productPrice.toString().replace(/[^\d]/g, '')) || 0;
                } else {
                    console.warn('‚ùå No valid price found for item:', item);
                    price = 0;
                }
                
                const quantity = item.quantity || 1;
                const itemTotal = price * quantity;
                subtotal += itemTotal;
                
                console.log(`üí∞ calculateCartSubtotal - Item: ${item.name}, Price: ${price}, Quantity: ${quantity}, Total: ${itemTotal}`);
            });
            
            console.log('üí∞ calculateCartSubtotal result:', subtotal);
            return subtotal;
        }

        // Update order summary with discount
        function updateOrderSummaryWithDiscount() {
            // Use script.js calculateCartTotal() if available, fallback to local calculation
            let subtotal = 0;
            if (window.calculateCartTotal && typeof window.calculateCartTotal === 'function') {
                subtotal = window.calculateCartTotal();
                console.log('üí∞ updateOrderSummaryWithDiscount using script.js calculateCartTotal:', subtotal);
            } else {
                subtotal = calculateCartSubtotal();
                console.log('üí∞ updateOrderSummaryWithDiscount fallback to calculateCartSubtotal:', subtotal);
            }
            
            const shippingFee = 50000;
            
            // Calculate discount if applied
            if (appliedDiscountCode) {
                calculateDiscount();
            }
            
            const finalTotal = subtotal - discountAmount + shippingFee;
            
            // Update UI - only update what's needed for discount
            const subtotalEl = document.getElementById('subtotalAmount');
            const discountLineEl = document.getElementById('discountLine');
            const discountAmountEl = document.getElementById('discountAmount');
            const finalTotalEl = document.getElementById('finalTotal');
            
            // Always update subtotal to ensure it's correct
            if (subtotalEl) {
                subtotalEl.textContent = formatPrice(subtotal) + ' VNƒê';
                console.log('‚úÖ Updated subtotal in discount function:', formatPrice(subtotal));
            }
            
            // Update discount line
            if (discountLineEl && discountAmountEl) {
                if (discountAmount > 0) {
                    discountLineEl.style.display = 'flex';
                    discountAmountEl.textContent = '-' + formatPrice(discountAmount) + ' VNƒê';
                    console.log('‚úÖ Showing discount:', formatPrice(discountAmount));
                } else {
                    discountLineEl.style.display = 'none';
                    console.log('‚úÖ Hiding discount line');
                }
            }
            
            // Update final total
            if (finalTotalEl) {
                finalTotalEl.textContent = formatPrice(finalTotal) + ' VNƒê';
                console.log('‚úÖ Updated final total:', formatPrice(finalTotal));
            }
        }

        // Don't override updateOrderSummary - just update discount when needed
        // updateOrderSummaryWithDiscount will be called when discount is applied/removed

        // Apply discount code when Enter key is pressed
        document.addEventListener('keydown', function(e) {
            if (e.target.id === 'manualDiscountCode' && e.key === 'Enter') {
                e.preventDefault();
                applyManualDiscountCode();
            }
        });

        // =====================================
        // OTP VERIFICATION FUNCTIONS
        // =====================================

        let otpTimer = null;
        let otpTimeLeft = 600; // 10 minutes in seconds
        
        // Show OTP modal for guest checkout
        window.showOtpModal = function(email = '') {
            const modal = document.getElementById('otpModal');
            const emailInput = document.getElementById('otpEmail');
            
            if (email && emailInput) {
                emailInput.value = email;
            }
            
            // Reset to step 1
            showOtpStep1();
            
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }
        };

        // Close OTP modal
        window.closeOtpModal = function() {
            const modal = document.getElementById('otpModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
            }
            
            // Clear timer
            if (otpTimer) {
                clearInterval(otpTimer);
                otpTimer = null;
            }
            
            // Reset form
            resetOtpForm();
        };

        // Show step 1 (email input)
        function showOtpStep1() {
            document.getElementById('otpStep1').style.display = 'block';
            document.getElementById('otpStep2').style.display = 'none';
        }

        // Show step 2 (OTP input)
        function showOtpStep2(email) {
            document.getElementById('otpStep1').style.display = 'none';
            document.getElementById('otpStep2').style.display = 'block';
            document.getElementById('otpEmailDisplay').textContent = email;
            
            // Start countdown timer
            startOtpTimer();
        }

        // Back to step 1
        window.backToOtpStep1 = function() {
            showOtpStep1();
            if (otpTimer) {
                clearInterval(otpTimer);
                otpTimer = null;
            }
        };

        // Send OTP code
        window.sendOtpCode = async function() {
            const emailInput = document.getElementById('otpEmail');
            const sendBtn = document.getElementById('sendOtpBtn');
            
            if (!emailInput.value) {
                alert('Vui l√≤ng nh·∫≠p email');
                return;
            }

            // Get customer name from checkout form if available
            const customerNameEl = document.getElementById('customerName');
            const customerName = customerNameEl ? customerNameEl.value : '';

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang g·ª≠i...';

            try {
                const response = await fetch('/api/guest-checkout/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: emailInput.value,
                        customerName: customerName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showOtpStep2(emailInput.value);
                    
                    if (typeof showNotification === 'function') {
                        showNotification('M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞!', 'success');
                    } else {
                        alert('M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!');
                    }
                } else {
                    alert(result.error || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i OTP');
                }
            } catch (error) {
                console.error('Error sending OTP:', error);
                alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i OTP');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> G·ª≠i M√£ OTP';
            }
        };

        // Verify OTP code
        window.verifyOtpCode = async function() {
            const emailInput = document.getElementById('otpEmail');
            const otpInput = document.getElementById('otpCode');
            const verifyBtn = document.getElementById('verifyOtpBtn');

            if (!otpInput.value || otpInput.value.length !== 6) {
                alert('Vui l√≤ng nh·∫≠p m√£ OTP 6 s·ªë');
                return;
            }

            // Get customer info from checkout form
            const customerNameEl = document.getElementById('customerName');
            const customerPhoneEl = document.getElementById('customerPhone');

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√°c th·ª±c...';

            try {
                const response = await fetch('/api/guest-checkout/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: emailInput.value,
                        otp: otpInput.value,
                        customerName: customerNameEl ? customerNameEl.value : '',
                        customerPhone: customerPhoneEl ? customerPhoneEl.value : ''
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Store OTP verification result globally with timestamp
                    window.otpVerificationResult = {
                        ...result,
                        verifiedAt: Date.now(),
                        validUntil: Date.now() + (30 * 60 * 1000) // Valid for 30 minutes
                    };
                    
                    // Close OTP modal
                    closeOtpModal();
                    
                    // Show success message
                    if (typeof showNotification === 'function') {
                        showNotification('Email ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c th√†nh c√¥ng!', 'success');
                    } else {
                        alert('Email ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c th√†nh c√¥ng!');
                    }
                    
                    // If user was created, show welcome message
                    if (result.isNewUser) {
                        if (typeof showNotification === 'function') {
                            showNotification('T√†i kho·∫£n m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o! B·∫°n c√≥ th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u sau khi ho√†n t·∫•t ƒë∆°n h√†ng.', 'info');
                        } else {
                            alert('T√†i kho·∫£n m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o! B·∫°n c√≥ th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u sau khi ho√†n t·∫•t ƒë∆°n h√†ng.');
                        }
                    }
                    
                    // Proceed with checkout
                    if (typeof completeOrder === 'function') {
                        completeOrder();
                    }
                } else {
                    alert(result.error || 'M√£ OTP kh√¥ng ch√≠nh x√°c');
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x√°c th·ª±c OTP');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check"></i> X√°c Th·ª±c';
            }
        };

        // Resend OTP code
        window.resendOtpCode = async function() {
            const emailInput = document.getElementById('otpEmail');
            const resendBtn = document.getElementById('resendOtpBtn');

            resendBtn.disabled = true;
            resendBtn.textContent = 'ƒêang g·ª≠i l·∫°i...';

            try {
                const response = await fetch('/api/guest-checkout/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: emailInput.value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reset timer
                    otpTimeLeft = 600;
                    startOtpTimer();
                    
                    if (typeof showNotification === 'function') {
                        showNotification('M√£ OTP m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!', 'success');
                    } else {
                        alert('M√£ OTP m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!');
                    }
                } else {
                    alert(result.error || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i l·∫°i OTP');
                }
            } catch (error) {
                console.error('Error resending OTP:', error);
                alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i l·∫°i OTP');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'G·ª≠i l·∫°i m√£ OTP';
            }
        };

        // Start OTP countdown timer
        function startOtpTimer() {
            const timerDisplay = document.getElementById('otpTimer');
            
            if (otpTimer) {
                clearInterval(otpTimer);
            }
            
            otpTimer = setInterval(() => {
                const minutes = Math.floor(otpTimeLeft / 60);
                const seconds = otpTimeLeft % 60;
                
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (otpTimeLeft <= 0) {
                    clearInterval(otpTimer);
                    timerDisplay.textContent = 'H·∫øt h·∫°n';
                    
                    if (typeof showNotification === 'function') {
                        showNotification('M√£ OTP ƒë√£ h·∫øt h·∫°n. Vui l√≤ng g·ª≠i l·∫°i.', 'warning');
                    }
                }
                
                otpTimeLeft--;
            }, 1000);
        }

        // Reset OTP form
        function resetOtpForm() {
            document.getElementById('otpEmail').value = '';
            document.getElementById('otpCode').value = '';
            document.getElementById('otpEmailDisplay').textContent = '';
            otpTimeLeft = 600;
        }

        // Handle Enter key in OTP input
        document.addEventListener('keydown', function(e) {
            if (e.target.id === 'otpCode' && e.key === 'Enter') {
                e.preventDefault();
                verifyOtpCode();
            }
            if (e.target.id === 'otpEmail' && e.key === 'Enter') {
                e.preventDefault();
                sendOtpCode();
            }
        });

        // Test SmartCart state function
        window.testSmartCartState = function() {
            console.log('üß† Testing SmartCart state...');
            
            if (window.smartCart) {
                console.log('‚úÖ SmartCart exists:', {
                    isLoggedIn: window.smartCart.isLoggedIn,
                    lastUpdateSource: window.smartCart.lastUpdateSource,
                    cartData: window.smartCart.cartData
                });
                
                // Force refresh cart data
                window.smartCart.refreshCartData().then(() => {
                    console.log('üîÑ SmartCart refreshed');
                });
            } else {
                console.log('‚ùå SmartCart not available');
            }
            
            // Test authentication status
            console.log('üë§ Current user:', window.currentUser);
            console.log('üíæ Stored user:', localStorage.getItem('techHavenUser'));
        };
    </script>

    <!-- Variant Selection Enhancement -->
    <script>
        // Enhanced addToCart wrapper that checks variants
        window.addToCartWithVariantCheck = function(productName, productPrice, productId, productImage) {
            // Call the enhanced addToCart function from script.js
            if (typeof window.addToCart === 'function') {
                window.addToCart(productName, productPrice, productId, productImage);
            } else {
                console.error('‚ùå addToCart function not available');
            }
        };
        
        // Update all existing add-to-cart buttons to use the new function
        document.addEventListener('DOMContentLoaded', function() {
            const addToCartButtons = document.querySelectorAll('.add-to-cart');
            addToCartButtons.forEach(button => {
                // Get the original onclick content
                const originalOnclick = button.getAttribute('onclick');
                if (originalOnclick && originalOnclick.includes('addToCart(')) {
                    // Replace addToCart with addToCartWithVariantCheck
                    const newOnclick = originalOnclick.replace('addToCart(', 'addToCartWithVariantCheck(');
                    button.setAttribute('onclick', newOnclick);
                    console.log('‚úÖ Updated button onclick for variant checking');
                }
            });
        });

        // Close variant modal on overlay click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('variantSelectionModal');
            if (e.target === modal) {
                closeVariantModal();
            }
        });

        // Close variant modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('variantSelectionModal');
                if (modal && modal.style.display === 'flex') {
                    closeVariantModal();
                }
            }
        });
    </script>

    <!-- Lottie Animation Functions -->
    <script>
        // Function to show Lottie congratulations animation
        function showCongratulationAnimation(callback) {
            // Create animation container
            const animationContainer = document.createElement('div');
            animationContainer.id = 'congratulation-animation';
            animationContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: transparent;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            `;
            
            // Create Lottie animation div
            const lottieDiv = document.createElement('div');
            lottieDiv.id = 'lottie-congratulation';
            lottieDiv.style.cssText = `
                width: 100vw;
                height: 100vh;
                transform: scale(0.8);
                transition: transform 0.3s ease;
                background: transparent;
                border-radius: 0;
                box-shadow: none;
                padding: 0;
                pointer-events: auto;
            `;
            
            animationContainer.appendChild(lottieDiv);
            document.body.appendChild(animationContainer);
            
            // Fade in animation
            setTimeout(() => {
                animationContainer.style.opacity = '1';
                lottieDiv.style.transform = 'scale(1)';
            }, 50);
            
            // Load Lottie animation
            const animation = lottie.loadAnimation({
                container: lottieDiv,
                renderer: 'svg',
                loop: false,
                autoplay: true,
                path: '/congratulation.json'
            });
            
            // Handle animation complete
            animation.addEventListener('complete', function() {
                setTimeout(() => {
                    // Fade out animation
                    animationContainer.style.opacity = '0';
                    lottieDiv.style.transform = 'scale(0.8)';
                    
                    setTimeout(() => {
                        if (animationContainer.parentNode) {
                            animationContainer.remove();
                        }
                        if (callback && typeof callback === 'function') {
                            callback();
                        }
                    }, 300);
                }, 800); // Show animation for 800ms after completion
            });
            
            // Allow clicking to close early
            animationContainer.addEventListener('click', function() {
                animationContainer.style.opacity = '0';
                setTimeout(() => {
                    if (animationContainer.parentNode) {
                        animationContainer.remove();
                    }
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                }, 300);
            });
        }
        
        // Make function available globally
        window.showCongratulationAnimation = showCongratulationAnimation;
    </script>

    <!-- VNPay Result Handlers -->
    <script>
        // VNPay result handlers for index page
        async function showVNPaySuccess(orderInfo, amount) {
            // Clear cart immediately when payment is successful
            await clearCartAfterPayment();
            
            // Show Lottie congratulations animation first for VNPay
            console.log('üéâ Showing congratulation animation for VNPay payment (index.ejs)');
            if (typeof window.showCongratulationAnimation === 'function') {
                try {
                    showCongratulationAnimation(() => {
                        console.log('‚úÖ VNPay congratulation animation completed (index.ejs)');
                        // Show VNPay success modal after animation
                        showVNPaySuccessModal(orderInfo, amount);
                    });
                } catch (error) {
                    console.error('‚ùå Error showing VNPay congratulation animation (index.ejs):', error);
                    // Fallback: show modal without animation
                    showVNPaySuccessModal(orderInfo, amount);
                }
            } else {
                console.warn('‚ö†Ô∏è showCongratulationAnimation function not available for VNPay (index.ejs), showing modal directly');
                // Fallback: show modal without animation
                showVNPaySuccessModal(orderInfo, amount);
            }
        }
        
        // Function to show VNPay success modal
        function showVNPaySuccessModal(orderInfo, amount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, rgb(76, 175, 80), rgb(69, 160, 73)); color: white; padding: 30px 40px; border-radius: 15px; box-shadow: rgba(0, 0, 0, 0.3) 0px 10px 30px; z-index: 10002; text-align: center; font-family: Inter, sans-serif; max-width: 400px; width: 90%;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 600;">Thanh to√°n th√†nh c√¥ng!</h3>
                    <p style="margin: 0.5rem 0; opacity: 0.9;">M√£ ƒë∆°n h√†ng: <strong>${orderInfo}</strong></p>
                    <p style="margin: 0.5rem 0; opacity: 0.9;">T·ªïng ti·ªÅn: <strong>${amount}</strong></p>
                    <p style="margin: 1rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong v√≤ng 24h ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.</p>
                    <button onclick="this.parentElement.parentElement.remove(); location.reload();" style="
                        margin-top: 1.5rem;
                        padding: 10px 20px;
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        border-radius: 8px;
                        color: white;
                        cursor: pointer;
                        font-size: 0.9rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        ƒê√≥ng
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Function to clear cart after successful payment
        async function clearCartAfterPayment() {
            console.log('üõí Clearing cart after successful payment...');
            
            // Clear localStorage cart immediately
            localStorage.removeItem('techHavenCart');
            localStorage.removeItem('techHavenCartCount');
            console.log('‚úÖ LocalStorage cart cleared');
            
            // Clear global cart variables if available
            if (typeof cartItems !== 'undefined') {
                cartItems.length = 0; // Clear array contents
                console.log('‚úÖ Global cartItems cleared');
            }
            if (typeof cartCount !== 'undefined') {
                cartCount = 0;
                console.log('‚úÖ Global cartCount cleared');
            }
            
            // Wait for Firebase auth to be ready and clear Firebase cart
            try {
                // Wait for Firebase auth to be fully initialized
                await new Promise((resolve) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });
                
                const user = firebase.auth().currentUser;
                if (user) {
                    console.log('üîë User authenticated, clearing Firebase cart');
                    const idToken = await user.getIdToken();
                    
                    // Multiple methods to ensure cart is cleared
                    const clearPromises = [];
                    
                    // Method 1: Use clearCartInFirebase function if available
                    if (typeof clearCartInFirebase === 'function') {
                        clearPromises.push(clearCartInFirebase(idToken));
                    }
                    
                    // Method 2: Direct API call to clear user cart
                    clearPromises.push(
                        fetch(`/api/cart/user/${user.uid}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${idToken}`,
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                            if (response.ok) {
                                console.log('‚úÖ Firebase cart cleared via user API');
                            } else {
                                console.warn('‚ö†Ô∏è User cart API call failed');
                            }
                        })
                    );
                    
                    // Method 3: Clear cart by UID (alternative method)
                    clearPromises.push(
                        fetch(`/api/cart/by-uid/${user.uid}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                            if (response.ok) {
                                console.log('‚úÖ Firebase cart cleared via UID API');
                            } else {
                                console.warn('‚ö†Ô∏è UID cart API call failed');
                            }
                        })
                    );
                    
                    // Wait for all clearing methods to complete
                    await Promise.allSettled(clearPromises);
                    
                } else {
                    console.log('üë§ Guest user - cart cleared from localStorage only');
                }
            } catch (error) {
                console.error('‚ùå Error clearing Firebase cart:', error);
            }
            
            // Force update cart UI multiple times to ensure it reflects changes
            try {
                // Update cart UI if function is available
                if (typeof updateCartUI === 'function') {
                    updateCartUI();
                    console.log('üîÑ Cart UI updated');
                }
                
                // Force update cart count in header
                const cartCountElements = document.querySelectorAll('.cart-count');
                cartCountElements.forEach(element => {
                    element.textContent = '0';
                });
                
                // Force hide cart count badges
                const cartBadges = document.querySelectorAll('.cart-badge');
                cartBadges.forEach(badge => {
                    badge.style.display = 'none';
                });
                
                // Clear cart sidebar content
                const cartItemsContainer = document.getElementById('cartItems');
                if (cartItemsContainer) {
                    cartItemsContainer.innerHTML = '<p class="empty-cart-message">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>';
                }
                
                // Update cart total
                const cartTotal = document.getElementById('cartTotal');
                if (cartTotal) {
                    cartTotal.textContent = '0 VNƒê';
                }
                
                console.log('‚úÖ Cart UI forcefully updated');
                
            } catch (uiError) {
                console.error('‚ùå Error updating cart UI:', uiError);
            }
            
            console.log('‚úÖ Cart clearing completed - all methods executed');
        }
        
        function showVNPayFailure(orderInfo, message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center;">
                    <div style="color: #ef4444; font-size: 4rem; margin-bottom: 1rem;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <h2 style="color: #ef4444; margin-bottom: 1rem;">Thanh to√°n th·∫•t b·∫°i!</h2>
                    <p style="margin-bottom: 1rem;">ƒê∆°n h√†ng: ${orderInfo}</p>
                    <p style="margin-bottom: 2rem;">L√Ω do: ${message}</p>
                    <button onclick="this.closest('[style*=\"position: fixed\"]').remove();" 
                            style="background: #ef4444; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                        ƒê√≥ng
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showVNPayError(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center;">
                    <div style="color: #f59e0b; font-size: 4rem; margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 style="color: #f59e0b; margin-bottom: 1rem;">L·ªói thanh to√°n!</h2>
                    <p style="margin-bottom: 2rem;">${message}</p>
                    <button onclick="this.closest('[style*=\"position: fixed\"]').remove();" 
                            style="background: #f59e0b; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                        ƒê√≥ng
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Check VNPay result on page load
        async function checkVNPayResult() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const orderId = urlParams.get('orderId');
            const amount = urlParams.get('amount');
            const error = urlParams.get('error');
            
            if (paymentStatus) {
                // Clean URL parameters
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                if (paymentStatus === 'success') {
                    // Ensure bill creation with fallback API call
                    await ensureBillCreation(orderId, amount);
                    
                    // Wait a moment for backend processing to complete
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const formattedAmount = parseFloat(amount).toLocaleString('vi-VN');
                    await showVNPaySuccess(orderId, formattedAmount + ' VNƒê');
                } else if (paymentStatus === 'failed') {
                    showVNPayFailure(orderId, error);
                } else if (paymentStatus === 'error') {
                    showVNPayError(urlParams.get('message'));
                }
            } else {
                // Check for old VNPay format (backward compatibility)
                const vnpResponseCode = urlParams.get('vnp_ResponseCode');
                if (vnpResponseCode !== null) {
                    const orderInfo = urlParams.get('vnp_OrderInfo') || 'N/A';
                    const vnpAmount = urlParams.get('vnp_Amount');
                    const formattedAmount = vnpAmount ? new Intl.NumberFormat('vi-VN').format(vnpAmount / 100) + ' VNƒê' : 'N/A';
                    
                    if (vnpResponseCode === '00') {
                        // For old format, we don't have orderId directly, use orderInfo
                        await showVNPaySuccess(orderInfo, formattedAmount);
                    } else {
                        const errorMessage = getVNPayErrorMessage(vnpResponseCode);
                        showVNPayFailure(orderInfo, errorMessage);
                    }
                    
                    // Clean URL
                    setTimeout(() => {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 3000);
                }
            }
        }
        
        // Ensure bill creation with fallback API call
        async function ensureBillCreation(orderId, amount) {
            try {
                console.log('üîÑ Ensuring bill creation for order:', orderId);
                
                const response = await fetch('/api/vnpay/process-success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: parseFloat(amount)
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ Bill creation ensured:', result.message);
                } else {
                    console.error('‚ùå Bill creation failed:', result.message);
                }
            } catch (error) {
                console.error('‚ùå Error ensuring bill creation:', error);
            }
        }

        
        function getVNPayErrorMessage(responseCode) {
            const errorMessages = {
                '01': 'Giao d·ªãch ch∆∞a ho√†n t·∫•t',
                '02': 'Giao d·ªãch b·ªã l·ªói',
                '04': 'Giao d·ªãch ƒë·∫£o (Kh√°ch h√†ng ƒë√£ b·ªã tr·ª´ ti·ªÅn t·∫°i Ng√¢n h√†ng nh∆∞ng GD ch∆∞a th√†nh c√¥ng ·ªü VNPAY)',
                '05': 'VNPAY ƒëang x·ª≠ l√Ω giao d·ªãch n√†y (GD ho√†n ti·ªÅn)',
                '06': 'VNPAY ƒë√£ g·ª≠i y√™u c·∫ßu ho√†n ti·ªÅn sang Ng√¢n h√†ng (GD ho√†n ti·ªÅn)',
                '07': 'Giao d·ªãch b·ªã nghi ng·ªù',
                '09': 'GD Ho√†n tr·∫£ b·ªã t·ª´ ch·ªëi',
                '10': 'Kh√°ch h√†ng h·ªßy giao d·ªãch',
                '11': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: H·∫øt th·ªùi gian th·ª±c hi·ªán giao d·ªãch',
                '12': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: Th·∫ª/T√†i kho·∫£n c·ªßa kh√°ch h√†ng b·ªã kh√≥a',
                '13': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do Qu√Ω kh√°ch nh·∫≠p sai m·∫≠t kh·∫©u x√°c th·ª±c giao d·ªãch (OTP)',
                '24': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: Kh√°ch h√†ng h·ªßy giao d·ªãch',
                '51': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: T√†i kho·∫£n c·ªßa qu√Ω kh√°ch kh√¥ng ƒë·ªß s·ªë d∆∞ ƒë·ªÉ th·ª±c hi·ªán giao d·ªãch',
                '65': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: T√†i kho·∫£n c·ªßa Qu√Ω kh√°ch ƒë√£ v∆∞·ª£t qu√° h·∫°n m·ª©c giao d·ªãch trong ng√†y',
                '75': 'Ng√¢n h√†ng thanh to√°n ƒëang b·∫£o tr√¨',
                '79': 'Giao d·ªãch kh√¥ng th√†nh c√¥ng do: KH nh·∫≠p sai m·∫≠t kh·∫©u thanh to√°n qu√° s·ªë l·∫ßn quy ƒë·ªãnh',
                '99': 'L·ªói kh√¥ng x√°c ƒë·ªãnh'
            };
            
            return errorMessages[responseCode] || `L·ªói kh√¥ng x√°c ƒë·ªãnh (${responseCode})`;
        }
        
        // Make functions global
        window.showVNPaySuccess = showVNPaySuccess;
        window.showVNPayFailure = showVNPayFailure;
        window.showVNPayError = showVNPayError;
        window.checkVNPayResult = checkVNPayResult;
        
        // Check VNPay result on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkVNPayResult, 500);
        });
    </script>
</body>
</html>
