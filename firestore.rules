rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Products collection - public read access
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Users collection
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Allow admin read access (you can customize this condition)
      allow read: if request.auth != null;
    }
    
    // Cart collection
    match /cart/{cartId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Carts collection (updated name)
    match /carts/{cartId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Wishlists collection
    match /wishlists/{wishlistId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Bills collection
    match /bills/{billId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         resource.data.email == request.auth.token.email);
      allow create: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Discount codes collection
    match /discountCodes/{codeId} {
      allow read: if true; // Public read for code validation
      allow write: if request.auth != null; // Only authenticated users can modify
    }
    
    // Coupon usage tracking
    match /couponUsage/{usageId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Guest checkout verification
    match /guestCheckout/{sessionId} {
      allow read, write: if true; // Allow guest access for OTP verification
    }
    
    // Admin access (customize the condition based on your admin logic)
    match /admin/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Temporary rule for development (expires December 15, 2025)
    // Remove this in production
    match /{document=**} {
      allow read, write: if request.time < timestamp.date(2025, 12, 15);
    }
  }
}
